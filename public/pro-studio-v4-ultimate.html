<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 Ultimate Studio V4 - World-Class Creative Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        :root {
            /* Ultimate Color Palette */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --cosmic-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            --holographic-gradient: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff, #06ffa5, #ffbe0b, #fb5607);
            
            /* Advanced Colors */
            --dark-space: #0a0a0f;
            --deep-purple: #1a0b2e;
            --electric-blue: #00d4ff;
            --neon-green: #39ff14;
            --cyber-pink: #ff0080;
            --quantum-gold: #ffd700;
            --plasma-orange: #ff4500;
            
            /* Glass Morphism */
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            
            /* Typography */
            --font-primary: 'Cairo', sans-serif;
            --font-tech: 'Orbitron', monospace;
            
            /* Shadows */
            --shadow-glow: 0 0 20px rgba(102, 126, 234, 0.4);
            --shadow-intense: 0 20px 60px rgba(0, 0, 0, 0.5);
            --shadow-neon: 0 0 30px currentColor;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--dark-space);
            font-family: var(--font-primary);
            color: white;
            overflow: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Ultimate Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(240, 147, 251, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 60% 70%, rgba(57, 255, 20, 0.08) 0%, transparent 50%);
            animation: cosmicFlow 20s ease-in-out infinite;
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            animation: gridMove 30s linear infinite;
            z-index: -1;
        }

        @keyframes cosmicFlow {
            0%, 100% { 
                transform: translateX(0) translateY(0) rotate(0deg) scale(1);
                filter: hue-rotate(0deg);
            }
            25% { 
                transform: translateX(-20px) translateY(-10px) rotate(90deg) scale(1.1);
                filter: hue-rotate(90deg);
            }
            50% { 
                transform: translateX(20px) translateY(10px) rotate(180deg) scale(0.9);
                filter: hue-rotate(180deg);
            }
            75% { 
                transform: translateX(-10px) translateY(20px) rotate(270deg) scale(1.05);
                filter: hue-rotate(270deg);
            }
        }

        @keyframes gridMove {
            0% { transform: translateX(0) translateY(0); }
            100% { transform: translateX(10px) translateY(10px); }
        }

        /* Ultimate Container Layout */
        .ultimate-container {
            display: grid;
            grid-template-columns: 1fr 500px;
            height: 100vh;
            gap: 0;
            position: relative;
        }

        /* Cosmic Preview Section */
        .cosmic-preview {
            background: linear-gradient(135deg, var(--deep-purple), var(--dark-space));
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .cosmic-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--holographic-gradient);
            opacity: 0.05;
            animation: holographicShift 15s ease-in-out infinite;
        }

        @keyframes holographicShift {
            0%, 100% { transform: translateX(-100%) skewX(-15deg); }
            50% { transform: translateX(100%) skewX(15deg); }
        }

        /* Ultimate Header */
        .ultimate-header {
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            border-bottom: 1px solid var(--glass-border);
            padding: 25px 35px;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .ultimate-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: headerShimmer 3s infinite;
        }

        @keyframes headerShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .ultimate-header h1 {
            background: var(--holographic-gradient);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: holographicText 4s ease-in-out infinite;
            font-weight: 900;
            font-size: 2.2rem;
            margin: 0;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        @keyframes holographicText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* 🎬 Overlay Integration Styles */
        .overlay-status-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .overlay-connection-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overlay-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
        }

        .overlay-status-indicator.connected {
            background: #44ff44;
            box-shadow: 0 0 15px rgba(68, 255, 68, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .url-display-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .url-input, .token-input {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .url-copy-btn {
            background: var(--electric-blue);
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .url-copy-btn:hover {
            background: var(--neon-cyan);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        .overlay-control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .overlay-quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .ultimate-btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .ultimate-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .ultimate-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--electric-blue);
        }

        /* 🎬 Enhanced Streaming System Styles */
        .simple-stream-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .simple-stream-status:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .stream-info-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stream-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 15px rgba(107, 114, 128, 0.4);
            position: relative;
        }

        .stream-indicator::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: indicatorShimmer 3s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stream-indicator.live {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow:
                0 0 20px rgba(239, 68, 68, 0.8),
                0 0 40px rgba(239, 68, 68, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: simpleLivePulse 1.5s infinite;
        }

        .stream-indicator.live::before {
            opacity: 1;
        }

        @keyframes simpleLivePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow:
                    0 0 20px rgba(239, 68, 68, 0.8),
                    0 0 40px rgba(239, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.3);
                box-shadow:
                    0 0 30px rgba(239, 68, 68, 1),
                    0 0 60px rgba(239, 68, 68, 0.6),
                    0 0 80px rgba(239, 68, 68, 0.3);
            }
        }

        @keyframes indicatorShimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 🎬 Integrated Streaming System Styles */
        .streaming-status-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .streaming-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .streaming-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
        }

        .streaming-indicator.live {
            background: #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            animation: livePulse 1.5s infinite;
        }

        @keyframes livePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            }
            50% {
                transform: scale(1.2);
                box-shadow: 0 0 25px rgba(255, 0, 0, 0.8), 0 0 35px rgba(255, 0, 0, 0.4);
            }
        }

        .stream-control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stream-quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-secondary-ultimate {
            background: var(--glass-bg);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary-ultimate:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Stream Overlay Container */
        .stream-overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 10000;
            display: none;
            overflow: hidden;
        }

        .stream-overlay-container.active {
            display: block;
        }

        .stream-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stream-player-card {
            position: absolute;
            bottom: 100px;
            right: 100px;
            transform: scale(0);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
            z-index: 10;
        }

        .stream-player-card.visible {
            transform: scale(1);
            opacity: 1;
        }

        .stream-lower-third {
            position: absolute;
            bottom: 50px;
            left: 50px;
            background: linear-gradient(135deg, rgba(0, 102, 255, 0.95), rgba(0, 153, 255, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px 30px;
            color: white;
            transform: translateX(-100%);
            transition: transform 0.5s ease;
            max-width: 500px;
            z-index: 10;
        }

        .stream-lower-third.visible {
            transform: translateX(0);
        }

        .stream-lower-third h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .stream-lower-third p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .stream-ticker {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.8));
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            overflow: hidden;
            transform: translateY(-100%);
            transition: transform 0.5s ease;
            z-index: 10;
        }

        .stream-ticker.visible {
            transform: translateY(0);
        }

        .ticker-content {
            white-space: nowrap;
            animation: tickerScroll 30s linear infinite;
            color: white;
            font-size: 18px;
            font-weight: 600;
            padding: 0 20px;
        }

        @keyframes tickerScroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* Stream FIFA Card Styles */
        .stream-overlay-container .fifa-card-container {
            max-width: 400px;
        }

        .stream-overlay-container .fifa-card {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border: 3px solid #00d4ff;
            border-radius: 20px;
            padding: 25px;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .stream-overlay-container .fifa-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .stream-overlay-container .card-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .stream-overlay-container .player-name {
            font-size: 24px;
            font-weight: bold;
            margin: 0 0 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .stream-overlay-container .clubs-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 16px;
        }

        .stream-overlay-container .transfer-arrow {
            color: #00d4ff;
            font-size: 18px;
            animation: pulse 2s infinite;
        }

        .stream-overlay-container .probability-section {
            text-align: center;
            margin: 20px 0;
        }

        .stream-overlay-container .probability-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .stream-overlay-container .probability-text {
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .stream-overlay-container .transfer-fee {
            font-size: 16px;
            font-weight: 600;
            color: #00d4ff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .stream-overlay-container .card-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
            opacity: 0.8;
        }

        .ultimate-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--holographic-gradient);
            animation: holographicFlow 3s linear infinite;
        }

        @keyframes holographicFlow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 20px;
            font-family: var(--font-tech);
            font-size: 1.8rem;
            font-weight: 900;
            background: var(--holographic-gradient);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: holographicText 4s ease-in-out infinite;
        }

        @keyframes holographicText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header-icon {
            font-size: 2.2rem;
            color: var(--electric-blue);
            animation: iconPulse 2s ease-in-out infinite;
            filter: drop-shadow(var(--shadow-neon));
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
        }

        .status-display {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            backdrop-filter: blur(20px);
        }

        .quantum-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--neon-green);
            animation: quantumPulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 20px var(--neon-green);
        }

        @keyframes quantumPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 20px var(--neon-green);
            }
            50% { 
                transform: scale(1.5);
                box-shadow: 0 0 40px var(--neon-green), 0 0 60px var(--neon-green);
            }
        }

        /* Ultimate Preview Content - Enhanced */
        .preview-content {
            flex: 1;
            background:
                radial-gradient(circle at 30% 70%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(240, 147, 251, 0.08) 0%, transparent 50%),
                #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 0 0 20px 0;
        }

        .preview-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 49%, rgba(255, 255, 255, 0.02) 50%, transparent 51%);
            animation: previewShimmer 8s linear infinite;
        }

        @keyframes previewShimmer {
            0% { transform: translateX(-100%) translateY(-100%); }
            100% { transform: translateX(100%) translateY(100%); }
        }

        .preview-placeholder {
            text-align: center;
            z-index: 5;
            position: relative;
        }

        .placeholder-icon {
            font-size: 5rem;
            color: var(--electric-blue);
            margin-bottom: 30px;
            animation: floatingIcon 3s ease-in-out infinite;
            filter: drop-shadow(0 0 30px var(--electric-blue));
        }

        @keyframes floatingIcon {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        .placeholder-title {
            font-size: 2.8rem;
            font-weight: 900;
            font-family: var(--font-tech);
            background: var(--cosmic-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        .placeholder-subtitle {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
        }

        /* Ultimate Control Panel */
        .control-panel {
            background: linear-gradient(180deg, var(--deep-purple), var(--dark-space));
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--glass-border);
            position: relative;
        }

        .control-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(57, 255, 20, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 128, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Ultimate Control Header */
        .control-header {
            background: var(--cosmic-gradient);
            padding: 35px 30px;
            text-align: center;
            position: relative;
            z-index: 1;
            box-shadow: var(--shadow-intense);
        }

        .control-title {
            font-size: 1.8rem;
            font-weight: 900;
            font-family: var(--font-tech);
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .control-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Ultimate Control Body */
        .control-body {
            flex: 1;
            padding: 30px;
            position: relative;
            z-index: 1;
        }

        /* Ultimate Control Sections */
        .ultimate-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            box-shadow: var(--glass-shadow);
        }

        .ultimate-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--holographic-gradient);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .ultimate-section:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-intense);
            border-color: var(--electric-blue);
        }

        .ultimate-section:hover::before {
            transform: scaleX(1);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: white;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: var(--font-tech);
        }

        .section-icon {
            font-size: 1.5rem;
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 10px rgba(79, 172, 254, 0.5));
        }

        /* Ultimate Form Controls */
        .ultimate-input-group {
            position: relative;
            margin-bottom: 20px;
        }

        /* Smart Club Input Enhancements */
        .smart-club-input {
            position: relative;
        }

        .club-suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            margin-top: 5px;
        }

        .club-suggestions-container.show {
            display: block;
            animation: suggestionsFadeIn 0.3s ease-out;
        }

        @keyframes suggestionsFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .club-suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
        }

        .club-suggestion-item:hover {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2));
            transform: translateX(5px);
        }

        .club-suggestion-item:last-child {
            border-bottom: none;
        }

        .club-suggestion-logo {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px;
        }

        .club-suggestion-info {
            flex: 1;
        }

        .club-suggestion-name {
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .club-suggestion-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .club-logo-preview {
            position: absolute;
            top: 50%;
            right: 45px;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            display: none;
            z-index: 10;
        }

        .club-logo-preview.show {
            display: block;
            animation: logoPreviewFadeIn 0.3s ease-out;
        }

        @keyframes logoPreviewFadeIn {
            from {
                opacity: 0;
                scale: 0.8;
            }
            to {
                opacity: 1;
                scale: 1;
            }
        }

        .club-logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
        }

        .club-input-verified {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }

        .club-input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        .club-suggestions-header {
            padding: 12px 16px;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .club-suggestions-footer {
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            text-align: center;
        }

        /* Multi-Player Club Suggestions */
        .multi-club-suggestions {
            z-index: 1001 !important;
        }

        .multi-club-logo-preview {
            z-index: 1002 !important;
        }

        .multi-player-input .club-suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1001;
        }

        .multi-player-input .club-logo-preview {
            position: absolute;
            top: 50%;
            right: 45px;
            transform: translateY(-50%);
            z-index: 1002;
        }

        .ultimate-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: white;
            border-radius: 15px;
            padding: 18px 55px 18px 20px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            font-family: var(--font-primary);
        }

        .ultimate-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }

        .ultimate-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--electric-blue);
            box-shadow:
                0 0 0 4px rgba(0, 212, 255, 0.2),
                0 8px 25px rgba(0, 212, 255, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .ultimate-input:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .input-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--electric-blue);
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .ultimate-input:focus + .input-icon {
            color: var(--neon-green);
            transform: translateY(-50%) scale(1.2);
        }

        /* Ultimate Buttons */
        .ultimate-btn {
            width: 100%;
            border: none;
            border-radius: 15px;
            padding: 18px 25px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: var(--font-tech);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .ultimate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .ultimate-btn:hover::before {
            left: 100%;
        }

        .ultimate-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-intense);
            filter: brightness(1.1);
        }

        .ultimate-btn:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }

        .ultimate-btn:focus {
            outline: none;
            box-shadow: var(--shadow-intense), 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .btn-primary-ultimate {
            background: var(--cosmic-gradient);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary-ultimate:hover {
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .btn-success-ultimate {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .btn-warning-ultimate {
            background: var(--warning-gradient);
            color: white;
            box-shadow: 0 8px 25px rgba(67, 233, 123, 0.4);
        }

        .btn-info-ultimate {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4);
        }

        .btn-info-ultimate:hover {
            background: linear-gradient(135deg, #0891b2, #0e7490);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(6, 182, 212, 0.6);
        }

        /* Ultimate Select */
        .ultimate-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: white;
            border-radius: 15px;
            padding: 18px 20px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
            cursor: pointer;
        }

        .ultimate-select:focus {
            outline: none;
            border-color: var(--electric-blue);
            box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.2);
        }

        .ultimate-select option {
            background: var(--deep-purple);
            color: white;
            padding: 10px;
        }

        /* 🚀 MODERN 2024: Only Transform + Opacity for 60fps */
        .fifa-card, .financial-card {
            position: relative;
            z-index: 10;
            width: 400px;
            height: 600px;
            opacity: 1;
            visibility: visible;

            /* 🎯 ONLY animate transform and opacity for hardware acceleration */
            transform: translateZ(0);

            /* 🚀 Modern Performance Optimizations */
            will-change: auto; /* Only set when needed */
            transform-style: preserve-3d;
            backface-visibility: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;

            /* 🌟 Modern smooth easing - shorter duration */
            transition:
                opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 🚀 MODERN 2024: Fast and Smooth Animation States */
        .card-entering, .card-exiting {
            will-change: transform, opacity; /* Only what we animate */
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }

        .card-entering {
            animation-fill-mode: both;
            animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1); /* Material Design easing */
        }

        .card-exiting {
            animation-fill-mode: both;
            animation-timing-function: cubic-bezier(0.4, 0, 1, 1); /* Sharp exit */
        }

        /* 🌟 Professional Entrance States */
        .card-entering {
            animation-fill-mode: both;
            animation-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card-exiting {
            animation-fill-mode: both;
            animation-timing-function: cubic-bezier(0.55, 0.055, 0.675, 0.19);
        }

        /* 🎭 Modern Cinematic Transitions */
        /* 🚀 MODERN 2024: Simple and Fast Animations (Transform + Opacity Only) */
        @keyframes modernFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95) translateZ(0);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) translateZ(0);
            }
        }

        @keyframes modernSlideUp {
            0% {
                opacity: 0;
                transform: translateY(40px) translateZ(0);
            }
            100% {
                opacity: 1;
                transform: translateY(0) translateZ(0);
            }
        }

        @keyframes modernSlideDown {
            0% {
                opacity: 0;
                transform: translateY(-40px) translateZ(0);
            }
            100% {
                opacity: 1;
                transform: translateY(0) translateZ(0);
            }
        }

        @keyframes modernSlideLeft {
            0% {
                opacity: 0;
                transform: translateX(-40px) translateZ(0);
            }
            100% {
                opacity: 1;
                transform: translateX(0) translateZ(0);
            }
        }

        @keyframes modernSlideRight {
            0% {
                opacity: 0;
                transform: translateX(40px) translateZ(0);
            }
            100% {
                opacity: 1;
                transform: translateX(0) translateZ(0);
            }
        }

        @keyframes modernScale {
            0% {
                opacity: 0;
                transform: scale(0.8) translateZ(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateZ(0);
            }
        }

        @keyframes modernFlip {
            0% {
                opacity: 0;
                transform: perspective(1000px) rotateY(-90deg) translateZ(0);
            }
            100% {
                opacity: 1;
                transform: perspective(1000px) rotateY(0deg) translateZ(0);
            }
        }

        @keyframes modernBounce {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9) translateZ(0);
            }
            60% {
                opacity: 0.8;
                transform: translateY(-10px) scale(1.05) translateZ(0);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) translateZ(0);
            }
        }

        @keyframes cinematicSlideUp {
            0% {
                opacity: 0;
                transform: translateY(100%) scale(0.9) rotateX(15deg);
                filter: blur(10px);
                clip-path: inset(100% 0 0 0);
            }
            30% {
                opacity: 0.6;
                transform: translateY(20%) scale(0.95) rotateX(5deg);
                filter: blur(5px);
                clip-path: inset(20% 0 0 0);
            }
            70% {
                opacity: 0.9;
                transform: translateY(-10%) scale(1.02) rotateX(-2deg);
                filter: blur(1px);
                clip-path: inset(0% 0 0 0);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
                filter: blur(0px);
                clip-path: inset(0% 0 0 0);
            }
        }

        /* 🚀 MODERN 2024: Exit Animations (Transform + Opacity Only) */
        @keyframes modernFadeOut {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1) translateZ(0);
            }
            100% {
                opacity: 0;
                transform: translateY(20px) scale(0.95) translateZ(0);
            }
        }

        @keyframes modernSlideOutDown {
            0% {
                opacity: 1;
                transform: translateY(0) translateZ(0);
            }
            100% {
                opacity: 0;
                transform: translateY(40px) translateZ(0);
            }
        }

        @keyframes modernSlideOutUp {
            0% {
                opacity: 1;
                transform: translateY(0) translateZ(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-40px) translateZ(0);
            }
        }

        @keyframes modernSlideOutLeft {
            0% {
                opacity: 1;
                transform: translateX(0) translateZ(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-40px) translateZ(0);
            }
        }

        @keyframes modernSlideOutRight {
            0% {
                opacity: 1;
                transform: translateX(0) translateZ(0);
            }
            100% {
                opacity: 0;
                transform: translateX(40px) translateZ(0);
            }
        }

        @keyframes modernScaleOut {
            0% {
                opacity: 1;
                transform: scale(1) translateZ(0);
            }
            100% {
                opacity: 0;
                transform: scale(0.8) translateZ(0);
            }
        }

        @keyframes modernFlipOut {
            0% {
                opacity: 1;
                transform: perspective(1000px) rotateY(0deg) translateZ(0);
            }
            100% {
                opacity: 0;
                transform: perspective(1000px) rotateY(90deg) translateZ(0);
            }
        }

        @keyframes modernBounceOut {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1) translateZ(0);
            }
            40% {
                opacity: 0.8;
                transform: translateY(-10px) scale(1.05) translateZ(0);
            }
            100% {
                opacity: 0;
                transform: translateY(30px) scale(0.9) translateZ(0);
            }
        }

        @keyframes cinematicSlideLeft {
            0% {
                opacity: 0;
                transform: translateX(-100%) scale(0.9) rotateY(15deg);
                filter: blur(10px);
                clip-path: inset(0 100% 0 0);
            }
            30% {
                opacity: 0.6;
                transform: translateX(-20%) scale(0.95) rotateY(5deg);
                filter: blur(5px);
                clip-path: inset(0 20% 0 0);
            }
            70% {
                opacity: 0.9;
                transform: translateX(10%) scale(1.02) rotateY(-2deg);
                filter: blur(1px);
                clip-path: inset(0% 0 0 0);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1) rotateY(0deg);
                filter: blur(0px);
                clip-path: inset(0% 0 0 0);
            }
        }

        @keyframes cinematicSlideRight {
            0% {
                opacity: 0;
                transform: translateX(100%) scale(0.9) rotateY(-15deg);
                filter: blur(10px);
                clip-path: inset(0 0 0 100%);
            }
            30% {
                opacity: 0.6;
                transform: translateX(20%) scale(0.95) rotateY(-5deg);
                filter: blur(5px);
                clip-path: inset(0 0 0 20%);
            }
            70% {
                opacity: 0.9;
                transform: translateX(-10%) scale(1.02) rotateY(2deg);
                filter: blur(1px);
                clip-path: inset(0% 0 0 0);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1) rotateY(0deg);
                filter: blur(0px);
                clip-path: inset(0% 0 0 0);
            }
        }

        @keyframes cinematicIrisWipe {
            0% {
                opacity: 0;
                clip-path: circle(0% at 50% 50%);
                transform: scale(0.8) rotate(-5deg);
                filter: blur(15px) brightness(0.5);
            }
            25% {
                opacity: 0.4;
                clip-path: circle(25% at 50% 50%);
                transform: scale(0.9) rotate(-2deg);
                filter: blur(8px) brightness(0.8);
            }
            50% {
                opacity: 0.7;
                clip-path: circle(50% at 50% 50%);
                transform: scale(1.05) rotate(1deg);
                filter: blur(4px) brightness(1.1);
            }
            75% {
                opacity: 0.9;
                clip-path: circle(75% at 50% 50%);
                transform: scale(1.02) rotate(0.5deg);
                filter: blur(2px) brightness(1.05);
            }
            100% {
                opacity: 1;
                clip-path: circle(100% at 50% 50%);
                transform: scale(1) rotate(0deg);
                filter: blur(0px) brightness(1);
            }
        }

        @keyframes cinematicFlipVertical {
            0% {
                opacity: 0;
                transform: perspective(1000px) rotateX(-90deg) scale(0.8);
                filter: blur(10px);
                transform-origin: center bottom;
            }
            25% {
                opacity: 0.3;
                transform: perspective(1000px) rotateX(-45deg) scale(0.9);
                filter: blur(6px);
            }
            50% {
                opacity: 0.7;
                transform: perspective(1000px) rotateX(-10deg) scale(1.05);
                filter: blur(3px);
            }
            75% {
                opacity: 0.9;
                transform: perspective(1000px) rotateX(5deg) scale(1.02);
                filter: blur(1px);
            }
            100% {
                opacity: 1;
                transform: perspective(1000px) rotateX(0deg) scale(1);
                filter: blur(0px);
            }
        }

        @keyframes cinematicFlipHorizontal {
            0% {
                opacity: 0;
                transform: perspective(1000px) rotateY(-90deg) scale(0.8);
                filter: blur(10px);
                transform-origin: center left;
            }
            25% {
                opacity: 0.3;
                transform: perspective(1000px) rotateY(-45deg) scale(0.9);
                filter: blur(6px);
            }
            50% {
                opacity: 0.7;
                transform: perspective(1000px) rotateY(-10deg) scale(1.05);
                filter: blur(3px);
            }
            75% {
                opacity: 0.9;
                transform: perspective(1000px) rotateY(5deg) scale(1.02);
                filter: blur(1px);
            }
            100% {
                opacity: 1;
                transform: perspective(1000px) rotateY(0deg) scale(1);
                filter: blur(0px);
            }
        }

        @keyframes cinematicExpandIn {
            0% {
                opacity: 0;
                transform: scale(0) rotate(-180deg);
                filter: blur(20px) brightness(0.3);
                clip-path: circle(0% at 50% 50%);
            }
            20% {
                opacity: 0.2;
                transform: scale(0.3) rotate(-90deg);
                filter: blur(15px) brightness(0.5);
                clip-path: circle(20% at 50% 50%);
            }
            40% {
                opacity: 0.5;
                transform: scale(0.7) rotate(-30deg);
                filter: blur(8px) brightness(0.8);
                clip-path: circle(50% at 50% 50%);
            }
            70% {
                opacity: 0.8;
                transform: scale(1.1) rotate(10deg);
                filter: blur(3px) brightness(1.1);
                clip-path: circle(80% at 50% 50%);
            }
            85% {
                opacity: 0.95;
                transform: scale(1.05) rotate(5deg);
                filter: blur(1px) brightness(1.05);
                clip-path: circle(95% at 50% 50%);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
                filter: blur(0px) brightness(1);
                clip-path: circle(100% at 50% 50%);
            }
        }

        @keyframes cinematicBounceExpand {
            0% {
                opacity: 0;
                transform: scale(0) translateY(100px) rotate(-10deg);
                filter: blur(15px);
            }
            15% {
                opacity: 0.3;
                transform: scale(0.4) translateY(50px) rotate(-5deg);
                filter: blur(10px);
            }
            30% {
                opacity: 0.6;
                transform: scale(0.8) translateY(10px) rotate(2deg);
                filter: blur(5px);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2) translateY(-20px) rotate(-1deg);
                filter: blur(2px);
            }
            70% {
                opacity: 0.95;
                transform: scale(0.95) translateY(5px) rotate(0.5deg);
                filter: blur(1px);
            }
            85% {
                opacity: 1;
                transform: scale(1.05) translateY(-5px) rotate(0deg);
                filter: blur(0px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0) rotate(0deg);
                filter: blur(0px);
            }
        }

        /* 🚀 ULTRA-SMOOTH: Advanced Exit Animations */
        @keyframes ultraSmoothFadeOut {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0) translateZ(0);
                filter: blur(0px) brightness(1) saturate(1);
            }
            15% {
                opacity: 0.9;
                transform: scale(1.02) translateY(-5px) translateZ(0);
                filter: blur(1px) brightness(1.1) saturate(1.1);
            }
            35% {
                opacity: 0.7;
                transform: scale(1.05) translateY(-8px) translateZ(0);
                filter: blur(3px) brightness(1.15) saturate(1.05);
            }
            55% {
                opacity: 0.5;
                transform: scale(1.03) translateY(5px) translateZ(0);
                filter: blur(6px) brightness(1.1) saturate(0.9);
            }
            75% {
                opacity: 0.25;
                transform: scale(0.95) translateY(15px) translateZ(0);
                filter: blur(10px) brightness(0.8) saturate(0.7);
            }
            90% {
                opacity: 0.1;
                transform: scale(0.9) translateY(25px) translateZ(0);
                filter: blur(15px) brightness(0.6) saturate(0.5);
            }
            100% {
                opacity: 0;
                transform: scale(0.85) translateY(35px) translateZ(0);
                filter: blur(20px) brightness(0.4) saturate(0.3);
            }
        }

        @keyframes ultraSmoothSlideOutDown {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg) translateZ(0);
                filter: blur(0px) brightness(1);
                clip-path: inset(0% 0 0 0);
            }
            15% {
                opacity: 0.9;
                transform: translateY(15%) scale(0.98) rotateX(3deg) translateZ(0);
                filter: blur(2px) brightness(1.05);
                clip-path: inset(0% 0 5% 0);
            }
            35% {
                opacity: 0.7;
                transform: translateY(35%) scale(0.94) rotateX(8deg) translateZ(0);
                filter: blur(5px) brightness(0.95);
                clip-path: inset(0% 0 25% 0);
            }
            55% {
                opacity: 0.5;
                transform: translateY(60%) scale(0.9) rotateX(12deg) translateZ(0);
                filter: blur(8px) brightness(0.8);
                clip-path: inset(0% 0 50% 0);
            }
            75% {
                opacity: 0.25;
                transform: translateY(85%) scale(0.85) rotateX(16deg) translateZ(0);
                filter: blur(12px) brightness(0.6);
                clip-path: inset(0% 0 75% 0);
            }
            90% {
                opacity: 0.1;
                transform: translateY(95%) scale(0.8) rotateX(18deg) translateZ(0);
                filter: blur(16px) brightness(0.4);
                clip-path: inset(0% 0 90% 0);
            }
            100% {
                opacity: 0;
                transform: translateY(120%) scale(0.75) rotateX(20deg) translateZ(0);
                filter: blur(20px) brightness(0.3);
                clip-path: inset(0% 0 100% 0);
            }
        }

        @keyframes cinematicSlideOutDown {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
                filter: blur(0px);
                clip-path: inset(0% 0 0 0);
            }
            30% {
                opacity: 0.8;
                transform: translateY(20%) scale(0.98) rotateX(5deg);
                filter: blur(2px);
                clip-path: inset(0% 0 10% 0);
            }
            70% {
                opacity: 0.4;
                transform: translateY(60%) scale(0.9) rotateX(10deg);
                filter: blur(6px);
                clip-path: inset(0% 0 50% 0);
            }
            100% {
                opacity: 0;
                transform: translateY(100%) scale(0.8) rotateX(15deg);
                filter: blur(12px);
                clip-path: inset(0% 0 100% 0);
            }
        }

        @keyframes cinematicSlideOutUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
                filter: blur(0px);
                clip-path: inset(0% 0 0 0);
            }
            30% {
                opacity: 0.8;
                transform: translateY(-20%) scale(0.98) rotateX(-5deg);
                filter: blur(2px);
                clip-path: inset(10% 0 0% 0);
            }
            70% {
                opacity: 0.4;
                transform: translateY(-60%) scale(0.9) rotateX(-10deg);
                filter: blur(6px);
                clip-path: inset(50% 0 0% 0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100%) scale(0.8) rotateX(-15deg);
                filter: blur(12px);
                clip-path: inset(100% 0 0% 0);
            }
        }

        @keyframes cinematicSlideOutLeft {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1) rotateY(0deg);
                filter: blur(0px);
                clip-path: inset(0% 0 0 0);
            }
            30% {
                opacity: 0.8;
                transform: translateX(-20%) scale(0.98) rotateY(-5deg);
                filter: blur(2px);
                clip-path: inset(0% 0 0% 10%);
            }
            70% {
                opacity: 0.4;
                transform: translateX(-60%) scale(0.9) rotateY(-10deg);
                filter: blur(6px);
                clip-path: inset(0% 0 0% 50%);
            }
            100% {
                opacity: 0;
                transform: translateX(-100%) scale(0.8) rotateY(-15deg);
                filter: blur(12px);
                clip-path: inset(0% 0 0% 100%);
            }
        }

        @keyframes cinematicSlideOutRight {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1) rotateY(0deg);
                filter: blur(0px);
                clip-path: inset(0% 0 0 0);
            }
            30% {
                opacity: 0.8;
                transform: translateX(20%) scale(0.98) rotateY(5deg);
                filter: blur(2px);
                clip-path: inset(0% 10% 0% 0);
            }
            70% {
                opacity: 0.4;
                transform: translateX(60%) scale(0.9) rotateY(10deg);
                filter: blur(6px);
                clip-path: inset(0% 50% 0% 0);
            }
            100% {
                opacity: 0;
                transform: translateX(100%) scale(0.8) rotateY(15deg);
                filter: blur(12px);
                clip-path: inset(0% 100% 0% 0);
            }
        }

        @keyframes cinematicIrisWipeOut {
            0% {
                opacity: 1;
                clip-path: circle(100% at 50% 50%);
                transform: scale(1) rotate(0deg);
                filter: blur(0px) brightness(1);
            }
            25% {
                opacity: 0.8;
                clip-path: circle(75% at 50% 50%);
                transform: scale(1.02) rotate(2deg);
                filter: blur(2px) brightness(1.1);
            }
            50% {
                opacity: 0.6;
                clip-path: circle(50% at 50% 50%);
                transform: scale(0.95) rotate(-1deg);
                filter: blur(5px) brightness(0.9);
            }
            75% {
                opacity: 0.3;
                clip-path: circle(25% at 50% 50%);
                transform: scale(0.9) rotate(3deg);
                filter: blur(10px) brightness(0.6);
            }
            100% {
                opacity: 0;
                clip-path: circle(0% at 50% 50%);
                transform: scale(0.8) rotate(5deg);
                filter: blur(20px) brightness(0.3);
            }
        }

        @keyframes cinematicFlipVerticalOut {
            0% {
                opacity: 1;
                transform: perspective(1000px) rotateX(0deg) scale(1);
                filter: blur(0px);
                transform-origin: center bottom;
            }
            25% {
                opacity: 0.8;
                transform: perspective(1000px) rotateX(15deg) scale(1.02);
                filter: blur(2px);
            }
            50% {
                opacity: 0.6;
                transform: perspective(1000px) rotateX(45deg) scale(0.95);
                filter: blur(5px);
            }
            75% {
                opacity: 0.3;
                transform: perspective(1000px) rotateX(75deg) scale(0.9);
                filter: blur(8px);
            }
            100% {
                opacity: 0;
                transform: perspective(1000px) rotateX(90deg) scale(0.8);
                filter: blur(15px);
            }
        }

        @keyframes cinematicFlipHorizontalOut {
            0% {
                opacity: 1;
                transform: perspective(1000px) rotateY(0deg) scale(1);
                filter: blur(0px);
                transform-origin: center left;
            }
            25% {
                opacity: 0.8;
                transform: perspective(1000px) rotateY(15deg) scale(1.02);
                filter: blur(2px);
            }
            50% {
                opacity: 0.6;
                transform: perspective(1000px) rotateY(45deg) scale(0.95);
                filter: blur(5px);
            }
            75% {
                opacity: 0.3;
                transform: perspective(1000px) rotateY(75deg) scale(0.9);
                filter: blur(8px);
            }
            100% {
                opacity: 0;
                transform: perspective(1000px) rotateY(90deg) scale(0.8);
                filter: blur(15px);
            }
        }

        @keyframes cinematicExpandOut {
            0% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
                filter: blur(0px) brightness(1);
                clip-path: circle(100% at 50% 50%);
            }
            20% {
                opacity: 0.9;
                transform: scale(1.1) rotate(10deg);
                filter: blur(2px) brightness(1.1);
                clip-path: circle(90% at 50% 50%);
            }
            40% {
                opacity: 0.7;
                transform: scale(0.8) rotate(45deg);
                filter: blur(5px) brightness(0.8);
                clip-path: circle(60% at 50% 50%);
            }
            70% {
                opacity: 0.4;
                transform: scale(0.4) rotate(120deg);
                filter: blur(10px) brightness(0.5);
                clip-path: circle(30% at 50% 50%);
            }
            100% {
                opacity: 0;
                transform: scale(0) rotate(180deg);
                filter: blur(20px) brightness(0.2);
                clip-path: circle(0% at 50% 50%);
            }
        }

        @keyframes cinematicBounceExpandOut {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0) rotate(0deg);
                filter: blur(0px);
            }
            20% {
                opacity: 0.9;
                transform: scale(1.1) translateY(-10px) rotate(5deg);
                filter: blur(1px);
            }
            40% {
                opacity: 0.7;
                transform: scale(0.9) translateY(20px) rotate(-10deg);
                filter: blur(3px);
            }
            60% {
                opacity: 0.5;
                transform: scale(0.6) translateY(50px) rotate(15deg);
                filter: blur(6px);
            }
            80% {
                opacity: 0.2;
                transform: scale(0.3) translateY(80px) rotate(-20deg);
                filter: blur(10px);
            }
            100% {
                opacity: 0;
                transform: scale(0) translateY(120px) rotate(25deg);
                filter: blur(15px);
            }
        }

        .card-transition-wipeLeft {
            animation: cardWipeLeft var(--transition-duration, 1s) ease-out forwards !important;
            opacity: 0 !important;
            clip-path: inset(0 100% 0 0) !important;
        }

        .card-transition-wipeRight {
            animation: cardWipeRight var(--transition-duration, 1s) ease-out forwards !important;
            opacity: 0 !important;
            clip-path: inset(0 0 0 100%) !important;
        }

        .card-transition-irisWipe {
            animation: cardIrisWipe var(--transition-duration, 1s) ease-out forwards !important;
            opacity: 0 !important;
            clip-path: circle(0% at 50% 50%) !important;
        }

        .card-transition-slideFromBelow {
            animation: cardSlideFromBelow var(--transition-duration, 1s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 0 !important;
            transform: translateY(100%) !important;
        }

        .card-transition-slideFromAbove {
            animation: cardSlideFromAbove var(--transition-duration, 1s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 0 !important;
            transform: translateY(-100%) !important;
        }

        .card-transition-slideFromLeft {
            animation: cardSlideFromLeft var(--transition-duration, 1s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 0 !important;
            transform: translateX(-100%) !important;
        }

        .card-transition-slideFromRight {
            animation: cardSlideFromRight var(--transition-duration, 1s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 0 !important;
            transform: translateX(100%) !important;
        }

        .card-transition-slideFadeBelow {
            animation: cardSlideFadeBelow var(--transition-duration, 1s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 0 !important;
            transform: translateY(50%) scale(0.8) !important;
        }

        .card-transition-slideFadeAbove {
            animation: cardSlideFadeAbove var(--transition-duration, 1s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 0 !important;
            transform: translateY(-50%) scale(0.8) !important;
        }

        .card-transition-slideFadeLeft {
            animation: cardSlideFadeLeft var(--transition-duration, 1s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 0 !important;
            transform: translateX(-50%) scale(0.8) !important;
        }

        .card-transition-slideFadeRight {
            animation: cardSlideFadeRight var(--transition-duration, 1s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 0 !important;
            transform: translateX(50%) scale(0.8) !important;
        }

        .card-transition-flipVertical {
            animation: cardFlipVertical var(--transition-duration, 1s) cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards !important;
            opacity: 0 !important;
            transform: rotateX(-90deg) !important;
        }

        .card-transition-flipHorizontal {
            animation: cardFlipHorizontal var(--transition-duration, 1s) cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards !important;
            opacity: 0 !important;
            transform: rotateY(-90deg) !important;
        }

        .card-transition-expandIn {
            animation: cardExpandIn var(--transition-duration, 1s) cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards !important;
            opacity: 0 !important;
            transform: scale(0) !important;
        }

        .card-transition-bounceExpand {
            animation: cardBounceExpand var(--transition-duration, 1s) cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards !important;
            opacity: 0 !important;
            transform: scale(0) !important;
        }

        /* Card Exit Animations */
        .card-exit-fadeIn {
            animation: cardFadeOut var(--transition-duration, 1s) ease-in forwards !important;
            opacity: 1 !important;
        }

        .card-exit-wipeUp {
            animation: cardWipeOutUp var(--transition-duration, 1s) ease-in forwards !important;
            opacity: 1 !important;
            clip-path: inset(0 0 0 0) !important;
        }

        .card-exit-wipeDown {
            animation: cardWipeOutDown var(--transition-duration, 1s) ease-in forwards !important;
            opacity: 1 !important;
            clip-path: inset(0 0 0 0) !important;
        }

        .card-exit-wipeLeft {
            animation: cardWipeOutLeft var(--transition-duration, 1s) ease-in forwards !important;
            opacity: 1 !important;
            clip-path: inset(0 0 0 0) !important;
        }

        .card-exit-wipeRight {
            animation: cardWipeOutRight var(--transition-duration, 1s) ease-in forwards !important;
            opacity: 1 !important;
            clip-path: inset(0 0 0 0) !important;
        }

        .card-exit-irisWipe {
            animation: cardIrisWipeOut var(--transition-duration, 1s) ease-in forwards !important;
            opacity: 1 !important;
            clip-path: circle(100% at 50% 50%) !important;
        }

        .card-exit-slideFromBelow {
            animation: cardSlideToBelow var(--transition-duration, 1s) cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        .card-exit-slideFromAbove {
            animation: cardSlideToAbove var(--transition-duration, 1s) cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        .card-exit-slideFromLeft {
            animation: cardSlideToLeft var(--transition-duration, 1s) cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important;
            opacity: 1 !important;
            transform: translateX(0) !important;
        }

        .card-exit-slideFromRight {
            animation: cardSlideToRight var(--transition-duration, 1s) cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important;
            opacity: 1 !important;
            transform: translateX(0) !important;
        }

        .card-exit-slideFadeBelow {
            animation: cardSlideFadeToBelow var(--transition-duration, 1s) cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important;
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
        }

        .card-exit-slideFadeAbove {
            animation: cardSlideFadeToAbove var(--transition-duration, 1s) cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important;
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
        }

        .card-exit-slideFadeLeft {
            animation: cardSlideFadeToLeft var(--transition-duration, 1s) cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important;
            opacity: 1 !important;
            transform: translateX(0) scale(1) !important;
        }

        .card-exit-slideFadeRight {
            animation: cardSlideFadeToRight var(--transition-duration, 1s) cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards !important;
            opacity: 1 !important;
            transform: translateX(0) scale(1) !important;
        }

        .card-exit-flipVertical {
            animation: cardFlipVerticalOut var(--transition-duration, 1s) cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards !important;
            opacity: 1 !important;
            transform: rotateX(0deg) !important;
        }

        .card-exit-flipHorizontal {
            animation: cardFlipHorizontalOut var(--transition-duration, 1s) cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards !important;
            opacity: 1 !important;
            transform: rotateY(0deg) !important;
        }

        .card-exit-expandIn {
            animation: cardExpandOut var(--transition-duration, 1s) cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards !important;
            opacity: 1 !important;
            transform: scale(1) !important;
        }

        .card-exit-bounceExpand {
            animation: cardBounceExpandOut var(--transition-duration, 1s) cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards !important;
            opacity: 1 !important;
            transform: scale(1) !important;
        }

        /* 🎬 Card Transition Keyframes - Entry Animations */
        @keyframes cardFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes cardWipeUp {
            0% {
                opacity: 0;
                clip-path: inset(100% 0 0 0);
            }
            100% {
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }
        }

        @keyframes cardWipeDown {
            0% {
                opacity: 0;
                clip-path: inset(0 0 100% 0);
            }
            100% {
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }
        }

        @keyframes cardWipeLeft {
            0% {
                opacity: 0;
                clip-path: inset(0 100% 0 0);
            }
            100% {
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }
        }

        @keyframes cardWipeRight {
            0% {
                opacity: 0;
                clip-path: inset(0 0 0 100%);
            }
            100% {
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }
        }

        @keyframes cardIrisWipe {
            0% {
                opacity: 0;
                clip-path: circle(0% at 50% 50%);
            }
            100% {
                opacity: 1;
                clip-path: circle(100% at 50% 50%);
            }
        }

        @keyframes cardSlideFromBelow {
            0% {
                opacity: 0;
                transform: translateY(100%);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes cardSlideFromAbove {
            0% {
                opacity: 0;
                transform: translateY(-100%);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes cardSlideFromLeft {
            0% {
                opacity: 0;
                transform: translateX(-100%);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes cardSlideFromRight {
            0% {
                opacity: 0;
                transform: translateX(100%);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes cardSlideFadeBelow {
            0% {
                opacity: 0;
                transform: translateY(50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes cardSlideFadeAbove {
            0% {
                opacity: 0;
                transform: translateY(-50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes cardSlideFadeLeft {
            0% {
                opacity: 0;
                transform: translateX(-50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes cardSlideFadeRight {
            0% {
                opacity: 0;
                transform: translateX(50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes cardFlipVertical {
            0% {
                opacity: 0;
                transform: rotateX(-90deg);
            }
            100% {
                opacity: 1;
                transform: rotateX(0deg);
            }
        }

        @keyframes cardFlipHorizontal {
            0% {
                opacity: 0;
                transform: rotateY(-90deg);
            }
            100% {
                opacity: 1;
                transform: rotateY(0deg);
            }
        }

        @keyframes cardExpandIn {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes cardBounceExpand {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* 🎬 Card Transition Keyframes - Exit Animations */
        @keyframes cardFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes cardWipeOutUp {
            0% {
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }
            100% {
                opacity: 0;
                clip-path: inset(0 0 100% 0);
            }
        }

        @keyframes cardWipeOutDown {
            0% {
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }
            100% {
                opacity: 0;
                clip-path: inset(100% 0 0 0);
            }
        }

        @keyframes cardWipeOutLeft {
            0% {
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }
            100% {
                opacity: 0;
                clip-path: inset(0 0 0 100%);
            }
        }

        @keyframes cardWipeOutRight {
            0% {
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }
            100% {
                opacity: 0;
                clip-path: inset(0 100% 0 0);
            }
        }

        @keyframes cardIrisWipeOut {
            0% {
                opacity: 1;
                clip-path: circle(100% at 50% 50%);
            }
            100% {
                opacity: 0;
                clip-path: circle(0% at 50% 50%);
            }
        }

        @keyframes cardSlideToBelow {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(100%);
            }
        }

        @keyframes cardSlideToAbove {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100%);
            }
        }

        @keyframes cardSlideToLeft {
            0% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-100%);
            }
        }

        @keyframes cardSlideToRight {
            0% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        @keyframes cardSlideFadeToBelow {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(50%) scale(0.8);
            }
        }

        @keyframes cardSlideFadeToAbove {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50%) scale(0.8);
            }
        }

        @keyframes cardSlideFadeToLeft {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) scale(0.8);
            }
        }

        @keyframes cardSlideFadeToRight {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(50%) scale(0.8);
            }
        }

        @keyframes cardFlipVerticalOut {
            0% {
                opacity: 1;
                transform: rotateX(0deg);
            }
            100% {
                opacity: 0;
                transform: rotateX(90deg);
            }
        }

        @keyframes cardFlipHorizontalOut {
            0% {
                opacity: 1;
                transform: rotateY(0deg);
            }
            100% {
                opacity: 0;
                transform: rotateY(90deg);
            }
        }

        @keyframes cardExpandOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0);
            }
        }

        @keyframes cardBounceExpandOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
            100% {
                opacity: 0;
                transform: scale(0);
            }
        }

        /* Multi Player Styles */
        .multi-player-input {
            margin-bottom: 15px;
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            0% {
                opacity: 0;
                transform: translateX(30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes cardEntrance {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: var(--target-width, 0%); }
        }

        /* Theme Variations */
        .theme-neon {
            --primary-gradient: linear-gradient(135deg, #ff0080 0%, #00d4ff 100%);
            --secondary-gradient: linear-gradient(135deg, #39ff14 0%, #ff4500 100%);
        }

        .theme-holographic {
            --primary-gradient: linear-gradient(135deg, #ff006e 0%, #8338ec 50%, #3a86ff 100%);
            --secondary-gradient: linear-gradient(135deg, #06ffa5 0%, #ffbe0b 50%, #fb5607 100%);
        }

        .theme-quantum {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .theme-futuristic {
            --primary-gradient: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
            --secondary-gradient: linear-gradient(135deg, #fc00ff 0%, #00dbde 100%);
        }

        /* Animation Speed Variables */
        :root {
            --animation-duration: 1s;
        }

        /* Enhanced Particle Effects */
        .enhanced-particles {
            filter: brightness(1.5) contrast(1.2);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .ultimate-container {
                grid-template-columns: 1fr 450px;
            }
        }

        @media (max-width: 768px) {
            .ultimate-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }

            .control-panel {
                max-height: 60vh;
                border-left: none;
                border-top: 1px solid var(--glass-border);
            }

            .header-title {
                font-size: 1.4rem;
            }

            .placeholder-title {
                font-size: 2rem;
            }

            /* Multi-player responsive */
            .multi-visualization {
                padding: 10px !important;
            }

            .multi-visualization > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* Enhanced Multi-Player Animations */
        @keyframes slideOutLeft {
            0% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50px);
            }
        }

        /* Enhanced Club Logo Animations */
        @keyframes targetGlow {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(var(--probability-color), 0.3);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 8px 30px rgba(var(--probability-color), 0.6);
                transform: scale(1.05);
            }
        }

        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-3px) rotate(2deg);
            }
        }

        @keyframes logoShine {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 100% 0;
            }
        }

        /* Beautiful Modern Arrow Animations */
        @keyframes arrowContainerGlow {
            0%, 100% {
                box-shadow:
                    0 8px 25px rgba(0, 0, 0, 0.3),
                    0 0 20px var(--probability-color, #667eea),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
                transform: scale(1);
            }
            50% {
                box-shadow:
                    0 12px 35px rgba(0, 0, 0, 0.4),
                    0 0 30px var(--probability-color, #667eea),
                    0 0 40px var(--probability-color, #667eea),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
                transform: scale(1.05);
            }
        }

        @keyframes arrowDraw {
            0% {
                stroke-dasharray: 0 100;
                opacity: 0.6;
            }
            50% {
                stroke-dasharray: 50 100;
                opacity: 1;
            }
            100% {
                stroke-dasharray: 100 100;
                opacity: 0.8;
            }
        }

        @keyframes sparkle1 {
            0%, 100% {
                opacity: 0;
                transform: scale(0);
            }
            50% {
                opacity: 1;
                transform: scale(1.5);
            }
        }

        @keyframes sparkle2 {
            0%, 100% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            60% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
        }

        /* Channel Rights Animation */
        @keyframes rightsGlow {
            0%, 100% {
                box-shadow:
                    0 10px 30px rgba(0, 0, 0, 0.4),
                    0 0 20px rgba(102, 126, 234, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow:
                    0 15px 40px rgba(0, 0, 0, 0.5),
                    0 0 30px rgba(102, 126, 234, 0.5),
                    0 0 40px rgba(102, 126, 234, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
        }

        /* Enhanced Card Animations */
        @keyframes particleFloat {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0.8;
            }
            33% {
                transform: translateY(-10px) rotate(120deg);
                opacity: 1;
            }
            66% {
                transform: translateY(5px) rotate(240deg);
                opacity: 0.9;
            }
        }

        @keyframes patternShift {
            0% {
                background-position: 0px 0px, 0px 0px;
            }
            100% {
                background-position: 30px 30px, -30px -30px;
            }
        }

        /* New Card Design Animations */
        @keyframes modernCardEntrance {
            0% {
                opacity: 0;
                transform: translateY(50px) rotateX(15deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) rotateX(0deg);
            }
        }

        @keyframes minimalistCardEntrance {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Glassmorphism Animations */
        @keyframes glassCardEntrance {
            0% {
                opacity: 0;
                transform: translateY(40px) rotateX(20deg);
                backdrop-filter: blur(0px);
            }
            100% {
                opacity: 1;
                transform: translateY(0) rotateX(0deg);
                backdrop-filter: blur(20px);
            }
        }

        @keyframes glassReflection {
            0%, 100% {
                transform: translateX(-100%) skewX(-15deg);
            }
            50% {
                transform: translateX(100%) skewX(-15deg);
            }
        }

        @keyframes glowRing {
            0% {
                transform: rotate(0deg);
                opacity: 0.5;
            }
            100% {
                transform: rotate(360deg);
                opacity: 0.8;
            }
        }

        @keyframes glassArrowPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 10px var(--probability-color, #667eea);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px var(--probability-color, #667eea);
            }
        }

        /* Cyberpunk Animations */
        @keyframes cyberpunkEntrance {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.8);
                box-shadow: 0 0 0 transparent;
            }
            50% {
                opacity: 0.8;
                transform: translateY(-10px) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                box-shadow:
                    0 0 30px var(--probability-color, #667eea),
                    0 0 60px var(--probability-color, #667eea);
            }
        }

        @keyframes gridPulse {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.7;
            }
        }

        @keyframes glitchScan {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes textGlitch {
            0%, 90%, 100% {
                text-shadow: 0 0 5px currentColor;
            }
            95% {
                text-shadow:
                    2px 0 0 #ff0080,
                    -2px 0 0 #00ffff,
                    0 0 10px currentColor;
            }
        }

        @keyframes probabilityGlow {
            0% {
                text-shadow: 0 0 20px currentColor;
            }
            100% {
                text-shadow:
                    0 0 30px currentColor,
                    0 0 40px currentColor;
            }
        }

        @keyframes hologramFlicker {
            0%, 100% {
                opacity: 1;
                filter: brightness(1.2) contrast(1.3) hue-rotate(0deg);
            }
            50% {
                opacity: 0.8;
                filter: brightness(1.4) contrast(1.5) hue-rotate(5deg);
            }
        }

        @keyframes scanLines {
            0% {
                transform: translateY(-100%);
            }
            100% {
                transform: translateY(100%);
            }
        }

        @keyframes nameGlitch {
            0%, 90%, 100% {
                transform: translate(0);
            }
            92% {
                transform: translate(-2px, 2px);
            }
            94% {
                transform: translate(2px, -2px);
            }
            96% {
                transform: translate(-1px, 1px);
            }
        }

        /* Neon Animations */
        @keyframes neonPulse {
            0% {
                box-shadow:
                    0 0 20px var(--probability-color, #667eea),
                    0 0 40px var(--probability-color, #667eea),
                    0 0 80px var(--probability-color, #667eea);
            }
            100% {
                box-shadow:
                    0 0 30px var(--probability-color, #667eea),
                    0 0 60px var(--probability-color, #667eea),
                    0 0 120px var(--probability-color, #667eea);
            }
        }

        @keyframes neonRotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes neonFlicker {
            0%, 100% {
                opacity: 1;
                text-shadow:
                    0 0 10px currentColor,
                    0 0 20px currentColor,
                    0 0 30px currentColor;
            }
            50% {
                opacity: 0.8;
                text-shadow:
                    0 0 5px currentColor,
                    0 0 15px currentColor,
                    0 0 25px currentColor;
            }
        }

        /* Holographic Animations */
        @keyframes holoCardEntrance {
            0% {
                opacity: 0;
                transform: translateY(30px) rotateY(15deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) rotateY(0deg);
            }
        }

        @keyframes holoBorder {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes holoShimmer {
            0%, 100% {
                background-position: 0% 0%;
                opacity: 0.3;
            }
            50% {
                background-position: 100% 100%;
                opacity: 0.7;
            }
        }

        @keyframes holoText {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* Custom Range Slider Styling */
        .ultimate-range {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 20px;
        }

        .ultimate-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #667eea);
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
            transition: all 0.3s ease;
        }

        .ultimate-range::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
        }

        .ultimate-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #667eea);
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
            transition: all 0.3s ease;
        }

        .ultimate-range::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
        }

        /* Multi-Player Input Hover Effects */
        .multi-player-input:hover {
            border-color: rgba(0, 212, 255, 0.5) !important;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.2);
            transform: translateY(-2px);
        }
    </style>

    <!-- Club Logo Integration Service -->
    <script src="/js/clubLogoIntegration.js"></script>

    <!-- Real-time Synchronization Service -->
    <script src="/js/realTimeSync.js"></script>

    <!-- System Tester -->
    <script src="/js/systemTester.js"></script>
</head>
<body>
    <div class="ultimate-container">
        <!-- Cosmic Preview Section -->
        <div class="cosmic-preview">
            <div class="ultimate-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="header-title">
                        <i class="fas fa-atom header-icon" style="
                            background: var(--holographic-gradient);
                            background-size: 400% 400%;
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                            animation: holographicText 4s ease-in-out infinite;
                            margin-left: 10px;
                            font-size: 1.5rem;
                        "></i>
                        <h1 style="
                            background: var(--holographic-gradient);
                            background-size: 400% 400%;
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                            animation: holographicText 4s ease-in-out infinite;
                            font-weight: 900;
                            font-size: 2.2rem;
                            margin: 0;
                            display: inline;
                        ">Ultimate Studio V4</h1>
                    </div>
                    <div class="status-display">
                        <div class="quantum-indicator"></div>
                        <span id="systemStatus">جاهز للإبداع</span>
                    </div>
                </div>
            </div>

            <div class="preview-content" id="previewContent">
                <div class="preview-placeholder" id="previewPlaceholder">
                    <i class="fas fa-rocket placeholder-icon"></i>
                    <h2 class="placeholder-title">إطلاق الإبداع</h2>
                    <p class="placeholder-subtitle">ابدأ تصورك المتقدم للانتقالات</p>
                </div>
            </div>
        </div>

        <!-- Ultimate Control Panel -->
        <div class="control-panel">
            <div class="control-header">
                <h3 class="control-title">
                    <i class="fas fa-magic me-3"></i>
                    Ultimate Creator V4
                </h3>
                <p class="control-subtitle">World-Class Transfer Visualization Platform</p>
            </div>

            <div class="control-body">
                <!-- Input Mode Selection -->
                <div class="ultimate-section">
                    <div class="section-title">
                        <i class="fas fa-cogs section-icon"></i>
                        نمط الإدخال
                    </div>

                    <select class="ultimate-select" id="inputMode" onchange="ultimateStudio.switchMode(this.value)">
                        <option value="manual">🎯 الإدخال اليدوي - متقدم</option>
                        <option value="saved">💾 اللاعبين المحفوظين - محسن</option>
                        <option value="multi">⚡ اللاعبين المتعددين - جديد</option>
                        <option value="extract">🔗 استخراج من صفحة اللاعب - عصري</option>
                        <option value="ai">🤖 مدعوم بالذكاء الاصطناعي - تجريبي</option>
                    </select>
                </div>

                <!-- Manual Input Section -->
                <div class="ultimate-section" id="manualInputSection">
                    <div class="section-title">
                        <i class="fas fa-user-astronaut section-icon"></i>
                        Player Configuration
                    </div>

                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input" id="playerName" placeholder="اسم اللاعب (مثال: محمد صلاح)">
                        <i class="fas fa-user input-icon"></i>
                    </div>

                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input" id="currentClub"
                               placeholder="النادي الحالي (مثال: ليفربول)"
                               autocomplete="off"
                               oninput="ultimateStudio.handleClubInput(this, 'current')"
                               onfocus="ultimateStudio.showClubSuggestions(this, 'current')"
                               onblur="ultimateStudio.hideClubSuggestions(this, 'current')">
                        <i class="fas fa-shield-alt input-icon"></i>
                        <div class="club-suggestions-container" id="currentClubSuggestions"></div>
                        <div class="club-logo-preview" id="currentClubLogoPreview"></div>
                    </div>

                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input" id="targetClub"
                               placeholder="النادي المطلوب (مثال: الهلال)"
                               autocomplete="off"
                               oninput="ultimateStudio.handleClubInput(this, 'target')"
                               onfocus="ultimateStudio.showClubSuggestions(this, 'target')"
                               onblur="ultimateStudio.hideClubSuggestions(this, 'target')">
                        <i class="fas fa-bullseye input-icon"></i>
                        <div class="club-suggestions-container" id="targetClubSuggestions"></div>
                        <div class="club-logo-preview" id="targetClubLogoPreview"></div>
                    </div>

                    <div class="ultimate-input-group">
                        <input type="url" class="ultimate-input" id="playerImage" placeholder="رابط صورة اللاعب (اختياري)">
                        <i class="fas fa-image input-icon"></i>
                    </div>

                    <button class="ultimate-btn btn-primary-ultimate" onclick="ultimateStudio.createVisualization()">
                        <i class="fas fa-rocket me-2"></i>
                        إطلاق التصور المتقدم
                    </button>
                </div>

                <!-- Saved Players Section -->
                <div class="ultimate-section" id="savedPlayersSection" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-database section-icon"></i>
                        Saved Players Database
                    </div>

                    <select class="ultimate-select" id="savedPlayersList">
                        <option value="">جاري تحميل قاعدة البيانات...</option>
                    </select>

                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input" id="savedPlayerTargetClub"
                               placeholder="النادي المطلوب"
                               autocomplete="off"
                               oninput="ultimateStudio.handleClubInput(this, 'savedTarget')"
                               onfocus="ultimateStudio.showClubSuggestions(this, 'savedTarget')"
                               onblur="ultimateStudio.hideClubSuggestions(this, 'savedTarget')">
                        <i class="fas fa-bullseye input-icon"></i>
                        <div class="club-suggestions-container" id="savedTargetClubSuggestions"></div>
                        <div class="club-logo-preview" id="savedTargetClubLogoPreview"></div>
                    </div>

                    <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.loadSavedPlayer()">
                        <i class="fas fa-download me-2"></i>
                        تحميل من قاعدة البيانات
                    </button>
                </div>

                <!-- Multi Players Section -->
                <div class="ultimate-section" id="multiSection" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-users section-icon"></i>
                        اللاعبين المتعددين
                    </div>

                    <!-- Multi-Player Input Mode Selection -->
                    <div class="ultimate-input-group">
                        <div class="section-subtitle">
                            <i class="fas fa-users"></i>
                            نمط إدخال اللاعبين المتعددين
                        </div>
                        <div style="
                            background: rgba(0, 212, 255, 0.1);
                            border: 2px solid rgba(0, 212, 255, 0.3);
                            border-radius: 15px;
                            padding: 15px;
                            text-align: center;
                            color: #00d4ff;
                            font-weight: 600;
                        ">
                            <i class="fas fa-check-circle" style="margin-left: 8px;"></i>
                            🔄 نمط مختلط - يدوي ومحفوظ
                        </div>
                    </div>

                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input" id="multiTargetClub"
                               placeholder="النادي المطلوب لجميع اللاعبين"
                               autocomplete="off"
                               oninput="ultimateStudio.handleClubInput(this, 'multiTarget')"
                               onfocus="ultimateStudio.showClubSuggestions(this, 'multiTarget')"
                               onblur="ultimateStudio.hideClubSuggestions(this, 'multiTarget')">
                        <i class="fas fa-bullseye input-icon"></i>
                        <div class="club-suggestions-container" id="multiTargetClubSuggestions"></div>
                        <div class="club-logo-preview" id="multiTargetClubLogoPreview"></div>
                    </div>

                    <div id="multiPlayersContainer">
                        <div class="multi-player-input" style="
                            background: rgba(255, 255, 255, 0.05);
                            border: 2px solid rgba(255, 255, 255, 0.1);
                            border-radius: 15px;
                            padding: 20px;
                            margin-bottom: 15px;
                            transition: all 0.3s ease;
                        ">
                            <div class="player-header" style="
                                display: flex;
                                align-items: center;
                                margin-bottom: 15px;
                                color: #00d4ff;
                                font-weight: 600;
                            ">
                                <i class="fas fa-user-circle" style="margin-left: 10px; font-size: 1.2rem;"></i>
                                اللاعب الأول
                            </div>

                            <!-- Player Name -->
                            <div class="ultimate-input-group">
                                <input type="text" class="ultimate-input multi-player-name" placeholder="اسم اللاعب">
                                <i class="fas fa-user input-icon"></i>
                            </div>

                            <!-- Current Club -->
                            <div class="ultimate-input-group">
                                <input type="text" class="ultimate-input smart-club-input multi-player-current-club"
                                       placeholder="النادي الحالي (اختياري)"
                                       autocomplete="off"
                                       oninput="ultimateStudio.handleMultiClubInput(this, 'current')"
                                       onfocus="ultimateStudio.showMultiClubSuggestions(this, 'current')"
                                       onblur="ultimateStudio.hideMultiClubSuggestions(this, 'current')">
                                <i class="fas fa-shield-alt input-icon"></i>
                                <div class="club-suggestions-container multi-club-suggestions"></div>
                                <div class="club-logo-preview multi-club-logo-preview"></div>
                            </div>

                            <!-- Target Club -->
                            <div class="ultimate-input-group">
                                <input type="text" class="ultimate-input smart-club-input multi-player-target-club"
                                       placeholder="النادي المطلوب"
                                       autocomplete="off"
                                       oninput="ultimateStudio.handleMultiClubInput(this, 'target')"
                                       onfocus="ultimateStudio.showMultiClubSuggestions(this, 'target')"
                                       onblur="ultimateStudio.hideMultiClubSuggestions(this, 'target')">
                                <i class="fas fa-bullseye input-icon"></i>
                                <div class="club-suggestions-container multi-club-suggestions"></div>
                                <div class="club-logo-preview multi-club-logo-preview"></div>
                            </div>

                            <!-- Player Image URL -->
                            <div class="ultimate-input-group">
                                <input type="url" class="ultimate-input multi-player-image" placeholder="رابط صورة اللاعب (اختياري)">
                                <i class="fas fa-image input-icon"></i>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.addManualMultiPlayer()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-plus"></i> إدخال يدوي
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.addSavedMultiPlayer()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-database"></i> من المحفوظين
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="ultimate-btn btn-warning-ultimate" onclick="ultimateStudio.removeMultiPlayer()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-minus"></i> حذف
                            </button>
                        </div>
                    </div>

                    <!-- Quick Export/Import Controls -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <button class="ultimate-btn btn-primary-ultimate" onclick="ultimateStudio.exportPlayerData()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-download"></i> تصدير اللاعبين
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="ultimate-btn btn-secondary-ultimate" onclick="ultimateStudio.importPlayerData()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-upload"></i> استيراد اللاعبين
                            </button>
                        </div>
                    </div>

                    <!-- Display Mode Selection -->
                    <div class="ultimate-input-group">
                        <select class="ultimate-select" id="multiDisplayMode" onchange="ultimateStudio.toggleSequenceSettings(this.value)">
                            <option value="all">🎬 عرض جميع اللاعبين معاً</option>
                            <option value="sequence">⏱️ عرض متتالي (لاعب بعد لاعب)</option>
                        </select>
                    </div>

                    <!-- Sequence Settings -->
                    <div id="sequenceSettings" style="display: none;">
                        <div class="ultimate-input-group">
                            <input type="number" class="ultimate-input" id="sequenceInterval" value="3" min="1" max="10" placeholder="الفترة بالثواني">
                            <i class="fas fa-clock input-icon"></i>
                        </div>
                    </div>

                    <button class="ultimate-btn btn-primary-ultimate" onclick="ultimateStudio.createMultiVisualization()">
                        <i class="fas fa-rocket me-2"></i>
                        إطلاق العرض المتعدد
                    </button>
                </div>

                <!-- Player Data Extraction Section -->
                <div class="ultimate-section" id="extractSection" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-link section-icon"></i>
                        استخراج بيانات اللاعب من صفحته
                    </div>

                    <div class="extraction-info" style="
                        background: rgba(59, 130, 246, 0.1);
                        border: 1px solid rgba(59, 130, 246, 0.3);
                        border-radius: 12px;
                        padding: 15px;
                        margin-bottom: 20px;
                    ">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-info-circle" style="color: #3b82f6; margin-left: 10px;"></i>
                            <strong style="color: #3b82f6;">ميزة جديدة وعصرية!</strong>
                        </div>
                        <p style="font-size: 0.9rem; opacity: 0.9; margin: 0;">
                            أدخل رابط صفحة اللاعب من Transfermarkt أو مواقع أخرى، وسيتم استخراج جميع البيانات تلقائياً
                        </p>
                    </div>

                    <!-- Player Page URL -->
                    <div class="ultimate-input-group">
                        <label class="ultimate-label">رابط صفحة اللاعب:</label>
                        <input type="url" class="ultimate-input" id="playerPageUrl"
                               placeholder="https://www.transfermarkt.com/player/profil/spieler/123456">
                        <i class="fas fa-link input-icon"></i>
                    </div>

                    <!-- Target Club -->
                    <div class="ultimate-input-group">
                        <label class="ultimate-label">النادي المطلوب الانتقال إليه:</label>
                        <input type="text" class="ultimate-input smart-club-input" id="extractTargetClub"
                               placeholder="مثال: ريال مدريد، برشلونة، مانشستر سيتي"
                               autocomplete="off"
                               oninput="ultimateStudio.handleClubInput(this, 'extractTarget')"
                               onfocus="ultimateStudio.showClubSuggestions(this, 'extractTarget')"
                               onblur="ultimateStudio.hideClubSuggestions(this, 'extractTarget')">
                        <i class="fas fa-bullseye input-icon"></i>
                        <div class="club-suggestions-container" id="extractTargetClubSuggestions"></div>
                        <div class="club-logo-preview" id="extractTargetClubLogoPreview"></div>
                    </div>

                    <!-- Supported Sites -->
                    <div class="supported-sites" style="
                        background: rgba(16, 185, 129, 0.1);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 12px;
                        padding: 15px;
                        margin: 15px 0;
                    ">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-check-circle" style="color: #10b981; margin-left: 10px;"></i>
                            <strong style="color: #10b981;">المواقع المدعومة:</strong>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
                            <div>• Transfermarkt.com</div>
                            <div>• SoFIFA.com</div>
                            <div>• FUTBin.com</div>
                            <div>• المزيد قريباً...</div>
                        </div>
                    </div>

                    <!-- Extract Button -->
                    <button class="ultimate-btn btn-primary-ultimate" onclick="ultimateStudio.extractPlayerData()" id="extractBtn">
                        <i class="fas fa-download"></i> استخراج البيانات تلقائياً
                    </button>

                    <!-- Extraction Results -->
                    <div id="extractionResults" style="
                        margin-top: 20px;
                        padding: 15px;
                        background: rgba(0, 0, 0, 0.3);
                        border-radius: 12px;
                        display: none;
                    ">
                        <div class="extraction-header" style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 15px;
                            color: #10b981;
                            font-weight: 600;
                        ">
                            <i class="fas fa-check-circle" style="margin-left: 10px;"></i>
                            تم استخراج البيانات بنجاح!
                        </div>
                        <div id="extractedData" style="font-size: 0.9rem;"></div>

                        <div class="extraction-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.useExtractedData()" style="font-size: 0.9rem;">
                                <i class="fas fa-check"></i> استخدام البيانات
                            </button>
                            <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.editExtractedData()" style="font-size: 0.9rem;">
                                <i class="fas fa-edit"></i> تعديل البيانات
                            </button>
                        </div>
                    </div>

                    <!-- Quick Examples -->
                    <div class="quick-examples" style="margin-top: 20px;">
                        <div style="
                            color: rgba(255, 255, 255, 0.8);
                            font-size: 0.9rem;
                            margin-bottom: 10px;
                            font-weight: 600;
                        ">
                            <i class="fas fa-lightbulb" style="margin-left: 8px; color: #fbbf24;"></i>
                            أمثلة سريعة:
                        </div>
                        <div class="examples-grid" style="display: grid; gap: 8px;">
                            <button class="example-btn" onclick="ultimateStudio.loadExample('salah')" style="
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                border-radius: 8px;
                                padding: 8px 12px;
                                color: white;
                                font-size: 0.8rem;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                text-align: right;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                                <i class="fas fa-star" style="margin-left: 5px; color: #fbbf24;"></i>
                                محمد صلاح ← ريال مدريد
                            </button>
                            <button class="example-btn" onclick="ultimateStudio.loadExample('mbappe')" style="
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                border-radius: 8px;
                                padding: 8px 12px;
                                color: white;
                                font-size: 0.8rem;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                text-align: right;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                                <i class="fas fa-fire" style="margin-left: 5px; color: #ef4444;"></i>
                                مبابي ← ليفربول
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Section -->
                <div class="ultimate-section" id="aiSection" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-brain section-icon"></i>
                        الذكاء الاصطناعي المتقدم
                    </div>

                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input" id="aiPrompt" placeholder="اوصف سيناريو الانتقال...">
                        <i class="fas fa-magic input-icon"></i>
                    </div>

                    <button class="ultimate-btn btn-warning-ultimate" onclick="ultimateStudio.generateWithAI()">
                        <i class="fas fa-brain me-2"></i>
                        إنشاء بالذكاء الاصطناعي
                    </button>
                </div>

                <!-- Card Style Settings -->
                <div class="ultimate-section">
                    <div class="section-title">
                        <i class="fas fa-id-card section-icon"></i>
                        نمط بطاقة اللاعب
                    </div>

                    <!-- Card Design Template -->
                    <div class="ultimate-input-group">
                        <label class="ultimate-label">🎨 قالب التصميم</label>
                        <select class="ultimate-select" id="cardDesignSelect" onchange="ultimateStudio.setCardDesignAndPreview(this.value)">
                            <option value="financial">💰 التصميم المالي (الحالي)</option>
                            <option value="modern">🏆 التصميم الحديث (FIFA Style)</option>
                            <option value="minimalist">✨ التصميم البسيط</option>
                            <option value="glassmorphism">🔮 التصميم الزجاجي</option>
                            <option value="cyberpunk">🤖 التصميم السايبربانك</option>
                            <option value="neon">⚡ التصميم النيون</option>
                            <option value="holographic">🌈 التصميم الهولوجرافي</option>
                        </select>

                        <!-- Quick Preview Button -->
                        <button class="ultimate-btn btn-info-ultimate mt-2" onclick="ultimateStudio.generateInstantPreview()" style="width: 100%; font-size: 0.9rem;">
                            <i class="fas fa-eye"></i> معاينة سريعة للقالب
                        </button>
                    </div>

                    <!-- Card Style (Legacy) -->
                    <div class="ultimate-input-group" style="display: none;">
                        <select class="ultimate-select" id="cardStyle" onchange="ultimateStudio.changeCardStyle(this.value)">
                            <option value="fifa26">🎮 فيفا 26 - احترافي محسن</option>
                        </select>
                    </div>

                    <!-- Card Transition Type -->
                    <div class="ultimate-input-group">
                        <label style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 8px; display: block;">
                            <i class="fas fa-magic" style="margin-left: 8px;"></i>
                            انتقال البطاقة (In/Out)
                        </label>
                        <select class="ultimate-select" id="cardTransition" onchange="ultimateStudio.changeCardTransition(this.value)">
                            <option value="fadeIn">🌟 Fade In - تلاشي تدريجي</option>
                            <option value="wipeUp">⬆️ Linear Wipe Up - مسح خطي للأعلى</option>
                            <option value="wipeDown">⬇️ Linear Wipe Down - مسح خطي للأسفل</option>
                            <option value="wipeLeft">⬅️ Linear Wipe Left - مسح خطي لليسار</option>
                            <option value="wipeRight">➡️ Linear Wipe Right - مسح خطي لليمين</option>
                            <option value="irisWipe">🎯 Iris Wipe In - مسح دائري</option>
                            <option value="slideFromBelow">⬆️ Slide From Below - انزلاق من الأسفل</option>
                            <option value="slideFromAbove">⬇️ Slide From Above - انزلاق من الأعلى</option>
                            <option value="slideFromLeft">➡️ Slide From Left - انزلاق من اليسار</option>
                            <option value="slideFromRight">⬅️ Slide From Right - انزلاق من اليمين</option>
                            <option value="slideFadeBelow">🌟⬆️ Slide & Fade From Below - انزلاق وتلاشي من الأسفل</option>
                            <option value="slideFadeAbove">🌟⬇️ Slide & Fade From Above - انزلاق وتلاشي من الأعلى</option>
                            <option value="slideFadeLeft">🌟➡️ Slide & Fade From Left - انزلاق وتلاشي من اليسار</option>
                            <option value="slideFadeRight">🌟⬅️ Slide & Fade From Right - انزلاق وتلاشي من اليمين</option>
                            <option value="flipVertical">🔄 Flip Vertically - قلب عمودي</option>
                            <option value="flipHorizontal">🔃 Flip Horizontally - قلب أفقي</option>
                            <option value="expandIn">📈 Expand In - توسع تدريجي</option>
                            <option value="bounceExpand">🎾 Bounce + Expand - ارتداد وتوسع</option>
                        </select>
                    </div>

                    <!-- Transition Duration -->
                    <div class="ultimate-input-group">
                        <label style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 8px; display: block;">
                            <i class="fas fa-clock" style="margin-left: 8px;"></i>
                            مدة الانتقال: <span id="transitionDurationValue">1.0</span> ثانية
                        </label>
                        <input type="range" class="ultimate-range" id="transitionDuration"
                               min="0.3" max="3.0" value="1.0" step="0.1"
                               onchange="ultimateStudio.updateTransitionDuration(this.value)"
                               style="
                                   width: 100%;
                                   height: 8px;
                                   border-radius: 5px;
                                   background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                                   outline: none;
                                   -webkit-appearance: none;
                               ">
                    </div>

                    <!-- Card Show/Hide Controls -->
                    <div class="ultimate-input-group">
                        <label style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 8px; display: block;">
                            <i class="fas fa-play-circle" style="margin-left: 8px;"></i>
                            تحكم بالبطاقة
                        </label>
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.showCard()" style="
                                    font-size: 0.9rem;
                                    padding: 12px;
                                    width: 100%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-eye"></i>
                                    إظهار (In)
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="ultimate-btn btn-danger-ultimate" onclick="ultimateStudio.hideCard()" style="
                                    font-size: 0.9rem;
                                    padding: 12px;
                                    width: 100%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                                    border: none;
                                    border-radius: 12px;
                                    color: white;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(239, 68, 68, 0.3)'">
                                    <i class="fas fa-eye-slash"></i>
                                    إخفاء (Out)
                                </button>
                            </div>
                        </div>
                        <!-- Test Transition Button -->
                        <div class="row g-2 mt-2">
                            <div class="col-12">
                                <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.testCurrentTransition()" style="
                                    font-size: 0.8rem;
                                    padding: 10px;
                                    width: 100%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                                    border: none;
                                    border-radius: 12px;
                                    color: white;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(139, 92, 246, 0.3)'">
                                    <i class="fas fa-magic"></i>
                                    اختبار الانتقال الحالي
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Background Settings -->
                <div class="ultimate-section">
                    <div class="section-title">
                        <i class="fas fa-palette section-icon"></i>
                        خلفية التطبيق
                    </div>

                    <!-- Background Theme -->
                    <div class="ultimate-input-group">
                        <select class="ultimate-select" id="visualTheme" onchange="ultimateStudio.changeTheme(this.value)">
                            <option value="cosmic">🌌 كوني عصري - افتراضي</option>
                            <option value="neon">⚡ نيون سايبر متحرك</option>
                            <option value="holographic">🌈 هولوجرافي ثلاثي الأبعاد</option>
                            <option value="quantum">⚛️ كمي متقدم نابض</option>
                            <option value="futuristic">🚀 مستقبلي 2025 متدفق</option>
                            <option value="financial">💰 التحليل المالي ثلاثي الأبعاد</option>
                            <option value="matrix">🔢 ماتريكس رقمي متحرك</option>
                            <option value="cyberpunk">🌃 سايبر بانك 2077</option>
                        </select>
                    </div>


                </div>

                <!-- Advanced Settings 2025 -->
                <div class="ultimate-section">
                    <div class="section-title">
                        <i class="fas fa-sliders-h section-icon"></i>
                        إعدادات متقدمة
                    </div>

                    <!-- Animation Speed -->
                    <div class="ultimate-input-group">
                        <select class="ultimate-select" id="animationSpeed">
                            <option value="slow">🐌 بطيء - سينمائي</option>
                            <option value="normal" selected>⚡ عادي - متوازن</option>
                            <option value="fast">🚀 سريع - ديناميكي</option>
                            <option value="instant">⚡ فوري - مباشر</option>
                        </select>
                    </div>

                    <!-- Particle Effects -->
                    <div class="ultimate-input-group">
                        <select class="ultimate-select" id="particleEffects">
                            <option value="enabled" selected>✨ تأثيرات الجسيمات - مفعلة</option>
                            <option value="disabled">🚫 تأثيرات الجسيمات - معطلة</option>
                            <option value="enhanced">🌟 تأثيرات محسنة - قوية</option>
                        </select>
                    </div>

                    <!-- Sound Effects -->
                    <div class="ultimate-input-group">
                        <select class="ultimate-select" id="soundEffects">
                            <option value="enabled" selected>🔊 التأثيرات الصوتية - مفعلة</option>
                            <option value="disabled">🔇 التأثيرات الصوتية - معطلة</option>
                            <option value="enhanced">🎵 صوت محسن - ستيريو</option>
                        </select>
                    </div>

                    <!-- Player Image Size -->
                    <div class="ultimate-input-group">
                        <label style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 8px; display: block;">
                            <i class="fas fa-expand-arrows-alt" style="margin-left: 8px;"></i>
                            حجم صورة اللاعب: <span id="imageSizeValue">150</span>px
                        </label>
                        <input type="range" class="ultimate-range" id="playerImageSize"
                               min="100" max="300" value="150" step="10"
                               onchange="ultimateStudio.updateImageSizeDisplay(this.value)"
                               style="
                                   width: 100%;
                                   height: 8px;
                                   border-radius: 5px;
                                   background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                                   outline: none;
                                   -webkit-appearance: none;
                               ">
                    </div>

                    <!-- Unified Club Logo Size -->
                    <div class="ultimate-input-group">
                        <label style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 8px; display: block;">
                            <i class="fas fa-shield-alt" style="margin-left: 8px;"></i>
                            حجم شعارات الأندية: <span id="logoSizeValue">32</span>px
                        </label>
                        <input type="range" class="ultimate-range" id="clubLogoSize"
                               min="20" max="60" value="32" step="4"
                               onchange="ultimateStudio.updateUnifiedLogoSize(this.value)"
                               style="
                                   width: 100%;
                                   height: 8px;
                                   border-radius: 5px;
                                   background: linear-gradient(90deg, #10b981 0%, #059669 100%);
                                   outline: none;
                                   -webkit-appearance: none;
                               ">
                        <div style="display: flex; justify-content: space-between; color: rgba(255, 255, 255, 0.6); font-size: 0.8rem; margin-top: 4px;">
                            <span>صغير (20px)</span>
                            <span>متوسط (40px)</span>
                            <span>كبير (60px)</span>
                        </div>
                    </div>

                    <!-- LM Studio Configuration -->
                    <div class="ultimate-input-group">
                        <label style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 8px; display: block;">
                            <i class="fas fa-robot" style="margin-left: 8px;"></i>
                            رابط LM Studio
                        </label>
                        <input type="text" class="ultimate-input" id="lmStudioURL"
                               placeholder="http://localhost:1234"
                               value="http://localhost:1234"
                               onchange="ultimateStudio.updateLMStudioURL(this.value)"
                               style="
                                   background: rgba(255, 255, 255, 0.05);
                                   border: 2px solid rgba(255, 255, 255, 0.1);
                                   border-radius: 12px;
                                   padding: 15px 20px;
                                   color: white;
                                   font-size: 0.95rem;
                                   transition: all 0.3s ease;
                                   width: 100%;
                               ">
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.testLMStudioConnection()" style="font-size: 0.8rem; padding: 8px;">
                                    <i class="fas fa-wifi"></i> اختبار الاتصال
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.autoDetectLMStudio()" style="font-size: 0.8rem; padding: 8px;">
                                    <i class="fas fa-search"></i> البحث التلقائي
                                </button>
                            </div>
                        </div>
                        <div id="lmStudioStatus" style="
                            margin-top: 10px;
                            padding: 8px 12px;
                            border-radius: 8px;
                            font-size: 0.8rem;
                            text-align: center;
                            display: none;
                        "></div>
                    </div>

                    <!-- Auto-save -->
                    <div class="ultimate-input-group">
                        <select class="ultimate-select" id="autoSave">
                            <option value="enabled" selected>💾 الحفظ التلقائي - مفعل</option>
                            <option value="disabled">🚫 الحفظ التلقائي - معطل</option>
                        </select>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="ultimate-section">
                    <div class="section-title">
                        <i class="fas fa-bolt section-icon"></i>
                        الإجراءات السريعة
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <button class="ultimate-btn btn-warning-ultimate" onclick="ultimateStudio.randomPlayer()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-dice"></i> عشوائي
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.exportCreation()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-download"></i> تصدير
                            </button>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <button class="ultimate-btn btn-primary-ultimate" onclick="ultimateStudio.resetSettings()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-undo"></i> إعادة تعيين
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.saveSettings()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-save"></i> حفظ الإعدادات
                            </button>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <button class="ultimate-btn btn-warning-ultimate" onclick="ultimateStudio.testClubLogos()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-vial"></i> اختبار الشعارات
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.createTestPlayer()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-user-plus"></i> لاعب تجريبي
                            </button>
                        </div>
                    </div>

                    <!-- Integration Controls -->
                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.showIntegrationStats()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-chart-bar"></i> إحصائيات التكامل
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="ultimate-btn btn-primary-ultimate" onclick="ultimateStudio.forceSyncWithExtractor()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-sync-alt"></i> مزامنة قسرية
                            </button>
                        </div>
                    </div>

                    <!-- Smart Club System Controls -->
                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.refreshClubsDatabase()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-database"></i> تحديث قاعدة الأندية
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="ultimate-btn btn-warning-ultimate" onclick="ultimateStudio.showClubsDatabaseStats()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-chart-pie"></i> إحصائيات الأندية
                            </button>
                        </div>
                    </div>

                    <!-- Favorite Clubs Management -->
                    <div class="row g-2 mt-2">
                        <div class="col-4">
                            <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.showFavoriteClubs()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-star"></i> المفضلة
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="ultimate-btn btn-primary-ultimate" onclick="ultimateStudio.showRecentClubs()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-history"></i> الحديثة
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="ultimate-btn btn-secondary-ultimate" onclick="ultimateStudio.clearRecentClubs()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-trash"></i> مسح
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Favorite Management -->
                    <div class="row g-2 mt-1">
                        <div class="col-6">
                            <button class="ultimate-btn btn-warning-ultimate" onclick="ultimateStudio.promptAddFavoriteClub()" style="font-size: 0.7rem; padding: 8px;">
                                <i class="fas fa-plus"></i> إضافة للمفضلة
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="ultimate-btn btn-danger-ultimate" onclick="ultimateStudio.promptRemoveFavoriteClub()" style="font-size: 0.7rem; padding: 8px;">
                                <i class="fas fa-minus"></i> إزالة من المفضلة
                            </button>
                        </div>
                    </div>

                    <!-- Real-time Sync Controls -->
                    <div class="row g-2 mt-2">
                        <div class="col-4">
                            <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.showRealTimeSyncStats()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-tachometer-alt"></i> إحصائيات فورية
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="ultimate-btn btn-warning-ultimate" onclick="ultimateStudio.toggleRealTimeMonitoring()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-play-pause"></i> تبديل المراقبة
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="ultimate-btn btn-secondary-ultimate" onclick="ultimateStudio.forceRealTimeSync()" style="font-size: 0.8rem; padding: 10px;">
                                <i class="fas fa-bolt"></i> مزامنة فورية
                            </button>
                        </div>
                    </div>

                    <!-- Logo Management -->
                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <button class="ultimate-btn btn-primary-ultimate" onclick="window.open('/club-logo-manager.html', '_blank')" style="font-size: 0.9rem; padding: 12px; width: 100%;">
                                <i class="fas fa-cogs"></i> إدارة شعارات الأندية
                            </button>
                        </div>
                    </div>

                    <!-- Data Management Controls -->
                    <div class="row g-2 mt-3">
                        <div class="col-6">
                            <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.exportPlayerData()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-download"></i> تصدير البيانات
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.importPlayerData()" style="font-size: 0.9rem; padding: 12px;">
                                <i class="fas fa-upload"></i> استيراد البيانات
                            </button>
                        </div>
                    </div>

                    <!-- Custom Title and Rights Controls -->
                    <div class="ultimate-section mt-3">
                        <div class="section-title">
                            <i class="fas fa-edit section-icon"></i>
                            تخصيص العناوين والحقوق
                        </div>

                        <div class="ultimate-input-group">
                            <label class="ultimate-label">عنوان العرض المخصص</label>
                            <input type="text" class="ultimate-input" id="customTitleInput"
                                   placeholder="عرض اللاعبين المتعدد - Ultimate Studio V4"
                                   value="">
                            <button class="ultimate-btn btn-primary-ultimate mt-2" onclick="ultimateStudio.setCustomTitle(document.getElementById('customTitleInput').value)" style="width: 100%;">
                                <i class="fas fa-save"></i> حفظ العنوان
                            </button>
                        </div>

                        <div class="ultimate-input-group">
                            <label class="ultimate-label">حقوق القناة</label>
                            <input type="text" class="ultimate-input" id="channelRightsInput"
                                   placeholder="© Ultimate Studio V4 - Professional Broadcasting"
                                   value="">
                            <button class="ultimate-btn btn-primary-ultimate mt-2" onclick="ultimateStudio.setChannelRights(document.getElementById('channelRightsInput').value)" style="width: 100%;">
                                <i class="fas fa-save"></i> حفظ الحقوق
                            </button>
                        </div>


                    </div>

                    <!-- System Testing -->
                    <div class="row g-2 mt-2">
                        <div class="col-3">
                            <button class="ultimate-btn btn-success-ultimate" onclick="ultimateStudio.runQuickTest()" style="font-size: 0.7rem; padding: 8px;">
                                <i class="fas fa-bolt"></i> اختبار سريع
                            </button>
                        </div>
                        <div class="col-3">
                            <button class="ultimate-btn btn-warning-ultimate" onclick="ultimateStudio.runComprehensiveTests()" style="font-size: 0.7rem; padding: 8px;">
                                <i class="fas fa-vial"></i> اختبار شامل
                            </button>
                        </div>
                        <div class="col-3">
                            <button class="ultimate-btn btn-info-ultimate" onclick="ultimateStudio.showSystemHealthStatus()" style="font-size: 0.7rem; padding: 8px;">
                                <i class="fas fa-heartbeat"></i> صحة النظام
                            </button>
                        </div>
                        <div class="col-3">
                            <button class="ultimate-btn btn-primary-ultimate" onclick="ultimateStudio.testDirectConnection()" style="font-size: 0.7rem; padding: 8px;">
                                <i class="fas fa-link"></i> اختبار الربط
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 🎬 نظام البث المدمج الجديد -->
                <div class="ultimate-section">
                    <div class="section-title">
                        <i class="fas fa-video section-icon"></i>
                        نظام البث المدمج - Professional
                    </div>

                    <!-- Stream Status -->
                    <div class="simple-stream-status">
                        <div class="stream-info-display">
                            <div class="stream-indicator live" id="newStreamStatus"></div>
                            <span id="newStreamText">البث نشط تلقائياً 🔴</span>
                        </div>
                        <div style="
                            background: rgba(34, 197, 94, 0.1);
                            border: 1px solid rgba(34, 197, 94, 0.3);
                            border-radius: 10px;
                            padding: 12px;
                            color: #22c55e;
                            text-align: center;
                            font-size: 0.9rem;
                        ">
                            <i class="fas fa-check-circle" style="margin-left: 8px;"></i>
                            البث يعمل تلقائياً - لا حاجة لبدء يدوي
                        </div>
                    </div>

                    <!-- Stream URL -->
                    <div class="ultimate-input-group">
                        <label class="ultimate-label">رابط البث المباشر للـ OBS:</label>
                        <div class="url-display-container">
                            <input type="text" id="directStreamUrl" readonly class="ultimate-input url-input"
                                   value="http://localhost:8201/stream-clean">
                            <button class="url-copy-btn" onclick="window.copyDirectStreamUrl ? window.copyDirectStreamUrl() : alert('الدالة غير محملة بعد')" title="نسخ الرابط">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small style="color: #888; margin-top: 5px; display: block;">
                            💡 استخدم هذا الرابط في OBS كمصدر Browser Source
                        </small>
                    </div>

                    <!-- Stream Controls -->
                    <div class="stream-control-buttons">
                        <button class="ultimate-btn btn-primary-ultimate" onclick="window.sendToDirectStream ? window.sendToDirectStream() : alert('الدالة غير محملة بعد')">
                            <i class="fas fa-broadcast-tower"></i> إرسال للبث المباشر
                        </button>
                        <button class="ultimate-btn btn-success-ultimate" onclick="window.sendCurrentToOBS ? window.sendCurrentToOBS() : alert('الدالة غير محملة بعد')" title="إرسال إلى OBS File System">
                            <i class="fas fa-file-alt"></i> إرسال لـ OBS
                        </button>
                        <button class="ultimate-btn btn-warning-ultimate" onclick="window.hideFromDirectStream ? window.hideFromDirectStream() : alert('الدالة غير محملة بعد')">
                            <i class="fas fa-eye-slash"></i> إخفاء من البث
                        </button>
                        <button class="ultimate-btn btn-info-ultimate" onclick="window.openDirectStream ? window.openDirectStream() : alert('الدالة غير محملة بعد')">
                            <i class="fas fa-external-link-alt"></i> فتح البث المباشر
                        </button>
                        <button class="ultimate-btn btn-secondary-ultimate" onclick="window.open('/obs-file-system.html', '_blank')" title="فتح OBS File System">
                            <i class="fas fa-desktop"></i> فتح OBS
                        </button>
                    </div>

                    <!-- Auto Stream -->
                    <div class="ultimate-input-group">
                        <label class="ultimate-checkbox-label">
                            <input type="checkbox" id="autoSendToDirectStream" class="ultimate-checkbox" checked>
                            <span class="checkmark"></span>
                            إرسال تلقائي للبث المباشر عند إنشاء البطاقة
                        </label>
                    </div>

                    <!-- Auto OBS File System -->
                    <div class="ultimate-input-group">
                        <label class="ultimate-checkbox-label">
                            <input type="checkbox" id="autoSendToOBSFileSystem" class="ultimate-checkbox" checked>
                            <span class="checkmark"></span>
                            إرسال تلقائي لـ OBS File System عند إنشاء البطاقة
                        </label>
                    </div>

                    <!-- Quick Actions -->
                    <div class="stream-quick-actions">
                        <button class="ultimate-btn-small btn-info-ultimate" onclick="window.openDirectStream ? window.openDirectStream() : alert('الدالة غير محملة بعد')">
                            <i class="fas fa-external-link-alt"></i> فتح البث المباشر
                        </button>
                        <button class="ultimate-btn-small btn-secondary-ultimate" onclick="window.clearDirectStream ? window.clearDirectStream() : alert('الدالة غير محملة بعد')">
                            <i class="fas fa-trash"></i> مسح البث
                        </button>
                        <button class="ultimate-btn-small btn-warning-ultimate" onclick="window.testDirectStream ? window.testDirectStream() : alert('الدالة غير محملة بعد')">
                            <i class="fas fa-vial"></i> اختبار مباشر
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 🎬 Integrated Stream Overlay -->
    <div id="streamOverlay" class="stream-overlay-container">
        <div class="stream-content">
            <!-- Stream Player Card -->
            <div id="streamPlayerCard" class="stream-player-card"></div>

            <!-- Stream Lower Third -->
            <div id="streamLowerThird" class="stream-lower-third">
                <h3 id="streamLowerTitle">عاجل: صفقة جديدة</h3>
                <p id="streamLowerText">تفاصيل الانتقال...</p>
            </div>

            <!-- Stream Ticker -->
            <div id="streamTicker" class="stream-ticker">
                <div class="ticker-content" id="streamTickerContent">
                    🔥 آخر أخبار الانتقالات • ⚽ ميسي ينتقل إلى نادي جديد • 💰 صفقة بقيمة 100 مليون يورو • 🏆 تحديثات مستمرة
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('🚀 Ultimate Studio V4 - Initializing Quantum Systems...');

        // 🎬 DIRECT STREAM SYSTEM - Load functions FIRST
        console.log('🚀 Loading Direct Stream System Functions...');

        // Global variables for direct stream
        window.directStreamActive = false;
        window.directStreamUrl = 'http://localhost:8201/stream-clean';

        // Toggle direct stream
        window.toggleDirectStream = function() {
            console.log('🎬 toggleDirectStream called');

            window.directStreamActive = !window.directStreamActive;

            // Store state in localStorage
            localStorage.setItem('directStreamActive', window.directStreamActive.toString());
            localStorage.setItem('directStreamStateChanged', Date.now().toString());

            // Send to server API for OBS compatibility
            fetch('/api/stream-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    active: window.directStreamActive
                })
            }).then(response => response.json())
              .then(data => console.log('📡 Stream state sent to server:', data))
              .catch(error => console.error('❌ Error sending stream state:', error));

            // Update UI
            window.updateDirectStreamUI();

            // Show notification
            const message = window.directStreamActive ? 'تم بدء البث المباشر' : 'تم إيقاف البث المباشر';
            alert(message);

            console.log('✅ Direct stream state:', window.directStreamActive);
        };

        // Apply current size settings to content for stream synchronization
        window.applyCurrentSizesToContent = function(htmlContent) {
            console.log('🔧 Applying current size settings to content for stream sync');

            // Get current settings
            const playerImageSize = document.getElementById('playerImageSize')?.value || 150;
            const clubLogoSize = document.getElementById('clubLogoSize')?.value || 32;

            console.log(`📏 Current sizes - Player: ${playerImageSize}px, Logo: ${clubLogoSize}px`);

            // Create a temporary container to manipulate the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            // Update player images
            const playerImages = tempDiv.querySelectorAll('img[alt*="صورة"], img[src*="player"], .player-image img, .player-photo img');
            playerImages.forEach(img => {
                img.style.width = playerImageSize + 'px';
                img.style.height = playerImageSize + 'px';
                console.log(`🖼️ Updated player image size to ${playerImageSize}px`);
            });

            // Update club logos with intelligent sizing
            const baseSize = parseInt(clubLogoSize);
            const smallSize = Math.max(16, baseSize - 8);
            const mediumSize = baseSize;
            const largeSize = Math.min(80, baseSize + 20);

            const clubLogos = tempDiv.querySelectorAll('img[src*="logo"], img[src*="crest"], img[alt*="النادي"], img[alt*="المطلوب"]');
            clubLogos.forEach(img => {
                let targetSize = mediumSize;

                // Determine context and apply appropriate size
                if (img.closest('.target-club-logo-large')) {
                    targetSize = largeSize;
                } else if (img.classList.contains('club-logo-small') || img.closest('.card-footer')) {
                    targetSize = smallSize;
                } else if (img.classList.contains('target-club-logo') || img.alt?.includes('المطلوب')) {
                    targetSize = mediumSize + 4;
                }

                img.style.width = targetSize + 'px';
                img.style.height = targetSize + 'px';
                console.log(`🏆 Updated club logo size to ${targetSize}px`);
            });

            console.log('✅ Size settings applied to content for stream sync');
            return tempDiv.innerHTML;
        };

        // Send current content to direct stream - ENHANCED ULTIMATE VERSION
        window.sendToDirectStream = function() {
            console.log('🎬 sendToDirectStream called - ENHANCED VERSION');

            // Auto-enable streaming if not active
            if (!window.directStreamActive) {
                console.log('🔄 Auto-enabling direct stream...');
                window.directStreamActive = true;
                localStorage.setItem('directStreamActive', 'true');
            }

            // Get current content from previewContent
            const previewContent = document.getElementById('previewContent');
            if (!previewContent || !previewContent.innerHTML.trim()) {
                console.log('⚠️ No content to send');
                alert('⚠️ لا يوجد محتوى لإرساله. يرجى إنشاء بطاقة أولاً');
                return;
            }

            // Apply current size settings to content before sending
            let contentHtml = previewContent.innerHTML;
            contentHtml = window.applyCurrentSizesToContent(contentHtml);

            // Prepare content data with enhanced metadata
            const contentData = {
                html: contentHtml,
                timestamp: Date.now(),
                source: 'Ultimate Studio V4',
                id: 'content_' + Date.now(),
                version: '2.0'
            };

            console.log('📦 Preparing to send content:', {
                size: contentData.html.length,
                timestamp: contentData.timestamp,
                id: contentData.id
            });

            // Store content for direct stream (localStorage for browser compatibility)
            localStorage.setItem('directStreamActive', 'true');
            localStorage.setItem('directStreamContent', JSON.stringify(contentData));
            localStorage.setItem('directStreamContentChanged', Date.now().toString());
            localStorage.setItem('directStreamLastUpdate', Date.now().toString());

            // 📁 NEW: Send to OBS File System as well
            window.sendToOBSFileSystem(contentData);

            console.log('💾 Content stored in localStorage successfully');

            // Send to server API for OBS compatibility - ENHANCED
            const sendToServer = async () => {
                try {
                    console.log('📡 Sending to server...');
                    const response = await fetch('/api/stream-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({
                            active: true,
                            content: contentData
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('📡 Content sent to server successfully:', data);

                    // Show success message silently
                    console.log('✅ تم إرسال المحتوى للبث المباشر بنجاح');
                    if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                        window.ultimateStudio.showNotification('✅ تم إرسال المحتوى للبث المباشر بنجاح', 'success');
                    }

                    return true;
                } catch (error) {
                    console.error('❌ Error sending content to server:', error);
                    console.log('📱 Using localStorage fallback mode');
                    console.log('✅ تم إرسال المحتوى للبث المباشر (وضع محلي)');
                    if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                        window.ultimateStudio.showNotification('✅ تم إرسال المحتوى للبث المباشر', 'success');
                    }
                    return false;
                }
            };

            // Execute server send
            sendToServer();

            // Trigger multiple events for cross-tab communication
            setTimeout(() => {
                console.log('🔄 Triggering storage events...');

                // Trigger storage event
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'directStreamContent',
                    newValue: JSON.stringify(contentData),
                    storageArea: localStorage
                }));

                // Trigger custom event
                window.dispatchEvent(new CustomEvent('directStreamUpdate', {
                    detail: contentData
                }));

                // Force update localStorage again to ensure it's saved
                localStorage.setItem('directStreamContent', JSON.stringify(contentData));
                localStorage.setItem('directStreamContentChanged', Date.now().toString());

                console.log('✅ All events triggered successfully');
            }, 100);

            console.log('✅ Content sent to direct stream:', contentData);
        };

        // Hide content from direct stream
        window.hideFromDirectStream = function() {
            console.log('🎬 hideFromDirectStream called');

            localStorage.removeItem('directStreamContent');
            localStorage.setItem('directStreamContentChanged', Date.now().toString());

            alert('✅ تم إخفاء المحتوى من البث المباشر');
            console.log('✅ Content hidden from direct stream');
        };

        // Open direct stream window
        window.openDirectStream = function() {
            window.open(window.directStreamUrl, 'DirectStreamView', 'width=1920,height=1080,scrollbars=no,resizable=yes');
            console.log('✅ Direct stream window opened');
        };

        // Copy direct stream URL
        window.copyDirectStreamUrl = function() {
            navigator.clipboard.writeText(window.directStreamUrl).then(() => {
                alert('تم نسخ رابط البث المباشر');
            }).catch(() => {
                prompt('انسخ هذا الرابط:', window.directStreamUrl);
            });
        };

        // 📁 NEW: Send to OBS File System
        window.sendToOBSFileSystem = async function(contentData) {
            try {
                console.log('📁 Sending to OBS File System...');

                const obsData = {
                    active: true,
                    html: contentData.html,
                    timestamp: contentData.timestamp,
                    id: contentData.id,
                    source: 'Pro Studio V4 Ultimate'
                };

                const response = await fetch('/api/update-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(obsData)
                });

                if (response.ok) {
                    console.log('✅ Content sent to OBS File System successfully');
                } else {
                    console.error('❌ Failed to send to OBS File System:', response.status);
                }

            } catch (error) {
                console.error('❌ Error sending to OBS File System:', error);
            }
        };

        // Clear direct stream
        window.clearDirectStream = function() {
            localStorage.removeItem('directStreamContent');
            localStorage.removeItem('directStreamActive');
            localStorage.setItem('directStreamCleared', Date.now().toString());

            window.directStreamActive = false;
            window.updateDirectStreamUI();

            // 📁 NEW: Clear OBS File System as well
            window.clearOBSFileSystem();

            alert('تم مسح البث المباشر');
            console.log('✅ Direct stream cleared');
        };

        // 📁 NEW: Clear OBS File System
        window.clearOBSFileSystem = async function() {
            try {
                const clearData = {
                    active: false,
                    html: '',
                    timestamp: Date.now(),
                    id: 'clear_' + Date.now(),
                    source: 'Pro Studio V4 Clear'
                };

                await fetch('/api/update-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(clearData)
                });

                console.log('✅ OBS File System cleared');
            } catch (error) {
                console.error('❌ Error clearing OBS File System:', error);
            }
        };

        // 📁 NEW: Send current content to OBS File System
        window.sendCurrentToOBS = function() {
            console.log('📁 Sending current content to OBS File System...');

            const previewContent = document.getElementById('previewContent');
            if (!previewContent || !previewContent.innerHTML.trim()) {
                alert('لا يوجد محتوى لإرساله! قم بإنشاء بطاقة لاعب أولاً.');
                return;
            }

            // Get current content with size adjustments
            const currentHTML = window.applyCurrentSizesToContent ?
                window.applyCurrentSizesToContent(previewContent.innerHTML) :
                previewContent.innerHTML;

            const contentData = {
                html: currentHTML,
                timestamp: Date.now(),
                id: 'obs_manual_' + Date.now(),
                source: 'Pro Studio V4 Manual'
            };

            // Send to OBS File System
            window.sendToOBSFileSystem(contentData);

            // Show success message
            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification('✅ تم إرسال المحتوى إلى OBS File System', 'success');
            } else {
                console.log('✅ تم إرسال المحتوى إلى OBS File System');
            }
        };

        // Test direct stream
        window.testDirectStream = function() {
            console.log('🧪 Testing direct stream system...');

            // Start stream
            window.directStreamActive = true;
            localStorage.setItem('directStreamActive', 'true');
            window.updateDirectStreamUI();

            // Create test content
            const testContent = {
                html: `
                    <div class="fifa-card" style="
                        background: linear-gradient(135deg, #1e3c72, #2a5298);
                        border: 3px solid transparent;
                        border-radius: 25px;
                        padding: 40px;
                        color: white;
                        text-align: center;
                        width: 450px;
                        min-height: 550px;
                    ">
                        <h2 style="font-size: 36px; margin-bottom: 20px;">محمد صلاح</h2>
                        <div style="margin: 30px 0;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px;">ليفربول</div>
                                <div style="font-size: 24px;">←</div>
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px;">ريال مدريد</div>
                            </div>
                        </div>
                        <div style="margin: 40px 0;">
                            <div style="font-size: 48px; font-weight: bold; color: #10b981;">85%</div>
                            <div style="font-size: 18px; opacity: 0.8;">احتمالية الانتقال</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; margin-top: 20px;">
                            رسوم الانتقال: 100 مليون يورو
                        </div>
                    </div>
                `,
                timestamp: Date.now(),
                source: 'Test Data'
            };

            localStorage.setItem('directStreamContent', JSON.stringify(testContent));
            localStorage.setItem('directStreamContentChanged', Date.now().toString());

            alert('تم تشغيل اختبار البث المباشر');
            console.log('✅ Direct stream test completed');
        };

        // Update direct stream UI
        window.updateDirectStreamUI = function() {
            const indicator = document.getElementById('newStreamStatus');
            const text = document.getElementById('newStreamText');
            const button = document.getElementById('newStreamBtn');

            console.log('🔄 Updating UI - Elements found:', {
                indicator: !!indicator,
                text: !!text,
                button: !!button,
                active: window.directStreamActive
            });

            if (indicator && text && button) {
                if (window.directStreamActive) {
                    indicator.classList.add('live');
                    text.innerHTML = 'البث مباشر <span style="color: #ff0000;">🔴</span>';
                    button.innerHTML = '<i class="fas fa-stop"></i> إيقاف البث';
                    button.className = 'ultimate-btn btn-danger-ultimate';
                } else {
                    indicator.classList.remove('live');
                    text.innerHTML = 'البث متوقف <span style="color: #888;">⚫</span>';
                    button.innerHTML = '<i class="fas fa-play"></i> بدء البث';
                    button.className = 'ultimate-btn btn-success-ultimate';
                }
                console.log('✅ UI updated successfully');
            } else {
                console.error('❌ UI elements not found');
            }
        };

        // Auto-send to direct stream when creating card - ENHANCED VERSION
        window.checkAutoSendToDirectStream = function() {
            const autoSend = document.getElementById('autoSendToDirectStream');
            if (autoSend && autoSend.checked) {
                console.log('🎬 Auto-send to direct stream triggered');

                // Auto-enable streaming if not active
                if (!window.directStreamActive) {
                    console.log('🔄 Auto-enabling direct stream for auto-send...');
                    window.directStreamActive = true;
                    localStorage.setItem('directStreamActive', 'true');
                }

                setTimeout(() => {
                    if (typeof window.sendToDirectStream === 'function') {
                        window.sendToDirectStream();
                        console.log('✅ Auto-send to direct stream completed');
                    } else {
                        console.warn('⚠️ sendToDirectStream function not available');
                    }
                }, 1000);
            } else if (autoSend && !autoSend.checked) {
                console.log('📺 Auto-send to direct stream disabled by user');
            } else {
                console.log('⚠️ Auto-send checkbox not found');
            }
        };

        // 📁 NEW: Auto-send to OBS File System when creating card
        window.checkAutoSendToOBSFileSystem = function() {
            const autoSend = document.getElementById('autoSendToOBSFileSystem');
            if (autoSend && autoSend.checked) {
                console.log('📁 Auto-send to OBS File System triggered');

                setTimeout(() => {
                    if (typeof window.sendCurrentToOBS === 'function') {
                        window.sendCurrentToOBS();
                        console.log('✅ Auto-send to OBS File System completed');
                    } else {
                        console.warn('⚠️ sendCurrentToOBS function not available');
                    }
                }, 1500); // Slightly delayed after direct stream
            } else if (autoSend && !autoSend.checked) {
                console.log('📁 Auto-send to OBS File System disabled');
            } else {
                console.warn('⚠️ Auto-send OBS checkbox not found');
            }
        };

        console.log('✅ Direct Stream Functions Loaded Successfully!');
        console.log('🎬 Available functions:', Object.keys(window).filter(key => key.includes('DirectStream') || key.includes('directStream')));

        // Initialize UI immediately when DOM is ready
        function initializeStreamUI() {
            // Load saved state
            const savedState = localStorage.getItem('directStreamActive') === 'true';
            if (savedState) {
                window.directStreamActive = savedState;
                console.log('📂 Loaded saved state:', window.directStreamActive);
            }

            // Update UI
            setTimeout(() => {
                window.updateDirectStreamUI();
                console.log('🔄 UI initialized');
            }, 100);
        }

        // Initialize immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeStreamUI);
        } else {
            initializeStreamUI();
        }

        // 🌟 Ultimate Studio V4 - World-Class Creative System
        class UltimateStudio {
            constructor() {
                this.currentPlayer = null;
                this.isProcessing = false;
                this.visualizationStyles = ['cosmic', 'holographic', 'neon', 'quantum', 'cyberpunk'];
                this.currentStyle = 'cosmic';
                this.currentCardStyle = 'fifa26'; // Default card style
                this.particleSystem = null;
                this.audioContext = null;
                this.multiPlayers = [];
                this.sequenceTimer = null;
                this.currentSequenceIndex = 0;
                this.settings = this.loadSettings();

                // 🏆 Football API Configuration
                this.footballAPI = {
                    token: '3f1dd06d6fab4b44bff09bdd9552411b',
                    baseUrl: 'https://api.football-data.org/v4',
                    headers: {
                        'X-Auth-Token': '3f1dd06d6fab4b44bff09bdd9552411b'
                    }
                };

                // 🌍 Club Database - Arabic to English mapping
                this.clubDatabase = this.initializeClubDatabase();
                this.leagueDatabase = this.initializeLeagueDatabase();

                // 🎯 Smart Club System
                this.clubSuggestions = [];
                this.clubsDatabase = [];
                this.favoriteClubs = this.loadFavoriteClubs();
                this.recentClubs = this.loadRecentClubs();
                this.loadClubsDatabase();

                this.init();
            }

            init() {
                console.log('🎨 Initializing Ultimate Creative Engine...');
                this.setupParticleSystem();
                this.setupAudioSystem();
                this.loadSavedPlayers();
                this.startQuantumAnimations();
                this.initializeSettings();
                this.loadCustomSettings();
                // Apply default modern background
                this.applyModernBackground('cosmic');
                console.log('✨ Ultimate Studio V4 Ready!');
            }

            // Load custom settings on startup
            loadCustomSettings() {
                // Load custom title
                setTimeout(() => {
                    const titleInput = document.getElementById('customTitleInput');
                    if (titleInput) {
                        titleInput.value = this.getCustomTitle();
                    }

                    // Load channel rights
                    const rightsInput = document.getElementById('channelRightsInput');
                    if (rightsInput) {
                        rightsInput.value = this.getChannelRights();
                    }

                    // Load card design
                    const designSelect = document.getElementById('cardDesignSelect');
                    if (designSelect) {
                        designSelect.value = this.getSelectedCardDesign();
                        console.log(`🎨 Loaded card design: ${this.getSelectedCardDesign()}`);
                    }
                }, 1000);
            }

            // 🎯 CUSTOM TITLE AND CHANNEL RIGHTS SYSTEM
            getCustomTitle() {
                const savedTitle = localStorage.getItem('customStreamTitle');
                return savedTitle || 'عرض اللاعبين المتعدد - Ultimate Studio V4';
            }

            setCustomTitle(title) {
                localStorage.setItem('customStreamTitle', title);
                this.showNotification('✅ تم حفظ العنوان المخصص', 'success');
                this.updateDisplayedTitle();
            }

            getChannelRights() {
                const savedRights = localStorage.getItem('channelRights');
                return savedRights || '© Ultimate Studio V4 - Professional Broadcasting';
            }

            setChannelRights(rights) {
                localStorage.setItem('channelRights', rights);
                this.showNotification('✅ تم حفظ حقوق القناة', 'success');
                this.updateDisplayedRights();
            }

            updateDisplayedTitle() {
                const titleElement = document.getElementById('customTitle');
                if (titleElement) {
                    titleElement.textContent = this.getCustomTitle();
                }
            }

            updateDisplayedRights() {
                const rightsElement = document.getElementById('channelRights');
                if (rightsElement) {
                    rightsElement.textContent = this.getChannelRights();
                }
            }

            // Card design system with instant preview
            setCardDesignAndPreview(design) {
                this.settings.cardDesign = design;
                this.saveSettings();
                this.showNotification(`✅ تم تغيير قالب التصميم إلى: ${this.getCardDesignName(design)}`, 'success');

                // Update UI
                const select = document.getElementById('cardDesignSelect');
                if (select) {
                    select.value = design;
                }

                // Generate instant preview if we have player data
                this.generateInstantPreview();
            }

            // Legacy function for backward compatibility
            setCardDesign(design) {
                this.setCardDesignAndPreview(design);
            }

            // Generate instant preview with current or sample data
            generateInstantPreview() {
                try {
                    let playerData = null;

                    // Check if we have current player data
                    if (this.currentPlayer && (this.currentPlayer.arabicName || this.currentPlayer.name)) {
                        playerData = this.currentPlayer;
                    } else {
                        // Use sample data for preview
                        playerData = {
                            arabicName: 'محمد صلاح',
                            name: 'Mohamed Salah',
                            currentClub: 'ليفربول',
                            targetClub: 'ريال مدريد',
                            age: '31',
                            position: 'جناح أيمن',
                            playerImage: '', // No image for sample
                            currentClubLogo: '',
                            targetClubLogo: '',
                            // Set probability in the expected format
                            probability: { percentage: 75 },
                            // Also set individual fields for compatibility
                            transferProbability: 75,
                            marketValue: 80000000,
                            contractYears: 2
                        };
                    }

                    // Ensure probability is set
                    if (!playerData.probability || !playerData.probability.percentage) {
                        playerData.probability = { percentage: 75 }; // Default for preview
                    }

                    // Generate preview
                    const previewContent = document.getElementById('previewContent');
                    const placeholder = document.getElementById('previewPlaceholder');

                    if (previewContent) {
                        if (placeholder) {
                            placeholder.style.display = 'none';
                        }

                        const visualizationHTML = this.createPlayerCardHTML(playerData);
                        previewContent.innerHTML = visualizationHTML;

                        // Show preview message
                        const designName = this.getCardDesignName(this.getSelectedCardDesign());
                        this.showNotification(`🎨 معاينة ${designName}`, 'info');
                    }
                } catch (error) {
                    console.error('Error generating instant preview:', error);
                    this.showNotification('⚠️ خطأ في إنشاء المعاينة', 'warning');
                }
            }

            getCardDesignName(design) {
                const names = {
                    'financial': 'التصميم المالي',
                    'modern': 'التصميم الحديث',
                    'minimalist': 'التصميم البسيط',
                    'glassmorphism': 'التصميم الزجاجي',
                    'cyberpunk': 'التصميم السايبربانك',
                    'neon': 'التصميم النيون',
                    'holographic': 'التصميم الهولوجرافي'
                };
                return names[design] || 'غير محدد';
            }

            // 🎯 SMART CLUB INPUT SYSTEM
            async loadClubsDatabase() {
                try {
                    // تحميل قاعدة البيانات من localStorage (المحدثة من المستخرج)
                    const verifiedClubs = localStorage.getItem('verifiedClubs');
                    const arabicMappings = localStorage.getItem('ARABIC_MAPPINGS');

                    if (verifiedClubs) {
                        const clubsData = JSON.parse(verifiedClubs);
                        this.clubsDatabase = clubsData.map(club => ({
                            id: club.id,
                            englishName: club.englishName,
                            arabicName: club.arabicName || club.englishName,
                            logoUrl: club.logoUrl,
                            league: club.league || 'غير محدد',
                            country: club.country || 'غير محدد',
                            searchTerms: this.generateSearchTerms(club.englishName, club.arabicName),
                            popularity: this.calculateClubPopularity(club)
                        }));

                        // Sort by popularity for faster suggestions
                        this.clubsDatabase.sort((a, b) => b.popularity - a.popularity);

                        // Create search index for instant search
                        this.createSearchIndex();

                        console.log(`🎯 Loaded ${this.clubsDatabase.length} clubs with modern search index`);
                    }

                    // إضافة ترجمات إضافية
                    if (arabicMappings) {
                        const mappings = JSON.parse(arabicMappings);
                        Object.entries(mappings).forEach(([english, arabic]) => {
                            const existingClub = this.clubsDatabase.find(club =>
                                club.englishName.toLowerCase() === english.toLowerCase()
                            );
                            if (existingClub && !existingClub.arabicName) {
                                existingClub.arabicName = arabic;
                                existingClub.searchTerms = this.generateSearchTerms(english, arabic);
                            }
                        });
                    }

                } catch (error) {
                    console.warn('⚠️ Could not load clubs database:', error);
                    this.clubsDatabase = this.getFallbackClubs();
                }
            }

            // Calculate club popularity for better sorting
            calculateClubPopularity(club) {
                let score = 0;

                // Popular leagues get higher scores
                const leagueScores = {
                    'Premier League': 100,
                    'La Liga': 95,
                    'Serie A': 90,
                    'Bundesliga': 85,
                    'Ligue 1': 80,
                    'Champions League': 100,
                    'Saudi Pro League': 75
                };

                score += leagueScores[club.league] || 50;

                // Popular clubs get bonus
                const popularClubs = [
                    'real madrid', 'barcelona', 'manchester united', 'liverpool',
                    'chelsea', 'arsenal', 'manchester city', 'juventus', 'ac milan',
                    'inter milan', 'bayern munich', 'psg', 'الهلال', 'النصر', 'الاتحاد'
                ];

                if (popularClubs.some(popular =>
                    club.englishName.toLowerCase().includes(popular) ||
                    club.arabicName.toLowerCase().includes(popular)
                )) {
                    score += 50;
                }

                return score;
            }

            // Create modern search index for instant suggestions
            createSearchIndex() {
                this.searchIndex = new Map();

                this.clubsDatabase.forEach(club => {
                    // Index all search terms
                    club.searchTerms.forEach(term => {
                        const key = term.toLowerCase();
                        if (!this.searchIndex.has(key)) {
                            this.searchIndex.set(key, []);
                        }
                        this.searchIndex.get(key).push(club);
                    });

                    // Index partial matches (for autocomplete)
                    const allTerms = [club.englishName, club.arabicName, ...club.searchTerms];
                    allTerms.forEach(term => {
                        if (term) {
                            for (let i = 1; i <= term.length; i++) {
                                const partial = term.toLowerCase().substring(0, i);
                                if (!this.searchIndex.has(partial)) {
                                    this.searchIndex.set(partial, []);
                                }
                                if (!this.searchIndex.get(partial).includes(club)) {
                                    this.searchIndex.get(partial).push(club);
                                }
                            }
                        }
                    });
                });

                console.log(`🔍 Created search index with ${this.searchIndex.size} entries`);
            }

            generateSearchTerms(englishName, arabicName) {
                const terms = new Set();

                // الاسم الإنجليزي
                terms.add(englishName.toLowerCase());

                // الاسم العربي
                if (arabicName && arabicName !== englishName) {
                    terms.add(arabicName.toLowerCase());
                }

                // كلمات منفصلة
                englishName.split(' ').forEach(word => {
                    if (word.length > 2) terms.add(word.toLowerCase());
                });

                if (arabicName) {
                    arabicName.split(' ').forEach(word => {
                        if (word.length > 1) terms.add(word.toLowerCase());
                    });
                }

                // اختصارات شائعة
                const abbreviations = {
                    'manchester united': ['man utd', 'united', 'man u'],
                    'manchester city': ['man city', 'city'],
                    'real madrid': ['real', 'madrid'],
                    'fc barcelona': ['barca', 'barcelona'],
                    'atletico madrid': ['atletico'],
                    'tottenham hotspur': ['spurs', 'tottenham'],
                    'west ham united': ['west ham'],
                    'newcastle united': ['newcastle'],
                    'aston villa': ['villa'],
                    'crystal palace': ['palace'],
                    'brighton & hove albion': ['brighton'],
                    'wolverhampton wanderers': ['wolves'],
                    'leicester city': ['leicester'],
                    'nottingham forest': ['forest']
                };

                const lowerEnglish = englishName.toLowerCase();
                if (abbreviations[lowerEnglish]) {
                    abbreviations[lowerEnglish].forEach(abbr => terms.add(abbr));
                }

                return Array.from(terms);
            }

            getFallbackClubs() {
                // قاعدة بيانات احتياطية للأندية الشائعة
                return [
                    { englishName: 'Arsenal', arabicName: 'آرسنال', logoUrl: '', league: 'Premier League', country: 'England' },
                    { englishName: 'Chelsea', arabicName: 'تشيلسي', logoUrl: '', league: 'Premier League', country: 'England' },
                    { englishName: 'Liverpool', arabicName: 'ليفربول', logoUrl: '', league: 'Premier League', country: 'England' },
                    { englishName: 'Manchester City', arabicName: 'مانشستر سيتي', logoUrl: '', league: 'Premier League', country: 'England' },
                    { englishName: 'Manchester United', arabicName: 'مانشستر يونايتد', logoUrl: '', league: 'Premier League', country: 'England' },
                    { englishName: 'Real Madrid', arabicName: 'ريال مدريد', logoUrl: '', league: 'La Liga', country: 'Spain' },
                    { englishName: 'FC Barcelona', arabicName: 'برشلونة', logoUrl: '', league: 'La Liga', country: 'Spain' },
                    { englishName: 'Al Hilal', arabicName: 'الهلال', logoUrl: '', league: 'Saudi Pro League', country: 'Saudi Arabia' },
                    { englishName: 'Al Nassr', arabicName: 'النصر', logoUrl: '', league: 'Saudi Pro League', country: 'Saudi Arabia' }
                ].map(club => ({
                    ...club,
                    id: club.englishName.toLowerCase().replace(/\s+/g, '_'),
                    searchTerms: this.generateSearchTerms(club.englishName, club.arabicName)
                }));
            }

            // Modern fast club input handler
            handleClubInput(input, type) {
                const query = input.value.trim();

                if (query.length < 1) {
                    this.hideClubSuggestions(input, type);
                    this.hideClubLogoPreview(input, type);
                    this.removeInputValidation(input);
                    return;
                }

                // Use modern search index for instant results
                const suggestions = this.modernSearchClubs(query);

                if (suggestions.length > 0) {
                    this.showClubSuggestions(input, type, suggestions);

                    // إذا كان هناك تطابق تام، عرض الشعار
                    const exactMatch = suggestions.find(club =>
                        club.englishName.toLowerCase() === query.toLowerCase() ||
                        club.arabicName.toLowerCase() === query.toLowerCase()
                    );

                    if (exactMatch) {
                        this.showClubLogoPreview(input, type, exactMatch);
                        this.setInputValidation(input, 'verified');
                    } else {
                        this.hideClubLogoPreview(input, type);
                        this.setInputValidation(input, 'partial');
                    }
                } else {
                    this.hideClubSuggestions(input, type);
                    this.hideClubLogoPreview(input, type);
                    this.setInputValidation(input, 'error');
                }
            }

            // Modern search using index for instant results
            modernSearchClubs(query) {
                if (!this.searchIndex) {
                    return this.searchClubs(query); // Fallback to old method
                }

                const searchKey = query.toLowerCase();
                const results = new Set();

                // Get exact matches first
                if (this.searchIndex.has(searchKey)) {
                    this.searchIndex.get(searchKey).forEach(club => results.add(club));
                }

                // Get partial matches
                for (let [key, clubs] of this.searchIndex.entries()) {
                    if (key.includes(searchKey) || searchKey.includes(key)) {
                        clubs.forEach(club => results.add(club));
                    }
                }

                // Convert to array and sort by popularity
                return Array.from(results)
                    .sort((a, b) => b.popularity - a.popularity)
                    .slice(0, 8); // Limit to 8 suggestions for performance
            }

            searchClubs(query) {
                const normalizedQuery = query.toLowerCase().trim();
                const results = [];

                this.clubsDatabase.forEach(club => {
                    let score = 0;

                    // تطابق تام
                    if (club.englishName.toLowerCase() === normalizedQuery ||
                        club.arabicName.toLowerCase() === normalizedQuery) {
                        score = 100;
                    }
                    // يبدأ بالاستعلام
                    else if (club.englishName.toLowerCase().startsWith(normalizedQuery) ||
                             club.arabicName.toLowerCase().startsWith(normalizedQuery)) {
                        score = 90;
                    }
                    // يحتوي على الاستعلام
                    else if (club.englishName.toLowerCase().includes(normalizedQuery) ||
                             club.arabicName.toLowerCase().includes(normalizedQuery)) {
                        score = 80;
                    }
                    // البحث في المصطلحات
                    else {
                        club.searchTerms.forEach(term => {
                            if (term.includes(normalizedQuery)) {
                                score = Math.max(score, 70);
                            } else if (term.startsWith(normalizedQuery)) {
                                score = Math.max(score, 75);
                            }
                        });
                    }

                    // تصحيح الأخطاء الإملائية البسيطة
                    if (score === 0) {
                        const similarity = this.calculateSimilarity(normalizedQuery, club.englishName.toLowerCase());
                        const arabicSimilarity = club.arabicName ?
                            this.calculateSimilarity(normalizedQuery, club.arabicName.toLowerCase()) : 0;

                        if (similarity > 0.7 || arabicSimilarity > 0.7) {
                            score = 60;
                        }
                    }

                    if (score > 0) {
                        results.push({ ...club, score });
                    }
                });

                // ترتيب النتائج حسب النقاط
                return results.sort((a, b) => b.score - a.score).slice(0, 8);
            }

            calculateSimilarity(str1, str2) {
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;

                if (longer.length === 0) return 1.0;

                const editDistance = this.levenshteinDistance(longer, shorter);
                return (longer.length - editDistance) / longer.length;
            }

            levenshteinDistance(str1, str2) {
                const matrix = [];

                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }

                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }

                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }

                return matrix[str2.length][str1.length];
            }

            showClubSuggestions(input, type, suggestions = null) {
                const containerId = type === 'current' ? 'currentClubSuggestions' : 'targetClubSuggestions';
                const container = document.getElementById(containerId);

                if (!container) return;

                if (!suggestions) {
                    const query = input.value.trim();
                    if (query.length < 2) {
                        container.classList.remove('show');
                        return;
                    }
                    suggestions = this.searchClubs(query);
                }

                if (suggestions.length === 0) {
                    container.classList.remove('show');
                    return;
                }

                let html = `
                    <div class="club-suggestions-header">
                        <i class="fas fa-search"></i> اقتراحات الأندية (${suggestions.length})
                    </div>
                `;

                suggestions.forEach(club => {
                    const logoHtml = club.logoUrl ?
                        `<img src="${club.logoUrl}" alt="${club.englishName}" class="club-suggestion-logo" onerror="this.style.display='none'">` :
                        `<div class="club-suggestion-logo" style="background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">${club.englishName.charAt(0)}</div>`;

                    html += `
                        <div class="club-suggestion-item" onclick="ultimateStudio.selectClub('${input.id}', '${type}', '${club.englishName}', '${club.arabicName}', '${club.logoUrl || ''}')">
                            ${logoHtml}
                            <div class="club-suggestion-info">
                                <div class="club-suggestion-name">${club.arabicName || club.englishName}</div>
                                <div class="club-suggestion-details">${club.englishName} • ${club.league} • ${club.country}</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="club-suggestions-footer">
                        اضغط على النادي لاختياره
                    </div>
                `;

                container.innerHTML = html;
                container.classList.add('show');
            }

            hideClubSuggestions(input, type) {
                setTimeout(() => {
                    const containerId = type === 'current' ? 'currentClubSuggestions' : 'targetClubSuggestions';
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.classList.remove('show');
                    }
                }, 200);
            }

            selectClub(inputId, type, englishName, arabicName, logoUrl) {
                const input = document.getElementById(inputId);
                if (!input) return;

                // تعيين القيمة
                input.value = arabicName || englishName;

                // إخفاء الاقتراحات
                this.hideClubSuggestions(input, type);

                // عرض الشعار
                this.showClubLogoPreview(input, type, { englishName, arabicName, logoUrl });

                // تعيين التحقق
                this.setInputValidation(input, 'verified');

                // إشعار المستخدم
                this.showNotification(`✅ تم اختيار ${arabicName || englishName}`, 'success');

                console.log(`🎯 Club selected: ${englishName} (${arabicName})`);
            }

            showClubLogoPreview(input, type, club) {
                const previewId = type === 'current' ? 'currentClubLogoPreview' : 'targetClubLogoPreview';
                const preview = document.getElementById(previewId);

                if (!preview || !club.logoUrl) return;

                preview.innerHTML = `<img src="${club.logoUrl}" alt="${club.englishName}" onerror="this.parentElement.style.display='none'">`;
                preview.classList.add('show');
            }

            hideClubLogoPreview(input, type) {
                const previewId = type === 'current' ? 'currentClubLogoPreview' : 'targetClubLogoPreview';
                const preview = document.getElementById(previewId);

                if (preview) {
                    preview.classList.remove('show');
                }
            }

            setInputValidation(input, status) {
                // إزالة جميع فئات التحقق
                input.classList.remove('club-input-verified', 'club-input-error', 'club-input-partial');

                // إضافة الفئة المناسبة
                switch (status) {
                    case 'verified':
                        input.classList.add('club-input-verified');
                        break;
                    case 'error':
                        input.classList.add('club-input-error');
                        break;
                    case 'partial':
                        // لا نضيف فئة للحالة الجزئية
                        break;
                }
            }

            removeInputValidation(input) {
                input.classList.remove('club-input-verified', 'club-input-error', 'club-input-partial');
            }

            // تحسين دالة getClubLogo لتستخدم النظام الجديد
            async getClubLogoEnhanced(clubName) {
                try {
                    // البحث في قاعدة البيانات المحلية أولاً
                    const localClub = this.clubsDatabase.find(club =>
                        club.englishName.toLowerCase() === clubName.toLowerCase() ||
                        club.arabicName.toLowerCase() === clubName.toLowerCase()
                    );

                    if (localClub && localClub.logoUrl) {
                        console.log(`🎯 Found logo in local database: ${localClub.logoUrl}`);
                        return localClub.logoUrl;
                    }

                    // استخدام النظام الأصلي كاحتياطي
                    return await this.getClubLogo(clubName);

                } catch (error) {
                    console.warn(`⚠️ Error getting enhanced club logo for ${clubName}:`, error);
                    return await this.getClubLogo(clubName);
                }
            }

            // دالة لإعادة تحميل قاعدة البيانات
            async refreshClubsDatabase() {
                console.log('🔄 Refreshing clubs database...');
                await this.loadClubsDatabase();
                this.showNotification(`✅ تم تحديث قاعدة بيانات الأندية - ${this.clubsDatabase.length} نادي`, 'success');
            }

            // دالة لإضافة نادي جديد
            addCustomClub(englishName, arabicName, logoUrl, league, country) {
                const newClub = {
                    id: englishName.toLowerCase().replace(/\s+/g, '_'),
                    englishName,
                    arabicName: arabicName || englishName,
                    logoUrl: logoUrl || '',
                    league: league || 'غير محدد',
                    country: country || 'غير محدد',
                    searchTerms: this.generateSearchTerms(englishName, arabicName)
                };

                // التحقق من عدم وجود النادي مسبقاً
                const exists = this.clubsDatabase.find(club =>
                    club.englishName.toLowerCase() === englishName.toLowerCase()
                );

                if (!exists) {
                    this.clubsDatabase.push(newClub);
                    console.log(`✅ Added custom club: ${englishName} (${arabicName})`);
                    this.showNotification(`✅ تم إضافة النادي: ${arabicName || englishName}`, 'success');
                } else {
                    console.log(`⚠️ Club already exists: ${englishName}`);
                    this.showNotification(`⚠️ النادي موجود مسبقاً: ${arabicName || englishName}`, 'warning');
                }
            }

            // دالة للحصول على إحصائيات قاعدة البيانات
            getClubsDatabaseStats() {
                const stats = {
                    totalClubs: this.clubsDatabase.length,
                    clubsWithLogos: this.clubsDatabase.filter(club => club.logoUrl).length,
                    clubsWithArabicNames: this.clubsDatabase.filter(club => club.arabicName && club.arabicName !== club.englishName).length,
                    leagues: [...new Set(this.clubsDatabase.map(club => club.league))].length,
                    countries: [...new Set(this.clubsDatabase.map(club => club.country))].length
                };

                console.log('📊 Clubs Database Stats:', stats);
                return stats;
            }

            // دالة لعرض إحصائيات قاعدة البيانات
            showClubsDatabaseStats() {
                const stats = this.getClubsDatabaseStats();

                const message = `📊 إحصائيات قاعدة بيانات الأندية:\n\n` +
                              `🏆 إجمالي الأندية: ${stats.totalClubs}\n` +
                              `🎨 أندية بشعارات: ${stats.clubsWithLogos}\n` +
                              `🌍 أندية بأسماء عربية: ${stats.clubsWithArabicNames}\n` +
                              `🏟️ عدد الدوريات: ${stats.leagues}\n` +
                              `🌎 عدد البلدان: ${stats.countries}\n\n` +
                              `📈 معدل الشعارات: ${Math.round((stats.clubsWithLogos / stats.totalClubs) * 100)}%\n` +
                              `🔤 معدل الترجمة العربية: ${Math.round((stats.clubsWithArabicNames / stats.totalClubs) * 100)}%`;

                alert(message);
                this.showNotification('📊 تم عرض إحصائيات قاعدة البيانات', 'info');
            }

            // تحسين دالة getClubLogo الأصلية لتستخدم النظام الجديد
            async getClubLogo(clubName) {
                try {
                    console.log(`🔍 Getting club logo with enhanced system: "${clubName}"`);

                    if (!clubName || clubName.trim() === '') {
                        console.warn('⚠️ Empty club name provided');
                        return null;
                    }

                    // أولاً، البحث في قاعدة البيانات المحلية المحسنة
                    const localClub = this.clubsDatabase.find(club =>
                        club.englishName.toLowerCase() === clubName.toLowerCase() ||
                        club.arabicName.toLowerCase() === clubName.toLowerCase() ||
                        club.searchTerms.some(term => term === clubName.toLowerCase())
                    );

                    if (localClub && localClub.logoUrl) {
                        console.log(`✅ Enhanced system found logo: ${localClub.logoUrl}`);
                        return localClub.logoUrl;
                    }

                    // ثانياً، استخدام خدمة التكامل
                    if (window.clubLogoIntegration) {
                        console.log(`🔗 Using integrated club logo service for: "${clubName}"`);
                        const integrationResult = await window.clubLogoIntegration.searchClubLogo(clubName);

                        if (integrationResult && integrationResult.logoUrl) {
                            console.log(`✅ Integration service found logo: ${integrationResult.logoUrl} (${integrationResult.source})`);
                            return integrationResult.logoUrl;
                        }
                    }

                    // ثالثاً، البحث الذكي مع تطبيع الاسم
                    const searchClubName = this.normalizeClubName(clubName);
                    if (searchClubName !== clubName) {
                        const normalizedClub = this.clubsDatabase.find(club =>
                            club.englishName.toLowerCase() === searchClubName.toLowerCase() ||
                            club.arabicName.toLowerCase() === searchClubName.toLowerCase()
                        );

                        if (normalizedClub && normalizedClub.logoUrl) {
                            console.log(`✅ Found logo with normalized name: ${normalizedClub.logoUrl}`);
                            return normalizedClub.logoUrl;
                        }
                    }

                    // رابعاً، استخدام API الخارجي
                    const response = await fetch(`/api/get-club-logo?clubName=${encodeURIComponent(searchClubName)}`);

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data.logoUrl) {
                            console.log(`✅ External API logo loaded: ${data.data.logoUrl}`);
                            return data.data.logoUrl;
                        }
                    }

                    // خامساً، المحاولة مع الاسم الأصلي
                    if (searchClubName !== clubName.trim()) {
                        console.log(`🔄 Trying with original name: "${clubName}"`);
                        const fallbackResponse = await fetch(`/api/get-club-logo?clubName=${encodeURIComponent(clubName.trim())}`);

                        if (fallbackResponse.ok) {
                            const fallbackResult = await fallbackResponse.json();
                            if (fallbackResult.success && fallbackResult.data.logoUrl) {
                                console.log(`✅ Logo found with original name: ${fallbackResult.data.logoUrl}`);
                                return fallbackResult.data.logoUrl;
                            }
                        }
                    }

                    console.warn(`❌ All enhanced logo services failed for: "${clubName}"`);
                    return null;

                } catch (error) {
                    console.error('🚨 Error fetching enhanced club logo:', error);
                    return null;
                }
            }

            normalizeClubName(clubName) {
                // تطبيع أسماء الأندية للبحث الأفضل
                const normalizations = {
                    'مان سيتي': 'Manchester City',
                    'مان يونايتد': 'Manchester United',
                    'ليفربول': 'Liverpool',
                    'تشيلسي': 'Chelsea',
                    'آرسنال': 'Arsenal',
                    'ريال مدريد': 'Real Madrid',
                    'برشلونة': 'FC Barcelona',
                    'الهلال': 'Al Hilal',
                    'النصر': 'Al Nassr',
                    'الاتحاد': 'Al Ittihad',
                    'الأهلي': 'Al Ahly'
                };

                return normalizations[clubName] || clubName;
            }

            // 🌟 FAVORITE AND RECENT CLUBS SYSTEM
            loadFavoriteClubs() {
                try {
                    const saved = localStorage.getItem('ultimateStudio_favoriteClubs');
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.warn('Error loading favorite clubs:', error);
                    return [];
                }
            }

            loadRecentClubs() {
                try {
                    const saved = localStorage.getItem('ultimateStudio_recentClubs');
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.warn('Error loading recent clubs:', error);
                    return [];
                }
            }

            addToRecentClubs(clubName) {
                if (!clubName) return;

                // إزالة النادي إذا كان موجوداً مسبقاً
                this.recentClubs = this.recentClubs.filter(club => club !== clubName);

                // إضافة النادي في المقدمة
                this.recentClubs.unshift(clubName);

                // الاحتفاظ بآخر 10 أندية فقط
                this.recentClubs = this.recentClubs.slice(0, 10);

                // حفظ في localStorage
                localStorage.setItem('ultimateStudio_recentClubs', JSON.stringify(this.recentClubs));
            }

            addToFavoriteClubs(clubName) {
                if (!clubName || this.favoriteClubs.includes(clubName)) return;

                this.favoriteClubs.push(clubName);
                localStorage.setItem('ultimateStudio_favoriteClubs', JSON.stringify(this.favoriteClubs));

                this.showNotification(`⭐ تم إضافة ${clubName} للمفضلة`, 'success');
            }

            removeFromFavoriteClubs(clubName) {
                this.favoriteClubs = this.favoriteClubs.filter(club => club !== clubName);
                localStorage.setItem('ultimateStudio_favoriteClubs', JSON.stringify(this.favoriteClubs));

                this.showNotification(`❌ تم إزالة ${clubName} من المفضلة`, 'info');
            }

            // تحسين دالة selectClub لتضيف للتاريخ
            selectClub(inputId, type, englishName, arabicName, logoUrl) {
                const input = document.getElementById(inputId);
                if (!input) return;

                const displayName = arabicName || englishName;

                // تعيين القيمة
                input.value = displayName;

                // إضافة للتاريخ
                this.addToRecentClubs(displayName);

                // إخفاء الاقتراحات
                this.hideClubSuggestions(input, type);

                // عرض الشعار
                this.showClubLogoPreview(input, type, { englishName, arabicName, logoUrl });

                // تعيين التحقق
                this.setInputValidation(input, 'verified');

                // إشعار المستخدم
                this.showNotification(`✅ تم اختيار ${displayName}`, 'success');

                console.log(`🎯 Club selected: ${englishName} (${arabicName})`);
            }

            // تحسين دالة showClubSuggestions لتشمل المفضلة والحديثة
            showClubSuggestions(input, type, suggestions = null) {
                const containerId = type === 'current' ? 'currentClubSuggestions' :
                                 type === 'target' ? 'targetClubSuggestions' :
                                 type === 'savedTarget' ? 'savedTargetClubSuggestions' :
                                 type === 'multiTarget' ? 'multiTargetClubSuggestions' :
                                 type === 'extractTarget' ? 'extractTargetClubSuggestions' : null;

                const container = document.getElementById(containerId);
                if (!container) return;

                if (!suggestions) {
                    const query = input.value.trim();
                    if (query.length < 2) {
                        // عرض المفضلة والحديثة عند عدم وجود استعلام
                        suggestions = this.getFavoriteAndRecentSuggestions();
                    } else {
                        suggestions = this.searchClubs(query);
                    }
                }

                if (suggestions.length === 0) {
                    container.classList.remove('show');
                    return;
                }

                let html = `
                    <div class="club-suggestions-header">
                        <i class="fas fa-search"></i> ${input.value.trim().length < 2 ? 'الأندية المفضلة والحديثة' : `اقتراحات الأندية (${suggestions.length})`}
                    </div>
                `;

                suggestions.forEach(club => {
                    const logoHtml = club.logoUrl ?
                        `<img src="${club.logoUrl}" alt="${club.englishName}" class="club-suggestion-logo" onerror="this.style.display='none'">` :
                        `<div class="club-suggestion-logo" style="background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">${club.englishName.charAt(0)}</div>`;

                    const isFavorite = this.favoriteClubs.includes(club.arabicName || club.englishName);
                    const isRecent = this.recentClubs.includes(club.arabicName || club.englishName);

                    const badges = [];
                    if (isFavorite) badges.push('<span style="color: #fbbf24;">⭐</span>');
                    if (isRecent) badges.push('<span style="color: #10b981;">🕒</span>');

                    html += `
                        <div class="club-suggestion-item" onclick="ultimateStudio.selectClub('${input.id}', '${type}', '${club.englishName}', '${club.arabicName}', '${club.logoUrl || ''}')">
                            ${logoHtml}
                            <div class="club-suggestion-info">
                                <div class="club-suggestion-name">${club.arabicName || club.englishName} ${badges.join(' ')}</div>
                                <div class="club-suggestion-details">${club.englishName} • ${club.league} • ${club.country}</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="club-suggestions-footer">
                        اضغط على النادي لاختياره • ⭐ مفضل • 🕒 حديث
                    </div>
                `;

                container.innerHTML = html;
                container.classList.add('show');
            }

            getFavoriteAndRecentSuggestions() {
                const suggestions = [];

                // إضافة الأندية المفضلة
                this.favoriteClubs.forEach(clubName => {
                    const club = this.findClubByName(clubName);
                    if (club) suggestions.push(club);
                });

                // إضافة الأندية الحديثة
                this.recentClubs.forEach(clubName => {
                    const club = this.findClubByName(clubName);
                    if (club && !suggestions.find(s => s.englishName === club.englishName)) {
                        suggestions.push(club);
                    }
                });

                return suggestions.slice(0, 8);
            }

            findClubByName(clubName) {
                return this.clubsDatabase.find(club =>
                    club.englishName === clubName ||
                    club.arabicName === clubName
                );
            }

            // 🎯 MULTI-PLAYER CLUB INPUT SYSTEM
            handleMultiClubInput(input, type) {
                const query = input.value.trim();

                if (query.length < 2) {
                    this.hideMultiClubSuggestions(input, type);
                    this.hideMultiClubLogoPreview(input, type);
                    this.removeInputValidation(input);
                    return;
                }

                // البحث عن الاقتراحات
                const suggestions = this.searchClubs(query);

                if (suggestions.length > 0) {
                    this.showMultiClubSuggestions(input, type, suggestions);

                    // إذا كان هناك تطابق تام، عرض الشعار
                    const exactMatch = suggestions.find(club =>
                        club.englishName.toLowerCase() === query.toLowerCase() ||
                        club.arabicName.toLowerCase() === query.toLowerCase()
                    );

                    if (exactMatch) {
                        this.showMultiClubLogoPreview(input, type, exactMatch);
                        this.setInputValidation(input, 'verified');
                    } else {
                        this.hideMultiClubLogoPreview(input, type);
                        this.setInputValidation(input, 'partial');
                    }
                } else {
                    this.hideMultiClubSuggestions(input, type);
                    this.hideMultiClubLogoPreview(input, type);
                    this.setInputValidation(input, 'error');
                }
            }

            showMultiClubSuggestions(input, type, suggestions = null) {
                const container = input.parentElement.querySelector('.multi-club-suggestions');
                if (!container) return;

                if (!suggestions) {
                    const query = input.value.trim();
                    if (query.length < 2) {
                        // عرض المفضلة والحديثة عند عدم وجود استعلام
                        suggestions = this.getFavoriteAndRecentSuggestions();
                    } else {
                        suggestions = this.searchClubs(query);
                    }
                }

                if (suggestions.length === 0) {
                    container.classList.remove('show');
                    return;
                }

                let html = `
                    <div class="club-suggestions-header">
                        <i class="fas fa-search"></i> ${input.value.trim().length < 2 ? 'الأندية المفضلة والحديثة' : `اقتراحات الأندية (${suggestions.length})`}
                    </div>
                `;

                suggestions.forEach(club => {
                    const logoHtml = club.logoUrl ?
                        `<img src="${club.logoUrl}" alt="${club.englishName}" class="club-suggestion-logo" onerror="this.style.display='none'">` :
                        `<div class="club-suggestion-logo" style="background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">${club.englishName.charAt(0)}</div>`;

                    const isFavorite = this.favoriteClubs.includes(club.arabicName || club.englishName);
                    const isRecent = this.recentClubs.includes(club.arabicName || club.englishName);

                    const badges = [];
                    if (isFavorite) badges.push('<span style="color: #fbbf24;">⭐</span>');
                    if (isRecent) badges.push('<span style="color: #10b981;">🕒</span>');

                    html += `
                        <div class="club-suggestion-item" onclick="ultimateStudio.selectMultiClub('${input.className}', '${type}', '${club.englishName}', '${club.arabicName}', '${club.logoUrl || ''}', this)">
                            ${logoHtml}
                            <div class="club-suggestion-info">
                                <div class="club-suggestion-name">${club.arabicName || club.englishName} ${badges.join(' ')}</div>
                                <div class="club-suggestion-details">${club.englishName} • ${club.league} • ${club.country}</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="club-suggestions-footer">
                        اضغط على النادي لاختياره • ⭐ مفضل • 🕒 حديث
                    </div>
                `;

                container.innerHTML = html;
                container.classList.add('show');
            }

            hideMultiClubSuggestions(input, type) {
                setTimeout(() => {
                    const container = input.parentElement.querySelector('.multi-club-suggestions');
                    if (container) {
                        container.classList.remove('show');
                    }
                }, 200);
            }

            selectMultiClub(inputClass, type, englishName, arabicName, logoUrl, element) {
                const input = element.closest('.ultimate-input-group').querySelector('input');
                if (!input) return;

                const displayName = arabicName || englishName;

                // تعيين القيمة
                input.value = displayName;

                // إضافة للتاريخ
                this.addToRecentClubs(displayName);

                // إخفاء الاقتراحات
                this.hideMultiClubSuggestions(input, type);

                // عرض الشعار
                this.showMultiClubLogoPreview(input, type, { englishName, arabicName, logoUrl });

                // تعيين التحقق
                this.setInputValidation(input, 'verified');

                // إشعار المستخدم
                this.showNotification(`✅ تم اختيار ${displayName}`, 'success');

                console.log(`🎯 Multi-club selected: ${englishName} (${arabicName})`);
            }

            showMultiClubLogoPreview(input, type, club) {
                const preview = input.parentElement.querySelector('.multi-club-logo-preview');

                if (!preview || !club.logoUrl) return;

                preview.innerHTML = `<img src="${club.logoUrl}" alt="${club.englishName}" onerror="this.parentElement.style.display='none'">`;
                preview.classList.add('show');
            }

            hideMultiClubLogoPreview(input, type) {
                const preview = input.parentElement.querySelector('.multi-club-logo-preview');

                if (preview) {
                    preview.classList.remove('show');
                }
            }

            // دوال إدارة الأندية المفضلة والحديثة
            showFavoriteClubs() {
                if (this.favoriteClubs.length === 0) {
                    alert('📝 لا توجد أندية مفضلة حالياً\n\nيمكنك إضافة الأندية للمفضلة عند البحث عنها.');
                    return;
                }

                const message = `⭐ الأندية المفضلة (${this.favoriteClubs.length}):\n\n` +
                              this.favoriteClubs.map((club, index) => `${index + 1}. ${club}`).join('\n') +
                              '\n\nيمكنك رؤية هذه الأندية في أعلى قائمة الاقتراحات عند البحث.';

                alert(message);
            }

            showRecentClubs() {
                if (this.recentClubs.length === 0) {
                    alert('📝 لا توجد أندية مستخدمة مؤخراً\n\nستظهر الأندية هنا بعد استخدامها في التصاميم.');
                    return;
                }

                const message = `🕒 الأندية المستخدمة مؤخراً (${this.recentClubs.length}):\n\n` +
                              this.recentClubs.map((club, index) => `${index + 1}. ${club}`).join('\n') +
                              '\n\nيتم حفظ آخر 10 أندية تم استخدامها.';

                alert(message);
            }

            clearRecentClubs() {
                if (this.recentClubs.length === 0) {
                    this.showNotification('📝 لا توجد أندية حديثة لمسحها', 'info');
                    return;
                }

                const confirmed = confirm(`🗑️ هل تريد مسح قائمة الأندية الحديثة؟\n\nسيتم مسح ${this.recentClubs.length} نادي من القائمة.`);

                if (confirmed) {
                    this.recentClubs = [];
                    localStorage.removeItem('ultimateStudio_recentClubs');
                    this.showNotification('✅ تم مسح قائمة الأندية الحديثة', 'success');
                }
            }

            // دالة لإضافة نادي للمفضلة من خلال الواجهة
            promptAddFavoriteClub() {
                const clubName = prompt('⭐ أدخل اسم النادي لإضافته للمفضلة:');

                if (clubName && clubName.trim()) {
                    const trimmedName = clubName.trim();

                    // البحث عن النادي في قاعدة البيانات
                    const club = this.findClubByName(trimmedName);

                    if (club) {
                        this.addToFavoriteClubs(club.arabicName || club.englishName);
                    } else {
                        // إضافة النادي حتى لو لم يكن في قاعدة البيانات
                        this.addToFavoriteClubs(trimmedName);
                    }
                }
            }

            // دالة لإزالة نادي من المفضلة
            promptRemoveFavoriteClub() {
                if (this.favoriteClubs.length === 0) {
                    this.showNotification('📝 لا توجد أندية مفضلة لإزالتها', 'info');
                    return;
                }

                const clubsList = this.favoriteClubs.map((club, index) => `${index + 1}. ${club}`).join('\n');
                const clubName = prompt(`❌ اختر النادي لإزالته من المفضلة:\n\n${clubsList}\n\nأدخل اسم النادي:`);

                if (clubName && clubName.trim()) {
                    const trimmedName = clubName.trim();

                    if (this.favoriteClubs.includes(trimmedName)) {
                        this.removeFromFavoriteClubs(trimmedName);
                    } else {
                        this.showNotification('❌ النادي غير موجود في المفضلة', 'error');
                    }
                }
            }

            // 🎬 AUTO SEND TO STREAM SYSTEM
            autoSendToStream() {
                try {
                    console.log('🎬 Auto-sending to stream...');

                    // التحقق من وجود البيانات
                    if (!this.currentPlayer) {
                        console.warn('⚠️ No current player data for auto-send');
                        return;
                    }

                    // التحقق من تفعيل البث التلقائي
                    const autoSendEnabled = document.getElementById('autoSendToDirectStream')?.checked;
                    const streamActive = window.directStreamActive || localStorage.getItem('directStreamActive') === 'true';

                    if (!autoSendEnabled && !streamActive) {
                        console.log('📺 Auto-send disabled or stream not active');
                        return;
                    }

                    // الحصول على محتوى البطاقة الحالية
                    const previewContent = document.getElementById('previewContent');
                    if (!previewContent || !previewContent.innerHTML.trim()) {
                        console.warn('⚠️ No preview content to send');
                        return;
                    }

                    // تحضير البيانات للإرسال
                    const streamData = {
                        content: previewContent.innerHTML,
                        player: this.currentPlayer,
                        timestamp: Date.now(),
                        autoSent: true,
                        settings: {
                            playerImageSize: this.settings.playerImageSize || 150,
                            clubLogoSize: this.settings.clubLogoSize || 32,
                            cardTransition: this.settings.cardTransition || 'fadeIn'
                        }
                    };

                    // إرسال للبث المباشر
                    if (typeof window.sendToDirectStream === 'function') {
                        window.sendToDirectStream();
                        console.log('✅ Auto-sent to direct stream');
                    }

                    // إرسال للبث الجديد
                    if (typeof window.showPlayerInNewStream === 'function') {
                        window.showPlayerInNewStream(this.currentPlayer);
                        console.log('✅ Auto-sent to new stream');
                    }

                    // حفظ البيانات في localStorage للمزامنة
                    localStorage.setItem('directStreamContent', JSON.stringify(streamData));
                    localStorage.setItem('directStreamContentChanged', Date.now().toString());
                    localStorage.setItem('currentPlayer', JSON.stringify(this.currentPlayer));
                    localStorage.setItem('playerChanged', Date.now().toString());

                    // 🚀 INSTANT NOTIFICATION SYSTEM - إشعارات فورية
                    this.notifyStreamInstantly(streamData);

                    // إشعار المستخدم
                    this.showNotification('🎬 تم الإرسال التلقائي للبث المباشر', 'success');

                    console.log('🎬 Auto-send completed successfully');

                } catch (error) {
                    console.error('❌ Error in auto-send to stream:', error);
                    this.showNotification('❌ خطأ في الإرسال التلقائي للبث', 'error');
                }
            }

            // 🚀 INSTANT STREAM NOTIFICATION SYSTEM
            notifyStreamInstantly(streamData) {
                try {
                    console.log('🚀 Sending instant notifications to stream...');

                    // 1. Custom Event Dispatch
                    window.dispatchEvent(new CustomEvent('directStreamUpdate', {
                        detail: {
                            type: 'PLAYER_CREATED',
                            data: streamData,
                            timestamp: Date.now(),
                            source: 'pro-studio-v4'
                        }
                    }));

                    // 2. Broadcast Channel (cross-tab communication)
                    if (typeof BroadcastChannel !== 'undefined') {
                        const streamChannel = new BroadcastChannel('stream-updates');
                        streamChannel.postMessage({
                            type: 'PLAYER_CREATED',
                            data: streamData,
                            timestamp: Date.now(),
                            source: 'pro-studio-v4'
                        });
                        streamChannel.close();
                    }

                    // 3. PostMessage to all windows (including stream-clean)
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'STREAM_UPDATE',
                            data: streamData,
                            timestamp: Date.now()
                        }, '*');
                    }

                    // 4. Try to directly notify stream-clean if it's open
                    try {
                        const streamWindows = [];
                        // Check if stream-clean is in another tab
                        if (typeof window.streamCleanWindow !== 'undefined' && window.streamCleanWindow) {
                            streamWindows.push(window.streamCleanWindow);
                        }

                        streamWindows.forEach(streamWindow => {
                            try {
                                streamWindow.postMessage({
                                    type: 'STREAM_UPDATE',
                                    data: streamData,
                                    timestamp: Date.now()
                                }, '*');
                            } catch (e) {
                                console.warn('Could not message stream window:', e);
                            }
                        });
                    } catch (e) {
                        console.warn('Could not access stream windows:', e);
                    }

                    // 5. Force localStorage events by updating multiple keys
                    const forceKeys = [
                        'directStreamForceUpdate',
                        'streamInstantNotification',
                        'playerInstantUpdate'
                    ];

                    forceKeys.forEach(key => {
                        localStorage.setItem(key, Date.now().toString());
                        // Remove after a short delay to trigger change events
                        setTimeout(() => {
                            localStorage.removeItem(key);
                        }, 100);
                    });

                    // 6. Simple localStorage updates
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            localStorage.setItem('directStreamContentChanged', Date.now().toString());
                        }, i * 50);
                    }

                    console.log('✅ Instant notifications sent successfully');

                } catch (error) {
                    console.error('❌ Error sending instant notifications:', error);
                }
            }

            initializeSettings() {
                // Load and apply saved settings
                Object.keys(this.settings).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = this.settings[key];
                    }
                });

                // Apply image size setting
                if (this.settings.playerImageSize) {
                    const imageSizeSlider = document.getElementById('playerImageSize');
                    const imageSizeValue = document.getElementById('imageSizeValue');
                    if (imageSizeSlider) {
                        imageSizeSlider.value = this.settings.playerImageSize;
                    }
                    if (imageSizeValue) {
                        imageSizeValue.textContent = this.settings.playerImageSize;
                    }
                }

                // Apply club logo size setting
                if (this.settings.clubLogoSize) {
                    const logoSizeSlider = document.getElementById('clubLogoSize');
                    const logoSizeValue = document.getElementById('logoSizeValue');
                    if (logoSizeSlider) {
                        logoSizeSlider.value = this.settings.clubLogoSize;
                    }
                    if (logoSizeValue) {
                        logoSizeValue.textContent = this.settings.clubLogoSize;
                    }
                }

                // Apply target club logo size setting
                if (this.settings.targetClubLogoSize) {
                    const targetLogoSizeSlider = document.getElementById('targetClubLogoSize');
                    const targetLogoSizeValue = document.getElementById('targetLogoSizeValue');
                    if (targetLogoSizeSlider) {
                        targetLogoSizeSlider.value = this.settings.targetClubLogoSize;
                    }
                    if (targetLogoSizeValue) {
                        targetLogoSizeValue.textContent = this.settings.targetClubLogoSize;
                    }
                }

                // Apply target club logo large size setting
                if (this.settings.targetClubLogoLargeSize) {
                    const targetLogoLargeSizeSlider = document.getElementById('targetClubLogoLargeSize');
                    const targetLogoLargeSizeValue = document.getElementById('targetLogoLargeSizeValue');
                    if (targetLogoLargeSizeSlider) {
                        targetLogoLargeSizeSlider.value = this.settings.targetClubLogoLargeSize;
                    }
                    if (targetLogoLargeSizeValue) {
                        targetLogoLargeSizeValue.textContent = this.settings.targetClubLogoLargeSize;
                    }
                }

                // Apply card transition settings
                if (this.settings.cardTransition) {
                    const cardTransitionSelect = document.getElementById('cardTransition');
                    if (cardTransitionSelect) {
                        cardTransitionSelect.value = this.settings.cardTransition;
                    }
                }

                if (this.settings.transitionDuration) {
                    const transitionDurationSlider = document.getElementById('transitionDuration');
                    const transitionDurationValue = document.getElementById('transitionDurationValue');
                    if (transitionDurationSlider) {
                        transitionDurationSlider.value = this.settings.transitionDuration;
                    }
                    if (transitionDurationValue) {
                        transitionDurationValue.textContent = this.settings.transitionDuration;
                    }
                }

                // Apply LM Studio URL setting
                if (this.settings.lmStudioURL) {
                    const lmStudioURLInput = document.getElementById('lmStudioURL');
                    if (lmStudioURLInput) {
                        lmStudioURLInput.value = this.settings.lmStudioURL;
                    }
                }

                this.applySettings();

                // Apply default background theme
                const defaultTheme = this.settings.visualTheme || 'cosmic';
                this.changeTheme(defaultTheme);

                // Auto-enable direct stream checkbox for better UX
                const autoSendCheckbox = document.getElementById('autoSendToDirectStream');
                if (autoSendCheckbox && !autoSendCheckbox.checked) {
                    autoSendCheckbox.checked = true;
                    console.log('✅ Auto-enabled direct stream checkbox for better UX');
                }

                console.log('⚙️ Settings initialized');
            }

            // 🏆 Initialize Club Database with Arabic-English mapping
            initializeClubDatabase() {
                return {
                    // 🇪🇸 La Liga (Primera Division - PD)
                    'ريال مدريد': { english: 'Real Madrid CF', league: 'PD', id: 86 },
                    'برشلونة': { english: 'FC Barcelona', league: 'PD', id: 81 },
                    'أتلتيكو مدريد': { english: 'Club Atlético de Madrid', league: 'PD', id: 78 },
                    'إشبيلية': { english: 'Sevilla FC', league: 'PD', id: 559 },
                    'فالنسيا': { english: 'Valencia CF', league: 'PD', id: 95 },
                    'فياريال': { english: 'Villarreal CF', league: 'PD', id: 94 },
                    'ريال بيتيس': { english: 'Real Betis Balompié', league: 'PD', id: 90 },
                    'ريال سوسيداد': { english: 'Real Sociedad de Fútbol', league: 'PD', id: 92 },

                    // 🏴󠁧󠁢󠁥󠁮󠁧󠁿 Premier League (PL)
                    'مانشستر سيتي': { english: 'Manchester City FC', league: 'PL', id: 65 },
                    'مانشستر يونايتد': { english: 'Manchester United FC', league: 'PL', id: 66 },
                    'ليفربول': { english: 'Liverpool FC', league: 'PL', id: 64 },
                    'تشيلسي': { english: 'Chelsea FC', league: 'PL', id: 61 },
                    'أرسنال': { english: 'Arsenal FC', league: 'PL', id: 57 },
                    'توتنهام': { english: 'Tottenham Hotspur FC', league: 'PL', id: 73 },
                    'نيوكاسل': { english: 'Newcastle United FC', league: 'PL', id: 67 },
                    'أستون فيلا': { english: 'Aston Villa FC', league: 'PL', id: 58 },
                    'ويست هام': { english: 'West Ham United FC', league: 'PL', id: 563 },
                    'برايتون': { english: 'Brighton & Hove Albion FC', league: 'PL', id: 397 },

                    // 🇮🇹 Serie A (SA)
                    'يوفنتوس': { english: 'Juventus FC', league: 'SA', id: 109 },
                    'ميلان': { english: 'AC Milan', league: 'SA', id: 98 },
                    'إنتر ميلان': { english: 'FC Internazionale Milano', league: 'SA', id: 108 },
                    'نابولي': { english: 'SSC Napoli', league: 'SA', id: 113 },
                    'روما': { english: 'AS Roma', league: 'SA', id: 100 },
                    'لاتسيو': { english: 'SS Lazio', league: 'SA', id: 110 },
                    'أتالانتا': { english: 'Atalanta BC', league: 'SA', id: 102 },
                    'فيورنتينا': { english: 'ACF Fiorentina', league: 'SA', id: 99 },

                    // 🇩🇪 Bundesliga (BL1)
                    'بايرن ميونخ': { english: 'FC Bayern München', league: 'BL1', id: 5 },
                    'بوروسيا دورتموند': { english: 'Borussia Dortmund', league: 'BL1', id: 4 },
                    'لايبزيغ': { english: 'RB Leipzig', league: 'BL1', id: 721 },
                    'باير ليفركوزن': { english: 'Bayer 04 Leverkusen', league: 'BL1', id: 3 },
                    'فرانكفورت': { english: 'Eintracht Frankfurt', league: 'BL1', id: 19 },
                    'بوروسيا مونشنغلادباخ': { english: 'Borussia Mönchengladbach', league: 'BL1', id: 18 },

                    // 🇫🇷 Ligue 1 (FL1)
                    'باريس سان جيرمان': { english: 'Paris Saint-Germain FC', league: 'FL1', id: 524 },
                    'مارسيليا': { english: 'Olympique de Marseille', league: 'FL1', id: 516 },
                    'ليون': { english: 'Olympique Lyonnais', league: 'FL1', id: 523 },
                    'موناكو': { english: 'AS Monaco FC', league: 'FL1', id: 548 },
                    'نيس': { english: 'OGC Nice', league: 'FL1', id: 522 },
                    'رين': { english: 'Stade Rennais FC', league: 'FL1', id: 529 },

                    // 🇳🇱 Eredivisie (DED)
                    'أياكس': { english: 'AFC Ajax', league: 'DED', id: 678 },
                    'بي إس في': { english: 'PSV', league: 'DED', id: 674 },
                    'فينورد': { english: 'Feyenoord Rotterdam', league: 'DED', id: 675 },

                    // 🇵🇹 Primeira Liga (PPL)
                    'بورتو': { english: 'FC Porto', league: 'PPL', id: 503 },
                    'بنفيكا': { english: 'SL Benfica', league: 'PPL', id: 1903 },
                    'سبورتينغ لشبونة': { english: 'Sporting Clube de Portugal', league: 'PPL', id: 498 },

                    // 🇧🇷 Brasileirão (BSA)
                    'فلامنغو': { english: 'CR Flamengo', league: 'BSA', id: 1776 },
                    'بالميراس': { english: 'SE Palmeiras', league: 'BSA', id: 1777 },
                    'كورينثيانس': { english: 'SC Corinthians Paulista', league: 'BSA', id: 1778 },
                    'ساو باولو': { english: 'São Paulo FC', league: 'BSA', id: 1779 },

                    // 🇸🇦 Saudi Pro League
                    'الهلال': { english: 'Al-Hilal SFC', league: 'SPL', id: null },
                    'النصر': { english: 'Al-Nassr FC', league: 'SPL', id: null },
                    'الاتحاد': { english: 'Al-Ittihad Club', league: 'SPL', id: null },
                    'الأهلي': { english: 'Al-Ahli Saudi FC', league: 'SPL', id: null },
                    'الشباب': { english: 'Al-Shabab FC', league: 'SPL', id: null },
                    'الفيصلي': { english: 'Al-Faisaly FC', league: 'SPL', id: null },
                    'التعاون': { english: 'Al-Taawoun FC', league: 'SPL', id: null },
                    'الفتح': { english: 'Al-Fateh SC', league: 'SPL', id: null }
                };
            }

            // 🏆 Initialize League Database
            initializeLeagueDatabase() {
                return {
                    'WC': { name: 'FIFA World Cup', country: 'International' },
                    'CL': { name: 'UEFA Champions League', country: 'Europe' },
                    'BL1': { name: 'Bundesliga', country: 'Germany' },
                    'DED': { name: 'Eredivisie', country: 'Netherlands' },
                    'BSA': { name: 'Campeonato Brasileiro Série A', country: 'Brazil' },
                    'PD': { name: 'Primera Division', country: 'Spain' },
                    'FL1': { name: 'Ligue 1', country: 'France' },
                    'ELC': { name: 'Championship', country: 'England' },
                    'PPL': { name: 'Primeira Liga', country: 'Portugal' },
                    'EC': { name: 'European Championship', country: 'Europe' },
                    'SA': { name: 'Serie A', country: 'Italy' },
                    'PL': { name: 'Premier League', country: 'England' },
                    'SPL': { name: 'Saudi Pro League', country: 'Saudi Arabia' }
                };
            }

            // 🏆 Enhanced Club Logo Service with Real-time Integration
            async getClubLogo(clubName) {
                try {
                    console.log(`🔍 Getting club logo with real-time integration: "${clubName}"`);

                    if (!clubName || clubName.trim() === '') {
                        console.warn('⚠️ Empty club name provided');
                        return null;
                    }

                    // First, try the integrated club logo service (real-time sync with verified extractor)
                    if (window.clubLogoIntegration) {
                        console.log(`🔗 Using integrated club logo service for: "${clubName}"`);
                        const integrationResult = await window.clubLogoIntegration.searchClubLogo(clubName);

                        if (integrationResult && integrationResult.logoUrl) {
                            console.log(`✅ Integration service found logo: ${integrationResult.logoUrl} (${integrationResult.source})`);
                            return integrationResult.logoUrl;
                        }
                    }

                    // Fallback: Use intelligent search to normalize the club name
                    const searchResult = await this.intelligentClubSearch(clubName);
                    let searchClubName = clubName.trim();

                    if (searchResult) {
                        // Use the standardized name for better logo matching
                        searchClubName = searchResult.arabicName || searchResult.englishName || clubName.trim();
                        console.log(`🧠 Intelligent search result: "${clubName}" → "${searchClubName}"`);
                    }

                    // Try the unified club logo service with the normalized name
                    const response = await fetch(`/api/get-club-logo?clubName=${encodeURIComponent(searchClubName)}`);

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data.logoUrl) {
                            console.log(`✅ Unified service logo loaded: ${data.data.logoUrl}`);
                            return data.data.logoUrl;
                        }
                    }

                    // If unified service fails, try with original name
                    if (searchClubName !== clubName.trim()) {
                        console.log(`🔄 Trying with original name: "${clubName}"`);
                        const fallbackResponse = await fetch(`/api/get-club-logo?clubName=${encodeURIComponent(clubName.trim())}`);

                        if (fallbackResponse.ok) {
                            const fallbackResult = await fallbackResponse.json();
                            if (fallbackResult.success && fallbackResult.data.logoUrl) {
                                console.log(`✅ Logo found with original name: ${fallbackResult.data.logoUrl}`);
                                return fallbackResult.data.logoUrl;
                            }
                        }
                    }

                    console.warn(`❌ All logo services failed for: "${clubName}"`);
                    return null;

                } catch (error) {
                    console.error('🚨 Error fetching club logo:', error);
                    return null;
                }
            }

            // 🧠 Intelligent Club Search System
            async intelligentClubSearch(clubName) {
                try {
                    if (!clubName || clubName.trim() === '') return null;

                    const normalizedQuery = this.normalizeClubName(clubName);

                    // Try exact match first
                    const exactMatch = this.findExactClubMatch(normalizedQuery);
                    if (exactMatch) return exactMatch;

                    // Try variation match
                    const variationMatch = this.findClubVariationMatch(normalizedQuery);
                    if (variationMatch) return variationMatch;

                    // Try partial match
                    const partialMatch = this.findPartialClubMatch(normalizedQuery);
                    if (partialMatch) return partialMatch;

                    // Try fuzzy match
                    const fuzzyMatch = this.findFuzzyClubMatch(normalizedQuery);
                    if (fuzzyMatch) return fuzzyMatch;

                    return null;
                } catch (error) {
                    console.error('🚨 Error in intelligent club search:', error);
                    return null;
                }
            }

            // Normalize club name for comparison
            normalizeClubName(name) {
                if (!name) return '';

                return name.toLowerCase()
                    .replace(/[أإآ]/g, 'ا')
                    .replace(/[ة]/g, 'ه')
                    .replace(/[ي]/g, 'ى')
                    .replace(/fc|cf|ac|sc|club|football|soccer/gi, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            // Find exact club match
            findExactClubMatch(normalizedQuery) {
                const clubMappings = this.getClubMappings();

                for (const [arabic, english] of clubMappings) {
                    if (this.normalizeClubName(arabic) === normalizedQuery ||
                        this.normalizeClubName(english) === normalizedQuery) {
                        return {
                            arabicName: arabic,
                            englishName: english,
                            matchType: 'exact'
                        };
                    }
                }
                return null;
            }

            // Find club variation match
            findClubVariationMatch(normalizedQuery) {
                const variations = this.getClubVariations();

                for (const [mainName, varList] of Object.entries(variations)) {
                    for (const variation of varList) {
                        if (this.normalizeClubName(variation) === normalizedQuery) {
                            const clubMappings = this.getClubMappings();
                            const mapping = clubMappings.find(([ar, en]) => ar === mainName || en === mainName);

                            if (mapping) {
                                return {
                                    arabicName: this.isArabic(mapping[0]) ? mapping[0] : mapping[1],
                                    englishName: this.isArabic(mapping[0]) ? mapping[1] : mapping[0],
                                    matchType: 'variation'
                                };
                            }
                        }
                    }
                }
                return null;
            }

            // Find partial club match
            findPartialClubMatch(normalizedQuery) {
                const clubMappings = this.getClubMappings();

                for (const [arabic, english] of clubMappings) {
                    const normalizedArabic = this.normalizeClubName(arabic);
                    const normalizedEnglish = this.normalizeClubName(english);

                    if (normalizedArabic.includes(normalizedQuery) ||
                        normalizedQuery.includes(normalizedArabic) ||
                        normalizedEnglish.includes(normalizedQuery) ||
                        normalizedQuery.includes(normalizedEnglish)) {
                        return {
                            arabicName: arabic,
                            englishName: english,
                            matchType: 'partial'
                        };
                    }
                }
                return null;
            }

            // Find fuzzy club match using simple distance
            findFuzzyClubMatch(normalizedQuery) {
                const clubMappings = this.getClubMappings();
                let bestMatch = null;
                let bestDistance = Infinity;
                const threshold = 2;

                for (const [arabic, english] of clubMappings) {
                    const arabicDistance = this.simpleDistance(normalizedQuery, this.normalizeClubName(arabic));
                    const englishDistance = this.simpleDistance(normalizedQuery, this.normalizeClubName(english));

                    const minDistance = Math.min(arabicDistance, englishDistance);

                    if (minDistance <= threshold && minDistance < bestDistance) {
                        bestDistance = minDistance;
                        bestMatch = {
                            arabicName: arabic,
                            englishName: english,
                            matchType: 'fuzzy',
                            distance: minDistance
                        };
                    }
                }

                return bestMatch;
            }

            // Simple distance calculation
            simpleDistance(str1, str2) {
                if (str1.length === 0) return str2.length;
                if (str2.length === 0) return str1.length;

                const matrix = [];
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }

                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                return matrix[str2.length][str1.length];
            }

            // Check if text is Arabic
            isArabic(text) {
                const arabicRegex = /[\u0600-\u06FF]/;
                return arabicRegex.test(text);
            }

            // Get club mappings
            getClubMappings() {
                return [
                    ['ريال مدريد', 'Real Madrid'],
                    ['برشلونة', 'Barcelona'],
                    ['مانشستر سيتي', 'Manchester City'],
                    ['مانشستر يونايتد', 'Manchester United'],
                    ['ليفربول', 'Liverpool'],
                    ['تشيلسي', 'Chelsea'],
                    ['أرسنال', 'Arsenal'],
                    ['باريس سان جيرمان', 'Paris Saint-Germain'],
                    ['بايرن ميونخ', 'Bayern Munich'],
                    ['يوفنتوس', 'Juventus'],
                    ['الهلال', 'Al Hilal'],
                    ['النصر', 'Al Nassr'],
                    ['أتلتيكو مدريد', 'Atletico Madrid'],
                    ['إنتر ميلان', 'Inter Milan'],
                    ['ميلان', 'AC Milan'],
                    ['نابولي', 'Napoli'],
                    ['بوروسيا دورتموند', 'Borussia Dortmund'],
                    ['الاتحاد', 'Al Ittihad'],
                    ['الأهلي', 'Al Ahli'],
                    ['توتنهام', 'Tottenham'],
                    ['فالنسيا', 'Valencia'],
                    ['إشبيلية', 'Sevilla'],
                    ['فياريال', 'Villarreal'],
                    ['نيوكاسل', 'Newcastle'],
                    ['أستون فيلا', 'Aston Villa'],
                    ['روما', 'AS Roma'],
                    ['لاتسيو', 'Lazio'],
                    ['أتالانتا', 'Atalanta'],
                    ['فيورنتينا', 'Fiorentina'],
                    ['لايبزيغ', 'RB Leipzig'],
                    ['باير ليفركوزن', 'Bayer Leverkusen'],
                    ['فرانكفورت', 'Eintracht Frankfurt'],
                    ['مارسيليا', 'Marseille'],
                    ['ليون', 'Lyon'],
                    ['موناكو', 'Monaco'],
                    ['نيس', 'Nice'],
                    ['أياكس', 'Ajax'],
                    ['بورتو', 'Porto'],
                    ['بنفيكا', 'Benfica'],
                    ['سبورتينغ لشبونة', 'Sporting CP']
                ];
            }

            // Get club variations
            getClubVariations() {
                return {
                    'ريال مدريد': ['ريال', 'ريال مدريد', 'الريال', 'ريال مدريد الاسباني', 'Real Madrid', 'Real', 'Madrid'],
                    'برشلونة': ['برشلونة', 'برشلونا', 'برشلونه', 'البارسا', 'بارسا', 'برشا', 'Barcelona', 'Barca', 'FC Barcelona'],
                    'مانشستر سيتي': ['مانشستر سيتي', 'مانشستر سيتى', 'مان سيتي', 'السيتي', 'سيتي', 'Manchester City', 'Man City', 'City'],
                    'مانشستر يونايتد': ['مانشستر يونايتد', 'مانشستر يونايتيد', 'مان يونايتد', 'اليونايتد', 'يونايتد', 'Manchester United', 'Man United', 'United'],
                    'ليفربول': ['ليفربول', 'ليفربوول', 'الليفر', 'الريدز', 'Liverpool', 'LFC', 'Reds'],
                    'تشيلسي': ['تشيلسي', 'تشيلسى', 'تشلسي', 'البلوز', 'Chelsea', 'CFC', 'Blues'],
                    'أرسنال': ['أرسنال', 'ارسنال', 'الارسنال', 'الجانرز', 'Arsenal', 'AFC', 'Gunners'],
                    'باريس سان جيرمان': ['باريس سان جيرمان', 'باريس', 'بي اس جي', 'PSG', 'باريس سان جرمان', 'Paris Saint-Germain', 'Paris'],
                    'بايرن ميونخ': ['بايرن ميونخ', 'بايرن', 'البايرن', 'بايرن ميونيخ', 'Bayern Munich', 'Bayern', 'FC Bayern'],
                    'يوفنتوس': ['يوفنتوس', 'يوفي', 'اليوفي', 'السيدة العجوز', 'Juventus', 'Juve', 'Juventus FC'],
                    'الهلال': ['الهلال', 'هلال', 'الزعيم', 'الهلال السعودي', 'Al Hilal', 'Al-Hilal', 'Hilal'],
                    'النصر': ['النصر', 'نصر', 'العالمي', 'النصر السعودي', 'Al Nassr', 'Al-Nassr', 'Nassr'],
                    'الاتحاد': ['الاتحاد', 'اتحاد', 'الاتحاد السعودي', 'Al Ittihad', 'Al-Ittihad', 'Ittihad'],
                    'الأهلي': ['الأهلي', 'أهلي', 'الأهلي السعودي', 'Al Ahli', 'Al-Ahli', 'Ahli'],
                    'أتلتيكو مدريد': ['أتلتيكو مدريد', 'اتلتيكو', 'أتلتيكو', 'Atletico Madrid', 'Atletico', 'Atleti'],
                    'إنتر ميلان': ['إنتر ميلان', 'انتر ميلان', 'انتر', 'إنتر', 'Inter Milan', 'Inter', 'Internazionale'],
                    'ميلان': ['ميلان', 'AC Milan', 'Milan', 'AC ميلان'],
                    'نابولي': ['نابولي', 'Napoli', 'SSC Napoli'],
                    'بوروسيا دورتموند': ['بوروسيا دورتموند', 'دورتموند', 'بورتموند', 'Borussia Dortmund', 'Dortmund', 'BVB'],
                    'توتنهام': ['توتنهام', 'توتنام', 'Tottenham', 'Spurs', 'THFC']
                };
            }





            // 🔍 Smart Club Search with Advanced Matching
            findClubByName(clubName) {
                if (!clubName) return null;

                const searchTerm = clubName.trim();

                // 1. Direct exact match
                if (this.clubDatabase[searchTerm]) {
                    console.log(`🎯 Direct match found: ${searchTerm}`);
                    return this.clubDatabase[searchTerm];
                }

                // 2. Smart abbreviations and common names
                const smartMappings = {
                    'مان سيتي': 'مانشستر سيتي',
                    'مان يونايتد': 'مانشستر يونايتد',
                    'مان يو': 'مانشستر يونايتد',
                    'ليفر': 'ليفربول',
                    'برشا': 'برشلونة',
                    'ريال': 'ريال مدريد',
                    'أتلتيكو': 'أتلتيكو مدريد',
                    'بي إس جي': 'باريس سان جيرمان',
                    'باريس': 'باريس سان جيرمان',
                    'يوفي': 'يوفنتوس',
                    'بايرن': 'بايرن ميونخ',
                    'دورتموند': 'بوروسيا دورتموند',
                    'انتر': 'إنتر ميلان',
                    'ميلان': 'ميلان',
                    'نابولي': 'نابولي',
                    'روما': 'روما',
                    'لاتسيو': 'لاتسيو'
                };

                if (smartMappings[searchTerm]) {
                    const mappedName = smartMappings[searchTerm];
                    if (this.clubDatabase[mappedName]) {
                        console.log(`🧠 Smart mapping: ${searchTerm} → ${mappedName}`);
                        return this.clubDatabase[mappedName];
                    }
                }

                // 3. Partial match in Arabic names
                const clubNames = Object.keys(this.clubDatabase);
                for (const name of clubNames) {
                    if (name.includes(searchTerm) || searchTerm.includes(name)) {
                        console.log(`🔍 Partial match: ${searchTerm} → ${name}`);
                        return this.clubDatabase[name];
                    }
                }

                // 4. English name search (case insensitive)
                for (const [arabicName, clubInfo] of Object.entries(this.clubDatabase)) {
                    const englishName = clubInfo.english.toLowerCase();
                    const searchLower = searchTerm.toLowerCase();

                    if (englishName.includes(searchLower) || searchLower.includes(englishName)) {
                        console.log(`🌍 English match: ${searchTerm} → ${arabicName}`);
                        return clubInfo;
                    }
                }

                // 5. Advanced fuzzy matching
                for (const [arabicName, clubInfo] of Object.entries(this.clubDatabase)) {
                    // Check if any word in the search term matches any word in club names
                    const searchWords = searchTerm.split(' ');
                    const arabicWords = arabicName.split(' ');
                    const englishWords = clubInfo.english.toLowerCase().split(' ');

                    for (const searchWord of searchWords) {
                        for (const arabicWord of arabicWords) {
                            if (arabicWord.includes(searchWord) || searchWord.includes(arabicWord)) {
                                console.log(`🎯 Word match: ${searchWord} in ${arabicName}`);
                                return clubInfo;
                            }
                        }

                        for (const englishWord of englishWords) {
                            if (englishWord.includes(searchWord.toLowerCase()) || searchWord.toLowerCase().includes(englishWord)) {
                                console.log(`🌍 English word match: ${searchWord} in ${clubInfo.english}`);
                                return clubInfo;
                            }
                        }
                    }
                }

                console.warn(`❌ No match found for: ${searchTerm}`);
                return null;
            }

            // 🏆 Get league info
            getLeagueInfo(leagueCode) {
                return this.leagueDatabase[leagueCode] || { name: 'Unknown League', country: 'Unknown' };
            }

            // 🎯 Mode Switching with Advanced Animations
            async switchMode(mode) {
                if (this.isProcessing) return;

                console.log(`🔄 Switching to ${mode} mode`);
                this.isProcessing = true;

                // Hide all sections with stagger animation
                const sections = ['manualInputSection', 'savedPlayersSection', 'multiSection', 'extractSection', 'aiSection'];
                await this.hideAllSections(sections);

                // Show selected section with cosmic entrance
                let sectionId;
                switch(mode) {
                    case 'manual':
                        sectionId = 'manualInputSection';
                        break;
                    case 'saved':
                        sectionId = 'savedPlayersSection';
                        break;
                    case 'multi':
                        sectionId = 'multiSection';
                        break;
                    case 'extract':
                        sectionId = 'extractSection';
                        break;
                    case 'ai':
                        sectionId = 'aiSection';
                        break;
                    default:
                        sectionId = 'manualInputSection';
                }

                await this.showSection(sectionId);

                // Handle mode-specific logic
                switch(mode) {
                    case 'saved':
                        await this.loadSavedPlayers();
                        break;
                    case 'multi':
                        this.initializeMultiMode();
                        break;
                    case 'extract':
                        this.initializeExtractMode();
                        break;
                    case 'ai':
                        this.initializeAIMode();
                        break;
                    case 'manual':
                        this.initializeManualMode();
                        break;
                }

                this.isProcessing = false;
                this.showNotification(`🚀 تم التبديل إلى نمط ${this.getModeNameArabic(mode)}`, 'success');
            }

            getModeNameArabic(mode) {
                const names = {
                    'manual': 'الإدخال اليدوي',
                    'saved': 'اللاعبين المحفوظين',
                    'multi': 'اللاعبين المتعددين',
                    'extract': 'استخراج من صفحة اللاعب',
                    'ai': 'الذكاء الاصطناعي'
                };
                return names[mode] || mode;
            }

            async hideAllSections(sections) {
                const promises = sections.map((sectionId, index) => {
                    return new Promise(resolve => {
                        const section = document.getElementById(sectionId);
                        if (section && section.style.display !== 'none') {
                            setTimeout(() => {
                                section.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                                section.style.opacity = '0';
                                section.style.transform = 'translateY(30px) scale(0.9)';
                                setTimeout(() => {
                                    section.style.display = 'none';
                                    resolve();
                                }, 500);
                            }, index * 100);
                        } else {
                            resolve();
                        }
                    });
                });
                await Promise.all(promises);
            }

            async showSection(sectionId) {
                return new Promise(resolve => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = 'block';
                        section.style.opacity = '0';
                        section.style.transform = 'translateY(30px) scale(0.9)';

                        setTimeout(() => {
                            section.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                            section.style.opacity = '1';
                            section.style.transform = 'translateY(0) scale(1)';
                            setTimeout(resolve, 600);
                        }, 100);
                    } else {
                        resolve();
                    }
                });
            }

            // 🎨 Professional Visualization Creation
            async createVisualization() {
                if (this.isProcessing) {
                    this.showNotification('⚡ معالجة قيد التقدم...', 'warning');
                    return;
                }

                const formData = this.getFormData();
                const validation = this.validateInput(formData);

                if (!validation.isValid) {
                    this.showNotification(validation.message, 'error');
                    this.highlightInvalidField(validation.field);
                    return;
                }

                this.isProcessing = true;
                this.updateSystemStatus('جاري إنشاء البطاقة الاحترافية...');

                try {
                    // Clear any existing content first
                    this.clearPreviewContent();

                    // Show professional loading animation
                    this.showProfessionalLoader();

                    // Get player data with enhanced probability calculation
                    const playerData = await this.getEnhancedPlayerData(formData);

                    // Store current player for reference
                    this.currentPlayer = playerData;

                    // Create FIFA 26 style visualization ONLY
                    await this.generateFIFA26Visualization(playerData);

                    // Check auto-send to overlay
                    checkAutoSendToOverlay();

                    // Check auto-stream
                    checkAutoStreamPlayer();

                    // Check auto-send to direct stream
                    checkAutoSendToDirectStream();

                    // Check auto-send to OBS File System
                    checkAutoSendToOBSFileSystem();

                    // 🎬 AUTO SEND TO STREAM - إرسال تلقائي محسن
                    this.autoSendToStream();

                    this.showNotification(`🌟 تم إنشاء بطاقة احترافية لـ ${formData.playerName}!`, 'success');

                } catch (error) {
                    console.error('🚨 Visualization error:', error);
                    this.showNotification('❌ فشل في إنشاء التصور', 'error');
                } finally {
                    this.hideProfessionalLoader();
                    this.isProcessing = false;
                    this.updateSystemStatus('جاهز للإبداع');
                }
            }

            // Clear preview content completely
            clearPreviewContent() {
                const previewContent = document.getElementById('previewContent');
                const placeholder = document.getElementById('previewPlaceholder');

                if (previewContent) {
                    previewContent.innerHTML = '';
                }

                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            }

            // 📊 Enhanced Probability Calculation System
            calculateAdvancedProbability(playerName, currentClub, targetClub) {
                console.log(`🧮 Calculating probability: ${playerName} (${currentClub}) → ${targetClub}`);

                let baseProbability = 35;
                let factors = [];

                // Club tier analysis
                const saudiClubs = ['الهلال', 'النصر', 'الاتحاد', 'الأهلي', 'الشباب', 'الفيصلي'];
                const topEuropeanClubs = ['ريال مدريد', 'برشلونة', 'مانشستر سيتي', 'ليفربول', 'بايرن ميونخ', 'باريس سان جيرمان'];
                const bigClubs = ['مانشستر يونايتد', 'تشيلسي', 'أرسنال', 'يوفنتوس', 'ميلان', 'إنتر ميلان'];

                // Target club factor
                if (saudiClubs.includes(targetClub)) {
                    baseProbability += 30;
                    factors.push('Saudi League Attraction (+30%)');
                } else if (topEuropeanClubs.includes(targetClub)) {
                    baseProbability += 20;
                    factors.push('Top European Club (+20%)');
                } else if (bigClubs.includes(targetClub)) {
                    baseProbability += 15;
                    factors.push('Big Club Appeal (+15%)');
                }

                // Current club factor
                if (topEuropeanClubs.includes(currentClub)) {
                    baseProbability -= 10;
                    factors.push('Top Club Retention (-10%)');
                }

                // Player name analysis (simplified)
                const starPlayers = ['محمد صلاح', 'كريم بنزيما', 'نيمار', 'مبابي', 'هالاند'];
                if (starPlayers.some(star => playerName.includes(star.split(' ')[0]))) {
                    baseProbability += 15;
                    factors.push('Star Player Status (+15%)');
                }

                // Market timing factor
                const currentMonth = new Date().getMonth();
                if (currentMonth === 0 || currentMonth === 5 || currentMonth === 6) { // Jan, June, July
                    baseProbability += 10;
                    factors.push('Transfer Window (+10%)');
                }

                // Add controlled randomness
                const randomFactor = Math.floor(Math.random() * 21) - 10; // -10 to +10
                baseProbability += randomFactor;
                factors.push(`Market Dynamics (${randomFactor > 0 ? '+' : ''}${randomFactor}%)`);

                // Ensure realistic range
                const finalProbability = Math.max(15, Math.min(95, baseProbability));

                return {
                    percentage: finalProbability,
                    factors: factors,
                    confidence: this.calculateConfidence(factors.length),
                    trend: this.calculateTrend(finalProbability)
                };
            }

            calculateConfidence(factorCount) {
                if (factorCount >= 4) return 'High';
                if (factorCount >= 2) return 'Medium';
                return 'Low';
            }

            calculateTrend(probability) {
                if (probability >= 70) return 'Very Likely';
                if (probability >= 50) return 'Likely';
                if (probability >= 30) return 'Possible';
                return 'Unlikely';
            }

            // 🎮 FIFA 26 Professional Visualization Generator
            async generateFIFA26Visualization(playerData) {
                const previewContent = document.getElementById('previewContent');
                const placeholder = document.getElementById('previewPlaceholder');

                // Apply exit transition to existing card if any
                const existingCard = previewContent.querySelector('.fifa-card');
                if (existingCard) {
                    await this.applyCardExitTransition(existingCard);
                }

                if (placeholder) {
                    placeholder.style.display = 'none';
                }

                const visualizationHTML = this.createFIFA26CardHTML(playerData);
                previewContent.innerHTML = visualizationHTML;

                // Show card initially with transition
                this.showCardInitially();

                // Initialize particle effects (background continues normally)
                this.initializeParticleEffects();

                // Start FIFA animations (background continues normally)
                this.startFIFAAnimations();

                // Add sound effects
                this.playCreationSound();

                // Force OBS refresh for new card
                setTimeout(() => {
                    this.forceOBSRefresh();
                }, 500);
            }

            // Professional loader
            showProfessionalLoader() {
                const placeholder = document.getElementById('previewPlaceholder');
                if (placeholder) {
                    placeholder.style.display = 'flex';
                    placeholder.innerHTML = `
                        <div class="professional-loader" style="text-align: center;">
                            <div style="
                                width: 80px;
                                height: 80px;
                                border: 4px solid rgba(255, 255, 255, 0.1);
                                border-top: 4px solid #00d4ff;
                                border-radius: 50%;
                                animation: professionalSpin 1s linear infinite;
                                margin: 0 auto 20px;
                            "></div>
                            <h3 style="
                                font-family: 'Orbitron', monospace;
                                color: #00d4ff;
                                margin-bottom: 10px;
                            ">إنشاء بطاقة احترافية</h3>
                            <p style="color: rgba(255, 255, 255, 0.7);">جاري معالجة البيانات...</p>
                        </div>
                        <style>
                            @keyframes professionalSpin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `;
                }
            }

            hideProfessionalLoader() {
                const placeholder = document.getElementById('previewPlaceholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            }

            clearPreviewContent() {
                const previewContent = document.getElementById('previewContent');
                if (previewContent) {
                    previewContent.innerHTML = '';
                }

                // Stop any running sequence
                this.stopSequence();
            }

            // Start FIFA-style animations
            startFIFAAnimations() {
                // FIFA animations are handled by CSS
                console.log('🎮 FIFA 26 animations started');
            }

            // 💰 Financial Analysis 3D Visualization Generator
            async generateFinancialVisualization(playerData) {
                const previewContent = document.getElementById('previewContent');
                const placeholder = document.getElementById('previewPlaceholder');

                // Apply exit transition to existing card if any
                const existingCard = previewContent.querySelector('.financial-card');
                if (existingCard) {
                    await this.applyCardExitTransition(existingCard);
                }

                if (placeholder) {
                    placeholder.style.display = 'none';
                }

                const visualizationHTML = this.createPlayerCardHTML(playerData);
                previewContent.innerHTML = visualizationHTML;

                // Apply entrance transition to new card
                const newCard = previewContent.querySelector('.financial-card');
                if (newCard) {
                    // Set initial state for smooth transition
                    newCard.style.opacity = '0';
                    newCard.style.visibility = 'visible';
                    newCard.style.transform = '';
                    newCard.style.clipPath = '';

                    // Apply transition after a small delay to the card only
                    setTimeout(() => {
                        this.applyCardTransition(previewContent); // Pass container, function will find the card
                    }, 100);
                }

                // Initialize 3D financial effects (background continues normally)
                this.initializeFinancial3DEffects();

                // Start financial animations (background continues normally)
                this.startFinancialAnimations();

                // Add sound effects
                this.playCreationSound();
            }

            // 💰 Financial Card HTML Generator (3D Mathematical Style)
            createFinancialCardHTML(player, animationDelay = 0) {
                const probability = player.probability;
                const probabilityValue = probability.percentage;
                const probabilityColor = this.getProbabilityColor(probabilityValue);
                const marketValueNum = this.extractMarketValue(player.marketValue);
                const transferFee = this.calculateTransferFee(marketValueNum, probabilityValue);

                return `
                    <div class="financial-card-container" style="
                        width: 100%;
                        height: 100%;
                        position: relative;
                        background:
                            radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                            radial-gradient(circle at 80% 80%, rgba(0, 255, 127, 0.1) 0%, transparent 50%),
                            linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
                        overflow: hidden;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                        perspective: 1000px;
                    ">
                        <!-- 3D Mathematical Background -->
                        <div class="math-background" style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 1;
                            opacity: 0.3;
                            background-image:
                                url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><text x=\"10\" y=\"20\" font-family=\"monospace\" font-size=\"8\" fill=\"%23ffd700\">$</text><text x=\"70\" y=\"40\" font-family=\"monospace\" font-size=\"6\" fill=\"%2300ff7f\">%</text><text x=\"30\" y=\"60\" font-family=\"monospace\" font-size=\"7\" fill=\"%23ff6b6b\">€</text><text x=\"80\" y=\"80\" font-family=\"monospace\" font-size=\"5\" fill=\"%234ecdc4\">∑</text></svg>');
                            animation: mathFloat 20s linear infinite;
                        "></div>

                        <!-- Floating Dollar Signs -->
                        <div class="floating-dollars" style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 2;
                        ">
                            ${this.generateFloatingDollars()}
                        </div>

                        <!-- Enhanced Financial Analysis Card -->
                        <div class="financial-card" style="
                            position: relative;
                            z-index: 10;
                            width: 450px;
                            height: 650px;
                            background: linear-gradient(135deg,
                                rgba(0, 0, 0, 0.95) 0%,
                                rgba(26, 26, 46, 0.98) 30%,
                                rgba(22, 33, 62, 0.95) 70%,
                                rgba(15, 25, 45, 0.98) 100%);
                            border-radius: 30px;
                            padding: 0;
                            overflow: hidden;
                            box-shadow:
                                0 35px 70px rgba(0, 0, 0, 0.7),
                                0 0 0 1px rgba(255, 215, 0, 0.4),
                                0 0 50px rgba(${probabilityColor.replace('#', '').match(/.{2}/g).map(hex => parseInt(hex, 16)).join(', ')}, 0.3),
                                inset 0 2px 0 rgba(255, 255, 255, 0.15),
                                inset 0 -2px 0 rgba(0, 0, 0, 0.3);
                            animation: financialEntrance 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${animationDelay}s both;
                            transform-style: preserve-3d;
                            border: 3px solid rgba(255, 215, 0, 0.5);
                        ">
                            <!-- Animated Background Particles -->
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background:
                                    radial-gradient(circle at 20% 30%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                                    radial-gradient(circle at 80% 70%, rgba(${probabilityColor.replace('#', '').match(/.{2}/g).map(hex => parseInt(hex, 16)).join(', ')}, 0.1) 0%, transparent 50%),
                                    radial-gradient(circle at 40% 80%, rgba(0, 255, 127, 0.05) 0%, transparent 50%);
                                animation: particleFloat 8s ease-in-out infinite;
                                pointer-events: none;
                            "></div>

                            <!-- Geometric Pattern Overlay -->
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background-image:
                                    linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.02) 50%, transparent 60%),
                                    linear-gradient(-45deg, transparent 40%, rgba(255, 255, 255, 0.02) 50%, transparent 60%);
                                background-size: 30px 30px;
                                animation: patternShift 10s linear infinite;
                                pointer-events: none;
                            "></div>
                            <!-- Header with 3D Probability -->
                            <div class="financial-header" style="
                                position: relative;
                                height: 160px;
                                background: linear-gradient(135deg,
                                    rgba(255, 215, 0, 0.2) 0%,
                                    rgba(0, 255, 127, 0.1) 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                padding: 20px;
                                border-bottom: 2px solid rgba(255, 215, 0, 0.3);
                                overflow: hidden;
                            ">
                                <!-- 3D Probability Display -->
                                <div class="probability-3d" style="
                                    position: relative;
                                    width: 200px;
                                    height: 120px;
                                    background: ${this.getFinancialProbabilityBackground(probabilityValue)};
                                    border-radius: 20px;
                                    border: 3px solid ${this.getFinancialProbabilityBorder(probabilityValue)};
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    justify-content: center;
                                    transform: rotateX(10deg) rotateY(-5deg);
                                    box-shadow:
                                        0 20px 40px rgba(0, 0, 0, 0.5),
                                        0 0 30px ${this.getFinancialProbabilityGlow(probabilityValue)};
                                    animation: probability3DFloat 4s ease-in-out infinite;
                                ">
                                    <!-- Percentage with 3D effect -->
                                    <div style="
                                        font-size: 3.5rem;
                                        font-weight: 900;
                                        font-family: 'Orbitron', monospace;
                                        color: ${this.getFinancialTextColor(probabilityValue)};
                                        text-shadow:
                                            0 0 20px ${this.getFinancialTextGlow(probabilityValue)},
                                            2px 2px 0px rgba(0, 0, 0, 0.8),
                                            4px 4px 0px rgba(0, 0, 0, 0.6);
                                        animation: numberPulse3D 3s ease-in-out infinite;
                                        transform: translateZ(20px);
                                    ">${probabilityValue}%</div>

                                    <!-- Label -->
                                    <div style="
                                        font-size: 0.9rem;
                                        color: rgba(255, 215, 0, 0.9);
                                        font-weight: 700;
                                        margin-top: 8px;
                                        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                                        letter-spacing: 1px;
                                    ">احتمالية الانتقال</div>
                                </div>
                            </div>

                            <!-- Player Info Section -->
                            <div class="financial-player-info" style="
                                padding: 25px;
                                background: linear-gradient(180deg,
                                    rgba(0, 0, 0, 0.3) 0%,
                                    rgba(0, 0, 0, 0.5) 100%);
                            ">
                                <!-- Player Name with 3D effect -->
                                <h1 style="
                                    font-size: 2rem;
                                    font-weight: 900;
                                    font-family: 'Orbitron', monospace;
                                    color: #ffd700;
                                    text-align: center;
                                    margin-bottom: 20px;
                                    text-shadow:
                                        0 0 20px rgba(255, 215, 0, 0.8),
                                        2px 2px 0px rgba(0, 0, 0, 0.8),
                                        4px 4px 0px rgba(0, 0, 0, 0.6);
                                    animation: nameGlow3D 3s ease-in-out infinite;
                                    transform: translateZ(15px);
                                ">${player.arabicName}</h1>

                                <!-- Financial Stats Grid -->
                                <div class="financial-stats" style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 15px;
                                    margin-bottom: 25px;
                                ">
                                    <!-- Market Value -->
                                    <div class="financial-stat" style="
                                        background: linear-gradient(135deg,
                                            rgba(255, 215, 0, 0.2) 0%,
                                            rgba(255, 215, 0, 0.1) 100%);
                                        border: 2px solid rgba(255, 215, 0, 0.4);
                                        border-radius: 15px;
                                        padding: 15px;
                                        text-align: center;
                                        transform: rotateX(5deg);
                                        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                                    ">
                                        <div style="color: rgba(255, 215, 0, 0.8); font-size: 0.8rem; margin-bottom: 5px;">القيمة السوقية</div>
                                        <div style="color: #ffd700; font-weight: 900; font-size: 1.2rem;">
                                            💰 ${player.marketValue}
                                        </div>
                                    </div>

                                    <!-- Transfer Fee -->
                                    <div class="financial-stat" style="
                                        background: linear-gradient(135deg,
                                            rgba(0, 255, 127, 0.2) 0%,
                                            rgba(0, 255, 127, 0.1) 100%);
                                        border: 2px solid rgba(0, 255, 127, 0.4);
                                        border-radius: 15px;
                                        padding: 15px;
                                        text-align: center;
                                        transform: rotateX(5deg);
                                        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                                    ">
                                        <div style="color: rgba(0, 255, 127, 0.8); font-size: 0.8rem; margin-bottom: 5px;">رسوم الانتقال المتوقعة</div>
                                        <div style="color: #00ff7f; font-weight: 900; font-size: 1.2rem;">
                                            💸 ${transferFee}
                                        </div>
                                    </div>

                                    <!-- Current Club with Logo -->
                                    <div class="financial-stat" style="
                                        background: linear-gradient(135deg,
                                            rgba(255, 255, 255, 0.1) 0%,
                                            rgba(255, 255, 255, 0.05) 100%);
                                        border: 2px solid rgba(255, 255, 255, 0.3);
                                        border-radius: 15px;
                                        padding: 15px;
                                        text-align: center;
                                        transform: rotateX(5deg);
                                        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                    ">
                                        <div style="color: rgba(255, 255, 255, 0.9); font-size: 0.85rem; margin-bottom: 12px; font-weight: 600;">النادي الحالي</div>
                                        ${player.currentClubLogo ? `
                                        <div style="
                                            position: relative;
                                            margin-bottom: 8px;
                                            padding: 8px;
                                            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
                                            border-radius: 12px;
                                            backdrop-filter: blur(10px);
                                            border: 1px solid rgba(255, 255, 255, 0.25);
                                            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                                        ">
                                            <img src="${player.currentClubLogo}" alt="${player.currentClub}" style="
                                                width: ${this.settings.clubLogoSize || 24}px;
                                                height: ${this.settings.clubLogoSize || 24}px;
                                                object-fit: contain;
                                                border-radius: 6px;
                                                filter: drop-shadow(0 4px 15px rgba(255, 255, 255, 0.4)) brightness(1.1) contrast(1.1);
                                                transition: all 0.3s ease;
                                            " onerror="this.style.display='none'">
                                        </div>
                                        ` : ''}
                                        <div style="color: white; font-weight: 700; font-size: 1rem; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);">${player.currentClub}</div>
                                    </div>

                                    <!-- Target Club with Logo -->
                                    <div class="financial-stat" style="
                                        background: linear-gradient(135deg,
                                            ${probabilityColor}40 0%,
                                            ${probabilityColor}20 100%);
                                        border: 2px solid ${probabilityColor}60;
                                        border-radius: 15px;
                                        padding: 15px;
                                        text-align: center;
                                        transform: rotateX(5deg);
                                        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                    ">
                                        <div style="color: ${probabilityColor}; font-size: 0.85rem; margin-bottom: 12px; font-weight: 600;">النادي المطلوب</div>
                                        ${player.targetClubLogo ? `
                                        <div style="
                                            position: relative;
                                            margin-bottom: 8px;
                                            padding: 10px;
                                            background: linear-gradient(135deg, ${probabilityColor}25, ${probabilityColor}15);
                                            border-radius: 15px;
                                            backdrop-filter: blur(15px);
                                            border: 2px solid ${probabilityColor}60;
                                            box-shadow: 0 6px 20px ${probabilityColor}30;
                                            animation: targetGlow 2s ease-in-out infinite alternate;
                                        ">
                                            <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                                width: ${this.settings.clubLogoSize || 24}px;
                                                height: ${this.settings.clubLogoSize || 24}px;
                                                object-fit: contain;
                                                border-radius: 8px;
                                                filter: drop-shadow(0 6px 20px ${probabilityColor}80) brightness(1.2) contrast(1.15);
                                                transition: all 0.3s ease;
                                            " onerror="this.style.display='none'">
                                        </div>
                                        ` : ''}
                                        <div style="color: ${probabilityColor}; font-weight: 700; font-size: 1rem; text-shadow: 0 2px 10px ${probabilityColor}60;">${player.targetClub}</div>
                                    </div>
                                </div>

                                <!-- Financial Analysis -->
                                <div class="financial-analysis" style="
                                    background: linear-gradient(135deg,
                                        rgba(0, 0, 0, 0.6) 0%,
                                        rgba(26, 26, 46, 0.4) 100%);
                                    border: 2px solid rgba(255, 215, 0, 0.3);
                                    border-radius: 20px;
                                    padding: 20px;
                                    margin-bottom: 20px;
                                    transform: rotateX(3deg);
                                    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
                                ">
                                    <h3 style="
                                        color: #ffd700;
                                        font-size: 1.2rem;
                                        font-weight: 700;
                                        margin-bottom: 15px;
                                        text-align: center;
                                        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                                    ">📊 التحليل المالي المتقدم</h3>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                        <div style="color: rgba(255, 255, 255, 0.8);">العمر:</div>
                                        <div style="color: #00ff7f; font-weight: 600;">${player.age} سنة</div>

                                        <div style="color: rgba(255, 255, 255, 0.8);">مستوى الثقة:</div>
                                        <div style="color: ${probabilityColor}; font-weight: 600;">${probability.confidence}</div>

                                        <div style="color: rgba(255, 255, 255, 0.8);">نسبة النجاح:</div>
                                        <div style="color: ${probabilityColor}; font-weight: 600;">${probabilityValue}%</div>


                                    </div>
                                </div>
                            </div>

                            <!-- Footer with Target Club -->
                            <div class="financial-footer" style="
                                position: absolute;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                height: 60px;
                                background: linear-gradient(135deg,
                                    rgba(255, 215, 0, 0.3) 0%,
                                    rgba(0, 255, 127, 0.2) 100%);
                                border-top: 3px solid rgba(255, 215, 0, 0.5);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: 700;
                                color: #ffd700;
                                font-size: 1.1rem;
                                text-align: center;
                                padding: 0 20px;
                                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
                                animation: footerGlow3D 4s ease-in-out infinite;
                            ">
                                <div style="
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
                                ">
                                    <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">الوجهة الاستثمارية</div>
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                        font-size: 1.3rem;
                                        font-weight: 900;
                                    ">
                                        ${player.targetClubLogo ? `
                                        <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                            width: ${this.settings.targetClubLogoSize || 28}px;
                                            height: ${this.settings.targetClubLogoSize || 28}px;
                                            object-fit: contain;
                                            border-radius: 4px;
                                            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
                                        " onerror="this.style.display='none'">
                                        ` : ''}
                                        <span>${player.targetClub}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Animations CSS -->
                        <style>
                            @keyframes financialEntrance {
                                0% {
                                    opacity: 0;
                                    transform: translateY(100px) rotateX(45deg) scale(0.8);
                                    filter: blur(10px);
                                }
                                100% {
                                    opacity: 1;
                                    transform: translateY(0) rotateX(0deg) scale(1);
                                    filter: blur(0px);
                                }
                            }

                            @keyframes probability3DFloat {
                                0%, 100% {
                                    transform: rotateX(10deg) rotateY(-5deg) translateZ(0px);
                                }
                                50% {
                                    transform: rotateX(15deg) rotateY(5deg) translateZ(10px);
                                }
                            }

                            @keyframes numberPulse3D {
                                0%, 100% {
                                    transform: translateZ(20px) scale(1);
                                    text-shadow:
                                        0 0 20px ${this.getFinancialTextGlow(probabilityValue)},
                                        2px 2px 0px rgba(0, 0, 0, 0.8),
                                        4px 4px 0px rgba(0, 0, 0, 0.6);
                                }
                                50% {
                                    transform: translateZ(30px) scale(1.05);
                                    text-shadow:
                                        0 0 30px ${this.getFinancialTextGlow(probabilityValue)},
                                        3px 3px 0px rgba(0, 0, 0, 0.8),
                                        6px 6px 0px rgba(0, 0, 0, 0.6);
                                }
                            }

                            @keyframes nameGlow3D {
                                0%, 100% {
                                    transform: translateZ(15px);
                                    text-shadow:
                                        0 0 20px rgba(255, 215, 0, 0.8),
                                        2px 2px 0px rgba(0, 0, 0, 0.8),
                                        4px 4px 0px rgba(0, 0, 0, 0.6);
                                }
                                50% {
                                    transform: translateZ(25px);
                                    text-shadow:
                                        0 0 30px rgba(255, 215, 0, 1),
                                        3px 3px 0px rgba(0, 0, 0, 0.8),
                                        6px 6px 0px rgba(0, 0, 0, 0.6);
                                }
                            }

                            @keyframes footerGlow3D {
                                0%, 100% {
                                    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
                                }
                                50% {
                                    box-shadow:
                                        0 -5px 20px rgba(0, 0, 0, 0.3),
                                        0 0 30px rgba(255, 215, 0, 0.4);
                                }
                            }

                            @keyframes mathFloat {
                                0% { transform: translateY(0px) rotate(0deg); }
                                50% { transform: translateY(-20px) rotate(180deg); }
                                100% { transform: translateY(0px) rotate(360deg); }
                            }

                            .floating-dollar {
                                position: absolute;
                                font-size: 2rem;
                                color: rgba(255, 215, 0, 0.6);
                                animation: dollarFloat 15s linear infinite;
                                pointer-events: none;
                            }

                            @keyframes dollarFloat {
                                0% {
                                    transform: translateY(100vh) rotate(0deg);
                                    opacity: 0;
                                }
                                10% {
                                    opacity: 1;
                                }
                                90% {
                                    opacity: 1;
                                }
                                100% {
                                    transform: translateY(-100px) rotate(360deg);
                                    opacity: 0;
                                }
                            }
                        </style>
                    </div>
                `;
            }

            // 💰 Financial Helper Functions
            generateFloatingDollars() {
                let dollarsHTML = '';
                const symbols = ['$', '€', '£', '¥', '₹', '%', '∑', '∆'];

                for (let i = 0; i < 8; i++) {
                    const symbol = symbols[i % symbols.length];
                    const left = Math.random() * 100;
                    const delay = Math.random() * 15;
                    const duration = 15 + Math.random() * 10;

                    dollarsHTML += `
                        <div class="floating-dollar" style="
                            left: ${left}%;
                            animation-delay: ${delay}s;
                            animation-duration: ${duration}s;
                        ">${symbol}</div>
                    `;
                }

                return dollarsHTML;
            }

            extractMarketValue(marketValueStr) {
                // Extract numeric value from market value string
                const match = marketValueStr.match(/[\d.]+/);
                return match ? parseFloat(match[0]) : 50;
            }

            calculateTransferFee(marketValue, probability) {
                // Calculate transfer fee based on market value and probability
                const baseFee = marketValue * 1.2; // 20% markup
                const probabilityMultiplier = 1 + (probability / 100) * 0.5; // Up to 50% increase for high probability
                const finalFee = baseFee * probabilityMultiplier;

                if (finalFee >= 100) {
                    return `${(finalFee / 1).toFixed(0)}M €`;
                } else {
                    return `${finalFee.toFixed(1)}M €`;
                }
            }

            getFinancialProbabilityBackground(probability) {
                if (probability >= 75) {
                    return 'linear-gradient(135deg, rgba(34, 197, 94, 0.3) 0%, rgba(16, 185, 129, 0.2) 100%)';
                } else if (probability >= 50) {
                    return 'linear-gradient(135deg, rgba(245, 158, 11, 0.3) 0%, rgba(251, 191, 36, 0.2) 100%)';
                } else {
                    return 'linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.2) 100%)';
                }
            }

            getFinancialProbabilityBorder(probability) {
                if (probability >= 75) return 'rgba(34, 197, 94, 0.6)';
                if (probability >= 50) return 'rgba(245, 158, 11, 0.6)';
                return 'rgba(239, 68, 68, 0.6)';
            }

            getFinancialProbabilityGlow(probability) {
                if (probability >= 75) return 'rgba(34, 197, 94, 0.4)';
                if (probability >= 50) return 'rgba(245, 158, 11, 0.4)';
                return 'rgba(239, 68, 68, 0.4)';
            }

            getFinancialTextColor(probability) {
                if (probability >= 75) return '#22c55e';
                if (probability >= 50) return '#f59e0b';
                return '#ef4444';
            }

            getFinancialTextGlow(probability) {
                if (probability >= 75) return 'rgba(34, 197, 94, 0.8)';
                if (probability >= 50) return 'rgba(245, 158, 11, 0.8)';
                return 'rgba(239, 68, 68, 0.8)';
            }

            getFinancialRating(probability) {
                if (probability >= 90) return '⭐⭐⭐⭐⭐ ممتاز';
                if (probability >= 75) return '⭐⭐⭐⭐ جيد جداً';
                if (probability >= 60) return '⭐⭐⭐ جيد';
                if (probability >= 40) return '⭐⭐ متوسط';
                return '⭐ ضعيف';
            }

            initializeFinancial3DEffects() {
                // Initialize 3D financial particle effects
                console.log('💰 Financial 3D effects initialized');
                this.createFinancialParticles();
            }

            createFinancialParticles() {
                // Create floating mathematical symbols
                const container = document.querySelector('.financial-card-container');
                if (!container) return;

                for (let i = 0; i < 15; i++) {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: absolute;
                        font-size: ${Math.random() * 20 + 10}px;
                        color: rgba(255, 215, 0, ${Math.random() * 0.3 + 0.1});
                        pointer-events: none;
                        z-index: 3;
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        animation: financialParticleFloat ${Math.random() * 10 + 15}s linear infinite;
                        animation-delay: ${Math.random() * 5}s;
                    `;

                    const symbols = ['$', '€', '£', '¥', '%', '∑', '∆', '∞', '±', '≈'];
                    particle.textContent = symbols[Math.floor(Math.random() * symbols.length)];

                    container.appendChild(particle);
                }

                // Add particle animation CSS
                if (!document.getElementById('financialParticleStyles')) {
                    const style = document.createElement('style');
                    style.id = 'financialParticleStyles';
                    style.textContent = `
                        @keyframes financialParticleFloat {
                            0% {
                                transform: translateY(0px) rotate(0deg);
                                opacity: 0;
                            }
                            10% {
                                opacity: 1;
                            }
                            90% {
                                opacity: 1;
                            }
                            100% {
                                transform: translateY(-100vh) rotate(360deg);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            startFinancialAnimations() {
                // Start financial-specific animations
                console.log('💰 Financial animations started');
            }

            // 🎮 FIFA 26 Card HTML Generator (Clean & Professional)
            createFIFA26CardHTML(player, animationDelay = 0) {
                const probability = player.probability;
                const probabilityValue = probability.percentage;
                const probabilityColor = this.getProbabilityColor(probabilityValue);
                const cardGradient = this.getCardGradient(probabilityValue);
                const ratingColor = this.getRatingColor(player.rating);
                const gradientId = `gradient-${Date.now()}`;

                return `
                    <div class="fifa-card-container" style="
                        width: 100%;
                        height: 100%;
                        position: relative;
                        background: radial-gradient(circle at center, #0a0a0f 0%, #1a0b2e 100%);
                        overflow: hidden;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    ">
                        <!-- Particle Canvas -->
                        <canvas id="particleCanvas" style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 1;
                        "></canvas>

                        <!-- FIFA 26 Style Card -->
                        <div class="fifa-card" style="
                            position: relative;
                            z-index: 10;
                            width: 400px;
                            height: 600px;
                            background: ${cardGradient};
                            border-radius: 25px;
                            padding: 0;
                            overflow: hidden;
                            box-shadow:
                                0 25px 50px rgba(0, 0, 0, 0.5),
                                0 0 0 1px rgba(255, 255, 255, 0.1),
                                inset 0 1px 0 rgba(255, 255, 255, 0.2);
                            animation: none;
                            transform-style: preserve-3d;
                        ">
                            <!-- Card Header -->
                            <div class="card-header" style="
                                position: relative;
                                height: 140px;
                                background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(255, 255, 255, 0.1));
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                padding: 20px;
                                border-bottom: 2px solid rgba(255, 255, 255, 0.2);
                            ">
                                <!-- Specialized Probability Zone -->
                                <div class="probability-zone" style="
                                    position: relative;
                                    width: 180px;
                                    height: 120px;
                                    background: ${this.getProbabilityZoneBackground(probabilityValue)};
                                    border-radius: 25px;
                                    border: 3px solid ${this.getProbabilityZoneBorder(probabilityValue)};
                                    box-shadow:
                                        0 0 30px ${this.getProbabilityZoneGlow(probabilityValue)},
                                        inset 0 2px 10px rgba(255, 255, 255, 0.1);
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    justify-content: center;
                                    animation: ${this.getProbabilityZoneAnimation(probabilityValue)} 4s ease-in-out infinite;
                                ">
                                    <!-- Floating Particles Background -->
                                    <div style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        right: 0;
                                        bottom: 0;
                                        border-radius: 22px;
                                        background: ${this.getProbabilityParticlePattern(probabilityValue)};
                                        opacity: 0.4;
                                        animation: particleFloat 6s linear infinite;
                                    "></div>

                                    <!-- Main Percentage Display -->
                                    <div class="percentage-display" style="
                                        position: relative;
                                        z-index: 3;
                                        font-size: 3.2rem;
                                        font-weight: 900;
                                        font-family: 'Orbitron', monospace;
                                        color: ${this.getProbabilityTextColor(probabilityValue)};
                                        text-shadow:
                                            0 0 20px ${this.getProbabilityTextGlow(probabilityValue)},
                                            0 2px 4px rgba(0, 0, 0, 0.5);
                                        animation: ${this.getProbabilityTextAnimation(probabilityValue)} 3s ease-in-out infinite;
                                        filter: drop-shadow(0 0 10px ${this.getProbabilityTextGlow(probabilityValue)});
                                    ">${probabilityValue}%</div>

                                    <!-- Specialized Progress Ring -->
                                    <div style="
                                        position: relative;
                                        width: 140px;
                                        height: 12px;
                                        background: ${this.getProbabilityTrackColor(probabilityValue)};
                                        border-radius: 15px;
                                        overflow: hidden;
                                        margin-top: 12px;
                                        border: 2px solid ${this.getProbabilityTrackBorder(probabilityValue)};
                                        box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3);
                                    ">
                                        <div style="
                                            width: ${probabilityValue}%;
                                            height: 100%;
                                            background: ${this.getProbabilityFillGradient(probabilityValue)};
                                            border-radius: 15px;
                                            animation:
                                                progressSlide 2.5s ease-out 0.5s both,
                                                ${this.getProbabilityFillAnimation(probabilityValue)} 4s ease-in-out infinite;
                                            box-shadow:
                                                0 0 20px ${this.getProbabilityFillGlow(probabilityValue)},
                                                inset 0 1px 3px rgba(255, 255, 255, 0.3);
                                        "></div>

                                        <!-- Dynamic Sparkle Effect -->
                                        ${this.getProbabilitySparkleEffect(probabilityValue)}
                                    </div>

                                    <!-- Elegant Label -->
                                    <div style="
                                        position: relative;
                                        z-index: 3;
                                        font-size: 0.85rem;
                                        color: ${this.getProbabilityLabelColor(probabilityValue)};
                                        font-weight: 700;
                                        margin-top: 10px;
                                        text-align: center;
                                        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                                        letter-spacing: 0.5px;
                                    ">احتمالية الانتقال</div>
                                </div>
                            </div>

                            <!-- Player Image Section -->
                            <div class="player-image-section" style="
                                position: relative;
                                height: 280px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                overflow: hidden;
                            ">
                                <!-- Background Pattern -->
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    right: 0;
                                    bottom: 0;
                                    background:
                                        radial-gradient(circle at 30% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                                        radial-gradient(circle at 70% 30%, ${probabilityColor}20 0%, transparent 50%);
                                    animation: backgroundShift 8s ease-in-out infinite;
                                "></div>

                                <!-- Target Club Logo (Large) -->
                                ${player.targetClubLogo ? `
                                <div class="target-club-logo-large" style="
                                    position: absolute;
                                    top: 20px;
                                    right: 20px;
                                    z-index: 5;
                                    background: linear-gradient(135deg,
                                        rgba(0, 0, 0, 0.8) 0%,
                                        rgba(0, 0, 0, 0.6) 100%);
                                    border-radius: 20px;
                                    padding: 15px;
                                    border: 3px solid ${probabilityColor}60;
                                    box-shadow:
                                        0 10px 30px rgba(0, 0, 0, 0.5),
                                        0 0 20px ${probabilityColor}40;
                                    animation: targetLogoFloat 4s ease-in-out infinite;
                                    backdrop-filter: blur(10px);
                                ">
                                    <img src="${player.targetClubLogo}"
                                         alt="${player.targetClub}"
                                         style="
                                            width: ${(this.settings.targetClubLogoSize || 28) * 2.5}px;
                                            height: ${(this.settings.targetClubLogoSize || 28) * 2.5}px;
                                            object-fit: contain;
                                            border-radius: 8px;
                                            filter:
                                                drop-shadow(0 0 15px ${probabilityColor}80)
                                                brightness(1.1)
                                                contrast(1.1);
                                            transition: all 0.3s ease;
                                         "
                                         onerror="this.style.display='none'">

                                    <!-- Target Club Name -->
                                    <div style="
                                        text-align: center;
                                        margin-top: 8px;
                                        color: ${probabilityColor};
                                        font-size: 0.8rem;
                                        font-weight: 700;
                                        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
                                        letter-spacing: 0.5px;
                                    ">${player.targetClub}</div>
                                </div>
                                ` : ''}

                                <!-- Player Image -->
                                <img src="${this.getPlayerImageUrl(player)}"
                                     alt="${player.arabicName}"
                                     class="player-image"
                                     style="
                                        width: ${this.settings.playerImageSize || 200}px;
                                        height: ${this.settings.playerImageSize || 200}px;
                                        border-radius: 50%;
                                        border: 5px solid rgba(255, 255, 255, 0.3);
                                        object-fit: cover;
                                        position: relative;
                                        z-index: 2;
                                        filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.5));
                                        animation: playerFloat 3s ease-in-out infinite;
                                        transition: all 0.3s ease;
                                     "
                                     onerror="this.src='${this.getFallbackImageUrl(player.arabicName)}'">

                                <!-- Glow Effect -->
                                <div style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    width: ${(this.settings.playerImageSize || 200) + 20}px;
                                    height: ${(this.settings.playerImageSize || 200) + 20}px;
                                    border-radius: 50%;
                                    background: radial-gradient(circle, ${probabilityColor}30 0%, transparent 70%);
                                    animation: glowPulse 2s ease-in-out infinite;
                                    z-index: 1;
                                    transition: all 0.3s ease;
                                "></div>
                            </div>

                            <!-- Player Info Section -->
                            <div class="player-info" style="
                                padding: 20px;
                                background: linear-gradient(180deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.4));
                                border-top: 1px solid rgba(255, 255, 255, 0.1);
                            ">
                                <!-- Player Name -->
                                <h1 style="
                                    font-size: 1.8rem;
                                    font-weight: 900;
                                    font-family: 'Orbitron', monospace;
                                    color: white;
                                    text-align: center;
                                    margin-bottom: 15px;
                                    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
                                    animation: nameGlow 3s ease-in-out infinite;
                                ">${player.arabicName}</h1>

                                <!-- Stats Grid -->
                                <div class="stats-grid" style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 15px;
                                    margin-bottom: 20px;
                                ">
                                    <!-- Age -->
                                    <div class="stat-item" style="
                                        background: rgba(255, 255, 255, 0.1);
                                        border-radius: 10px;
                                        padding: 12px;
                                        text-align: center;
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                    ">
                                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin-bottom: 5px;">العمر</div>
                                        <div style="color: white; font-weight: 700; font-size: 1.1rem;">${player.age} سنة</div>
                                    </div>

                                    <!-- Current Club -->
                                    <div class="stat-item" style="
                                        background: rgba(255, 255, 255, 0.1);
                                        border-radius: 10px;
                                        padding: 12px;
                                        text-align: center;
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                    ">
                                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin-bottom: 5px;">النادي الحالي</div>
                                        ${player.currentClubLogo ? `
                                        <img src="${player.currentClubLogo}" alt="${player.currentClub}" class="club-logo" style="
                                            width: ${this.settings.clubLogoSize || 24}px;
                                            height: ${this.settings.clubLogoSize || 24}px;
                                            object-fit: contain;
                                            margin-bottom: 5px;
                                            border-radius: 4px;
                                            transition: all 0.3s ease;
                                        " onerror="this.style.display='none'">
                                        ` : ''}
                                        <div style="color: white; font-weight: 700; font-size: 1rem;">${player.currentClub}</div>
                                    </div>

                                    <!-- Target Club -->
                                    <div class="stat-item" style="
                                        background: rgba(255, 255, 255, 0.1);
                                        border-radius: 10px;
                                        padding: 12px;
                                        text-align: center;
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                    ">
                                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin-bottom: 5px;">النادي المطلوب</div>
                                        ${player.targetClubLogo ? `
                                        <img src="${player.targetClubLogo}" alt="${player.targetClub}" class="target-club-logo" style="
                                            width: ${this.settings.clubLogoSize || 24}px;
                                            height: ${this.settings.clubLogoSize || 24}px;
                                            object-fit: contain;
                                            margin-bottom: 5px;
                                            border-radius: 4px;
                                            filter: drop-shadow(0 0 8px ${probabilityColor}40);
                                            transition: all 0.3s ease;
                                        " onerror="this.style.display='none'">
                                        ` : ''}
                                        <div style="color: ${probabilityColor}; font-weight: 700; font-size: 1rem;">${player.targetClub}</div>
                                    </div>

                                    <!-- Transfer Probability -->
                                    <div class="stat-item" style="
                                        background: rgba(255, 255, 255, 0.1);
                                        border-radius: 10px;
                                        padding: 12px;
                                        text-align: center;
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                    ">
                                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin-bottom: 5px;">نسبة الانتقال</div>
                                        <div style="color: ${probabilityColor}; font-weight: 700; font-size: 1.1rem;">${probabilityValue}%</div>
                                    </div>
                                </div>

                                <!-- Transfer Info -->
                                <div class="transfer-info" style="
                                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
                                    border-radius: 15px;
                                    padding: 15px;
                                    border: 1px solid rgba(255, 255, 255, 0.2);
                                ">
                                    <div style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-bottom: 10px;
                                    ">
                                        <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">من:</span>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            ${player.currentClubLogo ? `
                                            <img src="${player.currentClubLogo}" alt="${player.currentClub}" class="club-logo-small" style="
                                                width: ${Math.max(16, (this.settings.clubLogoSize || 24) - 4)}px;
                                                height: ${Math.max(16, (this.settings.clubLogoSize || 24) - 4)}px;
                                                object-fit: contain;
                                                border-radius: 3px;
                                                transition: all 0.3s ease;
                                            " onerror="this.style.display='none'">
                                            ` : ''}
                                            <span style="color: white; font-weight: 600;">${player.currentClub}</span>
                                        </div>
                                    </div>
                                    <div style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-bottom: 10px;
                                    ">
                                        <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">إلى:</span>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            ${player.targetClubLogo ? `
                                            <img src="${player.targetClubLogo}" alt="${player.targetClub}" class="target-club-logo-small" style="
                                                width: ${Math.max(16, (this.settings.clubLogoSize || 24) - 4)}px;
                                                height: ${Math.max(16, (this.settings.clubLogoSize || 24) - 4)}px;
                                                object-fit: contain;
                                                border-radius: 3px;
                                                filter: drop-shadow(0 0 6px ${probabilityColor}40);
                                                transition: all 0.3s ease;
                                            " onerror="this.style.display='none'">
                                            ` : ''}
                                            <span style="color: ${probabilityColor}; font-weight: 700;">${player.targetClub}</span>
                                        </div>
                                    </div>
                                    <div style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-bottom: 10px;
                                    ">
                                        <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">القيمة السوقية:</span>
                                        <span style="color: #ffd700; font-weight: 700;">${player.marketValue}</span>
                                    </div>
                                    <div style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                    ">
                                        <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">مستوى الثقة:</span>
                                        <span style="color: ${probabilityColor}; font-weight: 700;">${probability.confidence}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Footer -->
                            <div class="card-footer" style="
                                position: absolute;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                height: 55px;
                                background: ${this.getFooterBackground(probabilityValue)};
                                border: 2px solid ${this.getFooterBorder(probabilityValue)};
                                border-top: 3px solid ${this.getFooterTopBorder(probabilityValue)};
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: 700;
                                color: ${this.getFooterTextColor(probabilityValue)};
                                font-size: 1rem;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                                text-align: center;
                                padding: 0 15px;
                                box-shadow:
                                    0 -3px 15px rgba(0, 0, 0, 0.3),
                                    0 0 20px ${this.getFooterGlow(probabilityValue)};
                                animation: ${this.getFooterAnimation(probabilityValue)} 4s ease-in-out infinite;
                            ">
                                <div style="
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                                ">
                                    <div style="
                                        font-size: 0.75rem;
                                        opacity: 0.9;
                                        margin-bottom: 3px;
                                        color: ${this.getFooterSubtitleColor(probabilityValue)};
                                    ">الوجهة المحتملة</div>
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 8px;
                                        font-size: 1.2rem;
                                        font-weight: 900;
                                        filter: drop-shadow(0 0 8px ${this.getFooterTextGlow(probabilityValue)});
                                    ">
                                        <span>${player.targetClub}</span>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- FIFA 26 Card Animations -->
                        <style>
                            @keyframes cardEntrance {
                                0% {
                                    opacity: 0;
                                    transform: translateY(50px) rotateY(15deg) scale(0.8);
                                    filter: blur(10px);
                                }
                                100% {
                                    opacity: 1;
                                    transform: translateY(0) rotateY(0deg) scale(1);
                                    filter: blur(0px);
                                }
                            }

                            @keyframes probabilityGlow {
                                0%, 100% {
                                    opacity: 0.8;
                                    transform: scale(1);
                                }
                                50% {
                                    opacity: 1;
                                    transform: scale(1.05);
                                }
                            }

                            @keyframes numberPulse {
                                0%, 100% {
                                    transform: scale(1);
                                    text-shadow: 0 0 20px ${probabilityColor}80;
                                }
                                50% {
                                    transform: scale(1.1);
                                    text-shadow: 0 0 30px ${probabilityColor}, 0 0 40px ${probabilityColor}60;
                                }
                            }

                            @keyframes progressSlide {
                                0% {
                                    width: 0%;
                                    opacity: 0;
                                }
                                100% {
                                    width: ${probabilityValue}%;
                                    opacity: 1;
                                }
                            }

                            @keyframes successPulse {
                                0%, 100% {
                                    box-shadow: 0 0 15px #22c55e80;
                                    filter: brightness(1);
                                }
                                50% {
                                    box-shadow: 0 0 25px #22c55e, 0 0 35px #22c55e60;
                                    filter: brightness(1.2);
                                }
                            }

                            @keyframes warningGlow {
                                0%, 100% {
                                    box-shadow: 0 0 15px #f59e0b80;
                                    filter: brightness(1);
                                }
                                50% {
                                    box-shadow: 0 0 20px #f59e0b, 0 0 30px #f59e0b60;
                                    filter: brightness(1.1);
                                }
                            }

                            @keyframes dangerFlicker {
                                0%, 100% {
                                    box-shadow: 0 0 15px #dc262680;
                                    filter: brightness(1);
                                }
                                25% {
                                    box-shadow: 0 0 10px #dc2626;
                                    filter: brightness(0.9);
                                }
                                75% {
                                    box-shadow: 0 0 20px #dc2626, 0 0 30px #dc262660;
                                    filter: brightness(1.1);
                                }
                            }

                            @keyframes sparkleMove {
                                0% {
                                    transform: translateX(-100%);
                                    opacity: 0;
                                }
                                50% {
                                    opacity: 1;
                                }
                                100% {
                                    transform: translateX(100%);
                                    opacity: 0;
                                }
                            }

                            /* Specialized Zone Animations */
                            @keyframes zoneSuccessBreath {
                                0%, 100% {
                                    transform: scale(1);
                                    box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
                                }
                                50% {
                                    transform: scale(1.02);
                                    box-shadow: 0 0 40px rgba(34, 197, 94, 0.5);
                                }
                            }

                            @keyframes zoneWarningPulse {
                                0%, 100% {
                                    transform: scale(1);
                                    box-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
                                }
                                50% {
                                    transform: scale(1.01);
                                    box-shadow: 0 0 35px rgba(245, 158, 11, 0.4);
                                }
                            }

                            @keyframes zoneDangerAlert {
                                0%, 100% {
                                    transform: scale(1);
                                    box-shadow: 0 0 30px rgba(220, 38, 38, 0.3);
                                }
                                25% {
                                    transform: scale(0.98);
                                    box-shadow: 0 0 25px rgba(220, 38, 38, 0.2);
                                }
                                75% {
                                    transform: scale(1.01);
                                    box-shadow: 0 0 35px rgba(220, 38, 38, 0.4);
                                }
                            }

                            /* Text Animations */
                            @keyframes textSuccessGlow {
                                0%, 100% {
                                    text-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 2px 4px rgba(0, 0, 0, 0.5);
                                }
                                50% {
                                    text-shadow: 0 0 30px rgba(34, 197, 94, 1), 0 0 40px rgba(34, 197, 94, 0.6), 0 2px 4px rgba(0, 0, 0, 0.5);
                                }
                            }

                            @keyframes textWarningShimmer {
                                0%, 100% {
                                    text-shadow: 0 0 20px rgba(245, 158, 11, 0.8), 0 2px 4px rgba(0, 0, 0, 0.5);
                                }
                                50% {
                                    text-shadow: 0 0 25px rgba(245, 158, 11, 1), 0 0 35px rgba(245, 158, 11, 0.6), 0 2px 4px rgba(0, 0, 0, 0.5);
                                }
                            }

                            @keyframes textDangerFlash {
                                0%, 100% {
                                    text-shadow: 0 0 20px rgba(220, 38, 38, 0.8), 0 2px 4px rgba(0, 0, 0, 0.5);
                                }
                                25% {
                                    text-shadow: 0 0 15px rgba(220, 38, 38, 0.6), 0 2px 4px rgba(0, 0, 0, 0.5);
                                }
                                75% {
                                    text-shadow: 0 0 30px rgba(220, 38, 38, 1), 0 0 40px rgba(220, 38, 38, 0.6), 0 2px 4px rgba(0, 0, 0, 0.5);
                                }
                            }

                            /* Fill Animations */
                            @keyframes fillSuccessFlow {
                                0%, 100% {
                                    box-shadow: 0 0 20px rgba(16, 185, 129, 0.6), inset 0 1px 3px rgba(255, 255, 255, 0.3);
                                }
                                50% {
                                    box-shadow: 0 0 30px rgba(16, 185, 129, 0.8), inset 0 1px 3px rgba(255, 255, 255, 0.5);
                                }
                            }

                            @keyframes fillWarningWave {
                                0%, 100% {
                                    box-shadow: 0 0 20px rgba(245, 158, 11, 0.6), inset 0 1px 3px rgba(255, 255, 255, 0.3);
                                }
                                50% {
                                    box-shadow: 0 0 25px rgba(245, 158, 11, 0.7), inset 0 1px 3px rgba(255, 255, 255, 0.4);
                                }
                            }

                            @keyframes fillDangerPulse {
                                0%, 100% {
                                    box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), inset 0 1px 3px rgba(255, 255, 255, 0.3);
                                }
                                25% {
                                    box-shadow: 0 0 15px rgba(239, 68, 68, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.2);
                                }
                                75% {
                                    box-shadow: 0 0 25px rgba(239, 68, 68, 0.8), inset 0 1px 3px rgba(255, 255, 255, 0.4);
                                }
                            }

                            /* Particle Animation */
                            @keyframes particleFloat {
                                0%, 100% {
                                    transform: translateY(0px) rotate(0deg);
                                    opacity: 0.4;
                                }
                                50% {
                                    transform: translateY(-5px) rotate(180deg);
                                    opacity: 0.6;
                                }
                            }

                            @keyframes sparkleGlow {
                                0%, 100% {
                                    opacity: 0.8;
                                    transform: translate(-50%, -50%) scale(1);
                                }
                                50% {
                                    opacity: 1;
                                    transform: translate(-50%, -50%) scale(1.5);
                                }
                            }

                            /* Footer Animations */
                            @keyframes footerSuccessGlow {
                                0%, 100% {
                                    box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.3), 0 0 20px rgba(5, 150, 105, 0.4);
                                }
                                50% {
                                    box-shadow: 0 -3px 20px rgba(0, 0, 0, 0.4), 0 0 30px rgba(5, 150, 105, 0.6);
                                }
                            }

                            @keyframes footerWarningPulse {
                                0%, 100% {
                                    box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.3), 0 0 20px rgba(217, 119, 6, 0.4);
                                }
                                50% {
                                    box-shadow: 0 -3px 18px rgba(0, 0, 0, 0.35), 0 0 25px rgba(217, 119, 6, 0.5);
                                }
                            }

                            @keyframes footerDangerFlicker {
                                0%, 100% {
                                    box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.3), 0 0 20px rgba(185, 28, 28, 0.4);
                                }
                                25% {
                                    box-shadow: 0 -3px 12px rgba(0, 0, 0, 0.25), 0 0 15px rgba(185, 28, 28, 0.3);
                                }
                                75% {
                                    box-shadow: 0 -3px 18px rgba(0, 0, 0, 0.35), 0 0 25px rgba(185, 28, 28, 0.5);
                                }
                            }

                            @keyframes backgroundShift {
                                0%, 100% {
                                    transform: translateX(0) translateY(0) rotate(0deg);
                                }
                                33% {
                                    transform: translateX(10px) translateY(-5px) rotate(1deg);
                                }
                                66% {
                                    transform: translateX(-5px) translateY(10px) rotate(-1deg);
                                }
                            }

                            @keyframes playerFloat {
                                0%, 100% {
                                    transform: translateY(0) scale(1);
                                }
                                50% {
                                    transform: translateY(-10px) scale(1.02);
                                }
                            }

                            @keyframes glowPulse {
                                0%, 100% {
                                    opacity: 0.3;
                                    transform: translate(-50%, -50%) scale(1);
                                }
                                50% {
                                    opacity: 0.6;
                                    transform: translate(-50%, -50%) scale(1.1);
                                }
                            }

                            @keyframes nameGlow {
                                0%, 100% {
                                    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
                                }
                                50% {
                                    text-shadow:
                                        0 2px 10px rgba(0, 0, 0, 0.5),
                                        0 0 20px ${probabilityColor}50,
                                        0 0 30px ${probabilityColor}30;
                                }
                            }

                            @keyframes progressFill {
                                0% { stroke-dashoffset: ${2 * Math.PI * 35}; }
                                100% { stroke-dashoffset: ${2 * Math.PI * 35 * (1 - probabilityValue / 100)}; }
                            }

                            /* Hover Effects */
                            .fifa-card:hover {
                                transform: translateY(-10px) rotateY(5deg);
                                box-shadow:
                                    0 35px 70px rgba(0, 0, 0, 0.6),
                                    0 0 0 1px rgba(255, 255, 255, 0.2),
                                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
                                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                            }

                            .stat-item:hover {
                                background: rgba(255, 255, 255, 0.2);
                                transform: translateY(-2px);
                                transition: all 0.3s ease;
                            }

                            /* Target Club Logo Animation */
                            @keyframes targetLogoFloat {
                                0%, 100% {
                                    transform: translateY(0px) scale(1);
                                    box-shadow:
                                        0 10px 30px rgba(0, 0, 0, 0.5),
                                        0 0 20px ${probabilityColor}40;
                                }
                                50% {
                                    transform: translateY(-5px) scale(1.05);
                                    box-shadow:
                                        0 15px 40px rgba(0, 0, 0, 0.6),
                                        0 0 30px ${probabilityColor}60;
                                }
                            }

                            /* Enhanced Target Logo Hover */
                            .target-club-logo-large:hover {
                                transform: translateY(-3px) scale(1.1);
                                box-shadow:
                                    0 20px 50px rgba(0, 0, 0, 0.7),
                                    0 0 40px ${probabilityColor}80;
                                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                            }

                            .target-club-logo-large:hover img {
                                filter:
                                    drop-shadow(0 0 20px ${probabilityColor})
                                    brightness(1.2)
                                    contrast(1.2)
                                    saturate(1.1);
                            }
                        </style>
                    </div>
                `;
            }

            // 🎨 Enhanced Helper Methods with Dynamic Colors
            getProbabilityColor(percentage) {
                if (percentage >= 75) {
                    // Green gradient (75-100%)
                    const intensity = (percentage - 75) / 25; // 0 to 1
                    return `hsl(120, ${70 + intensity * 30}%, ${40 + intensity * 20}%)`; // Light to bright green
                } else if (percentage >= 50) {
                    // Orange to Yellow gradient (50-75%)
                    const intensity = (percentage - 50) / 25; // 0 to 1
                    const hue = 30 + intensity * 30; // Orange (30) to Yellow (60)
                    return `hsl(${hue}, ${80 + intensity * 20}%, ${50 + intensity * 10}%)`;
                } else {
                    // Red gradient (0-50%)
                    const intensity = percentage / 50; // 0 to 1
                    return `hsl(0, ${70 + intensity * 30}%, ${35 + intensity * 15}%)`; // Dark to bright red
                }
            }

            // Get gradient for probability background
            getProbabilityGradient(percentage) {
                if (percentage >= 75) {
                    return `linear-gradient(135deg, #22c55e, #16a34a, #15803d)`;
                } else if (percentage >= 50) {
                    const orangeIntensity = (percentage - 50) / 25;
                    if (orangeIntensity > 0.5) {
                        return `linear-gradient(135deg, #f59e0b, #eab308, #ca8a04)`;
                    } else {
                        return `linear-gradient(135deg, #ea580c, #f59e0b, #d97706)`;
                    }
                } else {
                    return `linear-gradient(135deg, #dc2626, #ef4444, #f87171)`;
                }
            }

            // Get animation type based on probability
            getProbabilityAnimation(percentage) {
                if (percentage >= 75) {
                    return 'successPulse'; // Green - success animation
                } else if (percentage >= 50) {
                    return 'warningGlow'; // Orange/Yellow - warning animation
                } else {
                    return 'dangerFlicker'; // Red - danger animation
                }
            }

            // 🎨 Specialized Probability Zone Color System

            // Zone Background - Subtle and elegant
            getProbabilityZoneBackground(percentage) {
                if (percentage >= 75) {
                    return 'linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.25))';
                } else if (percentage >= 50) {
                    return 'linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(234, 179, 8, 0.25))';
                } else {
                    return 'linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(239, 68, 68, 0.25))';
                }
            }

            // Zone Border - Complementary colors
            getProbabilityZoneBorder(percentage) {
                if (percentage >= 75) {
                    return 'rgba(34, 197, 94, 0.6)';
                } else if (percentage >= 50) {
                    return 'rgba(245, 158, 11, 0.6)';
                } else {
                    return 'rgba(220, 38, 38, 0.6)';
                }
            }

            // Zone Glow - Soft outer glow
            getProbabilityZoneGlow(percentage) {
                if (percentage >= 75) {
                    return 'rgba(34, 197, 94, 0.3)';
                } else if (percentage >= 50) {
                    return 'rgba(245, 158, 11, 0.3)';
                } else {
                    return 'rgba(220, 38, 38, 0.3)';
                }
            }

            // Text Color - High contrast and readable
            getProbabilityTextColor(percentage) {
                if (percentage >= 75) {
                    return '#ffffff'; // Pure white for green background
                } else if (percentage >= 50) {
                    return '#1f2937'; // Dark gray for yellow/orange background
                } else {
                    return '#ffffff'; // Pure white for red background
                }
            }

            // Text Glow - Enhances readability
            getProbabilityTextGlow(percentage) {
                if (percentage >= 75) {
                    return 'rgba(34, 197, 94, 0.8)';
                } else if (percentage >= 50) {
                    return 'rgba(245, 158, 11, 0.8)';
                } else {
                    return 'rgba(220, 38, 38, 0.8)';
                }
            }

            // Track Color - Progress bar background
            getProbabilityTrackColor(percentage) {
                if (percentage >= 75) {
                    return 'rgba(34, 197, 94, 0.2)';
                } else if (percentage >= 50) {
                    return 'rgba(245, 158, 11, 0.2)';
                } else {
                    return 'rgba(220, 38, 38, 0.2)';
                }
            }

            // Track Border - Progress bar border
            getProbabilityTrackBorder(percentage) {
                if (percentage >= 75) {
                    return 'rgba(34, 197, 94, 0.4)';
                } else if (percentage >= 50) {
                    return 'rgba(245, 158, 11, 0.4)';
                } else {
                    return 'rgba(220, 38, 38, 0.4)';
                }
            }

            // Fill Gradient - Progress bar fill
            getProbabilityFillGradient(percentage) {
                if (percentage >= 75) {
                    return 'linear-gradient(90deg, #10b981, #34d399, #6ee7b7)';
                } else if (percentage >= 50) {
                    return 'linear-gradient(90deg, #f59e0b, #fbbf24, #fde047)';
                } else {
                    return 'linear-gradient(90deg, #ef4444, #f87171, #fca5a5)';
                }
            }

            // Fill Glow - Progress bar glow
            getProbabilityFillGlow(percentage) {
                if (percentage >= 75) {
                    return 'rgba(16, 185, 129, 0.6)';
                } else if (percentage >= 50) {
                    return 'rgba(245, 158, 11, 0.6)';
                } else {
                    return 'rgba(239, 68, 68, 0.6)';
                }
            }

            // Label Color - Bottom label
            getProbabilityLabelColor(percentage) {
                if (percentage >= 75) {
                    return '#d1fae5'; // Light green
                } else if (percentage >= 50) {
                    return '#fef3c7'; // Light yellow
                } else {
                    return '#fee2e2'; // Light red
                }
            }

            // Zone Animation - Overall zone animation
            getProbabilityZoneAnimation(percentage) {
                if (percentage >= 75) {
                    return 'zoneSuccessBreath';
                } else if (percentage >= 50) {
                    return 'zoneWarningPulse';
                } else {
                    return 'zoneDangerAlert';
                }
            }

            // Text Animation - Number animation
            getProbabilityTextAnimation(percentage) {
                if (percentage >= 75) {
                    return 'textSuccessGlow';
                } else if (percentage >= 50) {
                    return 'textWarningShimmer';
                } else {
                    return 'textDangerFlash';
                }
            }

            // Fill Animation - Progress bar animation
            getProbabilityFillAnimation(percentage) {
                if (percentage >= 75) {
                    return 'fillSuccessFlow';
                } else if (percentage >= 50) {
                    return 'fillWarningWave';
                } else {
                    return 'fillDangerPulse';
                }
            }

            // Particle Pattern - Background pattern
            getProbabilityParticlePattern(percentage) {
                if (percentage >= 75) {
                    return `radial-gradient(circle at 20% 30%, rgba(34, 197, 94, 0.3) 2px, transparent 2px),
                            radial-gradient(circle at 70% 80%, rgba(16, 185, 129, 0.3) 1px, transparent 1px),
                            radial-gradient(circle at 90% 20%, rgba(34, 197, 94, 0.2) 1.5px, transparent 1.5px)`;
                } else if (percentage >= 50) {
                    return `radial-gradient(circle at 25% 25%, rgba(245, 158, 11, 0.3) 2px, transparent 2px),
                            radial-gradient(circle at 75% 75%, rgba(234, 179, 8, 0.3) 1px, transparent 1px),
                            radial-gradient(circle at 50% 90%, rgba(245, 158, 11, 0.2) 1.5px, transparent 1.5px)`;
                } else {
                    return `radial-gradient(circle at 30% 70%, rgba(220, 38, 38, 0.3) 2px, transparent 2px),
                            radial-gradient(circle at 80% 30%, rgba(239, 68, 68, 0.3) 1px, transparent 1px),
                            radial-gradient(circle at 10% 10%, rgba(220, 38, 38, 0.2) 1.5px, transparent 1.5px)`;
                }
            }

            // Sparkle Effect - Special effects for high probability
            getProbabilitySparkleEffect(percentage) {
                if (percentage >= 75) {
                    return `
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: linear-gradient(90deg,
                                transparent,
                                rgba(255, 255, 255, 0.8),
                                transparent);
                            animation: sparkleMove 3s linear infinite;
                            border-radius: 15px;
                        "></div>
                        <div style="
                            position: absolute;
                            top: 50%;
                            left: ${percentage}%;
                            transform: translate(-50%, -50%);
                            width: 6px;
                            height: 6px;
                            background: radial-gradient(circle, #ffffff, transparent);
                            border-radius: 50%;
                            animation: sparkleGlow 2s ease-in-out infinite;
                        "></div>
                    `;
                } else if (percentage >= 50) {
                    return `
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: linear-gradient(90deg,
                                transparent,
                                rgba(255, 255, 255, 0.5),
                                transparent);
                            animation: sparkleMove 4s linear infinite;
                            border-radius: 15px;
                        "></div>
                    `;
                } else {
                    return '';
                }
            }

            // 🏷️ Footer Color System - Complementary to probability zone

            getFooterBackground(percentage) {
                if (percentage >= 75) {
                    return 'linear-gradient(135deg, rgba(5, 150, 105, 0.9), rgba(6, 120, 85, 0.95))';
                } else if (percentage >= 50) {
                    return 'linear-gradient(135deg, rgba(217, 119, 6, 0.9), rgba(180, 83, 9, 0.95))';
                } else {
                    return 'linear-gradient(135deg, rgba(185, 28, 28, 0.9), rgba(153, 27, 27, 0.95))';
                }
            }

            getFooterBorder(percentage) {
                if (percentage >= 75) {
                    return 'rgba(5, 150, 105, 0.7)';
                } else if (percentage >= 50) {
                    return 'rgba(217, 119, 6, 0.7)';
                } else {
                    return 'rgba(185, 28, 28, 0.7)';
                }
            }

            getFooterTopBorder(percentage) {
                if (percentage >= 75) {
                    return 'rgba(34, 197, 94, 0.8)';
                } else if (percentage >= 50) {
                    return 'rgba(245, 158, 11, 0.8)';
                } else {
                    return 'rgba(220, 38, 38, 0.8)';
                }
            }

            getFooterTextColor(percentage) {
                return '#ffffff'; // Always white for good contrast
            }

            getFooterSubtitleColor(percentage) {
                if (percentage >= 75) {
                    return 'rgba(255, 255, 255, 0.8)';
                } else if (percentage >= 50) {
                    return 'rgba(255, 255, 255, 0.85)';
                } else {
                    return 'rgba(255, 255, 255, 0.8)';
                }
            }

            getFooterGlow(percentage) {
                if (percentage >= 75) {
                    return 'rgba(5, 150, 105, 0.4)';
                } else if (percentage >= 50) {
                    return 'rgba(217, 119, 6, 0.4)';
                } else {
                    return 'rgba(185, 28, 28, 0.4)';
                }
            }

            getFooterTextGlow(percentage) {
                if (percentage >= 75) {
                    return 'rgba(34, 197, 94, 0.6)';
                } else if (percentage >= 50) {
                    return 'rgba(245, 158, 11, 0.6)';
                } else {
                    return 'rgba(220, 38, 38, 0.6)';
                }
            }

            getFooterAnimation(percentage) {
                if (percentage >= 75) {
                    return 'footerSuccessGlow';
                } else if (percentage >= 50) {
                    return 'footerWarningPulse';
                } else {
                    return 'footerDangerFlicker';
                }
            }

            getCardGradient(percentage) {
                if (percentage >= 80) {
                    return 'linear-gradient(135deg, #39ff14 0%, #00ff88 50%, #00d4ff 100%)'; // Legendary
                } else if (percentage >= 60) {
                    return 'linear-gradient(135deg, #00d4ff 0%, #667eea 50%, #764ba2 100%)'; // Epic
                } else if (percentage >= 40) {
                    return 'linear-gradient(135deg, #ffd700 0%, #ff8c00 50%, #ff4500 100%)'; // Rare
                } else if (percentage >= 20) {
                    return 'linear-gradient(135deg, #ff4500 0%, #ff6b6b 50%, #ff8e8e 100%)'; // Uncommon
                } else {
                    return 'linear-gradient(135deg, #ff0080 0%, #8e44ad 50%, #3f51b5 100%)'; // Common
                }
            }

            getRatingColor(rating) {
                if (rating >= 90) return 'linear-gradient(135deg, #ffd700, #ffed4e)'; // Gold
                if (rating >= 85) return 'linear-gradient(135deg, #c0392b, #e74c3c)'; // Red
                if (rating >= 80) return 'linear-gradient(135deg, #8e44ad, #9b59b6)'; // Purple
                if (rating >= 75) return 'linear-gradient(135deg, #2980b9, #3498db)'; // Blue
                return 'linear-gradient(135deg, #27ae60, #2ecc71)'; // Green
            }

            getPlayerImageUrl(player) {
                // Check for both playerImage and imageUrl properties
                const imageUrl = player.playerImage || player.imageUrl;
                if (imageUrl && imageUrl.startsWith('http')) {
                    return imageUrl;
                }
                return this.getFallbackImageUrl(player.arabicName || player.name || 'لاعب');
            }

            getFallbackImageUrl(playerName) {
                const initials = playerName.split(' ')
                    .map(word => word.charAt(0))
                    .join('')
                    .substring(0, 2);

                return `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&size=300&background=667eea&color=fff&bold=true&format=png`;
            }

            // 🎵 Audio System
            setupAudioSystem() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('🎵 Audio system initialized');
                } catch (error) {
                    console.warn('🔇 Audio not available:', error);
                }
            }

            // 🎵 Professional Sound System
            playCreationSound() {
                if (!this.audioContext || this.settings.soundEffects === 'disabled') return;

                try {
                    this.playFIFAStyleSound();
                } catch (error) {
                    console.warn('🔇 Sound playback failed:', error);
                }
            }

            playFIFAStyleSound() {
                const now = this.audioContext.currentTime;

                // Create a professional FIFA-style sound
                // Main chord (C major)
                this.playNote(261.63, now, 0.8, 0.05); // C
                this.playNote(329.63, now + 0.1, 0.6, 0.04); // E
                this.playNote(392.00, now + 0.2, 0.8, 0.06); // G

                // High sparkle
                this.playNote(523.25, now + 0.3, 0.4, 0.03); // C (octave)
                this.playNote(659.25, now + 0.4, 0.3, 0.02); // E (octave)

                // Success chime
                this.playNote(783.99, now + 0.5, 0.5, 0.04); // G (octave)
                this.playNote(1046.50, now + 0.6, 0.3, 0.03); // C (2 octaves)
            }

            playNote(frequency, startTime, duration, volume) {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                const filterNode = this.audioContext.createBiquadFilter();

                // Professional sound shaping
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequency, startTime);

                // Add slight vibrato for richness
                const vibrato = this.audioContext.createOscillator();
                const vibratoGain = this.audioContext.createGain();
                vibrato.frequency.setValueAtTime(5, startTime); // 5Hz vibrato
                vibratoGain.gain.setValueAtTime(2, startTime); // 2Hz depth

                vibrato.connect(vibratoGain);
                vibratoGain.connect(oscillator.frequency);

                // Low-pass filter for warmth
                filterNode.type = 'lowpass';
                filterNode.frequency.setValueAtTime(2000, startTime);
                filterNode.Q.setValueAtTime(1, startTime);

                // Professional envelope (ADSR)
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.05); // Attack
                gainNode.gain.linearRampToValueAtTime(volume * 0.7, startTime + 0.1); // Decay
                gainNode.gain.setValueAtTime(volume * 0.7, startTime + duration - 0.1); // Sustain
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration); // Release

                // Connect the audio graph
                oscillator.connect(filterNode);
                filterNode.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                // Start and stop
                oscillator.start(startTime);
                vibrato.start(startTime);
                oscillator.stop(startTime + duration);
                vibrato.stop(startTime + duration);
            }

            // Enhanced sound for sequence transitions
            playSequenceTransitionSound() {
                if (!this.audioContext || this.settings.soundEffects === 'disabled') return;

                try {
                    const now = this.audioContext.currentTime;

                    // Quick transition sound
                    this.playNote(440, now, 0.2, 0.03);
                    this.playNote(554.37, now + 0.1, 0.2, 0.02);
                } catch (error) {
                    console.warn('🔇 Transition sound failed:', error);
                }
            }

            // 🌟 Particle System
            setupParticleSystem() {
                console.log('✨ Initializing particle system...');
                // Particle system will be initialized when visualization is created
            }

            initializeParticleEffects() {
                const canvas = document.getElementById('particleCanvas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;

                const particles = [];
                const particleCount = 50;

                // Create particles
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        size: Math.random() * 3 + 1,
                        opacity: Math.random() * 0.5 + 0.2,
                        color: this.getRandomParticleColor()
                    });
                }

                // Animate particles
                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    particles.forEach(particle => {
                        particle.x += particle.vx;
                        particle.y += particle.vy;

                        // Wrap around edges
                        if (particle.x < 0) particle.x = canvas.width;
                        if (particle.x > canvas.width) particle.x = 0;
                        if (particle.y < 0) particle.y = canvas.height;
                        if (particle.y > canvas.height) particle.y = 0;

                        // Draw particle
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                        ctx.fillStyle = particle.color;
                        ctx.globalAlpha = particle.opacity;
                        ctx.fill();
                    });

                    requestAnimationFrame(animate);
                };

                animate();
            }

            getRandomParticleColor() {
                const colors = ['#667eea', '#764ba2', '#f093fb', '#00d4ff', '#39ff14', '#ffd700'];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            // 🎨 Animation Systems
            startQuantumAnimations() {
                // Add quantum field effect to body
                setInterval(() => {
                    document.body.style.filter = `hue-rotate(${Date.now() / 100 % 360}deg)`;
                }, 100);
            }

            startCosmicAnimations() {
                const visualization = document.querySelector('.ultimate-visualization');
                if (visualization) {
                    visualization.style.animation = 'cosmicPulse 4s ease-in-out infinite';
                }
            }

            // 📱 Utility Methods
            getFormData() {
                return {
                    playerName: document.getElementById('playerName')?.value?.trim() || '',
                    currentClub: document.getElementById('currentClub')?.value?.trim() || '',
                    targetClub: document.getElementById('targetClub')?.value?.trim() || '',
                    playerImage: document.getElementById('playerImage')?.value?.trim() || ''
                };
            }

            validateInput(formData) {
                if (!formData.playerName) {
                    return { isValid: false, message: '🚨 اسم اللاعب مطلوب', field: 'playerName' };
                }
                if (!formData.currentClub) {
                    return { isValid: false, message: '🚨 النادي الحالي مطلوب', field: 'currentClub' };
                }
                if (!formData.targetClub) {
                    return { isValid: false, message: '🚨 النادي المطلوب مطلوب', field: 'targetClub' };
                }
                if (formData.playerName.length < 2) {
                    return { isValid: false, message: '🚨 اسم اللاعب قصير جداً', field: 'playerName' };
                }
                return { isValid: true };
            }

            highlightInvalidField(fieldName) {
                const field = document.getElementById(fieldName);
                if (field) {
                    field.style.borderColor = '#ff0080';
                    field.style.boxShadow = '0 0 0 4px rgba(255, 0, 128, 0.3)';
                    field.focus();
                    setTimeout(() => {
                        field.style.borderColor = '';
                        field.style.boxShadow = '';
                    }, 3000);
                }
            }

            clearForm() {
                // Don't clear form automatically - keep user data
                console.log('📝 Form data preserved for user convenience');
            }

            // 🔄 Enhanced Data Processing - Using Real API
            async getEnhancedPlayerData(formData) {
                try {
                    // Use the same API as the main page
                    const response = await fetch('/api/search-player', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            arabicName: formData.playerName,
                            targetClub: formData.targetClub,
                            currentClub: formData.currentClub
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Extract probability from the real API response
                        const probability = data.targetRumor?.probability || '0%';
                        const probabilityValue = parseInt(probability.match(/(\d+)/)?.[1] || '0');

                        // Get club logos with detailed logging
                        console.log('🔍 Getting club logos for:', {
                            currentClub: data.currentClub || formData.currentClub,
                            targetClub: formData.targetClub
                        });

                        const currentClubLogo = await this.getClubLogo(data.currentClub || formData.currentClub);
                        const targetClubLogo = await this.getClubLogo(formData.targetClub);

                        console.log('🏆 Club logos loaded:', {
                            current: currentClubLogo,
                            target: targetClubLogo,
                            currentClubName: data.currentClub || formData.currentClub,
                            targetClubName: formData.targetClub
                        });

                        // Log age data for debugging
                        console.log('🎂 Age data analysis:', {
                            'data.data?.age': data.data?.age,
                            'data.data?.playerAge': data.data?.playerAge,
                            'data.age': data.age,
                            'finalAge': data.data?.age || data.data?.playerAge || 'غير محدد'
                        });

                        return {
                            arabicName: formData.playerName,
                            englishName: data.englishName || formData.playerName,
                            currentClub: data.currentClub || formData.currentClub,
                            targetClub: formData.targetClub,
                            imageUrl: formData.playerImage || data.data?.playerImage,
                            currentClubLogo: currentClubLogo,
                            targetClubLogo: targetClubLogo,
                            probability: {
                                percentage: probabilityValue,
                                display: probability,
                                factors: this.generateFactorsFromRealData(data),
                                confidence: this.calculateConfidenceFromReal(data),
                                trend: this.calculateTrendFromReal(probabilityValue)
                            },
                            position: data.data?.playerPosition || data.playerPosition || this.getPlayerPosition(formData.playerName),
                            age: data.data?.age || data.data?.playerAge || 'غير محدد',
                            marketValue: data.data?.marketValue || this.calculateMarketValue(formData.playerName, formData.currentClub),
                            contractExpiry: data.data?.contractExpiry || this.generateContractExpiry(),
                            nationality: data.data?.nationality || this.getPlayerNationality(formData.playerName),
                            height: data.data?.height || this.getPlayerHeight(formData.playerName),
                            foot: data.data?.preferredFoot || this.getPlayerFoot(formData.playerName),
                            rating: this.calculatePlayerRating(formData.playerName, formData.currentClub),
                            allRumors: data.allRumors || []
                        };
                    } else {
                        throw new Error(data.error || 'فشل في البحث');
                    }
                } catch (error) {
                    console.error('🚨 Error getting real player data:', error);
                    // Fallback to local calculation if API fails
                    return this.getFallbackPlayerData(formData);
                }
            }

            // Fallback method if API fails
            async getFallbackPlayerData(formData) {
                console.log('🔄 Using fallback data for:', formData);

                const probability = this.calculateLocalProbability(formData.playerName, formData.targetClub);

                // Get club logos for fallback data with detailed logging
                console.log('🔍 Getting fallback logos for:', {
                    currentClub: formData.currentClub,
                    targetClub: formData.targetClub
                });

                const currentClubLogo = await this.getClubLogo(formData.currentClub || 'غير محدد');
                const targetClubLogo = await this.getClubLogo(formData.targetClub || 'غير محدد');

                console.log('🏆 Fallback logos loaded:', {
                    current: currentClubLogo,
                    target: targetClubLogo
                });

                return {
                    arabicName: formData.playerName,
                    englishName: formData.playerName,
                    currentClub: formData.currentClub || 'غير محدد',
                    targetClub: formData.targetClub || 'غير محدد',
                    imageUrl: formData.playerImage,
                    currentClubLogo: currentClubLogo,
                    targetClubLogo: targetClubLogo,
                    probability: {
                        percentage: probability,
                        display: probability + '%',
                        factors: ['تحليل محلي', 'بيانات أساسية'],
                        confidence: 'متوسطة',
                        trend: this.calculateTrendFromReal(probability)
                    },
                    position: this.getPlayerPosition(formData.playerName),
                    age: 'غير محدد', // Don't use local age calculation
                    marketValue: this.calculateMarketValue(formData.playerName, formData.currentClub),
                    contractExpiry: this.generateContractExpiry(),
                    nationality: this.getPlayerNationality(formData.playerName),
                    height: this.getPlayerHeight(formData.playerName),
                    foot: this.getPlayerFoot(formData.playerName),
                    rating: this.calculatePlayerRating(formData.playerName, formData.currentClub),
                    allRumors: []
                };
            }

            // Generate factors from real API data
            generateFactorsFromRealData(data) {
                const factors = [];

                if (data.targetRumor) {
                    factors.push('شائعة مؤكدة من المصادر');
                }

                if (data.allRumors && data.allRumors.length > 0) {
                    factors.push(`${data.allRumors.length} شائعة إضافية`);
                }

                if (data.currentClub) {
                    factors.push(`يلعب حالياً في ${data.currentClub}`);
                }

                if (data.playerPosition) {
                    factors.push(`مركز: ${data.playerPosition}`);
                }

                // Add some default factors if none found
                if (factors.length === 0) {
                    factors.push('تحليل السوق الحالي', 'تقييم الخبراء');
                }

                return factors;
            }

            calculateConfidenceFromReal(data) {
                let score = 0;

                if (data.targetRumor) score += 2;
                if (data.allRumors && data.allRumors.length > 0) score += 1;
                if (data.englishName) score += 1;
                if (data.currentClub) score += 1;

                if (score >= 4) return 'عالية';
                if (score >= 2) return 'متوسطة';
                return 'منخفضة';
            }

            calculateTrendFromReal(probability) {
                if (probability >= 70) return 'محتمل جداً';
                if (probability >= 50) return 'محتمل';
                if (probability >= 30) return 'ممكن';
                return 'غير محتمل';
            }

            // Local probability calculation (same as server.js)
            calculateLocalProbability(playerName, targetClub) {
                let baseProbability = 45;

                // Player-based adjustments (same as server.js)
                if (playerName.includes('محمد صلاح')) baseProbability = 75;
                else if (playerName.includes('صلاح')) baseProbability += 20;
                else if (playerName.includes('محمد') || playerName.includes('أحمد')) baseProbability += 10;
                else if (playerName.includes('مانه') || playerName.includes('فيرمينو')) baseProbability += 15;
                else if (playerName.includes('بنزيما')) baseProbability += 18;
                else if (playerName.includes('رونالدو')) baseProbability += 22;
                else if (playerName.includes('ميسي')) baseProbability += 20;
                else if (playerName.includes('نيمار')) baseProbability += 17;
                else if (playerName.includes('مبابي')) baseProbability += 19;

                // Club-based adjustments (same as server.js)
                const bigClubs = ['ريال مدريد', 'برشلونة', 'مانشستر سيتي', 'ليفربول', 'باريس سان جيرمان', 'بايرن ميونخ'];
                const saudiClubs = ['الهلال', 'النصر', 'الاتحاد', 'الأهلي'];

                if (bigClubs.includes(targetClub)) {
                    baseProbability += 15;
                } else if (saudiClubs.includes(targetClub)) {
                    baseProbability += 25; // Saudi clubs have high transfer success
                }

                // Use consistent hash-based variation (same as server.js)
                const nameHash = playerName.split('').reduce((hash, char) => {
                    return ((hash << 5) - hash) + char.charCodeAt(0);
                }, 0);

                const clubHash = targetClub.split('').reduce((hash, char) => {
                    return ((hash << 5) - hash) + char.charCodeAt(0);
                }, 0);

                // Create consistent variation based on name and club
                const variation = ((Math.abs(nameHash + clubHash) % 16) - 8); // -8 to +8
                const finalProbability = Math.max(20, Math.min(90, baseProbability + variation));

                return finalProbability;
            }

            // 🎯 Enhanced Player Data Extraction (Professional Database)
            getPlayerPosition(playerName) {
                const playerData = {
                    'محمد صلاح': 'RW',
                    'صلاح': 'RW',
                    'كريم بنزيما': 'ST',
                    'بنزيما': 'ST',
                    'ساديو مانه': 'LW',
                    'مانه': 'LW',
                    'نيمار': 'LW',
                    'كيليان مبابي': 'ST',
                    'مبابي': 'ST',
                    'إرلينغ هالاند': 'ST',
                    'هالاند': 'ST',
                    'كريستيانو رونالدو': 'ST',
                    'رونالدو': 'ST',
                    'ليونيل ميسي': 'CAM',
                    'ميسي': 'CAM',
                    'كيفن دي بروين': 'CAM',
                    'دي بروين': 'CAM',
                    'لوكا مودريتش': 'CM',
                    'مودريتش': 'CM',
                    'فيرجيل فان دايك': 'CB',
                    'فان دايك': 'CB',
                    'سيرجيو راموس': 'CB',
                    'راموس': 'CB',
                    'مانويل نوير': 'GK',
                    'نوير': 'GK'
                };

                // Check exact match first
                if (playerData[playerName]) {
                    return playerData[playerName];
                }

                // Check partial matches
                for (const [key, position] of Object.entries(playerData)) {
                    if (playerName.includes(key) || key.includes(playerName)) {
                        return position;
                    }
                }

                // Default positions based on name patterns
                if (playerName.includes('محمد') || playerName.includes('أحمد')) return 'ST';
                if (playerName.includes('عبد') || playerName.includes('علي')) return 'CM';
                if (playerName.includes('حارس')) return 'GK';

                const positions = ['ST', 'CM', 'CB', 'LW', 'RW', 'CAM'];
                return positions[Math.floor(Math.random() * positions.length)];
            }

            getPlayerAge(playerName) {
                const playerAges = {
                    'محمد صلاح': 32,
                    'صلاح': 32,
                    'كريم بنزيما': 36,
                    'بنزيما': 36,
                    'ساديو مانه': 32,
                    'مانه': 32,
                    'نيمار': 32,
                    'كيليان مبابي': 25,
                    'مبابي': 25,
                    'إرلينغ هالاند': 24,
                    'هالاند': 24,
                    'كريستيانو رونالدو': 39,
                    'رونالدو': 39,
                    'ليونيل ميسي': 37,
                    'ميسي': 37,
                    'كيفن دي بروين': 33,
                    'دي بروين': 33,
                    'لوكا مودريتش': 39,
                    'مودريتش': 39,
                    'فيرجيل فان دايك': 33,
                    'فان دايك': 33,
                    'سيرجيو راموس': 38,
                    'راموس': 38,
                    'مانويل نوير': 38,
                    'نوير': 38
                };

                // Check exact match first
                if (playerAges[playerName]) {
                    return playerAges[playerName];
                }

                // Check partial matches
                for (const [key, age] of Object.entries(playerAges)) {
                    if (playerName.includes(key) || key.includes(playerName)) {
                        return age;
                    }
                }

                // Generate realistic age based on name hash for consistency
                const nameHash = playerName.split('').reduce((hash, char) => {
                    return ((hash << 5) - hash) + char.charCodeAt(0);
                }, 0);

                return 20 + (Math.abs(nameHash) % 16); // 20-35 years
            }

            getPlayerNationality(playerName) {
                const nationalities = {
                    'محمد صلاح': 'مصر',
                    'صلاح': 'مصر',
                    'كريم بنزيما': 'فرنسا',
                    'بنزيما': 'فرنسا',
                    'ساديو مانه': 'السنغال',
                    'مانه': 'السنغال',
                    'نيمار': 'البرازيل',
                    'كيليان مبابي': 'فرنسا',
                    'مبابي': 'فرنسا',
                    'إرلينغ هالاند': 'النرويج',
                    'هالاند': 'النرويج',
                    'كريستيانو رونالدو': 'البرتغال',
                    'رونالدو': 'البرتغال',
                    'ليونيل ميسي': 'الأرجنتين',
                    'ميسي': 'الأرجنتين',
                    'كيفن دي بروين': 'بلجيكا',
                    'دي بروين': 'بلجيكا',
                    'لوكا مودريتش': 'كرواتيا',
                    'مودريتش': 'كرواتيا',
                    'فيرجيل فان دايك': 'هولندا',
                    'فان دايك': 'هولندا',
                    'سيرجيو راموس': 'إسبانيا',
                    'راموس': 'إسبانيا',
                    'مانويل نوير': 'ألمانيا',
                    'نوير': 'ألمانيا'
                };

                // Check exact and partial matches
                for (const [key, nationality] of Object.entries(nationalities)) {
                    if (playerName.includes(key) || key.includes(playerName)) {
                        return nationality;
                    }
                }

                // Default nationalities based on name patterns
                if (playerName.includes('محمد') || playerName.includes('أحمد') || playerName.includes('علي')) {
                    const arabCountries = ['مصر', 'السعودية', 'المغرب', 'الجزائر', 'تونس'];
                    return arabCountries[Math.floor(Math.random() * arabCountries.length)];
                }

                const countries = ['البرازيل', 'الأرجنتين', 'فرنسا', 'إسبانيا', 'إيطاليا', 'ألمانيا', 'إنجلترا'];
                return countries[Math.floor(Math.random() * countries.length)];
            }

            getPlayerHeight(playerName) {
                const heights = {
                    'محمد صلاح': '175 سم',
                    'كريم بنزيما': '185 سم',
                    'ساديو مانه': '175 سم',
                    'نيمار': '175 سم',
                    'كيليان مبابي': '178 سم',
                    'إرلينغ هالاند': '194 سم',
                    'كريستيانو رونالدو': '187 سم',
                    'ليونيل ميسي': '170 سم'
                };

                for (const [key, height] of Object.entries(heights)) {
                    if (playerName.includes(key) || key.includes(playerName)) {
                        return height;
                    }
                }

                // Generate realistic height
                const baseHeight = 170 + Math.floor(Math.random() * 25); // 170-195 cm
                return `${baseHeight} سم`;
            }

            getPlayerFoot(playerName) {
                const feet = {
                    'محمد صلاح': 'أيسر',
                    'كريم بنزيما': 'أيمن',
                    'ساديو مانه': 'أيمن',
                    'نيمار': 'أيمن',
                    'كيليان مبابي': 'أيمن',
                    'إرلينغ هالاند': 'أيسر',
                    'كريستيانو رونالدو': 'أيمن',
                    'ليونيل ميسي': 'أيسر'
                };

                for (const [key, foot] of Object.entries(feet)) {
                    if (playerName.includes(key) || key.includes(playerName)) {
                        return foot;
                    }
                }

                return Math.random() > 0.5 ? 'أيمن' : 'أيسر';
            }

            calculatePlayerRating(playerName, currentClub) {
                const starPlayers = {
                    'محمد صلاح': 89,
                    'صلاح': 89,
                    'كريم بنزيما': 91,
                    'بنزيما': 91,
                    'ساديو مانه': 86,
                    'مانه': 86,
                    'نيمار': 89,
                    'كيليان مبابي': 91,
                    'مبابي': 91,
                    'إرلينغ هالاند': 88,
                    'هالاند': 88,
                    'كريستيانو رونالدو': 87,
                    'رونالدو': 87,
                    'ليونيل ميسي': 91,
                    'ميسي': 91,
                    'كيفن دي بروين': 91,
                    'دي بروين': 91,
                    'لوكا مودريتش': 88,
                    'مودريتش': 88,
                    'فيرجيل فان دايك': 90,
                    'فان دايك': 90,
                    'سيرجيو راموس': 86,
                    'راموس': 86,
                    'مانويل نوير': 90,
                    'نوير': 90
                };

                for (const [key, rating] of Object.entries(starPlayers)) {
                    if (playerName.includes(key) || key.includes(playerName)) {
                        return rating;
                    }
                }

                // Base rating calculation
                let baseRating = 75;

                const topClubs = ['ريال مدريد', 'برشلونة', 'مانشستر سيتي', 'ليفربول', 'باريس سان جيرمان'];
                if (topClubs.includes(currentClub)) {
                    baseRating += 8;
                }

                const saudiClubs = ['الهلال', 'النصر', 'الاتحاد', 'الأهلي'];
                if (saudiClubs.includes(currentClub)) {
                    baseRating += 5;
                }

                // Add some variation
                const variation = Math.floor(Math.random() * 11) - 5; // -5 to +5
                return Math.max(65, Math.min(94, baseRating + variation));
            }

            calculateMarketValue(playerName, currentClub) {
                let baseValue = Math.floor(Math.random() * 50) + 10; // 10-60M

                const topClubs = ['ريال مدريد', 'برشلونة', 'مانشستر سيتي', 'ليفربول'];
                if (topClubs.includes(currentClub)) {
                    baseValue += 20;
                }

                return `€${baseValue}M`;
            }

            generateContractExpiry() {
                const currentYear = new Date().getFullYear();
                const expiryYear = currentYear + Math.floor(Math.random() * 4) + 1;
                return `${expiryYear}`;
            }

            // 💾 Saved Players Management
            async loadSavedPlayers() {
                const select = document.getElementById('savedPlayersList');
                if (!select) return;

                select.innerHTML = '<option value="">جاري تحميل قاعدة البيانات...</option>';

                try {
                    // Use the correct API endpoint from player-links system
                    const response = await fetch('/api/player-pages-cache-stats');

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success && data.data && data.data.entries && data.data.entries.length > 0) {
                        select.innerHTML = '<option value="">اختر لاعب محفوظ...</option>';
                        data.data.entries.forEach((player, index) => {
                            const option = document.createElement('option');
                            // Create a simplified player object for the Ultimate Studio
                            const playerData = {
                                arabicName: player.name || `لاعب ${index + 1}`,
                                currentClub: player.currentClub || 'غير محدد',
                                playerImage: player.playerImage || '',
                                pageUrl: player.url || ''
                            };
                            option.value = JSON.stringify(playerData);
                            option.textContent = `${playerData.arabicName} - ${playerData.currentClub}`;
                            select.appendChild(option);
                        });
                        console.log(`📋 تم تحميل ${data.data.entries.length} لاعب محفوظ`);
                        this.showNotification(`📋 تم تحميل ${data.data.entries.length} لاعب من قاعدة البيانات`, 'success');
                    } else {
                        // Try alternative API endpoint
                        try {
                            const altResponse = await fetch('/api/get-player-pages');
                            const altData = await altResponse.json();

                            if (altData.success && altData.data) {
                                select.innerHTML = '<option value="">اختر لاعب محفوظ...</option>';
                                Object.values(altData.data).forEach((player, index) => {
                                    const option = document.createElement('option');
                                    const playerData = {
                                        arabicName: player.arabicName || player.name || `لاعب ${index + 1}`,
                                        currentClub: player.currentClub || 'غير محدد',
                                        playerImage: player.playerImage || '',
                                        pageUrl: player.pageUrl || ''
                                    };
                                    option.value = JSON.stringify(playerData);
                                    option.textContent = `${playerData.arabicName} - ${playerData.currentClub}`;
                                    select.appendChild(option);
                                });
                                console.log(`📋 تم تحميل ${Object.keys(altData.data).length} لاعب محفوظ (API بديل)`);
                                this.showNotification(`📋 تم تحميل ${Object.keys(altData.data).length} لاعب من قاعدة البيانات`, 'success');
                            } else {
                                select.innerHTML = '<option value="">لا توجد لاعبين محفوظين</option>';
                                console.log('ℹ️ لا توجد لاعبين محفوظين في كلا الـ APIs');
                                this.showNotification('ℹ️ لا توجد لاعبين محفوظين - يمكنك إضافة لاعبين من صفحة إدارة الروابط', 'info');
                            }
                        } catch (altError) {
                            select.innerHTML = '<option value="">لا توجد لاعبين محفوظين</option>';
                            console.log('ℹ️ لا توجد لاعبين محفوظين');
                            this.showNotification('ℹ️ لا توجد لاعبين محفوظين - يمكنك إضافة لاعبين من صفحة إدارة الروابط', 'info');
                        }
                    }
                } catch (error) {
                    select.innerHTML = '<option value="">خطأ في الاتصال</option>';
                    console.error('🚨 Error loading saved players:', error);
                    this.showNotification('❌ فشل في تحميل اللاعبين المحفوظين', 'error');
                }
            }

            async loadSavedPlayer() {
                const selectedPlayer = document.getElementById('savedPlayersList').value;
                const targetClub = document.getElementById('savedPlayerTargetClub').value.trim();

                if (!selectedPlayer) {
                    this.showNotification('🚨 يرجى اختيار لاعب', 'warning');
                    return;
                }

                if (!targetClub) {
                    this.showNotification('🚨 يرجى إدخال النادي المطلوب', 'warning');
                    return;
                }

                this.isProcessing = true;
                this.updateSystemStatus('جاري تحميل اللاعب المحفوظ...');

                try {
                    const player = JSON.parse(selectedPlayer);

                    // Clear any existing content first
                    this.clearPreviewContent();
                    this.showProfessionalLoader();

                    // Create enhanced player data with fallback
                    const enhancedData = await this.createSavedPlayerData(player, targetClub);

                    await this.generateFIFA26Visualization(enhancedData);

                    // Check auto-send to overlay
                    checkAutoSendToOverlay();

                    // Check auto-stream
                    checkAutoStreamPlayer();

                    // Check auto-send to direct stream
                    checkAutoSendToDirectStream();

                    // Check auto-send to OBS File System
                    checkAutoSendToOBSFileSystem();

                    this.showNotification(`🌟 تم تحميل ${player.arabicName} من قاعدة البيانات!`, 'success');

                    // Don't clear target club field - keep user data
                } catch (error) {
                    console.error('🚨 Error loading saved player:', error);
                    this.showNotification(`❌ فشل في تحميل اللاعب: ${error.message}`, 'error');
                } finally {
                    this.hideProfessionalLoader();
                    this.isProcessing = false;
                    this.updateSystemStatus('جاهز للإبداع');
                }
            }

            // Create enhanced data for saved player
            async createSavedPlayerData(player, targetClub) {
                const playerName = player.arabicName || 'لاعب غير محدد';
                const currentClub = player.currentClub || 'غير محدد';

                // Try to get real API data first, then fallback to local calculation
                let probabilityData;
                try {
                    const response = await fetch('/api/search-player', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            arabicName: playerName,
                            targetClub: targetClub,
                            currentClub: currentClub
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.targetRumor?.probability) {
                        // Use real API probability
                        const apiProbability = parseInt(data.targetRumor.probability.match(/(\d+)/)?.[1] || '0');
                        probabilityData = {
                            percentage: apiProbability,
                            display: apiProbability + '%',
                            factors: this.generateFactorsFromRealData(data),
                            confidence: this.calculateConfidenceFromReal(data),
                            trend: this.calculateTrendFromReal(apiProbability)
                        };
                    } else {
                        throw new Error('API data not available');
                    }
                } catch (error) {
                    // Fallback to local calculation
                    const localProbability = this.calculateLocalProbability(playerName, targetClub);
                    probabilityData = {
                        percentage: localProbability,
                        display: localProbability + '%',
                        factors: this.generateLocalFactors(playerName, currentClub, targetClub),
                        confidence: this.calculateLocalConfidence(localProbability),
                        trend: this.calculateTrendFromReal(localProbability)
                    };
                }

                // Get club logos
                const currentClubLogo = await this.getClubLogo(currentClub);
                const targetClubLogo = await this.getClubLogo(targetClub);

                return {
                    arabicName: playerName,
                    englishName: playerName,
                    currentClub: currentClub,
                    targetClub: targetClub,
                    imageUrl: player.playerImage || player.imageUrl || '',
                    currentClubLogo: currentClubLogo,
                    targetClubLogo: targetClubLogo,
                    probability: probabilityData,
                    position: this.getPlayerPosition(playerName),
                    age: this.getPlayerAge(playerName),
                    marketValue: this.calculateMarketValue(playerName, currentClub),
                    contractExpiry: this.generateContractExpiry(),
                    nationality: this.getPlayerNationality(playerName),
                    height: this.getPlayerHeight(playerName),
                    foot: this.getPlayerFoot(playerName),
                    rating: this.calculatePlayerRating(playerName, currentClub),
                    allRumors: []
                };
            }

            generateLocalFactors(playerName, currentClub, targetClub) {
                const factors = [];

                factors.push(`يلعب حالياً في ${currentClub}`);
                factors.push(`مطلوب في ${targetClub}`);

                if (this.isStarPlayer(playerName)) {
                    factors.push('لاعب نجم عالمي');
                }

                if (this.isSaudiClub(targetClub)) {
                    factors.push('الدوري السعودي جاذب للنجوم');
                }

                factors.push('تحليل السوق الحالي');
                factors.push('تقييم الخبراء');

                return factors;
            }

            calculateLocalConfidence(probability) {
                if (probability >= 70) return 'عالية';
                if (probability >= 50) return 'متوسطة';
                return 'منخفضة';
            }

            isStarPlayer(playerName) {
                const starPlayers = ['محمد صلاح', 'صلاح', 'بنزيما', 'مبابي', 'هالاند', 'نيمار', 'ميسي', 'رونالدو'];
                return starPlayers.some(star => playerName.includes(star));
            }

            isSaudiClub(clubName) {
                const saudiClubs = ['الهلال', 'النصر', 'الاتحاد', 'الأهلي', 'الشباب', 'الفيصلي'];
                return saudiClubs.includes(clubName);
            }

            // 🤖 AI Mode (Experimental)
            initializeAIMode() {
                console.log('🤖 AI mode initialized');
                this.showNotification('🤖 AI mode is experimental', 'info');
            }

            async generateWithAI() {
                const prompt = document.getElementById('aiPrompt').value.trim();
                if (!prompt) {
                    this.showNotification('🚨 Please enter a description', 'warning');
                    return;
                }

                this.showNotification('🤖 AI generation is coming soon!', 'info');
                // TODO: Implement AI integration
            }

            // 🎲 Quick Actions
            randomPlayer() {
                const samplePlayers = [
                    { name: 'محمد صلاح', current: 'ليفربول', target: 'الهلال' },
                    { name: 'كريم بنزيما', current: 'الاتحاد', target: 'النصر' },
                    { name: 'ساديو مانه', current: 'بايرن ميونخ', target: 'الأهلي' },
                    { name: 'نيمار', current: 'الهلال', target: 'برشلونة' },
                    { name: 'كيليان مبابي', current: 'باريس سان جيرمان', target: 'ريال مدريد' },
                    { name: 'إرلينغ هالاند', current: 'مانشستر سيتي', target: 'النصر' }
                ];

                const randomIndex = Math.floor(Math.random() * samplePlayers.length);
                const player = samplePlayers[randomIndex];

                document.getElementById('playerName').value = player.name;
                document.getElementById('currentClub').value = player.current;
                document.getElementById('targetClub').value = player.target;

                this.showNotification(`🎲 Random player: ${player.name}`, 'success');
            }

            // 🎯 SMART DATA EXPORT/IMPORT SYSTEM
            exportPlayerData() {
                try {
                    // Collect current multi-player data from UI
                    const currentMultiPlayers = this.collectCurrentMultiPlayerData();

                    const exportData = {
                        timestamp: new Date().toISOString(),
                        version: 'Ultimate Studio V4',
                        type: 'multi_players_session',
                        singlePlayer: this.currentPlayer,
                        multiPlayers: currentMultiPlayers.length > 0 ? currentMultiPlayers : this.multiPlayers,
                        settings: this.settings,
                        customTitle: this.getCustomTitle(),
                        channelRights: this.getChannelRights(),
                        playersCount: currentMultiPlayers.length || this.multiPlayers.length
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });

                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                    const playersCount = exportData.playersCount;
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `ultimate-studio-${playersCount}players-${timestamp}.json`;
                    link.click();

                    this.showNotification(`✅ تم تصدير ${playersCount} لاعبين بنجاح`, 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('❌ فشل في تصدير البيانات', 'error');
                }
            }

            // Collect current multi-player data from UI forms
            collectCurrentMultiPlayerData() {
                const multiPlayerInputs = document.querySelectorAll('.multi-player-input');
                const playersData = [];

                multiPlayerInputs.forEach((container, index) => {
                    const savedPlayerSelect = container.querySelector('.saved-player-select');
                    let playerData = {};

                    if (savedPlayerSelect && savedPlayerSelect.value) {
                        // This is a saved player
                        try {
                            const savedPlayer = JSON.parse(savedPlayerSelect.value);
                            playerData = {
                                ...savedPlayer,
                                targetClub: container.querySelector('.multi-player-target-club').value.trim(),
                                type: 'saved_player',
                                originalData: savedPlayer
                            };
                        } catch (error) {
                            console.error('Error parsing saved player:', error);
                        }
                    } else {
                        // This is manual input
                        const name = container.querySelector('.multi-player-name').value.trim();
                        const currentClub = container.querySelector('.multi-player-current-club').value.trim();
                        const targetClub = container.querySelector('.multi-player-target-club').value.trim();
                        const imageUrl = container.querySelector('.multi-player-image').value.trim();

                        if (name || currentClub || targetClub) {
                            playerData = {
                                arabicName: name,
                                name: name,
                                currentClub: currentClub,
                                targetClub: targetClub,
                                playerImage: imageUrl,
                                imageUrl: imageUrl,
                                type: 'manual_input'
                            };
                        }
                    }

                    if (Object.keys(playerData).length > 0) {
                        playersData.push(playerData);
                    }
                });

                return playersData;
            }

            importPlayerData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importData = JSON.parse(e.target.result);

                            // Validate data structure
                            if (!importData.version || !importData.timestamp) {
                                throw new Error('Invalid data format');
                            }

                            // Import single player
                            if (importData.singlePlayer) {
                                this.currentPlayer = importData.singlePlayer;
                            }

                            // Smart import for multi players
                            if (importData.multiPlayers && Array.isArray(importData.multiPlayers)) {
                                this.multiPlayers = importData.multiPlayers;

                                // Auto-populate multi-player UI
                                this.autoPopulateMultiPlayerUI(importData.multiPlayers);
                            }

                            // Import settings
                            if (importData.settings) {
                                this.settings = { ...this.settings, ...importData.settings };
                                this.saveSettings();
                            }

                            // Import custom title and rights
                            if (importData.customTitle) {
                                this.setCustomTitle(importData.customTitle);
                            }
                            if (importData.channelRights) {
                                this.setChannelRights(importData.channelRights);
                            }

                            const playersCount = importData.multiPlayers ? importData.multiPlayers.length : 0;
                            this.showNotification(`✅ تم استيراد ${playersCount} لاعبين بنجاح`, 'success');

                        } catch (error) {
                            console.error('Import error:', error);
                            this.showNotification('❌ فشل في استيراد البيانات - تأكد من صحة الملف', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            // Smart auto-populate multi-player UI with automatic visualization
            async autoPopulateMultiPlayerUI(playersData) {
                try {
                    // Switch to multi-player mode first
                    const inputMode = document.getElementById('inputMode');
                    if (inputMode) {
                        inputMode.value = 'multi';
                        await this.switchMode('multi');
                    }

                    // Clear existing inputs first
                    const multiContainer = document.getElementById('multiPlayersContainer');
                    if (!multiContainer) {
                        this.showNotification('❌ لم يتم العثور على حاوي اللاعبين المتعددين', 'error');
                        return;
                    }

                    multiContainer.innerHTML = '';

                    // Add inputs for each player
                    for (let i = 0; i < playersData.length; i++) {
                        const player = playersData[i];

                        // Add new input container
                        if (player.type === 'saved_player' && player.originalData) {
                            await this.addSavedMultiPlayer();
                        } else {
                            this.addManualMultiPlayer();
                        }

                        // Get the newly added container
                        const containers = multiContainer.querySelectorAll('.multi-player-input');
                        const container = containers[containers.length - 1];

                        if (container) {
                            // Populate based on player type
                            if (player.type === 'saved_player' && player.originalData) {
                                // This was a saved player - try to restore saved player selection
                                const savedPlayerSelect = container.querySelector('.saved-player-select');
                                if (savedPlayerSelect) {
                                    // Try to find matching saved player
                                    const savedPlayers = this.getSavedPlayers();
                                    const matchingPlayer = savedPlayers.find(sp =>
                                        sp.arabicName === player.arabicName ||
                                        sp.name === player.name ||
                                        sp.id === player.id
                                    );

                                    if (matchingPlayer) {
                                        savedPlayerSelect.value = JSON.stringify(matchingPlayer);
                                        // Trigger change event to populate other fields
                                        await this.loadSelectedSavedPlayer(savedPlayerSelect);
                                    }
                                }
                            } else {
                                // Manual input - populate directly
                                container.querySelector('.multi-player-name').value = player.arabicName || player.name || '';
                                container.querySelector('.multi-player-current-club').value = player.currentClub || '';
                                container.querySelector('.multi-player-image').value = player.playerImage || player.imageUrl || '';
                            }

                            // Always set target club
                            container.querySelector('.multi-player-target-club').value = player.targetClub || '';
                        }
                    }

                    // Update UI counter
                    this.updateMultiPlayerCounter();

                    this.showNotification(`🎯 تم ملء ${playersData.length} لاعبين تلقائياً`, 'success');

                    // Auto-generate visualization after import
                    setTimeout(async () => {
                        await this.autoGenerateAfterImport(playersData);
                    }, 1000);

                } catch (error) {
                    console.error('Error in autoPopulateMultiPlayerUI:', error);
                    this.showNotification('❌ خطأ في ملء البيانات تلقائياً', 'error');
                }
            }

            // Auto-generate visualization after import
            async autoGenerateAfterImport(playersData) {
                try {
                    this.showNotification('🎨 جاري إنشاء التصميم تلقائياً...', 'info');

                    // Generate multi-player visualization
                    await this.generateMultiVisualization('all');

                    // Auto-send to OBS if available
                    setTimeout(() => {
                        this.autoSendToOBS();
                    }, 2000);

                    this.showNotification(`✅ تم إنشاء تصميم ${playersData.length} لاعبين تلقائياً!`, 'success');
                } catch (error) {
                    console.error('Error in auto-generation:', error);
                    this.showNotification('⚠️ تم استيراد البيانات لكن فشل في إنشاء التصميم تلقائياً', 'warning');
                }
            }

            // Auto-send to OBS after import
            autoSendToOBS() {
                try {
                    // Check if OBS is ready
                    const obsReady = localStorage.getItem('obsReady');
                    if (!obsReady) {
                        console.log('📺 OBS not ready, skipping auto-send');
                        return;
                    }

                    // Get current preview content
                    const previewContent = document.getElementById('previewContent');
                    if (previewContent && previewContent.innerHTML.trim()) {
                        // Send to direct stream
                        const streamData = {
                            html: previewContent.innerHTML,
                            timestamp: Date.now(),
                            source: 'auto-import'
                        };

                        localStorage.setItem('directStreamContent', JSON.stringify(streamData));
                        localStorage.setItem('directStreamActive', 'true');
                        localStorage.setItem('directStreamContentChanged', Date.now().toString());

                        // Also send via postMessage
                        window.postMessage({
                            type: 'STREAM_UPDATE',
                            data: streamData
                        }, '*');

                        this.showNotification('📺 تم إرسال التصميم إلى OBS تلقائياً', 'success');
                        console.log('📺 Auto-sent to OBS after import');
                    }
                } catch (error) {
                    console.error('Error auto-sending to OBS:', error);
                }
            }

            // Get saved players from localStorage
            getSavedPlayers() {
                try {
                    const savedPlayers = localStorage.getItem('savedPlayers');
                    return savedPlayers ? JSON.parse(savedPlayers) : [];
                } catch (error) {
                    console.error('Error loading saved players:', error);
                    return [];
                }
            }

            // Update multi-player counter
            updateMultiPlayerCounter() {
                const multiContainer = document.getElementById('multiPlayerInputs');
                if (multiContainer) {
                    const count = multiContainer.querySelectorAll('.multi-player-input').length;
                    const counterElement = document.querySelector('.multi-player-counter');
                    if (counterElement) {
                        counterElement.textContent = `${count} لاعب`;
                    }
                }
            }

            refreshMultiPlayerUI() {
                // Legacy function - kept for compatibility
                this.autoPopulateMultiPlayerUI(this.multiPlayers);
            }

            // 🎨 NEW CARD DESIGN SYSTEM
            getSelectedCardDesign() {
                return this.settings.cardDesign || 'financial';
            }

            // Master card creation function
            createPlayerCardHTML(player, animationDelay = 0) {
                const design = this.getSelectedCardDesign();

                switch (design) {
                    case 'modern':
                        return this.createModernCardHTML(player, animationDelay);
                    case 'minimalist':
                        return this.createMinimalistCardHTML(player, animationDelay);
                    case 'glassmorphism':
                        return this.createGlassmorphismCardHTML(player, animationDelay);
                    case 'cyberpunk':
                        return this.createCyberpunkCardHTML(player, animationDelay);
                    case 'neon':
                        return this.createNeonCardHTML(player, animationDelay);
                    case 'holographic':
                        return this.createHolographicCardHTML(player, animationDelay);
                    case 'financial':
                    default:
                        return this.createFinancialCardHTML(player, animationDelay);
                }
            }

            // Helper function to get probability value
            getProbabilityValue(player) {
                if (player.probability && player.probability.percentage) {
                    return player.probability.percentage;
                }
                if (player.transferProbability) {
                    return player.transferProbability;
                }
                return 50; // Default value
            }

            // Modern FIFA-inspired card design
            createModernCardHTML(player, animationDelay = 0) {
                const probabilityValue = this.getProbabilityValue(player);
                const probabilityColor = this.getProbabilityColor(probabilityValue);

                return `
                    <div class="modern-card" style="
                        position: relative;
                        width: 380px;
                        height: 520px;
                        background: linear-gradient(145deg,
                            rgba(15, 25, 45, 0.98) 0%,
                            rgba(25, 35, 65, 0.95) 50%,
                            rgba(35, 45, 85, 0.98) 100%);
                        border-radius: 25px;
                        padding: 0;
                        overflow: hidden;
                        box-shadow:
                            0 25px 50px rgba(0, 0, 0, 0.6),
                            0 0 0 2px ${probabilityColor}40,
                            0 0 30px ${probabilityColor}30;
                        animation: modernCardEntrance 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${animationDelay}s both;
                        border: 2px solid ${probabilityColor}60;
                    ">
                        <!-- Card Header -->
                        <div style="
                            position: relative;
                            height: 80px;
                            background: linear-gradient(135deg, ${probabilityColor}20, ${probabilityColor}10);
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            padding: 0 20px;
                            border-bottom: 2px solid ${probabilityColor}30;
                        ">
                            <div style="
                                color: ${probabilityColor};
                                font-size: 1.1rem;
                                font-weight: 700;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                            ">TRANSFER</div>
                            <div style="
                                background: ${probabilityColor};
                                color: white;
                                padding: 8px 16px;
                                border-radius: 15px;
                                font-weight: 800;
                                font-size: 1.2rem;
                            ">${probabilityValue}%</div>
                        </div>

                        <!-- Player Image Section -->
                        <div style="
                            position: relative;
                            height: 200px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
                        ">
                            ${player.playerImage ? `
                            <img src="${player.playerImage}" alt="${player.arabicName || player.name}" style="
                                width: 160px;
                                height: 160px;
                                border-radius: 50%;
                                object-fit: cover;
                                border: 4px solid ${probabilityColor};
                                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                                filter: brightness(1.1) contrast(1.1);
                            ">
                            ` : `
                            <div style="
                                width: 160px;
                                height: 160px;
                                border-radius: 50%;
                                background: linear-gradient(135deg, ${probabilityColor}30, ${probabilityColor}10);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border: 4px solid ${probabilityColor};
                                color: ${probabilityColor};
                                font-size: 3rem;
                                font-weight: 900;
                            ">⚽</div>
                            `}
                        </div>

                        <!-- Player Info -->
                        <div style="
                            padding: 20px;
                            text-align: center;
                        ">
                            <h2 style="
                                color: white;
                                font-size: 1.8rem;
                                font-weight: 800;
                                margin: 0 0 10px 0;
                                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
                            ">${player.arabicName || player.name}</h2>

                            <!-- Clubs Section -->
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                margin: 20px 0;
                                padding: 15px;
                                background: rgba(255, 255, 255, 0.05);
                                border-radius: 15px;
                                backdrop-filter: blur(10px);
                            ">
                                <!-- Current Club -->
                                <div style="text-align: center; flex: 1;">
                                    ${player.currentClubLogo ? `
                                    <img src="${player.currentClubLogo}" alt="${player.currentClub}" style="
                                        width: 40px;
                                        height: 40px;
                                        object-fit: contain;
                                        margin-bottom: 8px;
                                        filter: brightness(1.1);
                                    ">
                                    ` : ''}
                                    <div style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 600;">
                                        ${player.currentClub}
                                    </div>
                                </div>

                                <!-- Arrow -->
                                <div style="
                                    flex: 0 0 60px;
                                    display: flex;
                                    justify-content: center;
                                    color: ${probabilityColor};
                                    font-size: 1.5rem;
                                    font-weight: 900;
                                ">←</div>

                                <!-- Target Club -->
                                <div style="text-align: center; flex: 1;">
                                    ${player.targetClubLogo ? `
                                    <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                        width: 40px;
                                        height: 40px;
                                        object-fit: contain;
                                        margin-bottom: 8px;
                                        filter: brightness(1.1) drop-shadow(0 0 10px ${probabilityColor}60);
                                    ">
                                    ` : ''}
                                    <div style="color: ${probabilityColor}; font-size: 0.9rem; font-weight: 600;">
                                        ${player.targetClub}
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Info -->
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                margin-top: 15px;
                                padding-top: 15px;
                                border-top: 1px solid rgba(255, 255, 255, 0.1);
                            ">
                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem;">
                                    العمر: ${player.age || 'غير محدد'}
                                </div>
                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem;">
                                    المركز: ${player.position || 'غير محدد'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Minimalist card design
            createMinimalistCardHTML(player, animationDelay = 0) {
                const probabilityValue = this.getProbabilityValue(player);
                const probabilityColor = this.getProbabilityColor(probabilityValue);

                return `
                    <div class="minimalist-card" style="
                        position: relative;
                        width: 400px;
                        height: 280px;
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 20px;
                        padding: 30px;
                        overflow: hidden;
                        box-shadow:
                            0 20px 40px rgba(0, 0, 0, 0.1),
                            0 0 0 1px rgba(0, 0, 0, 0.05);
                        animation: minimalistCardEntrance 1s ease-out ${animationDelay}s both;
                        color: #2d3748;
                    ">
                        <!-- Probability Badge -->
                        <div style="
                            position: absolute;
                            top: 20px;
                            right: 20px;
                            background: ${probabilityColor};
                            color: white;
                            padding: 8px 16px;
                            border-radius: 25px;
                            font-weight: 800;
                            font-size: 1.1rem;
                            box-shadow: 0 4px 15px ${probabilityColor}40;
                        ">${probabilityValue}%</div>

                        <!-- Player Info -->
                        <div style="
                            display: flex;
                            align-items: center;
                            gap: 20px;
                            height: 100%;
                        ">
                            <!-- Player Image -->
                            <div style="flex: 0 0 120px;">
                                ${player.playerImage ? `
                                <img src="${player.playerImage}" alt="${player.arabicName || player.name}" style="
                                    width: 120px;
                                    height: 120px;
                                    border-radius: 15px;
                                    object-fit: cover;
                                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                                ">
                                ` : `
                                <div style="
                                    width: 120px;
                                    height: 120px;
                                    border-radius: 15px;
                                    background: linear-gradient(135deg, ${probabilityColor}20, ${probabilityColor}10);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: ${probabilityColor};
                                    font-size: 2.5rem;
                                ">⚽</div>
                                `}
                            </div>

                            <!-- Content -->
                            <div style="flex: 1;">
                                <h2 style="
                                    color: #1a202c;
                                    font-size: 1.6rem;
                                    font-weight: 700;
                                    margin: 0 0 15px 0;
                                ">${player.arabicName || player.name}</h2>

                                <!-- Transfer Info -->
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 15px;
                                    margin-bottom: 15px;
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        padding: 8px 12px;
                                        background: #f7fafc;
                                        border-radius: 10px;
                                        border-left: 4px solid #e2e8f0;
                                    ">
                                        ${player.currentClubLogo ? `
                                        <img src="${player.currentClubLogo}" alt="${player.currentClub}" style="
                                            width: 24px;
                                            height: 24px;
                                            object-fit: contain;
                                        ">
                                        ` : ''}
                                        <span style="font-size: 0.9rem; color: #4a5568; font-weight: 600;">
                                            ${player.currentClub}
                                        </span>
                                    </div>

                                    <div style="
                                        color: ${probabilityColor};
                                        font-size: 1.2rem;
                                        font-weight: 700;
                                    ">←</div>

                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        padding: 8px 12px;
                                        background: ${probabilityColor}10;
                                        border-radius: 10px;
                                        border-left: 4px solid ${probabilityColor};
                                    ">
                                        ${player.targetClubLogo ? `
                                        <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                            width: 24px;
                                            height: 24px;
                                            object-fit: contain;
                                        ">
                                        ` : ''}
                                        <span style="font-size: 0.9rem; color: ${probabilityColor}; font-weight: 600;">
                                            ${player.targetClub}
                                        </span>
                                    </div>
                                </div>

                                <!-- Additional Info -->
                                <div style="
                                    display: flex;
                                    gap: 20px;
                                    font-size: 0.85rem;
                                    color: #718096;
                                ">
                                    <span>العمر: ${player.age || 'غير محدد'}</span>
                                    <span>المركز: ${player.position || 'غير محدد'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Glassmorphism card design (Modern glass effect)
            createGlassmorphismCardHTML(player, animationDelay = 0) {
                const probabilityValue = this.getProbabilityValue(player);
                const probabilityColor = this.getProbabilityColor(probabilityValue);

                return `
                    <div class="glassmorphism-card" style="
                        position: relative;
                        width: 420px;
                        height: 580px;
                        background: linear-gradient(135deg,
                            rgba(255, 255, 255, 0.1) 0%,
                            rgba(255, 255, 255, 0.05) 100%);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border-radius: 30px;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        padding: 0;
                        overflow: hidden;
                        box-shadow:
                            0 8px 32px rgba(0, 0, 0, 0.3),
                            inset 0 1px 0 rgba(255, 255, 255, 0.2),
                            0 0 50px ${probabilityColor}30;
                        animation: glassCardEntrance 1.5s cubic-bezier(0.23, 1, 0.32, 1) ${animationDelay}s both;
                    ">
                        <!-- Glass reflection effect -->
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(135deg,
                                rgba(255, 255, 255, 0.1) 0%,
                                transparent 50%,
                                rgba(255, 255, 255, 0.05) 100%);
                            pointer-events: none;
                            animation: glassReflection 3s ease-in-out infinite;
                        "></div>

                        <!-- Header section -->
                        <div style="
                            position: relative;
                            padding: 30px 30px 20px;
                            text-align: center;
                            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        ">
                            <div style="
                                display: inline-block;
                                background: linear-gradient(135deg, ${probabilityColor}40, ${probabilityColor}20);
                                backdrop-filter: blur(10px);
                                border: 1px solid ${probabilityColor}30;
                                border-radius: 25px;
                                padding: 12px 24px;
                                color: white;
                                font-weight: 800;
                                font-size: 1.4rem;
                                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                                box-shadow: 0 4px 20px ${probabilityColor}20;
                            ">${probabilityValue}%</div>
                        </div>

                        <!-- Player section -->
                        <div style="
                            position: relative;
                            padding: 30px;
                            text-align: center;
                        ">
                            <!-- Player image -->
                            ${player.playerImage ? `
                            <img src="${player.playerImage}" alt="${player.arabicName || player.name}" style="
                                width: 180px;
                                height: 180px;
                                border-radius: 50%;
                                object-fit: cover;
                                border: 3px solid rgba(255, 255, 255, 0.3);
                                box-shadow:
                                    0 15px 35px rgba(0, 0, 0, 0.3),
                                    0 0 30px ${probabilityColor}40;
                                filter: brightness(1.1) contrast(1.1);
                                margin-bottom: 20px;
                            ">
                            ` : `
                            <div style="
                                width: 180px;
                                height: 180px;
                                border-radius: 50%;
                                background: linear-gradient(135deg, ${probabilityColor}30, ${probabilityColor}10);
                                backdrop-filter: blur(10px);
                                border: 3px solid rgba(255, 255, 255, 0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 4rem;
                                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
                                margin: 0 auto 20px;
                            ">⚽</div>
                            `}

                            <!-- Player name -->
                            <h2 style="
                                color: white;
                                font-size: 2rem;
                                font-weight: 800;
                                margin: 0 0 25px 0;
                                text-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
                            ">${player.arabicName || player.name}</h2>

                            <!-- Clubs section -->
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                margin: 25px 0;
                                padding: 20px;
                                background: rgba(255, 255, 255, 0.08);
                                backdrop-filter: blur(15px);
                                border-radius: 20px;
                                border: 1px solid rgba(255, 255, 255, 0.1);
                            ">
                                <!-- Current Club -->
                                <div style="text-align: center; flex: 1;">
                                    ${player.currentClubLogo ? `
                                    <img src="${player.currentClubLogo}" alt="${player.currentClub}" style="
                                        width: 45px;
                                        height: 45px;
                                        object-fit: contain;
                                        margin-bottom: 10px;
                                        filter: brightness(1.1);
                                    ">
                                    ` : ''}
                                    <div style="
                                        color: rgba(255, 255, 255, 0.9);
                                        font-size: 0.95rem;
                                        font-weight: 600;
                                    ">${player.currentClub}</div>
                                </div>

                                <!-- Arrow -->
                                <div style="
                                    flex: 0 0 60px;
                                    display: flex;
                                    justify-content: center;
                                    color: ${probabilityColor};
                                    font-size: 1.5rem;
                                    font-weight: 900;
                                ">←</div>

                                <!-- Target Club -->
                                <div style="text-align: center; flex: 1;">
                                    ${player.targetClubLogo ? `
                                    <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                        width: 45px;
                                        height: 45px;
                                        object-fit: contain;
                                        margin-bottom: 10px;
                                        filter: brightness(1.2) drop-shadow(0 0 10px ${probabilityColor}60);
                                    ">
                                    ` : ''}
                                    <div style="
                                        color: ${probabilityColor};
                                        font-size: 0.95rem;
                                        font-weight: 700;
                                    ">${player.targetClub}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Cyberpunk card design (Futuristic neon style)
            createCyberpunkCardHTML(player, animationDelay = 0) {
                const probabilityValue = this.getProbabilityValue(player);
                const probabilityColor = this.getProbabilityColor(probabilityValue);

                return `
                    <div class="cyberpunk-card" style="
                        position: relative;
                        width: 450px;
                        height: 600px;
                        background: linear-gradient(145deg,
                            #0a0a0a 0%,
                            #1a1a2e 30%,
                            #16213e  70%,
                            #0f0f23 100%);
                        border-radius: 15px;
                        padding: 0;
                        overflow: hidden;
                        border: 2px solid ${probabilityColor};
                        box-shadow:
                            0 0 30px ${probabilityColor}60,
                            0 0 60px ${probabilityColor}30,
                            inset 0 0 30px rgba(0, 0, 0, 0.5);
                        animation: cyberpunkEntrance 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) ${animationDelay}s both;
                        position: relative;
                    ">
                        <!-- Cyberpunk grid background -->
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background-image:
                                linear-gradient(${probabilityColor}30 1px, transparent 1px),
                                linear-gradient(90deg, ${probabilityColor}30 1px, transparent 1px);
                            background-size: 20px 20px;
                            animation: gridPulse 4s ease-in-out infinite;
                            pointer-events: none;
                        "></div>

                        <!-- Glitch lines -->
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(90deg,
                                transparent 0%,
                                ${probabilityColor}20 50%,
                                transparent 100%);
                            animation: glitchScan 3s linear infinite;
                            pointer-events: none;
                        "></div>

                        <!-- Header HUD -->
                        <div style="
                            position: relative;
                            padding: 25px;
                            border-bottom: 2px solid ${probabilityColor}50;
                            background: linear-gradient(90deg,
                                transparent 0%,
                                rgba(0, 0, 0, 0.3) 50%,
                                transparent 100%);
                        ">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 15px;
                            ">
                                <div style="
                                    color: ${probabilityColor};
                                    font-family: 'Courier New', monospace;
                                    font-size: 0.9rem;
                                    font-weight: 700;
                                    text-transform: uppercase;
                                    letter-spacing: 2px;
                                    text-shadow: 0 0 10px currentColor;
                                ">TRANSFER_PROTOCOL</div>
                                <div style="
                                    color: #00ff41;
                                    font-family: 'Courier New', monospace;
                                    font-size: 0.8rem;
                                    animation: textGlitch 2s infinite;
                                ">ONLINE</div>
                            </div>

                            <div style="
                                background: linear-gradient(90deg, ${probabilityColor}, #ff0080);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text;
                                font-size: 3rem;
                                font-weight: 900;
                                font-family: 'Courier New', monospace;
                                text-align: center;
                                text-shadow: 0 0 20px ${probabilityColor}80;
                                animation: probabilityGlow 2s ease-in-out infinite alternate;
                            ">${probabilityValue}%</div>
                        </div>

                        <!-- Player data section -->
                        <div style="
                            position: relative;
                            padding: 30px 25px;
                        ">
                            <!-- Player image with hologram effect -->
                            <div style="
                                position: relative;
                                text-align: center;
                                margin-bottom: 25px;
                            ">
                                ${player.playerImage ? `
                                <div style="
                                    position: relative;
                                    display: inline-block;
                                ">
                                    <img src="${player.playerImage}" alt="${player.arabicName || player.name}" style="
                                        width: 160px;
                                        height: 160px;
                                        border-radius: 10px;
                                        object-fit: cover;
                                        border: 2px solid ${probabilityColor};
                                        box-shadow:
                                            0 0 20px ${probabilityColor}60,
                                            inset 0 0 20px rgba(0, 0, 0, 0.3);
                                        filter: brightness(1.2) contrast(1.3) hue-rotate(10deg);
                                        animation: hologramFlicker 3s infinite;
                                    ">
                                    <!-- Hologram scan lines -->
                                    <div style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        background: repeating-linear-gradient(
                                            0deg,
                                            transparent,
                                            transparent 2px,
                                            ${probabilityColor}20 2px,
                                            ${probabilityColor}20 4px
                                        );
                                        border-radius: 10px;
                                        animation: scanLines 2s linear infinite;
                                        pointer-events: none;
                                    "></div>
                                </div>
                                ` : `
                                <div style="
                                    width: 160px;
                                    height: 160px;
                                    border-radius: 10px;
                                    background: linear-gradient(135deg, ${probabilityColor}30, #ff008030);
                                    border: 2px solid ${probabilityColor};
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: ${probabilityColor};
                                    font-size: 4rem;
                                    margin: 0 auto;
                                    box-shadow: 0 0 20px ${probabilityColor}60;
                                    animation: hologramFlicker 3s infinite;
                                ">⚽</div>
                                `}
                            </div>

                            <!-- Player name with glitch effect -->
                            <h2 style="
                                color: white;
                                font-size: 1.8rem;
                                font-weight: 800;
                                margin: 0 0 20px 0;
                                text-align: center;
                                font-family: 'Courier New', monospace;
                                text-transform: uppercase;
                                letter-spacing: 3px;
                                text-shadow:
                                    0 0 10px ${probabilityColor},
                                    2px 2px 0px #ff0080,
                                    -2px -2px 0px #00ffff;
                                animation: nameGlitch 4s infinite;
                            ">${player.arabicName || player.name}</h2>

                            <!-- Transfer data -->
                            <div style="
                                background: rgba(0, 0, 0, 0.6);
                                border: 1px solid ${probabilityColor}50;
                                border-radius: 10px;
                                padding: 20px;
                                margin: 20px 0;
                                position: relative;
                            ">
                                <!-- Data header -->
                                <div style="
                                    color: ${probabilityColor};
                                    font-family: 'Courier New', monospace;
                                    font-size: 0.8rem;
                                    font-weight: 700;
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                    margin-bottom: 15px;
                                    text-shadow: 0 0 5px currentColor;
                                ">TRANSFER_DATA</div>

                                <div style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: space-between;
                                ">
                                    <!-- Current Club -->
                                    <div style="
                                        text-align: center;
                                        flex: 1;
                                        padding: 10px;
                                        background: rgba(255, 255, 255, 0.05);
                                        border-radius: 8px;
                                        border: 1px solid rgba(255, 255, 255, 0.1);
                                    ">
                                        ${player.currentClubLogo ? `
                                        <img src="${player.currentClubLogo}" alt="${player.currentClub}" style="
                                            width: 40px;
                                            height: 40px;
                                            object-fit: contain;
                                            margin-bottom: 8px;
                                            filter: brightness(1.2) drop-shadow(0 0 5px ${probabilityColor}40);
                                        ">
                                        ` : ''}
                                        <div style="
                                            color: #00ff41;
                                            font-family: 'Courier New', monospace;
                                            font-size: 0.8rem;
                                            font-weight: 600;
                                            text-shadow: 0 0 5px currentColor;
                                        ">${player.currentClub}</div>
                                    </div>

                                    <!-- Transfer arrow -->
                                    <div style="
                                        flex: 0 0 80px;
                                        text-align: center;
                                        color: ${probabilityColor};
                                        font-size: 2rem;
                                        font-weight: 900;
                                        text-shadow: 0 0 15px currentColor;
                                        animation: arrowPulse 1.5s ease-in-out infinite;
                                    ">◀</div>

                                    <!-- Target Club -->
                                    <div style="
                                        text-align: center;
                                        flex: 1;
                                        padding: 10px;
                                        background: linear-gradient(135deg, ${probabilityColor}20, #ff008020);
                                        border-radius: 8px;
                                        border: 1px solid ${probabilityColor}50;
                                        box-shadow: 0 0 15px ${probabilityColor}30;
                                    ">
                                        ${player.targetClubLogo ? `
                                        <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                            width: 40px;
                                            height: 40px;
                                            object-fit: contain;
                                            margin-bottom: 8px;
                                            filter: brightness(1.3) drop-shadow(0 0 10px ${probabilityColor}80);
                                        ">
                                        ` : ''}
                                        <div style="
                                            color: ${probabilityColor};
                                            font-family: 'Courier New', monospace;
                                            font-size: 0.8rem;
                                            font-weight: 700;
                                            text-shadow: 0 0 8px currentColor;
                                        ">${player.targetClub}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional stats -->
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                margin-top: 20px;
                            ">
                                <div style="
                                    background: rgba(0, 0, 0, 0.4);
                                    border: 1px solid #00ff4150;
                                    border-radius: 8px;
                                    padding: 10px 15px;
                                    text-align: center;
                                    flex: 1;
                                    margin-right: 10px;
                                ">
                                    <div style="
                                        color: #00ff41;
                                        font-family: 'Courier New', monospace;
                                        font-size: 0.7rem;
                                        font-weight: 600;
                                        margin-bottom: 5px;
                                    ">AGE</div>
                                    <div style="
                                        color: white;
                                        font-family: 'Courier New', monospace;
                                        font-size: 1rem;
                                        font-weight: 700;
                                    ">${player.age || 'N/A'}</div>
                                </div>
                                <div style="
                                    background: rgba(0, 0, 0, 0.4);
                                    border: 1px solid #ff008050;
                                    border-radius: 8px;
                                    padding: 10px 15px;
                                    text-align: center;
                                    flex: 1;
                                ">
                                    <div style="
                                        color: #ff0080;
                                        font-family: 'Courier New', monospace;
                                        font-size: 0.7rem;
                                        font-weight: 600;
                                        margin-bottom: 5px;
                                    ">POS</div>
                                    <div style="
                                        color: white;
                                        font-family: 'Courier New', monospace;
                                        font-size: 1rem;
                                        font-weight: 700;
                                    ">${player.position || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Neon card design (Vibrant neon style)
            createNeonCardHTML(player, animationDelay = 0) {
                const probabilityValue = this.getProbabilityValue(player);
                const probabilityColor = this.getProbabilityColor(probabilityValue);

                return `
                    <div class="neon-card" style="
                        position: relative;
                        width: 400px;
                        height: 550px;
                        background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f23 100%);
                        border-radius: 20px;
                        padding: 25px;
                        overflow: hidden;
                        border: 3px solid ${probabilityColor};
                        box-shadow:
                            0 0 20px ${probabilityColor},
                            0 0 40px ${probabilityColor}60,
                            0 0 80px ${probabilityColor}30,
                            inset 0 0 20px rgba(0, 0, 0, 0.5);
                        animation: neonPulse 2s ease-in-out infinite alternate;
                    ">
                        <!-- Neon glow effect -->
                        <div style="
                            position: absolute;
                            top: -50%;
                            left: -50%;
                            width: 200%;
                            height: 200%;
                            background: conic-gradient(${probabilityColor}, #ff0080, #00ffff, ${probabilityColor});
                            animation: neonRotate 4s linear infinite;
                            z-index: -1;
                        "></div>

                        <div style="
                            position: absolute;
                            top: 3px;
                            left: 3px;
                            right: 3px;
                            bottom: 3px;
                            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f23 100%);
                            border-radius: 17px;
                            z-index: 1;
                        "></div>

                        <div style="position: relative; z-index: 2;">
                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 25px;">
                                <div style="
                                    color: ${probabilityColor};
                                    font-size: 3rem;
                                    font-weight: 900;
                                    text-shadow:
                                        0 0 10px currentColor,
                                        0 0 20px currentColor,
                                        0 0 30px currentColor;
                                    animation: neonFlicker 3s infinite;
                                ">${probabilityValue}%</div>
                            </div>

                            <!-- Player -->
                            <div style="text-align: center; margin-bottom: 25px;">
                                ${player.playerImage ? `
                                <img src="${player.playerImage}" alt="${player.arabicName || player.name}" style="
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    object-fit: cover;
                                    border: 2px solid ${probabilityColor};
                                    box-shadow: 0 0 20px ${probabilityColor}80;
                                    margin-bottom: 15px;
                                ">
                                ` : `
                                <div style="
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    background: linear-gradient(45deg, ${probabilityColor}30, #ff008030);
                                    border: 2px solid ${probabilityColor};
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: ${probabilityColor};
                                    font-size: 3rem;
                                    margin: 0 auto 15px;
                                    box-shadow: 0 0 20px ${probabilityColor}80;
                                ">⚽</div>
                                `}

                                <h2 style="
                                    color: white;
                                    font-size: 1.8rem;
                                    font-weight: 800;
                                    margin: 0;
                                    text-shadow: 0 0 15px ${probabilityColor}80;
                                ">${player.arabicName || player.name}</h2>
                            </div>

                            <!-- Clubs -->
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                background: rgba(0, 0, 0, 0.3);
                                border: 1px solid ${probabilityColor}50;
                                border-radius: 15px;
                                padding: 20px;
                                box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
                            ">
                                <div style="text-align: center; flex: 1;">
                                    ${player.currentClubLogo ? `
                                    <img src="${player.currentClubLogo}" alt="${player.currentClub}" style="
                                        width: 35px; height: 35px; object-fit: contain; margin-bottom: 8px;
                                        filter: drop-shadow(0 0 5px ${probabilityColor}60);
                                    ">` : ''}
                                    <div style="color: white; font-size: 0.9rem; font-weight: 600;">${player.currentClub}</div>
                                </div>
                                <div style="color: ${probabilityColor}; font-size: 1.5rem; font-weight: 900; flex: 0 0 40px; text-align: center;">←</div>
                                <div style="text-align: center; flex: 1;">
                                    ${player.targetClubLogo ? `
                                    <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                        width: 35px; height: 35px; object-fit: contain; margin-bottom: 8px;
                                        filter: drop-shadow(0 0 10px ${probabilityColor}80);
                                    ">` : ''}
                                    <div style="color: ${probabilityColor}; font-size: 0.9rem; font-weight: 700;">${player.targetClub}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Holographic card design (Rainbow hologram effect)
            createHolographicCardHTML(player, animationDelay = 0) {
                const probabilityValue = this.getProbabilityValue(player);

                return `
                    <div class="holographic-card" style="
                        position: relative;
                        width: 380px;
                        height: 520px;
                        background: linear-gradient(45deg, #1a1a2e, #16213e, #0f0f23);
                        border-radius: 25px;
                        padding: 25px;
                        overflow: hidden;
                        border: 2px solid transparent;
                        background-clip: padding-box;
                        animation: holoCardEntrance 2s ease-out ${animationDelay}s both;
                    ">
                        <!-- Holographic border -->
                        <div style="
                            position: absolute;
                            top: -2px; left: -2px; right: -2px; bottom: -2px;
                            background: linear-gradient(45deg, #ff0080, #00ffff, #ff8000, #8000ff, #ff0080);
                            background-size: 400% 400%;
                            border-radius: 27px;
                            z-index: -1;
                            animation: holoBorder 3s ease-in-out infinite;
                        "></div>

                        <!-- Rainbow reflection -->
                        <div style="
                            position: absolute;
                            top: 0; left: 0; width: 100%; height: 100%;
                            background: linear-gradient(135deg,
                                rgba(255, 0, 128, 0.1) 0%,
                                rgba(0, 255, 255, 0.1) 25%,
                                rgba(255, 128, 0, 0.1) 50%,
                                rgba(128, 0, 255, 0.1) 75%,
                                rgba(255, 0, 128, 0.1) 100%);
                            background-size: 200% 200%;
                            border-radius: 23px;
                            animation: holoShimmer 4s ease-in-out infinite;
                            pointer-events: none;
                        "></div>

                        <div style="position: relative; z-index: 2; text-align: center;">
                            <!-- Probability -->
                            <div style="
                                background: linear-gradient(45deg, #ff0080, #00ffff, #ff8000);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text;
                                font-size: 2.5rem;
                                font-weight: 900;
                                margin-bottom: 20px;
                                animation: holoText 2s ease-in-out infinite;
                            ">${probabilityValue}%</div>

                            <!-- Player -->
                            ${player.playerImage ? `
                            <img src="${player.playerImage}" alt="${player.arabicName || player.name}" style="
                                width: 140px; height: 140px; border-radius: 50%; object-fit: cover;
                                border: 3px solid transparent;
                                background: linear-gradient(45deg, #ff0080, #00ffff, #ff8000, #8000ff) border-box;
                                margin-bottom: 15px;
                                filter: brightness(1.2) contrast(1.2);
                            ">
                            ` : `
                            <div style="
                                width: 140px; height: 140px; border-radius: 50%;
                                background: linear-gradient(45deg, #ff008030, #00ffff30, #ff800030);
                                border: 3px solid #ff0080;
                                display: flex; align-items: center; justify-content: center;
                                color: white; font-size: 3rem; margin: 0 auto 15px;
                            ">⚽</div>
                            `}

                            <h2 style="
                                background: linear-gradient(45deg, #ffffff, #ff0080, #00ffff);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text;
                                font-size: 1.6rem; font-weight: 800; margin: 0 0 20px 0;
                            ">${player.arabicName || player.name}</h2>

                            <!-- Clubs -->
                            <div style="
                                display: flex; align-items: center; justify-content: space-between;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.2);
                                border-radius: 15px; padding: 15px;
                            ">
                                <div style="text-align: center; flex: 1;">
                                    ${player.currentClubLogo ? `
                                    <img src="${player.currentClubLogo}" alt="${player.currentClub}" style="
                                        width: 30px; height: 30px; object-fit: contain; margin-bottom: 5px;
                                    ">` : ''}
                                    <div style="color: white; font-size: 0.8rem;">${player.currentClub}</div>
                                </div>
                                <div style="color: #ff0080; font-size: 1.2rem; font-weight: 900;">←</div>
                                <div style="text-align: center; flex: 1;">
                                    ${player.targetClubLogo ? `
                                    <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                        width: 30px; height: 30px; object-fit: contain; margin-bottom: 5px;
                                    ">` : ''}
                                    <div style="color: #00ffff; font-size: 0.8rem; font-weight: 600;">${player.targetClub}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            exportCreation() {
                this.exportPlayerData();
            }

            // 🎨 UI Helpers
            showCosmicLoader() {
                const placeholder = document.getElementById('previewPlaceholder');
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div class="cosmic-loader">
                            <div style="
                                width: 80px;
                                height: 80px;
                                border: 4px solid rgba(255, 255, 255, 0.1);
                                border-top: 4px solid #00d4ff;
                                border-radius: 50%;
                                animation: cosmicSpin 1s linear infinite;
                                margin: 0 auto 20px;
                            "></div>
                            <h3 style="
                                font-family: 'Orbitron', monospace;
                                color: #00d4ff;
                                margin-bottom: 10px;
                            ">Creating Quantum Visualization</h3>
                            <p style="color: rgba(255, 255, 255, 0.7);">Processing cosmic data...</p>
                        </div>
                        <style>
                            @keyframes cosmicSpin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `;
                }
            }

            hideCosmicLoader() {
                // Loader will be hidden when visualization is generated
            }

            updateSystemStatus(status) {
                const statusElement = document.getElementById('systemStatus');
                if (statusElement) {
                    statusElement.textContent = status;
                }
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `ultimate-notification ${type}`;

                const colors = {
                    success: '#39ff14',
                    error: '#ff0080',
                    warning: '#ffd700',
                    info: '#00d4ff'
                };

                notification.style.cssText = `
                    position: fixed;
                    top: 30px;
                    right: 30px;
                    background: rgba(0, 0, 0, 0.9);
                    backdrop-filter: blur(20px);
                    border: 2px solid ${colors[type]};
                    border-radius: 15px;
                    padding: 20px 25px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    animation: notificationSlide 0.5s ease-out;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px ${colors[type]}30;
                    max-width: 400px;
                    font-family: 'Cairo', sans-serif;
                `;

                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"
                           style="color: ${colors[type]}; font-size: 1.2rem;"></i>
                        <span>${message}</span>
                    </div>
                `;

                // Add CSS for animation
                if (!document.getElementById('notificationStyles')) {
                    const style = document.createElement('style');
                    style.id = 'notificationStyles';
                    style.textContent = `
                        @keyframes notificationSlide {
                            0% { transform: translateX(100%); opacity: 0; }
                            100% { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes notificationFadeOut {
                            0% { transform: translateX(0); opacity: 1; }
                            100% { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(notification);

                // Auto remove after 4 seconds
                setTimeout(() => {
                    notification.style.animation = 'notificationFadeOut 0.5s ease-out forwards';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 500);
                }, 4000);

                // Click to dismiss
                notification.addEventListener('click', () => {
                    notification.style.animation = 'notificationFadeOut 0.5s ease-out forwards';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 500);
                });
            }

            // ⚙️ Advanced Settings 2025
            loadSettings() {
                const defaultSettings = {
                    visualTheme: 'cosmic',
                    animationSpeed: 'normal',
                    particleEffects: 'enabled',
                    soundEffects: 'enabled',
                    autoSave: 'enabled',
                    playerImageSize: 150,
                    clubLogoSize: 32,
                    cardTransition: 'fadeIn',
                    transitionDuration: 1.0,
                    lmStudioURL: 'http://localhost:1234'
                };

                try {
                    const saved = localStorage.getItem('ultimateStudio_settings');
                    return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
                } catch (error) {
                    console.warn('🚨 Error loading settings:', error);
                    return defaultSettings;
                }
            }

            saveSettings() {
                try {
                    // Merge current settings with new values
                    const newSettings = {
                        ...this.settings,
                        visualTheme: document.getElementById('visualTheme')?.value || this.settings.visualTheme || 'cosmic',
                        animationSpeed: document.getElementById('animationSpeed')?.value || this.settings.animationSpeed || 'normal',
                        particleEffects: document.getElementById('particleEffects')?.value || this.settings.particleEffects || 'enabled',
                        soundEffects: document.getElementById('soundEffects')?.value || this.settings.soundEffects || 'enabled',
                        autoSave: document.getElementById('autoSave')?.value || this.settings.autoSave || 'enabled',
                        playerImageSize: document.getElementById('playerImageSize')?.value || this.settings.playerImageSize || 150,
                        clubLogoSize: document.getElementById('clubLogoSize')?.value || this.settings.clubLogoSize || 32,
                        cardTransition: document.getElementById('cardTransition')?.value || this.settings.cardTransition || 'fadeIn',
                        transitionDuration: document.getElementById('transitionDuration')?.value || this.settings.transitionDuration || 1.0,
                        lmStudioURL: document.getElementById('lmStudioURL')?.value || this.settings.lmStudioURL || 'http://localhost:1234'
                    };

                    localStorage.setItem('ultimateStudio_settings', JSON.stringify(newSettings));
                    this.settings = newSettings;

                    this.showNotification('💾 تم حفظ الإعدادات بنجاح', 'success');
                } catch (error) {
                    console.error('🚨 Error saving settings:', error);
                    this.showNotification('❌ فشل في حفظ الإعدادات', 'error');
                }
            }

            // Safe settings save without applying (to avoid recursion)
            saveSettingsOnly() {
                try {
                    localStorage.setItem('ultimateStudio_settings', JSON.stringify(this.settings));
                } catch (error) {
                    console.error('🚨 Error saving settings:', error);
                }
            }

            resetSettings() {
                const defaultSettings = {
                    visualTheme: 'cosmic',
                    animationSpeed: 'normal',
                    particleEffects: 'enabled',
                    soundEffects: 'enabled',
                    autoSave: 'enabled'
                };

                // Update UI
                Object.keys(defaultSettings).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = defaultSettings[key];
                    }
                });

                this.settings = defaultSettings;
                this.applySettings();
                this.showNotification('🔄 تم إعادة تعيين الإعدادات', 'info');
            }

            applySettings() {
                // Apply visual theme
                this.changeTheme(this.settings.visualTheme);

                // Apply animation speed
                this.setAnimationSpeed(this.settings.animationSpeed);

                // Apply particle effects
                this.setParticleEffects(this.settings.particleEffects);

                // Apply sound effects
                this.setSoundEffects(this.settings.soundEffects);
            }

            // 🎮 Card Style Management
            changeCardStyle(style) {
                this.currentCardStyle = style;
                this.showNotification(`🎮 تم تغيير نمط البطاقة إلى ${this.getCardStyleNameArabic(style)}`, 'success');

                // If there's a current visualization, regenerate it with new style
                if (this.currentPlayer) {
                    this.regenerateWithNewStyle();
                }
            }

            getCardStyleNameArabic(style) {
                const names = {
                    'fifa26': 'فيفا 26',
                    'financial': 'التحليل المالي ثلاثي الأبعاد'
                };
                return names[style] || style;
            }

            async regenerateWithNewStyle() {
                if (!this.currentPlayer) return;

                this.clearPreviewContent();
                this.showProfessionalLoader();

                try {
                    await this.generateVisualizationByStyle(this.currentPlayer);
                } catch (error) {
                    console.error('Error regenerating with new style:', error);
                } finally {
                    this.hideProfessionalLoader();
                }
            }

            async generateVisualizationByStyle(playerData) {
                switch(this.currentCardStyle) {
                    case 'fifa26':
                        await this.generateFIFA26Visualization(playerData);
                        break;
                    case 'financial':
                        await this.generateFinancialVisualization(playerData);
                        break;
                    default:
                        await this.generateFIFA26Visualization(playerData);
                }
            }

            // 🎨 Modern Background Theme Management
            changeTheme(theme) {
                console.log(`🎨 Changing theme to: ${theme}`);

                const body = document.body;

                // Remove existing theme classes
                body.classList.remove('theme-cosmic', 'theme-neon', 'theme-holographic', 'theme-quantum', 'theme-futuristic', 'theme-financial', 'theme-matrix', 'theme-cyberpunk');

                // Add new theme class
                body.classList.add(`theme-${theme}`);

                // Save theme to settings
                this.settings.visualTheme = theme;
                this.saveSettingsOnly();

                // Apply modern background styles directly
                this.applyModernBackground(theme);

                // Update the select element
                const themeSelect = document.getElementById('visualTheme');
                if (themeSelect && themeSelect.value !== theme) {
                    themeSelect.value = theme;
                }

                this.showNotification(`🎨 تم تغيير خلفية التطبيق إلى ${this.getThemeNameArabic(theme)}`, 'success');
            }

            applyModernBackground(theme) {
                console.log(`🌈 Applying background theme: ${theme}`);

                const body = document.body;

                // Clean up existing particles and effects
                this.cleanupBackgroundEffects();

                // Remove existing background styles and animations
                body.style.background = '';
                body.style.backgroundImage = '';
                body.style.backgroundAttachment = '';
                body.style.backgroundSize = '';
                body.style.backgroundPosition = '';
                body.style.animation = '';

                // Force immediate application
                setTimeout(() => {
                    switch(theme) {
                    case 'neon':
                        body.style.background = `
                            linear-gradient(45deg, #ff0080 0%, #00d4ff 25%, #39ff14 50%, #ff4500 75%, #ff0080 100%),
                            radial-gradient(circle at 20% 80%, #ff0080 0%, transparent 50%),
                            radial-gradient(circle at 80% 20%, #00d4ff 0%, transparent 50%),
                            radial-gradient(circle at 40% 40%, #39ff14 0%, transparent 50%)
                        `;
                        body.style.backgroundSize = '400% 400%, 100% 100%, 100% 100%, 100% 100%';
                        body.style.animation = 'neonShift 8s ease-in-out infinite';
                        break;

                    case 'holographic':
                        body.style.background = `
                            linear-gradient(124deg, #ff006e, #8338ec, #3a86ff),
                            linear-gradient(45deg, #06ffa5, #ffbe0b, #fb5607),
                            linear-gradient(90deg, #ff006e, transparent, #3a86ff)
                        `;
                        body.style.backgroundSize = '300% 300%, 200% 200%, 100% 100%';
                        body.style.animation = 'holographicShift 12s ease-in-out infinite';
                        break;

                    case 'quantum':
                        body.style.background = `
                            radial-gradient(circle at 25% 25%, #667eea 0%, transparent 50%),
                            radial-gradient(circle at 75% 75%, #764ba2 0%, transparent 50%),
                            linear-gradient(135deg, #f093fb 0%, #f5576c 100%),
                            linear-gradient(45deg, #667eea, #764ba2)
                        `;
                        body.style.backgroundSize = '100% 100%, 100% 100%, 100% 100%, 100% 100%';
                        body.style.animation = 'quantumPulse 10s ease-in-out infinite';
                        break;

                    case 'futuristic':
                        body.style.background = `
                            linear-gradient(45deg, #00c9ff, #92fe9d, #fc00ff, #00dbde),
                            radial-gradient(circle at 30% 70%, #00c9ff 0%, transparent 60%),
                            radial-gradient(circle at 70% 30%, #fc00ff 0%, transparent 60%)
                        `;
                        body.style.backgroundSize = '300% 300%, 100% 100%, 100% 100%';
                        body.style.animation = 'futuristicFlow 15s linear infinite';
                        break;

                    case 'financial':
                        body.style.background = `
                            radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.15) 0%, transparent 50%),
                            radial-gradient(circle at 80% 80%, rgba(0, 255, 127, 0.15) 0%, transparent 50%),
                            radial-gradient(circle at 50% 10%, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
                            linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%)
                        `;
                        body.style.backgroundSize = '100% 100%, 100% 100%, 100% 100%, 100% 100%';
                        body.style.animation = 'financialFloat 25s ease-in-out infinite';
                        this.createFinancialParticles();
                        break;

                    case 'matrix':
                        body.style.background = `
                            linear-gradient(90deg, transparent 0%, rgba(0, 255, 0, 0.03) 50%, transparent 100%),
                            linear-gradient(0deg, #000000 0%, #001100 100%)
                        `;
                        body.style.backgroundSize = '100px 100%, 100% 100%';
                        body.style.animation = 'matrixRain 20s linear infinite';
                        this.createMatrixEffect();
                        break;

                    case 'cyberpunk':
                        body.style.background = `
                            linear-gradient(45deg, #ff0080 0%, #00d4ff 25%, #ff4500 50%, #39ff14 75%, #ff0080 100%),
                            radial-gradient(circle at 20% 80%, rgba(255, 0, 128, 0.3) 0%, transparent 50%),
                            radial-gradient(circle at 80% 20%, rgba(0, 212, 255, 0.3) 0%, transparent 50%),
                            linear-gradient(135deg, #0a0a0f 0%, #2a0845 100%)
                        `;
                        body.style.backgroundSize = '400% 400%, 100% 100%, 100% 100%, 100% 100%';
                        body.style.animation = 'cyberpunkGlow 12s ease-in-out infinite';
                        break;

                    default: // cosmic
                        body.style.background = `
                            radial-gradient(circle at 20% 80%, #667eea 0%, transparent 50%),
                            radial-gradient(circle at 80% 20%, #764ba2 0%, transparent 50%),
                            radial-gradient(circle at 40% 40%, #f093fb 0%, transparent 50%),
                            linear-gradient(135deg, #0a0a0f 0%, #1a0b2e 100%)
                        `;
                        body.style.backgroundSize = '100% 100%, 100% 100%, 100% 100%, 100% 100%';
                        body.style.animation = 'cosmicDrift 20s ease-in-out infinite';
                }

                    // Add dynamic background animations
                    this.addBackgroundAnimations();

                    console.log(`✅ Background theme applied: ${theme}`);
                }, 100); // Small delay to ensure proper application
            }

            // Clean up existing background effects
            cleanupBackgroundEffects() {
                // Remove financial particles
                const financialParticles = document.querySelectorAll('.financial-bg-particle');
                financialParticles.forEach(p => p.remove());

                // Remove matrix characters
                const matrixChars = document.querySelectorAll('.matrix-char');
                matrixChars.forEach(m => m.remove());

                // Remove existing styles
                const existingFinancialStyles = document.getElementById('financialBgStyles');
                if (existingFinancialStyles) {
                    existingFinancialStyles.remove();
                }

                const existingMatrixStyles = document.getElementById('matrixStyles');
                if (existingMatrixStyles) {
                    existingMatrixStyles.remove();
                }
            }

            addBackgroundAnimations() {
                // Remove existing animation styles
                const existingStyle = document.getElementById('backgroundAnimations');
                if (existingStyle) {
                    existingStyle.remove();
                }

                // Add new animation styles
                const style = document.createElement('style');
                style.id = 'backgroundAnimations';
                style.textContent = `
                    @keyframes neonShift {
                        0%, 100% { background-position: 0% 50%, 0% 0%, 100% 100%, 50% 50%; }
                        25% { background-position: 100% 50%, 20% 20%, 80% 80%, 30% 70%; }
                        50% { background-position: 100% 100%, 40% 40%, 60% 60%, 70% 30%; }
                        75% { background-position: 0% 100%, 60% 60%, 40% 40%, 80% 80%; }
                    }

                    @keyframes holographicShift {
                        0% { background-position: 0% 0%, 0% 0%, 0% 0%; }
                        33% { background-position: 100% 100%, 50% 50%, 25% 75%; }
                        66% { background-position: 50% 50%, 100% 0%, 75% 25%; }
                        100% { background-position: 0% 0%, 0% 0%, 0% 0%; }
                    }

                    @keyframes quantumPulse {
                        0%, 100% { background-position: 0% 0%, 100% 100%, 0% 0%, 0% 0%; }
                        25% { background-position: 25% 25%, 75% 75%, 25% 25%, 25% 25%; }
                        50% { background-position: 50% 50%, 50% 50%, 50% 50%, 50% 50%; }
                        75% { background-position: 75% 75%, 25% 25%, 75% 75%, 75% 75%; }
                    }

                    @keyframes futuristicFlow {
                        0% { background-position: 0% 0%, 0% 0%, 100% 100%; }
                        50% { background-position: 100% 100%, 50% 50%, 0% 0%; }
                        100% { background-position: 0% 0%, 0% 0%, 100% 100%; }
                    }

                    @keyframes cosmicDrift {
                        0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%, 0% 0%; }
                        25% { background-position: 25% 25%, 75% 75%, 25% 75%, 25% 25%; }
                        50% { background-position: 50% 50%, 50% 50%, 75% 25%, 50% 50%; }
                        75% { background-position: 75% 75%, 25% 25%, 25% 75%, 75% 75%; }
                    }

                    @keyframes financialFloat {
                        0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%, 0% 0%; }
                        25% { background-position: 20% 20%, 80% 80%, 30% 70%, 25% 25%; }
                        50% { background-position: 40% 40%, 60% 60%, 70% 30%, 50% 50%; }
                        75% { background-position: 60% 60%, 40% 40%, 20% 80%, 75% 75%; }
                    }

                    @keyframes matrixRain {
                        0% { background-position: 0% 0%, 0% 0%; }
                        100% { background-position: 100% 0%, 0% 100%; }
                    }

                    @keyframes cyberpunkGlow {
                        0%, 100% { background-position: 0% 50%, 0% 0%, 100% 100%, 0% 0%; }
                        25% { background-position: 100% 50%, 20% 20%, 80% 80%, 25% 25%; }
                        50% { background-position: 100% 100%, 40% 40%, 60% 60%, 50% 50%; }
                        75% { background-position: 0% 100%, 60% 60%, 40% 40%, 75% 75%; }
                    }
                `;
                document.head.appendChild(style);
            }

            getThemeNameArabic(theme) {
                const names = {
                    'cosmic': 'كوني عصري',
                    'neon': 'نيون سايبر متحرك',
                    'holographic': 'هولوجرافي ثلاثي الأبعاد',
                    'quantum': 'كمي متقدم نابض',
                    'futuristic': 'مستقبلي 2025 متدفق',
                    'financial': 'التحليل المالي ثلاثي الأبعاد',
                    'matrix': 'ماتريكس رقمي متحرك',
                    'cyberpunk': 'سايبر بانك 2077'
                };
                return names[theme] || theme;
            }

            setAnimationSpeed(speed) {
                const root = document.documentElement;

                switch(speed) {
                    case 'slow':
                        root.style.setProperty('--animation-duration', '3s');
                        break;
                    case 'fast':
                        root.style.setProperty('--animation-duration', '0.5s');
                        break;
                    case 'instant':
                        root.style.setProperty('--animation-duration', '0.1s');
                        break;
                    default: // normal
                        root.style.setProperty('--animation-duration', '1s');
                }
            }

            setParticleEffects(setting) {
                // This will be handled in the particle system
                this.particleEffectsSetting = setting;
            }

            setSoundEffects(setting) {
                this.soundEffectsSetting = setting;
            }

            // 🧪 Test Club Logos Function
            async testClubLogos() {
                console.log('🧪 Testing club logos with real-verified-extractor integration...');

                // أولاً، فحص البيانات المحفوظة
                const realExtractorData = localStorage.getItem('realExtractor_clubs');
                const arabicMappings = localStorage.getItem('ARABIC_MAPPINGS');

                console.log('📊 Data check:');
                console.log(`- Real Extractor Clubs: ${realExtractorData ? 'Found' : 'Not found'}`);
                console.log(`- Arabic Mappings: ${arabicMappings ? 'Found' : 'Not found'}`);

                if (realExtractorData) {
                    try {
                        const clubsData = JSON.parse(realExtractorData);
                        console.log(`📈 Total clubs in real-verified-extractor: ${clubsData.length}`);

                        // عرض أول 5 أندية كمثال
                        console.log('📋 Sample clubs:');
                        clubsData.slice(0, 5).forEach(([id, club]) => {
                            console.log(`  - ${club.englishName} (${club.arabicName}) - Logo: ${club.logoUrl ? 'Yes' : 'No'}`);
                        });
                    } catch (error) {
                        console.error('❌ Error parsing clubs data:', error);
                    }
                }

                const testClubs = [
                    'مانشستر سيتي',
                    'مان سيتي',
                    'ريال مدريد',
                    'برشلونة',
                    'الهلال',
                    'النصر',
                    'باريس سان جيرمان',
                    'بايرن ميونخ'
                ];

                console.log('\n🔍 Testing logo retrieval:');
                let successCount = 0;
                for (const club of testClubs) {
                    console.log(`\n🔍 Testing: ${club}`);
                    const logo = await this.getClubLogo(club);
                    if (logo) {
                        console.log(`📸 Result: ✅ Found - ${logo}`);
                        successCount++;
                    } else {
                        console.log(`📸 Result: ❌ Not found`);
                    }
                }

                console.log(`\n📊 Test Summary: ${successCount}/${testClubs.length} clubs found logos`);
                this.showNotification(`🧪 اختبار الشعارات: ${successCount}/${testClubs.length} نجح - تحقق من وحدة التحكم`,
                    successCount > testClubs.length / 2 ? 'success' : 'warning');
            }

            // 📊 Show Integration Statistics
            async showIntegrationStats() {
                try {
                    console.log('📊 Getting integration statistics...');

                    let message = '📊 إحصائيات التكامل:\n\n';

                    // Get local cache stats
                    if (window.clubLogoIntegration) {
                        const cacheStats = window.clubLogoIntegration.getCacheStats();
                        message += `🔗 التكامل المحلي:\n`;
                        message += `• إجمالي الأندية: ${cacheStats.totalClubs}\n`;
                        message += `• أندية بشعارات: ${cacheStats.clubsWithLogos}\n`;
                        message += `• أندية بدون شعارات: ${cacheStats.clubsWithoutLogos}\n`;
                        message += `• آخر مزامنة: ${cacheStats.lastSyncTime ? new Date(cacheStats.lastSyncTime).toLocaleString('ar') : 'لم تتم'}\n\n`;

                        if (Object.keys(cacheStats.sources).length > 0) {
                            message += `📈 المصادر:\n`;
                            Object.entries(cacheStats.sources).forEach(([source, count]) => {
                                message += `• ${source}: ${count}\n`;
                            });
                            message += '\n';
                        }
                    }

                    // Get server stats
                    try {
                        const response = await fetch('/api/sync-status');
                        if (response.ok) {
                            const serverStats = await response.json();
                            if (serverStats.success) {
                                const stats = serverStats.data;
                                message += `🌐 الخادم:\n`;
                                message += `• إجمالي الأندية: ${stats.totalClubs}\n`;
                                message += `• أندية بشعارات: ${stats.clubsWithLogos}\n`;
                                message += `• أندية بدون شعارات: ${stats.clubsWithoutLogos}\n`;
                                message += `• آخر تحديث: ${stats.lastUpdated ? new Date(stats.lastUpdated).toLocaleString('ar') : 'غير محدد'}\n\n`;

                                if (Object.keys(stats.sources).length > 0) {
                                    message += `📈 مصادر الخادم:\n`;
                                    Object.entries(stats.sources).forEach(([source, count]) => {
                                        message += `• ${source}: ${count}\n`;
                                    });
                                }
                            }
                        }
                    } catch (serverError) {
                        message += `⚠️ خطأ في الحصول على إحصائيات الخادم: ${serverError.message}\n`;
                    }

                    // Show in console and notification
                    console.log(message);
                    this.showNotification('📊 تم عرض إحصائيات التكامل في وحدة التحكم', 'info');

                    // Also show in alert for immediate visibility
                    alert(message);

                } catch (error) {
                    console.error('🚨 Error getting integration stats:', error);
                    this.showNotification('❌ خطأ في الحصول على إحصائيات التكامل', 'error');
                }
            }

            // 🔄 Force Sync with Verified Extractor
            async forceSyncWithExtractor() {
                try {
                    console.log('🔄 Forcing sync with verified extractor...');

                    if (window.clubLogoIntegration) {
                        await window.clubLogoIntegration.syncWithVerifiedExtractor();
                        this.showNotification('✅ تم تحديث البيانات من مستخرج الشعارات المعتمد', 'success');

                        // Show updated stats
                        setTimeout(() => {
                            this.showIntegrationStats();
                        }, 1000);
                    } else {
                        this.showNotification('⚠️ خدمة التكامل غير متاحة', 'warning');
                    }

                } catch (error) {
                    console.error('🚨 Error forcing sync:', error);
                    this.showNotification('❌ خطأ في المزامنة القسرية', 'error');
                }
            }

            // 📊 Show Real-time Sync Statistics
            async showRealTimeSyncStats() {
                try {
                    console.log('📊 Getting real-time sync statistics...');

                    let message = '📊 إحصائيات المزامنة الفورية:\n\n';

                    if (window.realTimeSync) {
                        const syncStats = window.realTimeSync.getSyncStats();

                        message += `🔄 حالة المراقبة: ${syncStats.isMonitoring ? 'نشطة' : 'متوقفة'}\n`;
                        message += `⏱️ فترة المزامنة: ${syncStats.syncInterval / 1000} ثانية\n`;
                        message += `📈 إجمالي المزامنات: ${syncStats.totalSyncs}\n`;
                        message += `✅ مزامنات ناجحة: ${syncStats.successfulSyncs}\n`;
                        message += `❌ أخطاء: ${syncStats.errors}\n`;
                        message += `👂 مستمعي التغييرات: ${syncStats.changeListeners}\n`;
                        message += `🕐 آخر مزامنة: ${syncStats.lastSyncTime ? new Date(syncStats.lastSyncTime).toLocaleString('ar') : 'لم تتم'}\n\n`;

                        // Calculate success rate
                        const successRate = syncStats.totalSyncs > 0 ?
                            ((syncStats.successfulSyncs / syncStats.totalSyncs) * 100).toFixed(1) : 0;
                        message += `📊 معدل النجاح: ${successRate}%\n`;

                    } else {
                        message += '⚠️ خدمة المزامنة الفورية غير متاحة\n';
                    }

                    // Show in console and notification
                    console.log(message);
                    this.showNotification('📊 تم عرض إحصائيات المزامنة الفورية في وحدة التحكم', 'info');

                    // Also show in alert for immediate visibility
                    alert(message);

                } catch (error) {
                    console.error('🚨 Error getting real-time sync stats:', error);
                    this.showNotification('❌ خطأ في الحصول على إحصائيات المزامنة الفورية', 'error');
                }
            }

            // 🔄 Toggle Real-time Monitoring
            toggleRealTimeMonitoring() {
                try {
                    if (window.realTimeSync) {
                        const stats = window.realTimeSync.getSyncStats();

                        if (stats.isMonitoring) {
                            window.realTimeSync.stopMonitoring();
                            this.showNotification('⏸️ تم إيقاف المراقبة الفورية', 'warning');
                        } else {
                            window.realTimeSync.startMonitoring();
                            this.showNotification('▶️ تم تشغيل المراقبة الفورية', 'success');
                        }
                    } else {
                        this.showNotification('⚠️ خدمة المزامنة الفورية غير متاحة', 'warning');
                    }
                } catch (error) {
                    console.error('🚨 Error toggling real-time monitoring:', error);
                    this.showNotification('❌ خطأ في تبديل المراقبة الفورية', 'error');
                }
            }

            // 🔄 Force Real-time Sync
            async forceRealTimeSync() {
                try {
                    if (window.realTimeSync) {
                        await window.realTimeSync.forceSync();
                        this.showNotification('✅ تم تنفيذ المزامنة الفورية', 'success');

                        // Show updated stats
                        setTimeout(() => {
                            this.showRealTimeSyncStats();
                        }, 1000);
                    } else {
                        this.showNotification('⚠️ خدمة المزامنة الفورية غير متاحة', 'warning');
                    }
                } catch (error) {
                    console.error('🚨 Error forcing real-time sync:', error);
                    this.showNotification('❌ خطأ في المزامنة الفورية القسرية', 'error');
                }
            }

            // 🧪 Run Comprehensive System Tests
            async runComprehensiveTests() {
                try {
                    console.log('🧪 Starting comprehensive system tests...');
                    this.showNotification('🧪 بدء الاختبارات الشاملة للنظام...', 'info');

                    if (window.SystemTester) {
                        const tester = new window.SystemTester();
                        const results = await tester.runComprehensiveTests();

                        // Show results summary
                        const report = tester.generateTestReport();
                        const message = `📊 نتائج الاختبارات الشاملة:

🔢 إجمالي الاختبارات: ${report.summary.totalTests}
✅ نجح: ${report.summary.passedTests}
❌ فشل: ${report.summary.failedTests}
📈 معدل النجاح: ${report.successRate}%
⏱️ متوسط وقت الاستجابة: ${report.summary.averageResponseTime.toFixed(2)}ms

📋 الفئات:
${Object.entries(report.categories).map(([category, stats]) =>
    `• ${category}: ${stats.passed}/${stats.total} (${(stats.passed/stats.total*100).toFixed(1)}%)`
).join('\n')}`;

                        console.log(message);
                        alert(message);

                        this.showNotification(`✅ اكتملت الاختبارات - معدل النجاح: ${report.successRate}%`, 'success');

                        return results;
                    } else {
                        this.showNotification('⚠️ نظام الاختبار غير متاح', 'warning');
                    }
                } catch (error) {
                    console.error('🚨 Error running comprehensive tests:', error);
                    this.showNotification('❌ خطأ في تشغيل الاختبارات الشاملة', 'error');
                }
            }

            // ⚡ Run Quick System Test
            async runQuickTest() {
                try {
                    console.log('⚡ Starting quick system test...');
                    this.showNotification('⚡ بدء الاختبار السريع...', 'info');

                    if (window.SystemTester) {
                        const tester = new window.SystemTester();
                        const results = await tester.runQuickTest();

                        const passedTests = results.filter(r => r.searchPassed && r.logoPassed).length;
                        const totalTests = results.length;
                        const successRate = (passedTests / totalTests * 100).toFixed(1);

                        const message = `⚡ نتائج الاختبار السريع:

✅ نجح: ${passedTests}/${totalTests} (${successRate}%)

📋 التفاصيل:
${results.map(r =>
    `• ${r.club}: ${r.searchPassed ? '✅' : '❌'} بحث | ${r.logoPassed ? '✅' : '❌'} شعار`
).join('\n')}`;

                        console.log(message);
                        alert(message);

                        this.showNotification(`⚡ اكتمل الاختبار السريع - معدل النجاح: ${successRate}%`,
                            successRate > 80 ? 'success' : successRate > 60 ? 'warning' : 'error');

                        return results;
                    } else {
                        this.showNotification('⚠️ نظام الاختبار غير متاح', 'warning');
                    }
                } catch (error) {
                    console.error('🚨 Error running quick test:', error);
                    this.showNotification('❌ خطأ في تشغيل الاختبار السريع', 'error');
                }
            }

            // 📊 Show System Health Status
            async showSystemHealthStatus() {
                try {
                    console.log('📊 Checking system health...');

                    let healthReport = '📊 تقرير صحة النظام:\n\n';
                    let overallHealth = 100;

                    // Check integration service
                    if (window.clubLogoIntegration) {
                        const cacheStats = window.clubLogoIntegration.getCacheStats();
                        healthReport += `🔗 خدمة التكامل: ✅ نشطة\n`;
                        healthReport += `   • الأندية المحفوظة: ${cacheStats.totalClubs}\n`;
                        healthReport += `   • أندية بشعارات: ${cacheStats.clubsWithLogos}\n`;
                        healthReport += `   • آخر مزامنة: ${cacheStats.lastSyncTime ? new Date(cacheStats.lastSyncTime).toLocaleString('ar') : 'لم تتم'}\n\n`;
                    } else {
                        healthReport += `🔗 خدمة التكامل: ❌ غير نشطة\n\n`;
                        overallHealth -= 30;
                    }

                    // Check real-time sync
                    if (window.realTimeSync) {
                        const syncStats = window.realTimeSync.getSyncStats();
                        healthReport += `⚡ المزامنة الفورية: ${syncStats.isMonitoring ? '✅' : '⚠️'} ${syncStats.isMonitoring ? 'نشطة' : 'متوقفة'}\n`;
                        healthReport += `   • إجمالي المزامنات: ${syncStats.totalSyncs}\n`;
                        healthReport += `   • مزامنات ناجحة: ${syncStats.successfulSyncs}\n`;
                        healthReport += `   • أخطاء: ${syncStats.errors}\n\n`;

                        if (!syncStats.isMonitoring) overallHealth -= 20;
                        if (syncStats.errors > 0) overallHealth -= 10;
                    } else {
                        healthReport += `⚡ المزامنة الفورية: ❌ غير متاحة\n\n`;
                        overallHealth -= 25;
                    }

                    // Check API connectivity
                    try {
                        const response = await fetch('/api/sync-status');
                        if (response.ok) {
                            healthReport += `🌐 اتصال API: ✅ متصل\n`;
                            const data = await response.json();
                            if (data.success) {
                                healthReport += `   • أندية الخادم: ${data.data.totalClubs}\n`;
                            }
                        } else {
                            healthReport += `🌐 اتصال API: ⚠️ مشاكل في الاتصال\n`;
                            overallHealth -= 15;
                        }
                    } catch (error) {
                        healthReport += `🌐 اتصال API: ❌ غير متصل\n`;
                        overallHealth -= 25;
                    }

                    healthReport += `\n📈 الصحة العامة: ${overallHealth}%\n`;

                    if (overallHealth >= 90) {
                        healthReport += `🟢 النظام يعمل بشكل ممتاز`;
                    } else if (overallHealth >= 70) {
                        healthReport += `🟡 النظام يعمل بشكل جيد مع بعض المشاكل البسيطة`;
                    } else if (overallHealth >= 50) {
                        healthReport += `🟠 النظام يعمل مع مشاكل متوسطة`;
                    } else {
                        healthReport += `🔴 النظام يحتاج إلى إصلاح فوري`;
                    }

                    console.log(healthReport);
                    alert(healthReport);

                    const notificationType = overallHealth >= 80 ? 'success' : overallHealth >= 60 ? 'warning' : 'error';
                    this.showNotification(`📊 صحة النظام: ${overallHealth}%`, notificationType);

                } catch (error) {
                    console.error('🚨 Error checking system health:', error);
                    this.showNotification('❌ خطأ في فحص صحة النظام', 'error');
                }
            }

            // 🔗 Test Direct Connection with Real-Verified-Extractor
            async testDirectConnection() {
                try {
                    console.log('🔗 Testing direct connection with real-verified-extractor...');
                    this.showNotification('🔗 اختبار الربط المباشر...', 'info');

                    // فحص البيانات المحفوظة
                    const realExtractorData = localStorage.getItem('realExtractor_clubs');
                    const arabicMappings = localStorage.getItem('ARABIC_MAPPINGS');

                    let report = '🔗 تقرير الربط المباشر:\n\n';

                    if (!realExtractorData) {
                        report += '❌ لا توجد بيانات من real-verified-extractor\n';
                        report += '💡 تأكد من فتح http://localhost:8201/real-verified-extractor-fixed.html واستخراج الأندية أولاً\n\n';
                    } else {
                        try {
                            const clubsData = JSON.parse(realExtractorData);
                            report += `✅ تم العثور على ${clubsData.length} نادي\n`;

                            // عد الأندية التي لديها شعارات
                            let clubsWithLogos = 0;
                            let sampleClubs = [];

                            clubsData.slice(0, 10).forEach(([id, club]) => {
                                if (club.logoUrl) clubsWithLogos++;
                                sampleClubs.push(`${club.englishName} (${club.arabicName})`);
                            });

                            report += `🏆 أندية بشعارات: ${clubsWithLogos}/10 من العينة\n`;
                            report += `📋 عينة من الأندية:\n${sampleClubs.slice(0, 5).map(club => `  • ${club}`).join('\n')}\n\n`;

                        } catch (error) {
                            report += `❌ خطأ في قراءة البيانات: ${error.message}\n\n`;
                        }
                    }

                    if (!arabicMappings) {
                        report += '⚠️ لا توجد ترجمات عربية محفوظة\n';
                    } else {
                        try {
                            const mappings = JSON.parse(arabicMappings);
                            report += `✅ تم العثور على ${Object.keys(mappings).length} ترجمة عربية\n\n`;
                        } catch (error) {
                            report += `❌ خطأ في قراءة الترجمات: ${error.message}\n\n`;
                        }
                    }

                    // اختبار البحث المباشر
                    report += '🔍 اختبار البحث المباشر:\n';
                    const testClubs = ['ريال مدريد', 'برشلونة', 'مانشستر سيتي', 'الهلال'];
                    let foundCount = 0;

                    for (const clubName of testClubs) {
                        const logo = await this.getClubLogo(clubName);
                        if (logo) {
                            report += `  ✅ ${clubName}: تم العثور على الشعار\n`;
                            foundCount++;
                        } else {
                            report += `  ❌ ${clubName}: لم يتم العثور على الشعار\n`;
                        }
                    }

                    report += `\n📊 النتيجة: ${foundCount}/${testClubs.length} أندية تم العثور على شعاراتها\n`;

                    if (foundCount === 0) {
                        report += '\n💡 نصائح لحل المشكلة:\n';
                        report += '1. افتح real-verified-extractor-fixed.html\n';
                        report += '2. اضغط على "بدء الاستخراج الذكي"\n';
                        report += '3. انتظر حتى يتم استخراج الأندية\n';
                        report += '4. عد إلى هذه الصفحة وجرب مرة أخرى\n';
                    }

                    console.log(report);
                    alert(report);

                    const notificationType = foundCount > testClubs.length / 2 ? 'success' :
                                           foundCount > 0 ? 'warning' : 'error';
                    this.showNotification(`🔗 اختبار الربط: ${foundCount}/${testClubs.length} نجح`, notificationType);

                } catch (error) {
                    console.error('🚨 Error testing direct connection:', error);
                    this.showNotification('❌ خطأ في اختبار الربط المباشر', 'error');
                }
            }

            // 🎮 Create Test Player with Guaranteed Logos
            async createTestPlayer() {
                console.log('🎮 Creating test player with guaranteed logos...');

                this.showProfessionalLoader();

                // Create test player data with guaranteed logos
                const testPlayerData = {
                    arabicName: 'محمد صلاح',
                    englishName: 'Mohamed Salah',
                    currentClub: 'ليفربول',
                    targetClub: 'ريال مدريد',
                    imageUrl: 'https://img.a.transfermarkt.technology/portrait/big/148455-1694609670.jpg?lm=1',
                    currentClubLogo: await this.getClubLogo('ليفربول'),
                    targetClubLogo: await this.getClubLogo('ريال مدريد'),
                    probability: {
                        percentage: 75,
                        display: '75%',
                        factors: ['نجم عالمي', 'عقد ينتهي قريباً', 'اهتمام ريال مدريد'],
                        confidence: 'عالية',
                        trend: 'محتمل جداً'
                    },
                    position: 'RW',
                    age: 32,
                    marketValue: '€60M',
                    contractExpiry: '2025',
                    nationality: 'مصر',
                    height: '175 سم',
                    foot: 'أيسر',
                    rating: 89,
                    allRumors: []
                };

                console.log('🏆 Test player data with logos:', testPlayerData);

                // Store as current player
                this.currentPlayer = testPlayerData;

                // Generate FIFA 26 visualization
                const visualizationHTML = this.createFIFA26CardHTML(testPlayerData);
                const previewContent = document.getElementById('previewContent');
                const placeholder = document.getElementById('previewPlaceholder');

                if (placeholder) {
                    placeholder.style.display = 'none';
                }

                previewContent.innerHTML = visualizationHTML;

                // Initialize effects
                this.initializeParticleEffects();
                this.startFIFAAnimations();
                this.playCreationSound();

                this.hideProfessionalLoader();
                this.showNotification('🎮 تم إنشاء لاعب تجريبي مع شعارات مضمونة!', 'success');
            }

            // 💰 Create Financial Particles for Background
            createFinancialParticles() {
                // Remove existing particles
                const existingParticles = document.querySelectorAll('.financial-bg-particle');
                existingParticles.forEach(p => p.remove());

                const body = document.body;
                const symbols = ['$', '€', '£', '¥', '₹', '%', '∑', '∆', '∞', '±'];

                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'financial-bg-particle';
                    particle.style.cssText = `
                        position: fixed;
                        font-size: ${Math.random() * 30 + 15}px;
                        color: rgba(255, 215, 0, ${Math.random() * 0.3 + 0.1});
                        pointer-events: none;
                        z-index: 1;
                        left: ${Math.random() * 100}vw;
                        top: ${Math.random() * 100}vh;
                        animation: financialBgFloat ${Math.random() * 20 + 30}s linear infinite;
                        animation-delay: ${Math.random() * 10}s;
                    `;
                    particle.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                    body.appendChild(particle);
                }

                // Add CSS for financial particles
                if (!document.getElementById('financialBgStyles')) {
                    const style = document.createElement('style');
                    style.id = 'financialBgStyles';
                    style.textContent = `
                        @keyframes financialBgFloat {
                            0% {
                                transform: translateY(0px) rotate(0deg);
                                opacity: 0;
                            }
                            10% {
                                opacity: 1;
                            }
                            90% {
                                opacity: 1;
                            }
                            100% {
                                transform: translateY(-100vh) rotate(360deg);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            // 🔢 Create Matrix Effect
            createMatrixEffect() {
                // Remove existing matrix
                const existingMatrix = document.querySelectorAll('.matrix-char');
                existingMatrix.forEach(m => m.remove());

                const body = document.body;
                const chars = '01アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン';

                for (let i = 0; i < 50; i++) {
                    const char = document.createElement('div');
                    char.className = 'matrix-char';
                    char.style.cssText = `
                        position: fixed;
                        font-family: 'Courier New', monospace;
                        font-size: ${Math.random() * 20 + 10}px;
                        color: rgba(0, 255, 0, ${Math.random() * 0.8 + 0.2});
                        pointer-events: none;
                        z-index: 1;
                        left: ${Math.random() * 100}vw;
                        top: -50px;
                        animation: matrixFall ${Math.random() * 10 + 5}s linear infinite;
                        animation-delay: ${Math.random() * 5}s;
                    `;
                    char.textContent = chars[Math.floor(Math.random() * chars.length)];
                    body.appendChild(char);
                }

                // Add CSS for matrix effect
                if (!document.getElementById('matrixStyles')) {
                    const style = document.createElement('style');
                    style.id = 'matrixStyles';
                    style.textContent = `
                        @keyframes matrixFall {
                            0% {
                                transform: translateY(-50px);
                                opacity: 0;
                            }
                            10% {
                                opacity: 1;
                            }
                            90% {
                                opacity: 1;
                            }
                            100% {
                                transform: translateY(100vh);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            initializeManualMode() {
                console.log('✏️ Manual mode initialized');
            }

            // 🎭 Multi Players Mode
            initializeMultiMode() {
                console.log('👥 Multi players mode initialized');
                this.setupMultiDisplayMode();
                // Reset sequence settings visibility
                this.toggleSequenceSettings('all');
            }

            // Toggle sequence settings visibility
            toggleSequenceSettings(mode) {
                const sequenceSettings = document.getElementById('sequenceSettings');
                if (sequenceSettings) {
                    if (mode === 'sequence') {
                        sequenceSettings.style.display = 'block';
                        sequenceSettings.style.animation = 'slideInRight 0.5s ease-out';
                    } else {
                        sequenceSettings.style.display = 'none';
                    }
                }
            }

            setupMultiDisplayMode() {
                const displayMode = document.getElementById('multiDisplayMode');
                const sequenceSettings = document.getElementById('sequenceSettings');

                displayMode.addEventListener('change', (e) => {
                    if (e.target.value === 'sequence') {
                        sequenceSettings.style.display = 'block';
                    } else {
                        sequenceSettings.style.display = 'none';
                    }
                });
            }

            addMultiPlayer() {
                const container = document.getElementById('multiPlayersContainer');
                const playerCount = container.children.length;

                if (playerCount >= 10) {
                    this.showNotification('🚨 الحد الأقصى 10 لاعبين', 'warning');
                    return;
                }

                const playerDiv = document.createElement('div');
                playerDiv.className = 'multi-player-input';
                playerDiv.style.cssText = `
                    background: rgba(255, 255, 255, 0.05);
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    border-radius: 15px;
                    padding: 20px;
                    margin-bottom: 15px;
                    transition: all 0.3s ease;
                    animation: slideInRight 0.5s ease-out;
                `;

                playerDiv.innerHTML = `
                    <div class="player-header" style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 15px;
                        color: #00d4ff;
                        font-weight: 600;
                    ">
                        <div>
                            <i class="fas fa-user-circle" style="margin-left: 10px; font-size: 1.2rem;"></i>
                            اللاعب ${playerCount + 1}
                        </div>
                        <button type="button" onclick="ultimateStudio.removeSpecificPlayer(this)" style="
                            background: linear-gradient(135deg, #ff4757, #ff3838);
                            border: none;
                            border-radius: 50%;
                            width: 30px;
                            height: 30px;
                            color: white;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Player Name -->
                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input multi-player-name" placeholder="اسم اللاعب">
                        <i class="fas fa-user input-icon"></i>
                    </div>

                    <!-- Current Club -->
                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input multi-player-current-club"
                               placeholder="النادي الحالي (اختياري)"
                               autocomplete="off"
                               oninput="ultimateStudio.handleMultiClubInput(this, 'current')"
                               onfocus="ultimateStudio.showMultiClubSuggestions(this, 'current')"
                               onblur="ultimateStudio.hideMultiClubSuggestions(this, 'current')">
                        <i class="fas fa-shield-alt input-icon"></i>
                        <div class="club-suggestions-container multi-club-suggestions"></div>
                        <div class="club-logo-preview multi-club-logo-preview"></div>
                    </div>

                    <!-- Target Club -->
                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input multi-player-target-club"
                               placeholder="النادي المطلوب"
                               autocomplete="off"
                               oninput="ultimateStudio.handleMultiClubInput(this, 'target')"
                               onfocus="ultimateStudio.showMultiClubSuggestions(this, 'target')"
                               onblur="ultimateStudio.hideMultiClubSuggestions(this, 'target')">
                        <i class="fas fa-bullseye input-icon"></i>
                        <div class="club-suggestions-container multi-club-suggestions"></div>
                        <div class="club-logo-preview multi-club-logo-preview"></div>
                    </div>

                    <!-- Player Image URL -->
                    <div class="ultimate-input-group">
                        <input type="url" class="ultimate-input multi-player-image" placeholder="رابط صورة اللاعب (اختياري)">
                        <i class="fas fa-image input-icon"></i>
                    </div>
                `;

                container.appendChild(playerDiv);
                this.showNotification(`✅ تم إضافة اللاعب ${playerCount + 1}`, 'success');
            }

            removeMultiPlayer() {
                const container = document.getElementById('multiPlayersContainer');
                const playerCount = container.children.length;

                if (playerCount <= 1) {
                    this.showNotification('🚨 يجب الاحتفاظ بلاعب واحد على الأقل', 'warning');
                    return;
                }

                container.removeChild(container.lastElementChild);
                this.updatePlayerNumbers();
                this.showNotification(`✅ تم حذف اللاعب`, 'success');
            }

            removeSpecificPlayer(button) {
                const container = document.getElementById('multiPlayersContainer');
                const playerCount = container.children.length;

                if (playerCount <= 1) {
                    this.showNotification('🚨 يجب الاحتفاظ بلاعب واحد على الأقل', 'warning');
                    return;
                }

                const playerDiv = button.closest('.multi-player-input');
                playerDiv.style.animation = 'slideOutLeft 0.3s ease-in';

                setTimeout(() => {
                    container.removeChild(playerDiv);
                    this.updatePlayerNumbers();
                    this.showNotification(`✅ تم حذف اللاعب`, 'success');
                }, 300);
            }

            updatePlayerNumbers() {
                const container = document.getElementById('multiPlayersContainer');
                const players = container.children;

                Array.from(players).forEach((player, index) => {
                    const header = player.querySelector('.player-header div');
                    if (header) {
                        header.innerHTML = `
                            <i class="fas fa-user-circle" style="margin-left: 10px; font-size: 1.2rem;"></i>
                            اللاعب ${index + 1}
                        `;
                    }
                });
            }

            // Initialize multi-player section with mixed mode
            initializeMultiMode() {
                const container = document.getElementById('multiPlayersContainer');
                if (!container) return;

                // Clear existing players
                container.innerHTML = '';

                // Add first manual player by default
                this.addManualMultiPlayer();

                this.showNotification('🔄 نمط مختلط جاهز - يمكنك إضافة لاعبين يدوياً أو من المحفوظين', 'success');
            }

            // Add manual input player
            addManualMultiPlayer() {
                const container = document.getElementById('multiPlayersContainer');
                const playerCount = container.children.length;

                if (playerCount >= 10) {
                    this.showNotification('🚨 الحد الأقصى 10 لاعبين', 'warning');
                    return;
                }

                const playerDiv = document.createElement('div');
                playerDiv.className = 'multi-player-input';
                playerDiv.style.cssText = `
                    background: rgba(255, 255, 255, 0.05);
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    border-radius: 15px;
                    padding: 20px;
                    margin-bottom: 15px;
                    transition: all 0.3s ease;
                    animation: slideInRight 0.5s ease-out;
                `;

                playerDiv.innerHTML = `
                    <div class="player-header" style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 15px;
                        color: #00d4ff;
                        font-weight: 600;
                    ">
                        <div>
                            <i class="fas fa-edit" style="margin-left: 10px; font-size: 1.2rem; color: #00d4ff;"></i>
                            اللاعب ${playerCount + 1} - إدخال يدوي
                        </div>
                        <button type="button" onclick="ultimateStudio.removeSpecificPlayer(this)" style="
                            background: linear-gradient(135deg, #ff4757, #ff3838);
                            border: none;
                            border-radius: 50%;
                            width: 30px;
                            height: 30px;
                            color: white;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Player Name -->
                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input multi-player-name" placeholder="اسم اللاعب">
                        <i class="fas fa-user input-icon"></i>
                    </div>

                    <!-- Current Club -->
                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input multi-player-current-club"
                               placeholder="النادي الحالي (اختياري)"
                               autocomplete="off"
                               oninput="ultimateStudio.handleMultiClubInput(this, 'current')"
                               onfocus="ultimateStudio.showMultiClubSuggestions(this, 'current')"
                               onblur="ultimateStudio.hideMultiClubSuggestions(this, 'current')">
                        <i class="fas fa-shield-alt input-icon"></i>
                        <div class="club-suggestions-container multi-club-suggestions"></div>
                        <div class="club-logo-preview multi-club-logo-preview"></div>
                    </div>

                    <!-- Target Club -->
                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input multi-player-target-club"
                               placeholder="النادي المطلوب"
                               autocomplete="off"
                               oninput="ultimateStudio.handleMultiClubInput(this, 'target')"
                               onfocus="ultimateStudio.showMultiClubSuggestions(this, 'target')"
                               onblur="ultimateStudio.hideMultiClubSuggestions(this, 'target')">
                        <i class="fas fa-bullseye input-icon"></i>
                        <div class="club-suggestions-container multi-club-suggestions"></div>
                        <div class="club-logo-preview multi-club-logo-preview"></div>
                    </div>

                    <!-- Player Image URL -->
                    <div class="ultimate-input-group">
                        <input type="url" class="ultimate-input multi-player-image" placeholder="رابط صورة اللاعب (اختياري)">
                        <i class="fas fa-image input-icon"></i>
                    </div>
                `;

                container.appendChild(playerDiv);
                this.showNotification(`✅ تم إضافة لاعب يدوي ${playerCount + 1}`, 'success');
            }

            // Add saved player selection
            async addSavedMultiPlayer() {
                const container = document.getElementById('multiPlayersContainer');
                const playerCount = container.children.length;

                if (playerCount >= 10) {
                    this.showNotification('🚨 الحد الأقصى 10 لاعبين', 'warning');
                    return;
                }

                // Load saved players if not already loaded
                await this.loadSavedPlayers();

                const playerDiv = document.createElement('div');
                playerDiv.className = 'multi-player-input';
                playerDiv.style.cssText = `
                    background: rgba(0, 212, 255, 0.05);
                    border: 2px solid rgba(0, 212, 255, 0.3);
                    border-radius: 15px;
                    padding: 20px;
                    margin-bottom: 15px;
                    transition: all 0.3s ease;
                    animation: slideInRight 0.5s ease-out;
                `;

                // Get saved players list
                const savedPlayersSelect = document.getElementById('savedPlayersList');
                const savedPlayersOptions = savedPlayersSelect ? savedPlayersSelect.innerHTML : '<option value="">لا توجد لاعبين محفوظين</option>';

                playerDiv.innerHTML = `
                    <div class="player-header" style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 15px;
                        color: #00d4ff;
                        font-weight: 600;
                    ">
                        <div>
                            <i class="fas fa-database" style="margin-left: 10px; font-size: 1.2rem; color: #00d4ff;"></i>
                            اللاعب ${playerCount + 1} - من المحفوظين
                        </div>
                        <button type="button" onclick="ultimateStudio.removeSpecificPlayer(this)" style="
                            background: linear-gradient(135deg, #ff4757, #ff3838);
                            border: none;
                            border-radius: 50%;
                            width: 30px;
                            height: 30px;
                            color: white;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Saved Player Selection -->
                    <div class="ultimate-input-group">
                        <select class="ultimate-select multi-saved-player" onchange="ultimateStudio.loadSelectedSavedPlayer(this)">
                            ${savedPlayersOptions}
                        </select>
                        <i class="fas fa-database input-icon"></i>
                    </div>

                    <!-- Target Club -->
                    <div class="ultimate-input-group">
                        <input type="text" class="ultimate-input smart-club-input multi-player-target-club"
                               placeholder="النادي المطلوب"
                               autocomplete="off"
                               oninput="ultimateStudio.handleMultiClubInput(this, 'target')"
                               onfocus="ultimateStudio.showMultiClubSuggestions(this, 'target')"
                               onblur="ultimateStudio.hideMultiClubSuggestions(this, 'target')">
                        <i class="fas fa-bullseye input-icon"></i>
                        <div class="club-suggestions-container multi-club-suggestions"></div>
                        <div class="club-logo-preview multi-club-logo-preview"></div>
                    </div>

                    <!-- Hidden fields for player data -->
                    <input type="hidden" class="multi-player-name" value="">
                    <input type="hidden" class="multi-player-current-club" value="">
                    <input type="hidden" class="multi-player-image" value="">
                `;

                container.appendChild(playerDiv);
                this.showNotification(`✅ تم إضافة لاعب من المحفوظين ${playerCount + 1}`, 'success');
            }

            // Load selected saved player data into multi-player form
            async loadSelectedSavedPlayer(selectElement) {
                const selectedValue = selectElement.value;
                if (!selectedValue) return;

                try {
                    const player = JSON.parse(selectedValue);
                    const playerContainer = selectElement.closest('.multi-player-input');

                    // Update hidden fields
                    playerContainer.querySelector('.multi-player-name').value = player.arabicName || player.name || '';
                    playerContainer.querySelector('.multi-player-current-club').value = player.currentClub || '';
                    playerContainer.querySelector('.multi-player-image').value = player.playerImage || player.imageUrl || '';

                    // Update header to show selected player with image
                    const header = playerContainer.querySelector('.player-header div');
                    if (header) {
                        const playerImageUrl = player.playerImage || player.imageUrl || this.getFallbackImageUrl(player.arabicName || player.name);
                        header.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <img src="${playerImageUrl}"
                                     alt="${player.arabicName || player.name}"
                                     style="
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 50%;
                                        border: 2px solid #00d4ff;
                                        object-fit: cover;
                                        box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
                                     "
                                     onerror="this.src='${this.getFallbackImageUrl(player.arabicName || player.name)}'">
                                <div>
                                    <div style="color: #00d4ff; font-weight: 700;">
                                        <i class="fas fa-database" style="margin-left: 8px;"></i>
                                        ${player.arabicName || player.name}
                                    </div>
                                    <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin-top: 2px;">
                                        ${player.currentClub || 'غير محدد'} - محفوظ
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    this.showNotification(`✅ تم تحميل ${player.arabicName || player.name} من المحفوظين`, 'success');
                } catch (error) {
                    console.error('Error loading saved player:', error);
                    this.showNotification('❌ خطأ في تحميل بيانات اللاعب', 'error');
                }
            }

            // Legacy function - now defaults to manual
            addMultiPlayer() {
                this.addManualMultiPlayer();
            }

            // Generic function for adding multi-player input (used by import system)
            addMultiPlayerInput() {
                this.addManualMultiPlayer();
            }

            // Update image size display and apply to all modes
            updateImageSizeDisplay(value) {
                document.getElementById('imageSizeValue').textContent = value;
                this.settings.playerImageSize = value;
                this.saveSettings();

                // Apply to all existing images in all modes
                const allImages = document.querySelectorAll('img[alt*="اللاعب"], img[src*="player"], .player-image, img[style*="border-radius: 50%"]');
                allImages.forEach(img => {
                    // Skip very small images (like icons)
                    const currentWidth = parseInt(img.style.width) || img.offsetWidth;
                    if (currentWidth > 50) {
                        img.style.width = value + 'px';
                        img.style.height = value + 'px';
                        img.style.transition = 'all 0.3s ease';
                    }
                });

                // Show visual feedback
                this.showNotification(`📏 تم تحديث حجم الصور إلى ${value}px`, 'success');

                // Force OBS refresh for live streaming
                this.forceOBSRefresh();

                // Auto-sync with stream if active
                this.autoSyncWithStream();
            }

            // Unified logo size update - applies to all club logos intelligently
            updateUnifiedLogoSize(value) {
                document.getElementById('logoSizeValue').textContent = value;
                this.settings.clubLogoSize = parseInt(value);
                this.saveSettings();

                // Calculate proportional sizes for different contexts
                const baseSize = parseInt(value);
                const smallSize = Math.max(16, baseSize - 8);  // For small contexts
                const mediumSize = baseSize;                   // For normal contexts
                const largeSize = Math.min(80, baseSize + 20); // For large contexts

                // COMPREHENSIVE SEARCH: Find ALL possible club logos
                const logoSelectors = [
                    'img[src*="logo"]',
                    'img[src*="crest"]',
                    'img[src*="badge"]',
                    'img[alt*="النادي"]',
                    'img[alt*="المطلوب"]',
                    'img[alt*="club"]',
                    'img[alt*="Club"]',
                    'img[alt*="logo"]',
                    'img[alt*="Logo"]'
                ];

                let totalLogosFound = 0;

                logoSelectors.forEach(selector => {
                    const logos = document.querySelectorAll(selector);
                    console.log(`🔍 Selector "${selector}" found ${logos.length} logos`);

                    logos.forEach((img, index) => {
                        // Skip if it's clearly a player image (circular or very large)
                        const isPlayerImage = img.style.borderRadius === '50%' ||
                                            img.classList.contains('player-image') ||
                                            (img.offsetWidth > 100 && img.offsetHeight > 100);

                        if (!isPlayerImage) {
                            let targetSize = mediumSize;

                            // Determine context and apply appropriate size
                            if (img.closest('.target-club-logo-large')) {
                                targetSize = largeSize;
                            } else if (img.classList.contains('club-logo-small') || img.closest('.card-footer')) {
                                targetSize = smallSize;
                            } else if (img.classList.contains('target-club-logo') || img.alt?.includes('المطلوب')) {
                                targetSize = mediumSize + 4;
                            }

                            // Apply the size with important flag to override any existing styles
                            img.style.setProperty('width', targetSize + 'px', 'important');
                            img.style.setProperty('height', targetSize + 'px', 'important');
                            img.style.setProperty('transition', 'all 0.3s ease', 'important');

                            totalLogosFound++;
                            console.log(`🏆 Logo ${totalLogosFound}: ${img.alt || img.src.split('/').pop() || 'Unknown'} → ${targetSize}px`);
                        }
                    });
                });

                // FORCE UPDATE: Also update any logos in preview content with force
                const previewContent = document.getElementById('previewContent');
                if (previewContent) {
                    const previewLogos = previewContent.querySelectorAll('img');
                    let previewLogosUpdated = 0;

                    previewLogos.forEach(img => {
                        const src = img.src.toLowerCase();
                        const alt = (img.alt || '').toLowerCase();

                        // Check if it's a club logo
                        if (src.includes('logo') || src.includes('crest') || src.includes('badge') ||
                            alt.includes('نادي') || alt.includes('club') || alt.includes('logo')) {

                            img.style.setProperty('width', mediumSize + 'px', 'important');
                            img.style.setProperty('height', mediumSize + 'px', 'important');
                            img.style.setProperty('transition', 'all 0.3s ease', 'important');
                            previewLogosUpdated++;
                        }
                    });
                    console.log(`📺 FORCE UPDATED ${previewLogosUpdated} logos in preview content`);
                }

                // Update CSS custom properties for dynamic sizing
                document.documentElement.style.setProperty('--club-logo-size', mediumSize + 'px');
                document.documentElement.style.setProperty('--club-logo-small', smallSize + 'px');
                document.documentElement.style.setProperty('--club-logo-large', largeSize + 'px');

                // Update settings for backward compatibility
                this.settings.targetClubLogoSize = mediumSize + 4;
                this.settings.targetClubLogoLargeSize = largeSize;

                // Show visual feedback with size breakdown
                this.showNotification(`🏆 تم تحديث ${totalLogosFound} شعار - الحجم: ${mediumSize}px`, 'info');

                // Force OBS refresh for live streaming
                this.forceOBSRefresh();

                // Auto-sync with stream if active
                this.autoSyncWithStream();

                // Force re-render if in multi-player mode
                setTimeout(() => {
                    if (document.getElementById('previewContent').innerHTML.trim()) {
                        console.log('🔄 Forcing re-render to apply new logo sizes');
                        const currentMode = document.getElementById('inputMode').value;
                        if (currentMode === 'multi') {
                            // Trigger a refresh of the current display
                            const refreshBtn = document.querySelector('[onclick*="generateMultiVisualization"]');
                            if (refreshBtn) {
                                refreshBtn.click();
                            }
                        }
                    }
                }, 500);
            }

            // Keep old functions for backward compatibility
            updateLogoSizeDisplay(value) {
                this.updateUnifiedLogoSize(value);
            }

            // Keep old functions for backward compatibility
            updateTargetLogoSizeDisplay(value) {
                this.updateUnifiedLogoSize(document.getElementById('clubLogoSize').value);
            }

            updateTargetLogoLargeSizeDisplay(value) {
                this.updateUnifiedLogoSize(document.getElementById('clubLogoSize').value);
            }

            // Force OBS refresh for live streaming updates
            forceOBSRefresh() {
                try {
                    console.log('🔄 Forcing OBS refresh for live streaming...');

                    // Method 1: Add a temporary invisible element to trigger DOM change
                    const refreshTrigger = document.createElement('div');
                    refreshTrigger.style.cssText = 'position:absolute;top:-1px;left:-1px;width:1px;height:1px;opacity:0;pointer-events:none;';
                    refreshTrigger.textContent = Date.now().toString();
                    document.body.appendChild(refreshTrigger);

                    // Remove it after a brief moment
                    setTimeout(() => {
                        if (refreshTrigger.parentNode) {
                            refreshTrigger.parentNode.removeChild(refreshTrigger);
                        }
                    }, 100);

                    // Method 2: Force repaint by temporarily changing a CSS property
                    const cardElement = document.querySelector('.fifa-card, .financial-card');
                    if (cardElement) {
                        const originalTransform = cardElement.style.transform;
                        cardElement.style.transform = 'translateZ(0.1px)';

                        // Force reflow
                        cardElement.offsetHeight;

                        // Restore original transform
                        setTimeout(() => {
                            cardElement.style.transform = originalTransform || 'translateZ(0)';
                        }, 50);
                    }

                    // Method 3: Update stream content with new sizes
                    this.updateStreamContentSizes();

                    // Method 4: Dispatch custom event for OBS integration
                    window.dispatchEvent(new CustomEvent('obsRefresh', {
                        detail: {
                            timestamp: Date.now(),
                            source: 'pro-studio-v4-ultimate',
                            type: 'layout-update'
                        }
                    }));

                    console.log('✅ OBS refresh triggered successfully');

                } catch (error) {
                    console.warn('⚠️ OBS refresh failed:', error);
                }
            }

            // Update stream content with current size settings
            updateStreamContentSizes() {
                try {
                    const currentStreamData = localStorage.getItem('directStreamContent');
                    if (currentStreamData) {
                        const streamData = JSON.parse(currentStreamData);
                        if (streamData.html) {
                            // Apply current sizes to the stream content
                            const updatedHTML = window.applyCurrentSizesToContent(streamData.html);

                            const newStreamData = {
                                ...streamData,
                                html: updatedHTML,
                                timestamp: Date.now(),
                                sizesUpdated: true
                            };

                            localStorage.setItem('directStreamContent', JSON.stringify(newStreamData));
                            localStorage.setItem('directStreamContentChanged', Date.now().toString());

                            console.log('📺 Stream content sizes updated for OBS');
                        }
                    }
                } catch (error) {
                    console.error('❌ Error updating stream content sizes:', error);
                }
            }

            // Auto-sync with stream when sizes change
            autoSyncWithStream() {
                try {
                    console.log('🔄 Auto-syncing with stream...');

                    // Check if direct stream is active
                    const isStreamActive = window.directStreamActive || localStorage.getItem('directStreamActive') === 'true';

                    if (!isStreamActive) {
                        console.log('📺 Stream not active, skipping sync');
                        return;
                    }

                    // Check if there's content to sync
                    const previewContent = document.getElementById('previewContent');
                    if (!previewContent || !previewContent.innerHTML.trim()) {
                        console.log('📺 No content to sync');
                        return;
                    }

                    console.log('📺 Syncing current content with updated sizes...');

                    // Auto-send updated content to stream
                    if (typeof window.sendToDirectStream === 'function') {
                        setTimeout(() => {
                            window.sendToDirectStream();
                            console.log('✅ Content synced with stream');
                        }, 500); // Small delay to ensure size changes are applied
                    } else {
                        console.warn('⚠️ sendToDirectStream function not available');
                    }

                } catch (error) {
                    console.warn('⚠️ Auto-sync with stream failed:', error);
                }
            }

            // 🎬 Card Transition Management
            changeCardTransition(transition) {
                console.log(`🎬 Changing card transition to: ${transition}`);

                this.settings.cardTransition = transition;
                this.saveSettingsOnly();

                // Update CSS custom property immediately
                document.documentElement.style.setProperty('--current-transition', transition);

                const transitionName = this.getTransitionNameArabic(transition);
                this.showNotification(`🎬 تم تغيير انتقال البطاقة إلى ${transitionName}`, 'success');

                // Auto-test the transition if there's a card visible
                this.autoTestTransition();
            }

            // 🧪 Auto-test transition when changed
            autoTestTransition() {
                const cardElement = document.querySelector('.fifa-card, .financial-card');
                if (cardElement && cardElement.style.visibility !== 'hidden') {
                    console.log('🧪 Auto-testing new transition...');
                    setTimeout(() => {
                        this.hideCard();
                        setTimeout(() => {
                            this.showCard();
                        }, (this.settings.transitionDuration || 1.0) * 1000 + 300);
                    }, 500);
                }
            }

            // 🎭 Test current transition manually
            testCurrentTransition() {
                const cardElement = document.querySelector('.fifa-card, .financial-card');

                if (!cardElement) {
                    this.showNotification('❌ لا توجد بطاقة لاختبار الانتقال - قم بإنشاء بطاقة أولاً', 'warning');
                    return;
                }

                const transitionType = this.settings?.cardTransition || 'fadeIn';
                const transitionDuration = this.settings?.transitionDuration || 1.0;
                const transitionName = this.getTransitionNameArabic(transitionType);

                this.showNotification(`🎭 اختبار انتقال: ${transitionName} (${transitionDuration}s)`, 'info');
                console.log(`🎭 Testing transition: ${transitionType} (${transitionDuration}s)`);

                // Test sequence: Hide -> Show
                this.hideCard();
                setTimeout(() => {
                    this.showCard();
                }, (transitionDuration * 1000) + 400); // Add buffer time
            }

            // 🚀 Show card initially with modern entrance
            showCardInitially() {
                setTimeout(() => {
                    const cardElement = document.querySelector('.fifa-card, .financial-card');
                    if (cardElement) {
                        // CRITICAL FIX: Ensure card is visible
                        cardElement.style.visibility = 'visible';
                        cardElement.style.opacity = '1';

                        // Modern fast entrance
                        cardElement.style.willChange = 'transform, opacity';
                        cardElement.style.opacity = '0';
                        cardElement.style.visibility = 'visible';
                        cardElement.classList.add('card-entering');

                        requestAnimationFrame(() => {
                            cardElement.style.animation = 'modernFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards';
                        });

                        // Clean up after animation
                        setTimeout(() => {
                            cardElement.classList.remove('card-entering');
                            cardElement.style.animation = 'none';
                            cardElement.style.opacity = '1';
                            cardElement.style.willChange = 'auto';

                            // Auto-send to direct stream if enabled
                            if (typeof window.checkAutoSendToDirectStream === 'function') {
                                window.checkAutoSendToDirectStream();
                            }

                            // Auto-send to OBS File System if enabled
                            if (typeof window.checkAutoSendToOBSFileSystem === 'function') {
                                window.checkAutoSendToOBSFileSystem();
                            }
                        }, 350);
                    }
                }, 300); // Faster initial delay
            }

            // 🚀 Get modern entrance animation name
            getModernEntranceAnimation(transitionType) {
                const animationMap = {
                    'fadeIn': 'modernFadeIn',
                    'wipeUp': 'modernSlideUp',
                    'wipeDown': 'modernSlideDown',
                    'wipeLeft': 'modernSlideLeft',
                    'wipeRight': 'modernSlideRight',
                    'slideFromBelow': 'modernSlideUp',
                    'slideFromAbove': 'modernSlideDown',
                    'slideFromLeft': 'modernSlideLeft',
                    'slideFromRight': 'modernSlideRight',
                    'slideFadeBelow': 'modernSlideUp',
                    'slideFadeAbove': 'modernSlideDown',
                    'slideFadeLeft': 'modernSlideLeft',
                    'slideFadeRight': 'modernSlideRight',
                    'irisWipe': 'modernScale',
                    'flipVertical': 'modernFlip',
                    'flipHorizontal': 'modernFlip',
                    'expandIn': 'modernScale',
                    'bounceExpand': 'modernBounce'
                };
                return animationMap[transitionType] || 'modernFadeIn';
            }

            // 🚀 Get modern exit animation name
            getModernExitAnimation(transitionType) {
                const animationMap = {
                    'fadeIn': 'modernFadeOut',
                    'wipeUp': 'modernSlideOutUp',
                    'wipeDown': 'modernSlideOutDown',
                    'wipeLeft': 'modernSlideOutLeft',
                    'wipeRight': 'modernSlideOutRight',
                    'slideFromBelow': 'modernSlideOutDown',
                    'slideFromAbove': 'modernSlideOutUp',
                    'slideFromLeft': 'modernSlideOutLeft',
                    'slideFromRight': 'modernSlideOutRight',
                    'slideFadeBelow': 'modernSlideOutDown',
                    'slideFadeAbove': 'modernSlideOutUp',
                    'slideFadeLeft': 'modernSlideOutLeft',
                    'slideFadeRight': 'modernSlideOutRight',
                    'irisWipe': 'modernScaleOut',
                    'flipVertical': 'modernFlipOut',
                    'flipHorizontal': 'modernFlipOut',
                    'expandIn': 'modernScaleOut',
                    'bounceExpand': 'modernBounceOut'
                };
                return animationMap[transitionType] || 'modernFadeOut';
            }

            // 🎯 Get initial transform for transition type
            getInitialTransform(transitionType) {
                switch(transitionType) {
                    case 'slideFromBelow': return 'translateY(100%)';
                    case 'slideFromAbove': return 'translateY(-100%)';
                    case 'slideFromLeft': return 'translateX(-100%)';
                    case 'slideFromRight': return 'translateX(100%)';
                    case 'slideFadeBelow': return 'translateY(50%) scale(0.8)';
                    case 'slideFadeAbove': return 'translateY(-50%) scale(0.8)';
                    case 'slideFadeLeft': return 'translateX(-50%) scale(0.8)';
                    case 'slideFadeRight': return 'translateX(50%) scale(0.8)';
                    case 'flipVertical': return 'rotateX(-90deg)';
                    case 'flipHorizontal': return 'rotateY(-90deg)';
                    case 'expandIn': return 'scale(0)';
                    case 'bounceExpand': return 'scale(0)';
                    default: return 'none';
                }
            }

            // 🎯 Get initial clip-path for transition type
            getInitialClipPath(transitionType) {
                switch(transitionType) {
                    case 'wipeUp': return 'inset(100% 0 0 0)';
                    case 'wipeDown': return 'inset(0 0 100% 0)';
                    case 'wipeLeft': return 'inset(0 100% 0 0)';
                    case 'wipeRight': return 'inset(0 0 0 100%)';
                    case 'irisWipe': return 'circle(0% at 50% 50%)';
                    default: return 'none';
                }
            }

            // 🚪 Get exit transform for transition type
            getExitTransform(transitionType) {
                switch(transitionType) {
                    case 'slideFromBelow': return 'translateY(100%)';
                    case 'slideFromAbove': return 'translateY(-100%)';
                    case 'slideFromLeft': return 'translateX(-100%)';
                    case 'slideFromRight': return 'translateX(100%)';
                    case 'slideFadeBelow': return 'translateY(50%) scale(0.8)';
                    case 'slideFadeAbove': return 'translateY(-50%) scale(0.8)';
                    case 'slideFadeLeft': return 'translateX(-50%) scale(0.8)';
                    case 'slideFadeRight': return 'translateX(50%) scale(0.8)';
                    case 'flipVertical': return 'rotateX(90deg)';
                    case 'flipHorizontal': return 'rotateY(90deg)';
                    case 'expandIn': return 'scale(0)';
                    case 'bounceExpand': return 'scale(0)';
                    default: return 'none';
                }
            }

            // 🚪 Get exit clip-path for transition type
            getExitClipPath(transitionType) {
                switch(transitionType) {
                    case 'wipeUp': return 'inset(0 0 100% 0)';
                    case 'wipeDown': return 'inset(100% 0 0 0)';
                    case 'wipeLeft': return 'inset(0 0 0 100%)';
                    case 'wipeRight': return 'inset(0 100% 0 0)';
                    case 'irisWipe': return 'circle(0% at 50% 50%)';
                    default: return 'none';
                }
            }

            updateTransitionDuration(duration) {
                const durationFloat = parseFloat(duration);

                // Update display value
                document.getElementById('transitionDurationValue').textContent = duration;

                // Update settings
                this.settings.transitionDuration = durationFloat;
                this.saveSettingsOnly();

                // Update CSS custom property immediately
                document.documentElement.style.setProperty('--transition-duration', `${durationFloat}s`);

                this.showNotification(`⏱️ تم تحديث مدة الانتقال إلى ${duration} ثانية`, 'success');

                console.log(`⏱️ Transition duration changed to: ${durationFloat}s`);
            }

            getTransitionNameArabic(transition) {
                const names = {
                    'fadeIn': 'تلاشي تدريجي',
                    'wipeUp': 'مسح خطي للأعلى',
                    'wipeDown': 'مسح خطي للأسفل',
                    'wipeLeft': 'مسح خطي لليسار',
                    'wipeRight': 'مسح خطي لليمين',
                    'irisWipe': 'مسح دائري',
                    'slideFromBelow': 'انزلاق من الأسفل',
                    'slideFromAbove': 'انزلاق من الأعلى',
                    'slideFromLeft': 'انزلاق من اليسار',
                    'slideFromRight': 'انزلاق من اليمين',
                    'slideFadeBelow': 'انزلاق وتلاشي من الأسفل',
                    'slideFadeAbove': 'انزلاق وتلاشي من الأعلى',
                    'slideFadeLeft': 'انزلاق وتلاشي من اليسار',
                    'slideFadeRight': 'انزلاق وتلاشي من اليمين',
                    'flipVertical': 'قلب عمودي',
                    'flipHorizontal': 'قلب أفقي',
                    'expandIn': 'توسع تدريجي',
                    'bounceExpand': 'ارتداد وتوسع'
                };
                return names[transition] || transition;
            }

            // 🤖 LM Studio Configuration Functions
            updateLMStudioURL(url) {
                if (!url || url.trim() === '') {
                    this.showNotification('❌ يرجى إدخال رابط LM Studio صحيح', 'warning');
                    return;
                }

                // Validate URL format
                try {
                    new URL(url);
                } catch (e) {
                    this.showNotification('❌ تنسيق الرابط غير صحيح - استخدم: http://IP:PORT', 'warning');
                    return;
                }

                // Save to settings
                this.settings.lmStudioURL = url.trim();
                this.saveSettings();

                this.showNotification(`🤖 تم تحديث رابط LM Studio: ${url}`, 'success');
                console.log(`🤖 LM Studio URL updated: ${url}`);
            }

            async testLMStudioConnection() {
                const url = this.settings.lmStudioURL || document.getElementById('lmStudioURL').value;
                const statusDiv = document.getElementById('lmStudioStatus');

                if (!url) {
                    this.showNotification('❌ يرجى إدخال رابط LM Studio أولاً', 'warning');
                    return;
                }

                // Show testing status
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(59, 130, 246, 0.2)';
                statusDiv.style.color = '#60a5fa';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري اختبار الاتصال...';

                try {
                    // Extract IP and port from URL
                    const urlObj = new URL(url);
                    const ip = urlObj.hostname;
                    const port = urlObj.port || '12345';

                    const response = await fetch('/api/network/test-lm-studio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ip, port })
                    });

                    const data = await response.json();

                    if (data.success) {
                        statusDiv.style.background = 'rgba(34, 197, 94, 0.2)';
                        statusDiv.style.color = '#4ade80';
                        statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> الاتصال ناجح - LM Studio يعمل!';
                        this.showNotification('✅ اتصال LM Studio ناجح', 'success');
                    } else {
                        statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                        statusDiv.style.color = '#f87171';
                        statusDiv.innerHTML = '<i class="fas fa-times-circle"></i> فشل الاتصال - تحقق من الرابط';
                        this.showNotification('❌ فشل اتصال LM Studio - تحقق من الرابط والمنفذ', 'error');
                    }
                } catch (error) {
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    statusDiv.style.color = '#f87171';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> خطأ في الاختبار';
                    this.showNotification('❌ خطأ في اختبار الاتصال: ' + error.message, 'error');
                }
            }

            async autoDetectLMStudio() {
                const statusDiv = document.getElementById('lmStudioStatus');
                const urlInput = document.getElementById('lmStudioURL');

                // Show searching status
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(59, 130, 246, 0.2)';
                statusDiv.style.color = '#60a5fa';
                statusDiv.innerHTML = '<i class="fas fa-search fa-spin"></i> جاري البحث عن LM Studio...';

                try {
                    const response = await fetch('/api/network/find-lm-studio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success && data.url) {
                        // Update URL input
                        urlInput.value = data.url;
                        this.updateLMStudioURL(data.url);

                        statusDiv.style.background = 'rgba(34, 197, 94, 0.2)';
                        statusDiv.style.color = '#4ade80';
                        statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> تم العثور على LM Studio!';
                        this.showNotification(`🎯 تم العثور على LM Studio: ${data.url}`, 'success');
                    } else {
                        statusDiv.style.background = 'rgba(245, 158, 11, 0.2)';
                        statusDiv.style.color = '#fbbf24';
                        statusDiv.innerHTML = '<i class="fas fa-search"></i> لم يتم العثور على LM Studio';
                        this.showNotification('⚠️ لم يتم العثور على LM Studio - تأكد من تشغيله', 'warning');
                    }
                } catch (error) {
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    statusDiv.style.color = '#f87171';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> خطأ في البحث';
                    this.showNotification('❌ خطأ في البحث التلقائي: ' + error.message, 'error');
                }
            }

            // 🚀 MODERN 2024: Fast and Smooth Card Controls
            showCard() {
                console.log('🚀 Starting modern showCard...');

                const cardElement = document.querySelector('.fifa-card, .financial-card');

                if (!cardElement) {
                    this.showNotification('❌ لا توجد بطاقة لإظهارها - قم بإنشاء بطاقة أولاً', 'warning');
                    return;
                }

                // 🎬 AUTO SEND TO STREAM - إرسال تلقائي للبث المباشر
                this.autoSendToStream();

                // Get current settings - shorter duration for modern feel
                const transitionType = this.settings?.cardTransition || document.getElementById('cardTransition')?.value || 'fadeIn';
                const transitionDuration = Math.min(this.settings?.transitionDuration || parseFloat(document.getElementById('transitionDuration')?.value) || 0.3, 0.4); // Max 400ms

                console.log(`🚀 Modern transition: ${transitionType}, duration: ${transitionDuration}s`);

                // 🚀 Modern performance optimizations - only what we need
                cardElement.style.willChange = 'transform, opacity';

                // Reset all states
                cardElement.className = cardElement.className.replace(/card-(entering|exiting)/g, '');
                cardElement.style.animation = 'none';
                cardElement.style.opacity = '0';
                cardElement.style.visibility = 'visible';
                cardElement.style.transform = 'translateZ(0)';

                // Force reflow
                cardElement.offsetHeight;

                // Add entering class
                cardElement.classList.add('card-entering');

                // Use requestAnimationFrame for perfect timing
                requestAnimationFrame(() => {
                    const animationName = this.getModernEntranceAnimation(transitionType);
                    const timingFunction = 'cubic-bezier(0.4, 0, 0.2, 1)'; // Material Design easing
                    cardElement.style.animation = `${animationName} ${transitionDuration}s ${timingFunction} forwards`;
                    console.log(`✅ Applied modern animation: ${animationName}`);
                });

                // Clean up after animation
                setTimeout(() => {
                    cardElement.classList.remove('card-entering');
                    cardElement.style.animation = 'none';
                    cardElement.style.opacity = '1';
                    cardElement.style.transform = 'translateZ(0)';
                    cardElement.style.willChange = 'auto'; // Reset for performance

                    // Auto-send to direct stream if enabled
                    if (typeof window.checkAutoSendToDirectStream === 'function') {
                        window.checkAutoSendToDirectStream();
                    }

                    // Auto-send to OBS File System if enabled
                    if (typeof window.checkAutoSendToOBSFileSystem === 'function') {
                        window.checkAutoSendToOBSFileSystem();
                    }
                }, (transitionDuration * 1000) + 50);

                const transitionName = this.getTransitionNameArabic(transitionType);
                this.showNotification(`🚀 إظهار عصري: ${transitionName} (${transitionDuration}s)`, 'success');
            }

            hideCard() {
                console.log('🚀 Starting modern hideCard...');

                const cardElement = document.querySelector('.fifa-card, .financial-card');

                if (!cardElement) {
                    this.showNotification('❌ لا توجد بطاقة لإخفائها', 'warning');
                    return;
                }

                // Get current settings - shorter duration for modern feel
                const transitionType = this.settings?.cardTransition || document.getElementById('cardTransition')?.value || 'fadeIn';
                const transitionDuration = Math.min(this.settings?.transitionDuration || parseFloat(document.getElementById('transitionDuration')?.value) || 0.3, 0.4); // Max 400ms

                console.log(`🚀 Modern exit: ${transitionType}, duration: ${transitionDuration}s`);

                // 🚀 Modern performance optimizations - only what we need
                cardElement.style.willChange = 'transform, opacity';

                // Reset states
                cardElement.className = cardElement.className.replace(/card-(entering|exiting)/g, '');
                cardElement.style.animation = 'none';
                cardElement.style.opacity = '1';
                cardElement.style.visibility = 'visible';
                cardElement.style.transform = 'translateZ(0)';

                // Force reflow
                cardElement.offsetHeight;

                // Add exiting class
                cardElement.classList.add('card-exiting');

                // Use requestAnimationFrame for perfect timing
                requestAnimationFrame(() => {
                    const animationName = this.getModernExitAnimation(transitionType);
                    const timingFunction = 'cubic-bezier(0.4, 0, 1, 1)'; // Sharp exit
                    cardElement.style.animation = `${animationName} ${transitionDuration}s ${timingFunction} forwards`;
                    console.log(`✅ Applied modern exit: ${animationName}`);
                });

                // Hide completely after animation
                setTimeout(() => {
                    cardElement.classList.remove('card-exiting');
                    cardElement.style.animation = 'none';
                    cardElement.style.visibility = 'hidden';
                    cardElement.style.opacity = '0';
                    cardElement.style.willChange = 'auto'; // Reset for performance
                    console.log('🚀 Card hidden after modern exit');
                }, (transitionDuration * 1000) + 50);

                const transitionName = this.getTransitionNameArabic(transitionType);
                this.showNotification(`🚀 إخفاء عصري: ${transitionName} (${transitionDuration}s)`, 'info');
            }

            // Apply card transition with duration - TARGET CARD ONLY
            applyCardTransition(containerElement, transition = null, duration = null) {
                if (!containerElement) return;

                // Find the actual card element inside the container
                const cardElement = containerElement.querySelector('.fifa-card, .financial-card') || containerElement;

                if (!cardElement) {
                    console.warn('⚠️ No card element found for transition');
                    return;
                }

                const transitionType = transition || this.settings.cardTransition || 'fadeIn';
                const transitionDuration = duration || this.settings.transitionDuration || 1.0;

                // Set CSS custom property for duration
                document.documentElement.style.setProperty('--transition-duration', `${transitionDuration}s`);

                // Remove any existing transition and exit classes from the card
                cardElement.classList.remove(
                    // Entry transitions
                    'card-transition-fadeIn', 'card-transition-wipeUp', 'card-transition-wipeDown',
                    'card-transition-wipeLeft', 'card-transition-wipeRight', 'card-transition-irisWipe',
                    'card-transition-slideFromBelow', 'card-transition-slideFromAbove',
                    'card-transition-slideFromLeft', 'card-transition-slideFromRight',
                    'card-transition-slideFadeBelow', 'card-transition-slideFadeAbove',
                    'card-transition-slideFadeLeft', 'card-transition-slideFadeRight',
                    'card-transition-flipVertical', 'card-transition-flipHorizontal',
                    'card-transition-expandIn', 'card-transition-bounceExpand',
                    // Exit transitions
                    'card-exit-fadeIn', 'card-exit-wipeUp', 'card-exit-wipeDown',
                    'card-exit-wipeLeft', 'card-exit-wipeRight', 'card-exit-irisWipe',
                    'card-exit-slideFromBelow', 'card-exit-slideFromAbove',
                    'card-exit-slideFromLeft', 'card-exit-slideFromRight',
                    'card-exit-slideFadeBelow', 'card-exit-slideFadeAbove',
                    'card-exit-slideFadeLeft', 'card-exit-slideFadeRight',
                    'card-exit-flipVertical', 'card-exit-flipHorizontal',
                    'card-exit-expandIn', 'card-exit-bounceExpand'
                );

                // Reset any inline styles that might interfere
                cardElement.style.opacity = '';
                cardElement.style.visibility = '';
                cardElement.style.transform = '';
                cardElement.style.clipPath = '';

                // Apply new transition class to the card only
                cardElement.classList.add(`card-transition-${transitionType}`);

                console.log(`🎬 Applied transition to CARD: ${transitionType} (${transitionDuration}s)`);
            }

            // Apply card exit transition - TARGET CARD ONLY
            applyCardExitTransition(containerElement, transition = null, duration = null) {
                if (!containerElement) return Promise.resolve();

                // Find the actual card element inside the container
                const cardElement = containerElement.querySelector('.fifa-card, .financial-card') || containerElement;

                if (!cardElement) {
                    console.warn('⚠️ No card element found for exit transition');
                    return Promise.resolve();
                }

                const transitionType = transition || this.settings.cardTransition || 'fadeIn';
                const transitionDuration = duration || this.settings.transitionDuration || 1.0;

                return new Promise(resolve => {
                    // Set CSS custom property for duration
                    document.documentElement.style.setProperty('--transition-duration', `${transitionDuration}s`);

                    // Remove any existing transition classes first
                    cardElement.classList.remove(
                        // Entry transitions
                        'card-transition-fadeIn', 'card-transition-wipeUp', 'card-transition-wipeDown',
                        'card-transition-wipeLeft', 'card-transition-wipeRight', 'card-transition-irisWipe',
                        'card-transition-slideFromBelow', 'card-transition-slideFromAbove',
                        'card-transition-slideFromLeft', 'card-transition-slideFromRight',
                        'card-transition-slideFadeBelow', 'card-transition-slideFadeAbove',
                        'card-transition-slideFadeLeft', 'card-transition-slideFadeRight',
                        'card-transition-flipVertical', 'card-transition-flipHorizontal',
                        'card-transition-expandIn', 'card-transition-bounceExpand',
                        // Exit transitions
                        'card-exit-fadeIn', 'card-exit-wipeUp', 'card-exit-wipeDown',
                        'card-exit-wipeLeft', 'card-exit-wipeRight', 'card-exit-irisWipe',
                        'card-exit-slideFromBelow', 'card-exit-slideFromAbove',
                        'card-exit-slideFromLeft', 'card-exit-slideFromRight',
                        'card-exit-slideFadeBelow', 'card-exit-slideFadeAbove',
                        'card-exit-slideFadeLeft', 'card-exit-slideFadeRight',
                        'card-exit-flipVertical', 'card-exit-flipHorizontal',
                        'card-exit-expandIn', 'card-exit-bounceExpand'
                    );

                    // Reset any inline styles
                    cardElement.style.transform = '';
                    cardElement.style.clipPath = '';

                    // Apply exit transition class to the card only
                    cardElement.classList.add(`card-exit-${transitionType}`);

                    // Wait for animation to complete
                    setTimeout(() => {
                        resolve();
                    }, transitionDuration * 1000);

                    console.log(`🎬 Applied exit transition to CARD: ${transitionType} (${transitionDuration}s)`);
                });
            }

            async createMultiVisualization() {
                if (this.isProcessing) {
                    this.showNotification('⚡ معالجة قيد التقدم...', 'warning');
                    return;
                }

                const defaultTargetClub = document.getElementById('multiTargetClub').value.trim();
                const playerContainers = document.querySelectorAll('.multi-player-input');
                const displayMode = document.getElementById('multiDisplayMode').value;

                // Collect player data from enhanced inputs
                const playersInputData = [];
                let hasValidPlayer = false;

                playerContainers.forEach((container, index) => {
                    // Check if this is a saved player or manual input
                    const savedPlayerSelect = container.querySelector('.multi-saved-player');
                    let name, currentClub, imageUrl;

                    if (savedPlayerSelect && savedPlayerSelect.value) {
                        // This is a saved player
                        try {
                            const savedPlayer = JSON.parse(savedPlayerSelect.value);
                            name = savedPlayer.arabicName || savedPlayer.name || '';
                            currentClub = savedPlayer.currentClub || '';
                            imageUrl = savedPlayer.playerImage || savedPlayer.imageUrl || '';
                        } catch (error) {
                            console.error('Error parsing saved player data:', error);
                            name = '';
                        }
                    } else {
                        // This is manual input
                        name = container.querySelector('.multi-player-name').value.trim();
                        currentClub = container.querySelector('.multi-player-current-club').value.trim();
                        imageUrl = container.querySelector('.multi-player-image').value.trim();
                    }

                    const targetClub = container.querySelector('.multi-player-target-club').value.trim();

                    if (name) {
                        hasValidPlayer = true;
                        playersInputData.push({
                            playerName: name,
                            currentClub: currentClub || 'غير محدد',
                            targetClub: targetClub || defaultTargetClub || 'غير محدد',
                            playerImage: imageUrl
                        });
                    }
                });

                if (!hasValidPlayer) {
                    this.showNotification('🚨 يرجى إدخال اسم لاعب واحد على الأقل', 'warning');
                    return;
                }

                // Validate that at least one player has a target club
                const hasTargetClub = playersInputData.some(player => player.targetClub !== 'غير محدد');
                if (!hasTargetClub) {
                    this.showNotification('🚨 يرجى تحديد النادي المطلوب لأحد اللاعبين على الأقل', 'warning');
                    return;
                }

                this.isProcessing = true;
                this.updateSystemStatus('جاري معالجة اللاعبين المتعددين...');

                try {
                    // Get enhanced data for all players
                    const playersData = [];
                    for (const playerInput of playersInputData) {
                        const playerData = await this.getEnhancedPlayerData(playerInput);
                        playersData.push(playerData);
                    }

                    this.multiPlayers = playersData;

                    if (displayMode === 'all') {
                        await this.generateMultiAllVisualization(playersData);
                    } else {
                        await this.generateMultiSequenceVisualization(playersData);
                    }

                    // Check auto-send to overlay for multi-player
                    checkAutoSendToOverlay();

                    // Check auto-stream for multi-player
                    checkAutoStreamPlayer();

                    // Check auto-send to direct stream for multi-player
                    checkAutoSendToDirectStream();

                    // Check auto-send to OBS File System for multi-player
                    checkAutoSendToOBSFileSystem();

                    const layoutConfig = this.getSmartLayoutConfig(playersData.length);
                    this.showNotification(`🌟 تم إنشاء عرض ${playersData.length} لاعبين! 📐 ${layoutConfig.description}`, 'success');

                } catch (error) {
                    console.error('🚨 Multi visualization error:', error);
                    this.showNotification('❌ فشل في إنشاء العرض المتعدد', 'error');
                } finally {
                    this.isProcessing = false;
                    this.updateSystemStatus('جاهز للإبداع');
                }
            }

            async generateMultiAllVisualization(playersData, targetClub) {
                const previewContent = document.getElementById('previewContent');
                const placeholder = document.getElementById('previewPlaceholder');

                if (placeholder) {
                    placeholder.style.display = 'none';
                }

                // Create grid of FIFA 26 cards like individual input
                const multiHTML = this.createMultiGridHTML(playersData);
                previewContent.innerHTML = multiHTML;

                // Apply entrance transition to each individual card in the grid
                const cards = previewContent.querySelectorAll('.fifa-card');
                cards.forEach((card, index) => {
                    // Set initial state (hidden) for each card
                    card.style.opacity = '0';

                    // Apply staggered transitions to each card
                    setTimeout(() => {
                        this.applyCardTransition(card);
                    }, 100 + (index * 150)); // Staggered by 150ms each
                });

                this.initializeParticleEffects();
                this.startFIFAAnimations();
                this.playCreationSound();
            }

            async generateMultiSequenceVisualization(playersData, targetClub) {
                const interval = parseInt(document.getElementById('sequenceInterval').value) || 3;

                this.currentSequenceIndex = 0;
                this.showSequencePlayer(playersData[0]);

                // Add stop button to the visualization
                this.addSequenceStopButton();

                this.sequenceTimer = setInterval(() => {
                    this.currentSequenceIndex++;
                    if (this.currentSequenceIndex >= playersData.length) {
                        this.currentSequenceIndex = 0;
                    }
                    this.showSequencePlayer(playersData[this.currentSequenceIndex]);
                }, interval * 1000);

                this.showNotification(`⏱️ العرض المتتالي بدأ - ${interval} ثواني لكل لاعب - اضغط زر الإيقاف للتوقف`, 'info');
            }

            addSequenceStopButton() {
                const previewContent = document.getElementById('previewContent');
                if (previewContent) {
                    // Add floating stop button
                    const stopButton = document.createElement('div');
                    stopButton.id = 'sequenceStopButton';
                    stopButton.innerHTML = `
                        <button onclick="ultimateStudio.stopSequence()" style="
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            z-index: 1000;
                            background: linear-gradient(135deg, #ff4757, #ff3838);
                            border: none;
                            border-radius: 50px;
                            padding: 15px 25px;
                            color: white;
                            font-weight: 700;
                            font-size: 1rem;
                            cursor: pointer;
                            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.4);
                            transition: all 0.3s ease;
                            animation: pulseStop 2s ease-in-out infinite;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-stop me-2"></i>
                            إيقاف العرض المتتالي
                        </button>
                        <style>
                            @keyframes pulseStop {
                                0%, 100% { box-shadow: 0 8px 25px rgba(255, 71, 87, 0.4); }
                                50% { box-shadow: 0 8px 35px rgba(255, 71, 87, 0.7); }
                            }
                        </style>
                    `;
                    document.body.appendChild(stopButton);
                }
            }

            async showSequencePlayer(playerData) {
                const previewContent = document.getElementById('previewContent');
                const placeholder = document.getElementById('previewPlaceholder');

                // Apply exit transition to existing card if any (except for first player)
                if (this.currentSequenceIndex > 0) {
                    const existingCard = previewContent.querySelector('.fifa-card');
                    if (existingCard) {
                        await this.applyCardExitTransition(existingCard);
                    }
                }

                if (placeholder) {
                    placeholder.style.display = 'none';
                }

                // Use FIFA 26 card for sequence display
                const playerHTML = this.createFIFA26CardHTML(playerData);
                previewContent.innerHTML = playerHTML;

                // Apply entrance transition to new card
                const newCard = previewContent.querySelector('.fifa-card');
                if (newCard) {
                    // Set initial state for smooth transition
                    newCard.style.opacity = '0';
                    newCard.style.visibility = 'visible';
                    newCard.style.transform = '';
                    newCard.style.clipPath = '';

                    // Apply transition after a small delay to the card only
                    setTimeout(() => {
                        this.applyCardTransition(previewContent); // Pass container, function will find the card
                    }, 100);
                }

                // Background effects continue normally
                this.initializeParticleEffects();
                this.startFIFAAnimations();

                // Play different sound for sequence
                if (this.currentSequenceIndex === 0) {
                    this.playCreationSound(); // First player gets full sound
                } else {
                    this.playSequenceTransitionSound(); // Others get transition sound
                }

                // Show sequence progress
                this.showNotification(`🎮 عرض ${playerData.arabicName} (${this.currentSequenceIndex + 1}/${this.multiPlayers.length})`, 'info');
            }

            stopSequence() {
                if (this.sequenceTimer) {
                    clearInterval(this.sequenceTimer);
                    this.sequenceTimer = null;

                    // Remove stop button
                    const stopButton = document.getElementById('sequenceStopButton');
                    if (stopButton) {
                        stopButton.remove();
                    }

                    // Clear preview and show placeholder
                    this.clearPreviewContent();
                    const placeholder = document.getElementById('previewPlaceholder');
                    if (placeholder) {
                        placeholder.style.display = 'flex';
                        placeholder.innerHTML = `
                            <div style="text-align: center;">
                                <i class="fas fa-stop-circle" style="font-size: 4rem; color: #ff4757; margin-bottom: 20px;"></i>
                                <h3 style="color: white; margin-bottom: 10px;">تم إيقاف العرض المتتالي</h3>
                                <p style="color: rgba(255, 255, 255, 0.7);">يمكنك الآن اختيار نمط آخر أو إنشاء تصور جديد</p>
                            </div>
                        `;
                    }

                    this.showNotification('⏹️ تم إيقاف العرض المتتالي - يمكنك الآن استخدام الأنماط الأخرى', 'success');
                }
            }

            // Enhanced Layout System - Stream & Details Optimized
            getIntelligentLayout(playersCount) {
                // Enhanced quality tiers with better detail preservation
                const qualityTiers = {
                    premium: { minWidth: 450, minHeight: 650, maxPlayers: 2 },
                    high: { minWidth: 380, minHeight: 550, maxPlayers: 4 },
                    medium: { minWidth: 320, minHeight: 480, maxPlayers: 6 },
                    compact: { minWidth: 280, minHeight: 420, maxPlayers: 8 }
                };

                // Optimized layout configurations for better detail visibility
                const layouts = {
                    1: {
                        cardWidth: 500, cardHeight: 700, gap: 0,
                        columns: '1fr', maxWidth: '550px',
                        description: 'لاعب واحد - عرض مميز كامل التفاصيل',
                        tier: 'premium', layout: 'centered'
                    },
                    2: {
                        cardWidth: 450, cardHeight: 650, gap: 40,
                        columns: 'repeat(2, 1fr)', maxWidth: '980px',
                        description: 'لاعبان - عرض عالي الجودة',
                        tier: 'premium', layout: 'side-by-side'
                    },
                    3: {
                        cardWidth: 400, cardHeight: 580, gap: 35,
                        columns: 'repeat(3, 1fr)', maxWidth: '1270px',
                        description: 'ثلاثة لاعبين - جودة ممتازة',
                        tier: 'high', layout: 'single-row'
                    },
                    4: {
                        cardWidth: 380, cardHeight: 550, gap: 30,
                        columns: 'repeat(2, 1fr)', maxWidth: '840px',
                        description: 'أربعة لاعبين - شبكة 2×2',
                        tier: 'high', layout: 'grid-2x2'
                    },
                    5: {
                        cardWidth: 320, cardHeight: 480, gap: 25,
                        columns: 'repeat(5, 1fr)', maxWidth: '1650px',
                        description: 'خمسة لاعبين - صف واحد',
                        tier: 'medium', layout: 'single-row'
                    },
                    6: {
                        cardWidth: 320, cardHeight: 480, gap: 25,
                        columns: 'repeat(3, 1fr)', maxWidth: '1020px',
                        description: 'ستة لاعبين - شبكة 3×2',
                        tier: 'medium', layout: 'grid-3x2'
                    },
                    7: {
                        cardWidth: 280, cardHeight: 420, gap: 20,
                        columns: 'repeat(7, 1fr)', maxWidth: '2000px',
                        description: 'سبعة لاعبين - صف واحد',
                        tier: 'compact', layout: 'single-row'
                    },
                    8: {
                        cardWidth: 280, cardHeight: 420, gap: 20,
                        columns: 'repeat(4, 1fr)', maxWidth: '1160px',
                        description: 'ثمانية لاعبين - شبكة 4×2',
                        tier: 'compact', layout: 'grid-4x2'
                    }
                };

                const config = layouts[Math.min(playersCount, 8)] || layouts[8];

                return {
                    ...config,
                    cardWidth: `${config.cardWidth}px`,
                    cardHeight: `${config.cardHeight}px`,
                    gap: `${config.gap}px`,
                    obsOptimized: playersCount >= 4,
                    qualityTier: config.tier,
                    gridRows: this.calculateGridRows(playersCount, config.layout)
                };
            }

            // Calculate grid rows for better layout
            calculateGridRows(playersCount, layout) {
                const rowConfigs = {
                    'grid-2x2': 2,
                    'grid-3x2': 2,
                    'grid-4x2': 2,
                    'single-row': 1,
                    'centered': 1,
                    'side-by-side': 1
                };
                return rowConfigs[layout] || Math.ceil(playersCount / 4);
            }

            // Smart Layout Calculator - Intelligent Quality System
            getSmartLayoutConfig(playersCount) {
                return this.getIntelligentLayout(playersCount);
            }

            // Create grid of FIFA 26 cards for multi-player display - Enhanced
            createMultiGridHTML(playersData) {
                const playersCount = playersData.length;
                const layoutConfig = this.getSmartLayoutConfig(playersCount);

                // Smart Layout Styles for Different Player Counts
                let specialLayout = `
                    /* OBS Single Row Optimization */
                    .obs-single-row {
                        display: flex !important;
                        flex-direction: row !important;
                        justify-content: center !important;
                        align-items: center !important;
                        gap: ${layoutConfig.gap} !important;
                        max-width: 1920px !important;
                        width: 100% !important;
                        height: 100vh !important;
                        max-height: 1080px !important;
                        padding: 20px 50px !important;
                        margin: 0 auto !important;
                        overflow: hidden !important;
                        box-sizing: border-box !important;
                    }

                    .obs-single-row .fifa-card {
                        flex-shrink: 0 !important;
                        width: ${layoutConfig.cardWidth} !important;
                        height: ${layoutConfig.cardHeight} !important;
                        max-width: ${layoutConfig.cardWidth} !important;
                        max-height: ${layoutConfig.cardHeight} !important;
                    }
                `;

                if (playersCount === 4) {
                    specialLayout = `
                        /* 4 Players: Perfect 2x2 Grid - Enhanced Balance */
                        .players-grid-smart {
                            display: grid !important;
                            grid-template-columns: repeat(2, 1fr) !important;
                            grid-template-rows: repeat(2, 1fr) !important;
                            gap: 30px !important;
                            max-width: ${layoutConfig.maxWidth} !important;
                            margin: 0 auto !important;
                            align-items: center !important;
                            justify-items: center !important;
                            padding: 30px !important;
                            place-content: center !important;
                            min-height: 100vh !important;
                            box-sizing: border-box !important;
                        }

                        /* Enhanced card spacing for 4 players */
                        .players-grid-smart .fifa-card {
                            margin: 10px !important;
                        }
                    `;
                } else if (playersCount === 5) {
                    specialLayout = `
                        /* 5 Players: 3 top + 2 bottom centered */
                        .players-grid-smart {
                            display: flex !important;
                            flex-direction: column !important;
                            gap: 25px !important;
                            max-width: ${layoutConfig.maxWidth} !important;
                            margin: 0 auto !important;
                            align-items: center !important;
                            padding: 20px !important;
                        }
                        .players-row-top {
                            display: grid !important;
                            grid-template-columns: repeat(3, 1fr) !important;
                            gap: ${layoutConfig.gap} !important;
                            width: 100% !important;
                            justify-items: center !important;
                        }
                        .players-row-bottom {
                            display: grid !important;
                            grid-template-columns: repeat(2, 1fr) !important;
                            gap: ${layoutConfig.gap} !important;
                            width: 66.67% !important;
                            justify-items: center !important;
                            margin-top: 10px !important;
                        }
                    `;
                } else if (playersCount === 6) {
                    specialLayout = `
                        /* 6 Players: Perfect 3x2 Grid - Enhanced Balance */
                        .players-grid-smart {
                            display: grid !important;
                            grid-template-columns: repeat(3, 1fr) !important;
                            grid-template-rows: repeat(2, 1fr) !important;
                            gap: 25px !important;
                            max-width: ${layoutConfig.maxWidth} !important;
                            margin: 0 auto !important;
                            align-items: center !important;
                            justify-items: center !important;
                            padding: 30px !important;
                            place-content: center !important;
                            min-height: 100vh !important;
                            box-sizing: border-box !important;
                        }

                        /* Enhanced card spacing for 6 players */
                        .players-grid-smart .fifa-card {
                            margin: 8px !important;
                        }
                    `;
                } else if (playersCount === 7) {
                    specialLayout = `
                        /* 7 Players: 4 top + 3 bottom */
                        .players-grid-smart {
                            display: flex !important;
                            flex-direction: column !important;
                            gap: 20px !important;
                            max-width: ${layoutConfig.maxWidth} !important;
                            margin: 0 auto !important;
                            align-items: center !important;
                            padding: 20px !important;
                        }
                        .players-row-top {
                            display: grid !important;
                            grid-template-columns: repeat(4, 1fr) !important;
                            gap: ${layoutConfig.gap} !important;
                            width: 100% !important;
                            justify-items: center !important;
                        }
                        .players-row-bottom {
                            display: grid !important;
                            grid-template-columns: repeat(3, 1fr) !important;
                            gap: ${layoutConfig.gap} !important;
                            width: 75% !important;
                            justify-items: center !important;
                        }
                    `;
                } else if (playersCount === 8) {
                    specialLayout = `
                        /* 8 Players: Perfect 4x2 Grid - Enhanced Balance */
                        .players-grid-smart {
                            display: grid !important;
                            grid-template-columns: repeat(4, 1fr) !important;
                            grid-template-rows: repeat(2, 1fr) !important;
                            gap: 20px !important;
                            max-width: ${layoutConfig.maxWidth} !important;
                            margin: 0 auto !important;
                            align-items: center !important;
                            justify-items: center !important;
                            padding: 25px !important;
                            place-content: center !important;
                            min-height: 100vh !important;
                            box-sizing: border-box !important;
                        }

                        /* Enhanced card spacing for 8 players */
                        .players-grid-smart .fifa-card {
                            margin: 5px !important;
                        }
                    `;
                }

                const gridHTML = `
                    <style>
                        ${specialLayout}
                        .multi-grid-container {
                            width: 100%;
                            height: 100%;
                            position: relative;
                            background: radial-gradient(circle at center, #0a0a0f 0%, #1a0b2e 100%);
                            overflow-y: auto;
                            padding: 20px;
                        }

                        /* Custom Title Styling */
                        .custom-title {
                            position: absolute;
                            top: 20px;
                            left: 50%;
                            transform: translateX(-50%);
                            z-index: 100;
                            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(147, 51, 234, 0.9));
                            color: white;
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 1.8rem;
                            font-weight: 700;
                            text-align: center;
                            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
                            backdrop-filter: blur(10px);
                            border: 2px solid rgba(255, 255, 255, 0.2);
                            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
                            min-width: 300px;
                        }

                        /* Channel Rights Styling - Bottom Center */
                        .channel-rights {
                            position: absolute;
                            bottom: 25px;
                            left: 50%;
                            transform: translateX(-50%);
                            z-index: 100;
                            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85), rgba(30, 30, 30, 0.85));
                            color: rgba(255, 255, 255, 0.95);
                            padding: 12px 25px;
                            border-radius: 20px;
                            font-size: 1.1rem;
                            font-weight: 600;
                            text-align: center;
                            box-shadow:
                                0 10px 30px rgba(0, 0, 0, 0.4),
                                0 0 20px rgba(102, 126, 234, 0.3),
                                inset 0 1px 0 rgba(255, 255, 255, 0.2);
                            backdrop-filter: blur(15px);
                            border: 2px solid rgba(255, 255, 255, 0.15);
                            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
                            min-width: 350px;
                            animation: rightsGlow 3s ease-in-out infinite;
                        }
                        .players-grid-smart {
                            position: relative;
                            z-index: 10;
                            display: grid;
                            grid-template-columns: ${layoutConfig.columns};
                            gap: ${layoutConfig.gap};
                            max-width: ${layoutConfig.maxWidth};
                            margin: 0 auto;
                            align-items: start;
                            justify-items: center;
                        }
                        /* Quality-Based Card Sizing */
                        .fifa-card {
                            width: ${layoutConfig.cardWidth} !important;
                            max-width: ${layoutConfig.cardWidth} !important;
                            height: ${layoutConfig.cardHeight} !important;
                            max-height: ${layoutConfig.cardHeight} !important;
                            transition: all 0.3s ease !important;
                        }

                        /* Quality Tier Styling */
                        .quality-${layoutConfig.qualityTier} .fifa-card {
                            ${layoutConfig.qualityTier === 'premium' ? `
                                box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6) !important;
                                border: 3px solid rgba(255, 255, 255, 0.3) !important;
                            ` : layoutConfig.qualityTier === 'high' ? `
                                box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5) !important;
                                border: 2px solid rgba(255, 255, 255, 0.25) !important;
                            ` : layoutConfig.qualityTier === 'medium' ? `
                                box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4) !important;
                                border: 2px solid rgba(255, 255, 255, 0.2) !important;
                            ` : `
                                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3) !important;
                                border: 1px solid rgba(255, 255, 255, 0.15) !important;
                            `}
                        }

                        /* OBS Container Optimization */
                        .multi-grid-container {
                            max-height: 1080px !important;
                            overflow: hidden !important;
                            display: flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                        }

                        /* Intelligent Grid System */
                        .players-grid-smart {
                            display: grid !important;
                            grid-template-columns: ${layoutConfig.columns} !important;
                            gap: ${layoutConfig.gap} !important;
                            max-width: ${layoutConfig.maxWidth} !important;
                            margin: 0 auto !important;
                            align-items: center !important;
                            justify-items: center !important;
                            padding: 30px !important;
                        }

                        /* Font Size Adaptation */
                        .quality-${layoutConfig.qualityTier} .fifa-card .player-name {
                            font-size: ${layoutConfig.qualityTier === 'premium' ? '2.2rem' :
                                        layoutConfig.qualityTier === 'high' ? '2rem' :
                                        layoutConfig.qualityTier === 'medium' ? '1.8rem' : '1.6rem'} !important;
                        }

                        .quality-${layoutConfig.qualityTier} .fifa-card .club-info {
                            font-size: ${layoutConfig.qualityTier === 'premium' ? '1.4rem' :
                                        layoutConfig.qualityTier === 'high' ? '1.2rem' :
                                        layoutConfig.qualityTier === 'medium' ? '1.1rem' : '1rem'} !important;
                        }

                        .quality-${layoutConfig.qualityTier} .fifa-card .probability-text {
                            font-size: ${layoutConfig.qualityTier === 'premium' ? '1.8rem' :
                                        layoutConfig.qualityTier === 'high' ? '1.6rem' :
                                        layoutConfig.qualityTier === 'medium' ? '1.4rem' : '1.2rem'} !important;
                        }
                    </style>
                    <div class="multi-grid-container">
                        <!-- Custom Title -->
                        <div class="custom-title" id="customTitle">
                            ${this.getCustomTitle()}
                        </div>

                        <!-- Particle Canvas -->
                        <canvas id="particleCanvas" style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 1;
                        "></canvas>



                        <!-- Players Grid - Smart Layout -->
                        ${this.createSmartPlayersGrid(playersData)}



                        <!-- Channel Rights -->
                        <div class="channel-rights" id="channelRights">
                            ${this.getChannelRights()}
                        </div>
                    </div>
                `;
                return gridHTML;
            }

            // Clean Players Grid Generator - Stream Optimized
            createSmartPlayersGrid(playersData) {
                const playersCount = playersData.length;
                const layoutConfig = this.getSmartLayoutConfig(playersCount);

                // NO INFO BOX - Direct to grid for clean streaming
                return `
                    <style>
                        .players-grid-clean {
                            display: grid;
                            grid-template-columns: ${layoutConfig.columns};
                            ${layoutConfig.gridRows > 1 ? `grid-template-rows: repeat(${layoutConfig.gridRows}, 1fr);` : ''}
                            gap: ${layoutConfig.gap};
                            max-width: ${layoutConfig.maxWidth};
                            margin: 0 auto;
                            align-items: center;
                            justify-items: center;
                            padding: clamp(20px, 4vh, 40px) clamp(15px, 3vw, 30px);
                            min-height: 100vh;
                            box-sizing: border-box;
                            place-content: center;
                        }

                        .clean-card {
                            width: ${layoutConfig.cardWidth};
                            height: ${layoutConfig.cardHeight};
                            max-width: ${layoutConfig.cardWidth};
                            max-height: ${layoutConfig.cardHeight};
                            min-width: 250px;
                            min-height: 350px;
                        }

                        /* Responsive adjustments */
                        @media (max-width: 1920px) {
                            .players-grid-clean {
                                gap: calc(${layoutConfig.gap} * 0.8);
                            }
                        }

                        @media (max-width: 1600px) {
                            .clean-card {
                                width: calc(${layoutConfig.cardWidth} * 0.9);
                                height: calc(${layoutConfig.cardHeight} * 0.9);
                            }
                        }

                        @media (max-width: 1200px) {
                            .clean-card {
                                width: calc(${layoutConfig.cardWidth} * 0.8);
                                height: calc(${layoutConfig.cardHeight} * 0.8);
                            }
                        }
                    </style>
                    <div class="players-grid-clean quality-${layoutConfig.qualityTier}">
                        ${playersData.map((player, index) => this.createCleanFIFA26CardHTML(player, index * 0.15)).join('')}
                    </div>
                `;
            }

            // Clean FIFA 26 Card HTML Generator - Stream Optimized
            createCleanFIFA26CardHTML(player, animationDelay = 0) {
                const probability = player.probability;
                const probabilityValue = probability.percentage;
                const probabilityColor = this.getProbabilityColor(probabilityValue);
                const cardGradient = this.getCardGradient(probabilityValue);
                const ratingColor = this.getRatingColor(player.rating);
                const gradientId = `gradient-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                return `
                    <div class="fifa-card clean-card" style="
                        animation-delay: ${animationDelay}s;
                        background: ${cardGradient};
                        border: 3px solid ${probabilityColor};
                        border-radius: 20px;
                        position: relative;
                        overflow: hidden;
                        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4), 0 0 30px ${probabilityColor}40;
                        transition: all 0.3s ease;
                        display: flex;
                        flex-direction: column;
                        justify-content: flex-start;
                        padding: clamp(15px, 3vw, 20px);
                        box-sizing: border-box;
                        min-height: 350px;
                        height: 100%;
                    ">
                        <!-- Background Effects -->
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
                            z-index: 1;
                        "></div>

                        <!-- Probability Badge -->
                        <div style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            background: ${probabilityColor};
                            color: #000;
                            padding: 8px 15px;
                            border-radius: 15px;
                            font-weight: 900;
                            font-size: 1.4rem;
                            z-index: 10;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        ">${probabilityValue}%</div>

                        <!-- Player Name -->
                        <div style="
                            position: relative;
                            z-index: 5;
                            text-align: center;
                            margin-top: 5px;
                            padding: 0 10px;
                            min-height: 60px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <h3 style="
                                color: #ffffff;
                                font-size: clamp(1.2rem, 2.5vw, 1.6rem);
                                font-weight: 800;
                                margin: 0;
                                text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
                                line-height: 1.3;
                                word-wrap: break-word;
                                text-align: center;
                                overflow-wrap: break-word;
                                hyphens: auto;
                            ">${player.arabicName || player.name}</h3>
                        </div>

                        <!-- Player Image -->
                        <div style="
                            position: relative;
                            z-index: 5;
                            text-align: center;
                            margin: 10px 0;
                            flex: 0 0 auto;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            min-height: 100px;
                        ">
                            <img src="${player.imageUrl}" alt="${player.name}" style="
                                width: clamp(80px, 15vw, 110px);
                                height: clamp(80px, 15vw, 110px);
                                border-radius: 50%;
                                border: 3px solid rgba(255,255,255,0.3);
                                box-shadow: 0 8px 25px rgba(0,0,0,0.4);
                                object-fit: cover;
                            " onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(player.arabicName || player.name)}&size=110&background=667eea&color=fff&bold=true&format=png'">
                        </div>

                        <!-- Club Transfer Info -->
                        <div style="
                            position: relative;
                            z-index: 5;
                            text-align: center;
                            margin: 10px 0;
                            flex: 1 1 auto;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            min-height: 120px;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: clamp(8px, 2vw, 15px);
                                margin-bottom: 8px;
                                flex-wrap: wrap;
                            ">
                                <!-- Current Club -->
                                <div style="
                                    text-align: center;
                                    flex: 0 0 auto;
                                    min-width: 60px;
                                ">
                                    <img src="${player.currentClubLogo}" alt="${player.currentClub}" style="
                                        width: clamp(30px, 6vw, 40px);
                                        height: clamp(30px, 6vw, 40px);
                                        border-radius: 6px;
                                        border: 2px solid rgba(255,255,255,0.3);
                                        background: rgba(255,255,255,0.1);
                                        padding: 2px;
                                        object-fit: contain;
                                    " onerror="this.style.display='none'">
                                    <p style="
                                        color: rgba(255,255,255,0.9);
                                        font-size: clamp(0.7rem, 1.5vw, 0.85rem);
                                        margin: 3px 0 0 0;
                                        font-weight: 600;
                                        line-height: 1.2;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                        white-space: nowrap;
                                        max-width: 80px;
                                    ">${player.currentClub}</p>
                                </div>

                                <!-- Beautiful Modern Arrow -->
                                <div style="
                                    position: relative;
                                    flex: 0 0 auto;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    width: clamp(50px, 10vw, 80px);
                                    height: clamp(35px, 7vw, 50px);
                                    margin: 0 10px;
                                ">
                                    <!-- Arrow Container -->
                                    <div style="
                                        position: relative;
                                        width: 100%;
                                        height: 100%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        background: linear-gradient(135deg, ${probabilityColor}15, ${probabilityColor}25);
                                        border-radius: 25px;
                                        border: 2px solid ${probabilityColor}40;
                                        backdrop-filter: blur(10px);
                                        box-shadow:
                                            0 8px 25px rgba(0, 0, 0, 0.3),
                                            0 0 20px ${probabilityColor}30,
                                            inset 0 1px 0 rgba(255, 255, 255, 0.2);
                                        animation: arrowContainerGlow 3s ease-in-out infinite;
                                    ">
                                        <!-- Arrow SVG -->
                                        <svg width="24" height="16" viewBox="0 0 24 16" style="
                                            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.4));
                                        ">
                                            <defs>
                                                <linearGradient id="arrowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                    <stop offset="0%" style="stop-color:${probabilityColor};stop-opacity:0.8" />
                                                    <stop offset="50%" style="stop-color:${probabilityColor};stop-opacity:1" />
                                                    <stop offset="100%" style="stop-color:${probabilityColor};stop-opacity:0.8" />
                                                </linearGradient>
                                            </defs>
                                            <path d="M22 8 L8 8 M12 4 L8 8 L12 12"
                                                  stroke="url(#arrowGradient)"
                                                  stroke-width="2.5"
                                                  fill="none"
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round"
                                                  style="animation: arrowDraw 2s ease-in-out infinite;" />
                                        </svg>

                                        <!-- Sparkle Effects -->
                                        <div style="
                                            position: absolute;
                                            top: 20%;
                                            right: 15%;
                                            width: 4px;
                                            height: 4px;
                                            background: ${probabilityColor};
                                            border-radius: 50%;
                                            animation: sparkle1 2s ease-in-out infinite;
                                        "></div>
                                        <div style="
                                            position: absolute;
                                            bottom: 25%;
                                            left: 20%;
                                            width: 3px;
                                            height: 3px;
                                            background: ${probabilityColor};
                                            border-radius: 50%;
                                            animation: sparkle2 2.5s ease-in-out infinite;
                                        "></div>
                                    </div>
                                </div>

                                <!-- Target Club -->
                                <div style="
                                    text-align: center;
                                    flex: 0 0 auto;
                                    min-width: 60px;
                                ">
                                    <img src="${player.targetClubLogo}" alt="${player.targetClub}" style="
                                        width: clamp(30px, 6vw, 40px);
                                        height: clamp(30px, 6vw, 40px);
                                        border-radius: 6px;
                                        border: 2px solid ${probabilityColor};
                                        background: rgba(255,255,255,0.1);
                                        padding: 2px;
                                        box-shadow: 0 0 10px ${probabilityColor}40;
                                        object-fit: contain;
                                    " onerror="this.style.display='none'">
                                    <p style="
                                        color: ${probabilityColor};
                                        font-size: clamp(0.7rem, 1.5vw, 0.85rem);
                                        margin: 3px 0 0 0;
                                        font-weight: 700;
                                        line-height: 1.2;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                        white-space: nowrap;
                                        max-width: 80px;
                                    ">${player.targetClub}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div style="
                            position: relative;
                            z-index: 5;
                            text-align: center;
                            margin-top: auto;
                            flex: 0 0 auto;
                        ">
                            <div style="
                                background: rgba(0,0,0,0.4);
                                border-radius: 8px;
                                padding: 6px 10px;
                                margin-top: 8px;
                                border: 1px solid rgba(255,255,255,0.1);
                            ">
                                <p style="
                                    color: rgba(255,255,255,0.9);
                                    font-size: clamp(0.7rem, 1.4vw, 0.8rem);
                                    margin: 0;
                                    font-weight: 600;
                                    line-height: 1.3;
                                ">العمر: ${player.age || 'غير محدد'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Preview Layout Function
            previewLayout() {
                const playersInputs = document.querySelectorAll('.multi-player-input');
                const playersCount = Array.from(playersInputs).filter(input => input.value.trim()).length;

                if (playersCount === 0) {
                    this.showNotification('⚠️ أدخل أسماء اللاعبين أولاً لمعاينة التخطيط', 'warning');
                    return;
                }

                const layoutConfig = this.getSmartLayoutConfig(playersCount);

                const previewHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        backdrop-filter: blur(10px);
                    " onclick="this.remove()">
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            padding: 40px;
                            border-radius: 20px;
                            text-align: center;
                            max-width: 600px;
                            color: white;
                            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                        " onclick="event.stopPropagation()">
                            <h2 style="margin-bottom: 20px; font-size: 2rem;">📐 معاينة التخطيط</h2>
                            <div style="
                                background: rgba(255, 255, 255, 0.1);
                                padding: 20px;
                                border-radius: 15px;
                                margin: 20px 0;
                                border: 2px solid rgba(255, 255, 255, 0.3);
                            ">
                                <h3 style="color: #ffff00; margin-bottom: 15px;">
                                    ${playersCount} لاعب
                                </h3>
                                <p style="font-size: 1.2rem; margin-bottom: 10px;">
                                    ${layoutConfig.description}
                                </p>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(2, 1fr);
                                    gap: 15px;
                                    margin-top: 20px;
                                    text-align: left;
                                ">
                                    <div>📏 <strong>حجم البطاقة:</strong> ${layoutConfig.cardSize}</div>
                                    <div>📐 <strong>المسافة:</strong> ${layoutConfig.gap}</div>
                                    <div>📊 <strong>العرض الأقصى:</strong> ${layoutConfig.maxWidth}</div>
                                    <div>🎯 <strong>الأعمدة:</strong> ${layoutConfig.columns}</div>
                                </div>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 2px solid rgba(255, 255, 255, 0.5);
                                color: white;
                                padding: 12px 30px;
                                border-radius: 10px;
                                font-size: 1.1rem;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                ✅ فهمت
                            </button>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', previewHTML);
                this.showNotification(`📐 معاينة تخطيط ${playersCount} لاعبين`, 'info');
            }

            createMultiAllVisualizationHTML(playersData, targetClub) {
                const averageProbability = playersData.reduce((sum, player) =>
                    sum + player.probability.percentage, 0) / playersData.length;

                const probabilityColor = this.getProbabilityColor(averageProbability);

                return `
                    <div class="multi-visualization" style="
                        width: 100%;
                        height: 100%;
                        position: relative;
                        background: radial-gradient(circle at center, #0a0a0f 0%, #1a0b2e 100%);
                        overflow-y: auto;
                        padding: 20px;
                    ">
                        <!-- Particle Canvas -->
                        <canvas id="particleCanvas" style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 1;
                        "></canvas>



                            <!-- Average Probability -->
                            <div style="
                                display: inline-block;
                                background: rgba(255, 255, 255, 0.1);
                                backdrop-filter: blur(20px);
                                border: 2px solid ${probabilityColor};
                                border-radius: 15px;
                                padding: 15px 25px;
                                margin-bottom: 30px;
                            ">
                                <span style="
                                    font-size: 1.5rem;
                                    font-weight: 700;
                                    color: ${probabilityColor};
                                ">متوسط الاحتمالية: ${Math.round(averageProbability)}%</span>
                            </div>
                        </div>

                        <!-- Players Grid -->
                        <div style="
                            position: relative;
                            z-index: 10;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                            gap: 20px;
                            max-width: 1200px;
                            margin: 0 auto;
                        ">
                            ${playersData.map((player, index) => this.createPlayerCard(player, index)).join('')}
                        </div>

                        <!-- Control Panel -->
                        <div style="
                            position: relative;
                            z-index: 10;
                            text-align: center;
                            margin-top: 30px;
                        ">
                            <button onclick="ultimateStudio.stopSequence()" style="
                                background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
                                border: none;
                                border-radius: 15px;
                                padding: 15px 30px;
                                color: white;
                                font-weight: 700;
                                font-size: 1.1rem;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-stop me-2"></i>
                                إيقاف العرض
                            </button>
                        </div>
                    </div>
                `;
            }

            createPlayerCard(player, index) {
                const probabilityColor = this.getProbabilityColor(player.probability.percentage);
                const delay = index * 0.2;

                return `
                    <div class="player-card" style="
                        background: rgba(255, 255, 255, 0.08);
                        backdrop-filter: blur(20px);
                        border: 2px solid rgba(255, 255, 255, 0.15);
                        border-radius: 20px;
                        padding: 25px;
                        text-align: center;
                        animation: cardEntrance 0.8s ease-out ${delay}s both;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-10px)'; this.style.borderColor='${probabilityColor}'"
                       onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(255, 255, 255, 0.15)'">

                        <!-- Player Image -->
                        <div style="
                            position: relative;
                            display: inline-block;
                            margin-bottom: 20px;
                        ">
                            <img src="${this.getPlayerImageUrl(player)}"
                                 alt="${player.arabicName}"
                                 class="player-image"
                                 style="
                                    width: ${this.settings.playerImageSize || 150}px;
                                    height: ${this.settings.playerImageSize || 150}px;
                                    border-radius: 50%;
                                    border: 3px solid ${probabilityColor};
                                    object-fit: cover;
                                    box-shadow: 0 0 20px ${probabilityColor}40;
                                    transition: all 0.3s ease;
                                 "
                                 onerror="this.src='${this.getFallbackImageUrl(player.arabicName)}'">

                            <!-- Probability Badge -->
                            <div style="
                                position: absolute;
                                top: -10px;
                                right: -10px;
                                background: ${probabilityColor};
                                color: white;
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: 900;
                                font-size: 0.9rem;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                            ">${player.probability.percentage}%</div>
                        </div>

                        <!-- Player Info -->
                        <h3 style="
                            font-size: 1.3rem;
                            font-weight: 700;
                            color: white;
                            margin-bottom: 10px;
                        ">${player.arabicName}</h3>

                        <p style="
                            font-size: 1rem;
                            color: rgba(255, 255, 255, 0.7);
                            margin-bottom: 15px;
                        ">${player.currentClub}</p>

                        <!-- Probability Bar -->
                        <div style="
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 10px;
                            height: 8px;
                            margin-bottom: 15px;
                            overflow: hidden;
                        ">
                            <div style="
                                background: linear-gradient(90deg, ${probabilityColor}, #ffffff);
                                height: 100%;
                                width: ${player.probability.percentage}%;
                                border-radius: 10px;
                                animation: progressFill 1.5s ease-out ${delay + 0.5}s both;
                            "></div>
                        </div>

                        <!-- Trend -->
                        <div style="
                            font-size: 0.9rem;
                            color: ${probabilityColor};
                            font-weight: 600;
                        ">${player.probability.trend}</div>
                    </div>
                `;
            }

            // 🔗 Player Data Extraction Functions
            initializeExtractMode() {
                console.log('🔗 Initializing Extract Mode...');
                this.showNotification('🔗 نمط استخراج البيانات جاهز', 'info');
            }

            async extractPlayerData() {
                const urlInput = document.getElementById('playerPageUrl');
                const targetClubInput = document.getElementById('extractTargetClub');
                const extractBtn = document.getElementById('extractBtn');
                const resultsDiv = document.getElementById('extractionResults');

                if (!urlInput.value.trim()) {
                    this.showNotification('⚠️ يرجى إدخال رابط صفحة اللاعب', 'warning');
                    urlInput.focus();
                    return;
                }

                // Validate URL
                try {
                    new URL(urlInput.value);
                } catch {
                    this.showNotification('❌ رابط غير صحيح', 'error');
                    urlInput.focus();
                    return;
                }

                // Show loading state
                extractBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الاستخراج...';
                extractBtn.disabled = true;
                resultsDiv.style.display = 'none';

                try {
                    const response = await fetch('/api/extract-player-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            url: urlInput.value.trim(),
                            targetClub: targetClubInput.value.trim()
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.displayExtractionResults(result.data);
                        this.showNotification('✅ تم استخراج البيانات بنجاح!', 'success');
                    } else {
                        throw new Error(result.error || 'فشل في استخراج البيانات');
                    }

                } catch (error) {
                    console.error('❌ Extraction error:', error);
                    this.showNotification(`❌ خطأ في الاستخراج: ${error.message}`, 'error');
                } finally {
                    extractBtn.innerHTML = '<i class="fas fa-download"></i> استخراج البيانات تلقائياً';
                    extractBtn.disabled = false;
                }
            }

            displayExtractionResults(data) {
                const resultsDiv = document.getElementById('extractionResults');
                const dataDiv = document.getElementById('extractedData');

                dataDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong style="color: #3b82f6;">اسم اللاعب:</strong><br>
                            <span>${data.arabicName || data.englishName || 'غير محدد'}</span>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">النادي الحالي:</strong><br>
                            <span>${data.currentClub || 'غير محدد'}</span>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">النادي المطلوب:</strong><br>
                            <span>${data.targetClub || 'غير محدد'}</span>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">القيمة السوقية:</strong><br>
                            <span>${data.marketValue || 'غير محدد'}</span>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">العمر:</strong><br>
                            <span>${data.age || 'غير محدد'}</span>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">المركز:</strong><br>
                            <span>${data.position || 'غير محدد'}</span>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">احتمالية الانتقال:</strong><br>
                            <span style="color: #10b981; font-weight: bold;">${data.probability}%</span>
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">رسوم الانتقال:</strong><br>
                            <span>${data.transferFee || 'غير محدد'}</span>
                        </div>
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i>
                        تم الاستخراج من: ${data.source || 'مصدر غير معروف'} |
                        ${new Date(data.extractedAt).toLocaleString('ar-SA')}
                    </div>
                `;

                // Store extracted data for later use
                this.extractedPlayerData = data;
                resultsDiv.style.display = 'block';
            }

            useExtractedData() {
                if (!this.extractedPlayerData) {
                    this.showNotification('❌ لا توجد بيانات مستخرجة', 'error');
                    return;
                }

                const data = this.extractedPlayerData;

                // Fill manual input fields
                document.getElementById('playerName').value = data.arabicName || data.englishName || '';
                document.getElementById('currentClub').value = data.currentClub || '';
                document.getElementById('targetClub').value = data.targetClub || '';
                document.getElementById('transferFee').value = data.transferFee || '';

                // Switch to manual mode
                document.getElementById('inputMode').value = 'manual';
                this.switchMode('manual');

                this.showNotification('✅ تم نقل البيانات إلى النمط اليدوي', 'success');
            }

            editExtractedData() {
                if (!this.extractedPlayerData) {
                    this.showNotification('❌ لا توجد بيانات مستخرجة', 'error');
                    return;
                }

                // Switch to manual mode and fill data for editing
                this.useExtractedData();
                this.showNotification('📝 يمكنك الآن تعديل البيانات في النمط اليدوي', 'info');
            }

            loadExample(type) {
                const examples = {
                    'salah': {
                        url: 'https://www.transfermarkt.com/mohamed-salah/profil/spieler/148455',
                        targetClub: 'ريال مدريد'
                    },
                    'mbappe': {
                        url: 'https://www.transfermarkt.com/kylian-mbappe/profil/spieler/342229',
                        targetClub: 'ليفربول'
                    }
                };

                const example = examples[type];
                if (example) {
                    document.getElementById('playerPageUrl').value = example.url;
                    document.getElementById('extractTargetClub').value = example.targetClub;
                    this.showNotification(`📝 تم تحميل مثال ${type === 'salah' ? 'محمد صلاح' : 'مبابي'}`, 'info');
                }
            }
        }

        // Initialize Ultimate Studio
        const ultimateStudio = new UltimateStudio();
        console.log('🌟 Ultimate Studio V4 - Ready for World-Class Creativity!');

        // 🎬 Overlay Integration System
        class OverlayIntegration {
            constructor() {
                this.ws = null;
                this.overlayId = null;
                this.token = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;

                this.init();
            }

            init() {
                this.generateCredentials();
                this.updateUI();
                console.log('🎬 Overlay Integration initialized');
            }

            generateCredentials() {
                this.overlayId = 'studio_' + Math.random().toString(36).substr(2, 9);
                this.token = 'token_' + Math.random().toString(36).substr(2, 16);
            }

            updateUI() {
                const baseUrl = window.location.origin.replace('8201', '8202'); // Use overlay server port
                const outputUrl = `${baseUrl}/obs-overlay.html?id=${this.overlayId}&token=${this.token}`;

                document.getElementById('obsOutputUrl').value = outputUrl;
                document.getElementById('overlayToken').value = this.token;
            }

            connectToOverlay() {
                try {
                    const wsUrl = `ws://localhost:8202/control-ws?id=${this.overlayId}&token=${this.token}`;
                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        console.log('🔗 Overlay WebSocket connected');
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                        this.reconnectAttempts = 0;
                        ultimateStudio.showNotification('✅ تم الاتصال بالـ Overlay بنجاح', 'success');
                    };

                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        console.log('📨 Overlay message received:', data);
                    };

                    this.ws.onclose = () => {
                        console.log('🔌 Overlay WebSocket disconnected');
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        this.attemptReconnect();
                    };

                    this.ws.onerror = (error) => {
                        console.error('❌ Overlay WebSocket error:', error);
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        ultimateStudio.showNotification('❌ خطأ في الاتصال بالـ Overlay', 'error');
                    };

                } catch (error) {
                    console.error('❌ Failed to connect to Overlay:', error);
                    ultimateStudio.showNotification('❌ فشل في الاتصال بالـ Overlay', 'error');
                }
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`🔄 Attempting to reconnect to Overlay... ${this.reconnectAttempts}`);
                    setTimeout(() => this.connectToOverlay(), 3000);
                }
            }

            updateConnectionStatus(connected) {
                const indicator = document.getElementById('overlayConnectionStatus');
                const text = document.getElementById('overlayConnectionText');

                if (connected) {
                    indicator.classList.add('connected');
                    text.textContent = 'متصل بالـ Overlay';
                } else {
                    indicator.classList.remove('connected');
                    text.textContent = 'غير متصل بالـ Overlay';
                }
            }

            sendCommand(type, data = {}) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    const message = {
                        type,
                        overlayId: this.overlayId,
                        token: this.token,
                        timestamp: Date.now(),
                        ...data
                    };

                    this.ws.send(JSON.stringify(message));
                    console.log('📤 Sent to Overlay:', message);
                    return true;
                } else {
                    ultimateStudio.showNotification('❌ غير متصل بالـ Overlay', 'error');
                    return false;
                }
            }

            sendCurrentPlayer() {
                // Get current player data from the form
                const playerData = this.getCurrentPlayerData();

                if (playerData && this.sendCommand('showPlayer', { playerData })) {
                    ultimateStudio.showNotification('✅ تم إرسال البطاقة للـ Overlay', 'success');
                } else {
                    ultimateStudio.showNotification('❌ لا توجد بيانات لاعب لإرسالها', 'warning');
                }
            }

            hidePlayer() {
                if (this.sendCommand('hidePlayer')) {
                    ultimateStudio.showNotification('✅ تم إخفاء البطاقة من الـ Overlay', 'success');
                }
            }

            getCurrentPlayerData() {
                // Get data from the current form
                const arabicName = document.getElementById('arabicName')?.value;
                const currentClub = document.getElementById('currentClub')?.value;
                const targetClub = document.getElementById('targetClub')?.value;
                const probability = document.getElementById('probability')?.value;
                const transferFee = document.getElementById('transferFee')?.value;

                if (!arabicName || !currentClub || !targetClub) {
                    return null;
                }

                return {
                    arabicName: arabicName || 'لاعب غير محدد',
                    currentClub: currentClub || 'نادي غير محدد',
                    targetClub: targetClub || 'نادي غير محدد',
                    probability: probability || '50',
                    transferFee: transferFee || 'غير محدد'
                };
            }

            testConnection() {
                if (this.isConnected) {
                    ultimateStudio.showNotification('✅ الاتصال يعمل بشكل طبيعي', 'success');
                } else {
                    ultimateStudio.showNotification('❌ غير متصل - جرب الاتصال مرة أخرى', 'error');
                }
            }

            openControlPanel() {
                const controlUrl = window.location.origin.replace('8201', '8202') + '/overlay-control';
                window.open(controlUrl, '_blank');
            }
        }

        // 🎬 Initialize Overlay Integration
        const overlayIntegration = new OverlayIntegration();

        // 🎯 Global Functions for Overlay Control
        function connectToOverlay() {
            overlayIntegration.connectToOverlay();
        }

        function sendCurrentPlayerToOverlay() {
            overlayIntegration.sendCurrentPlayer();
        }

        function hideOverlayPlayer() {
            overlayIntegration.hidePlayer();
        }

        function testOverlayConnection() {
            overlayIntegration.testConnection();
        }

        function openOverlayControl() {
            overlayIntegration.openControlPanel();
        }

        function copyOverlayUrl() {
            const urlInput = document.getElementById('obsOutputUrl');
            const url = urlInput.value;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    ultimateStudio.showNotification('✅ تم نسخ رابط الـ OBS', 'success');
                }).catch(() => {
                    // Fallback
                    urlInput.select();
                    document.execCommand('copy');
                    ultimateStudio.showNotification('✅ تم نسخ رابط الـ OBS', 'success');
                });
            } else {
                urlInput.select();
                document.execCommand('copy');
                ultimateStudio.showNotification('✅ تم نسخ رابط الـ OBS', 'success');
            }
        }

        function copyOverlayToken() {
            const tokenInput = document.getElementById('overlayToken');
            const token = tokenInput.value;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(token).then(() => {
                    ultimateStudio.showNotification('✅ تم نسخ الـ Token', 'success');
                }).catch(() => {
                    // Fallback
                    tokenInput.select();
                    document.execCommand('copy');
                    ultimateStudio.showNotification('✅ تم نسخ الـ Token', 'success');
                });
            } else {
                tokenInput.select();
                document.execCommand('copy');
                ultimateStudio.showNotification('✅ تم نسخ الـ Token', 'success');
            }
        }

        // 🎯 Auto-send functionality
        function checkAutoSendToOverlay() {
            const autoSend = document.getElementById('autoSendToOverlay');
            if (autoSend && autoSend.checked && overlayIntegration.isConnected) {
                setTimeout(() => {
                    overlayIntegration.sendCurrentPlayer();
                }, 1000); // Wait 1 second after card creation
            }
        }

        // 🎯 Expose for debugging
        window.overlayIntegration = overlayIntegration;














        // 🎬 Global Stream Variables - Initialize at top
        var isStreamingActive = false;
        var streamUrl = 'http://localhost:8201/ultimate-stream-overlay';

        console.log('🎬 Ultimate Studio V4 Streaming System loading...');

        // 🎯 Enhanced Stream Functions
        function startSimpleStream() {
            console.log('🎬 startSimpleStream called, current state:', isStreamingActive);

            try {
                // Toggle streaming state
                isStreamingActive = !isStreamingActive;

                console.log('🔄 New streaming state:', isStreamingActive);

                // Update UI immediately
                updateStreamUI();

                // Store stream state
                localStorage.setItem('streamingActive', isStreamingActive.toString());

                // Notify stream overlay about state change
                notifyStreamOverlay();

                // Show enhanced notification
                const message = isStreamingActive ?
                    '🔴 تم بدء البث المباشر - النظام جاهز لعرض البطاقات' :
                    '⏹️ تم إيقاف البث - تم مسح جميع العناصر';
                const type = isStreamingActive ? 'success' : 'info';

                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(message, type);
                } else {
                    console.log(message);
                    alert(message);
                }

                // Auto-clear stream content when stopping
                if (!isStreamingActive) {
                    clearStream();
                }

                console.log('✅ Stream toggle successful, active:', isStreamingActive);

            } catch (error) {
                console.error('❌ Error in startSimpleStream:', error);
                const errorMsg = 'خطأ في نظام البث: ' + error.message;
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }

        // 🔔 Notify stream overlay about state changes
        function notifyStreamOverlay() {
            try {
                // Store stream state for overlay
                localStorage.setItem('streamingActive', isStreamingActive.toString());
                localStorage.setItem('streamStateChanged', Date.now().toString());

                // Dispatch custom event for real-time updates
                window.dispatchEvent(new CustomEvent('streamStateChanged', {
                    detail: { active: isStreamingActive, timestamp: Date.now() }
                }));

                console.log('📡 Stream overlay notified, state:', isStreamingActive);
            } catch (error) {
                console.error('❌ Error notifying stream overlay:', error);
            }
        }

        function updateStreamUI() {
            console.log('🔄 Updating stream UI, active:', isStreamingActive);

            try {
                const indicator = document.getElementById('simpleStreamStatus');
                const text = document.getElementById('simpleStreamText');
                const button = document.getElementById('simpleStreamBtn');

                console.log('🔍 UI Elements found:', {
                    indicator: !!indicator,
                    text: !!text,
                    button: !!button
                });

                if (!indicator || !text || !button) {
                    console.error('❌ Stream UI elements not found');
                    console.error('Missing elements:', {
                        indicator: !indicator ? 'simpleStreamStatus' : 'found',
                        text: !text ? 'simpleStreamText' : 'found',
                        button: !button ? 'simpleStreamBtn' : 'found'
                    });
                    return;
                }

                if (isStreamingActive) {
                    indicator.classList.add('live');
                    text.innerHTML = 'البث مباشر <span style="color: #ff0000;">🔴</span>';
                    button.innerHTML = '<i class="fas fa-stop"></i> إيقاف البث';
                    button.className = 'ultimate-btn btn-danger-ultimate';
                    button.style.background = 'linear-gradient(135deg, #ff4757, #ff3838)';
                    console.log('✅ UI updated to streaming ON');
                } else {
                    indicator.classList.remove('live');
                    text.innerHTML = 'البث متوقف <span style="color: #888;">⚫</span>';
                    button.innerHTML = '<i class="fas fa-play"></i> بدء البث';
                    button.className = 'ultimate-btn btn-success-ultimate';
                    button.style.background = 'linear-gradient(135deg, #2ed573, #1e90ff)';
                    console.log('✅ UI updated to streaming OFF');
                }

                // Update URL input to ensure it's correct
                const urlInput = document.getElementById('simpleStreamUrl');
                if (urlInput && urlInput.value !== streamUrl) {
                    urlInput.value = streamUrl;
                }

                console.log('✅ Stream UI updated successfully');

            } catch (error) {
                console.error('❌ Error updating stream UI:', error);
                const errorMsg = 'خطأ في تحديث واجهة البث: ' + error.message;
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }

        function showPlayerInSimpleStream() {
            console.log('🎬 showPlayerInSimpleStream called');

            try {
                // Check if streaming is active
                if (!isStreamingActive) {
                    const message = '⚠️ يجب بدء البث أولاً قبل عرض اللاعبين';
                    if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                        window.ultimateStudio.showNotification(message, 'warning');
                    } else {
                        alert(message);
                    }
                    return;
                }

                // Get current player data
                const playerData = getCurrentPlayerData();

                if (!playerData || !playerData.arabicName) {
                    const message = '⚠️ لا توجد بيانات لاعب لعرضها - يرجى إنشاء بطاقة أولاً';
                    if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                        window.ultimateStudio.showNotification(message, 'warning');
                    } else {
                        alert(message);
                    }
                    return;
                }

                // Enhanced player data with timestamp
                const enhancedPlayerData = {
                    ...playerData,
                    timestamp: Date.now(),
                    streamId: 'ultimate-studio-v4',
                    action: 'show'
                };

                // Store in localStorage for stream overlay
                localStorage.setItem('currentStreamPlayer', JSON.stringify(enhancedPlayerData));
                localStorage.setItem('playerDisplayChanged', Date.now().toString());

                // Dispatch custom event for real-time updates
                window.dispatchEvent(new CustomEvent('playerDisplayChanged', {
                    detail: { action: 'show', player: enhancedPlayerData }
                }));

                const message = `✅ تم عرض ${playerData.arabicName} في البث المباشر`;
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(message, 'success');
                } else {
                    console.log(message);
                }

                console.log('✅ Player sent to stream:', playerData.arabicName);

            } catch (error) {
                console.error('❌ Error showing player in stream:', error);
                const errorMsg = 'خطأ في عرض اللاعب: ' + error.message;
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }

        function hidePlayerFromSimpleStream() {
            console.log('🎬 hidePlayerFromSimpleStream called');

            try {
                // Remove from localStorage
                localStorage.removeItem('currentStreamPlayer');
                localStorage.setItem('playerDisplayChanged', Date.now().toString());

                // Dispatch custom event for real-time updates
                window.dispatchEvent(new CustomEvent('playerDisplayChanged', {
                    detail: { action: 'hide', timestamp: Date.now() }
                }));

                const message = '✅ تم إخفاء اللاعب من البث المباشر';
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(message, 'success');
                } else {
                    console.log(message);
                }

                console.log('✅ Player hidden from stream');

            } catch (error) {
                console.error('❌ Error hiding player from stream:', error);
                const errorMsg = 'خطأ في إخفاء اللاعب: ' + error.message;
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }

        function openSimpleStream() {
            console.log('🎬 openSimpleStream called');
            console.log('🔗 Stream URL:', streamUrl);

            try {
                // Enhanced stream window opening with better settings
                const streamWindow = window.open(
                    streamUrl,
                    'UltimateStudioStream',
                    'width=1920,height=1080,scrollbars=yes,resizable=yes,location=no,menubar=no,toolbar=no,status=no,titlebar=no'
                );

                if (streamWindow) {
                    console.log('✅ Stream window opened successfully');

                    // Store window reference for future use
                    window.streamWindowRef = streamWindow;

                    const message = '✅ تم فتح البث في نافذة جديدة - جاهز للاستخدام في OBS';
                    if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                        window.ultimateStudio.showNotification(message, 'success');
                    } else {
                        console.log(message);
                        alert(message);
                    }

                    // Focus on new window and setup
                    setTimeout(() => {
                        try {
                            streamWindow.focus();

                            // Send current stream state to the new window
                            if (isStreamingActive) {
                                streamWindow.postMessage({
                                    type: 'streamState',
                                    active: true,
                                    timestamp: Date.now()
                                }, '*');
                            }

                            console.log('✅ Stream window focused and configured');
                        } catch (e) {
                            console.log('⚠️ Could not configure stream window:', e);
                        }
                    }, 1000);

                    // Monitor window status
                    const checkWindow = setInterval(() => {
                        try {
                            if (streamWindow.closed) {
                                console.log('📺 Stream window was closed');
                                clearInterval(checkWindow);
                                window.streamWindowRef = null;
                            }
                        } catch (e) {
                            clearInterval(checkWindow);
                        }
                    }, 2000);

                } else {
                    console.error('❌ Failed to open stream window - likely blocked by popup blocker');

                    // Try alternative method - create a link and click it
                    const link = document.createElement('a');
                    link.href = streamUrl;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    const message = '🔗 تم فتح البث في تبويب جديد (طريقة بديلة)';
                    if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                        window.ultimateStudio.showNotification(message, 'info');
                    } else {
                        alert(message);
                    }
                }

            } catch (error) {
                console.error('❌ Error opening stream:', error);
                const errorMsg = '❌ خطأ في فتح البث: ' + error.message;
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }

                // Fallback - show URL to user
                const fallbackMessage = `يمكنك فتح البث يدوياً من هذا الرابط:\n${streamUrl}`;
                alert(fallbackMessage);
            }
        }

        function clearStream() {
            console.log('🎬 clearStream called');

            try {
                // Clear localStorage
                localStorage.removeItem('currentStreamPlayer');

                const message = '🧹 تم مسح بيانات البث';
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(message, 'info');
                } else {
                    console.log(message);
                }

                console.log('✅ Stream data cleared');

            } catch (error) {
                console.error('❌ Error clearing stream:', error);
                alert('خطأ في مسح البث: ' + error.message);
            }
        }

        function getCurrentPlayerData() {
            try {
                console.log('🔍 Getting current player data...');

                // Try different possible input IDs
                const possibleIds = {
                    arabicName: ['arabicName', 'playerName', 'name'],
                    currentClub: ['currentClub', 'fromClub', 'club1'],
                    targetClub: ['targetClub', 'toClub', 'club2'],
                    probability: ['probability', 'transferProbability', 'prob'],
                    transferFee: ['transferFee', 'fee', 'price']
                };

                const playerData = {};

                // Try to find each field
                for (const [field, ids] of Object.entries(possibleIds)) {
                    let value = '';
                    for (const id of ids) {
                        const element = document.getElementById(id);
                        if (element && element.value && element.value.trim()) {
                            value = element.value.trim();
                            console.log(`✅ Found ${field} in element ${id}:`, value);
                            break;
                        }
                    }
                    playerData[field] = value;
                }

                console.log('🔍 Collected player data:', playerData);

                // Check if we have minimum required data
                if (!playerData.arabicName && !playerData.currentClub && !playerData.targetClub) {
                    console.log('⚠️ No player data found in any input fields');

                    // Try to get data from visible card if exists
                    const visibleCard = document.querySelector('.fifa-card:not([style*="display: none"])');
                    if (visibleCard) {
                        console.log('🔍 Trying to extract data from visible card...');
                        const nameEl = visibleCard.querySelector('.player-name, h2, .name');
                        const clubsEl = visibleCard.querySelector('.clubs-info, .club-info');

                        if (nameEl) {
                            playerData.arabicName = nameEl.textContent.trim();
                            console.log('✅ Extracted name from card:', playerData.arabicName);
                        }

                        if (clubsEl) {
                            const clubText = clubsEl.textContent;
                            const clubs = clubText.split('→').map(c => c.trim());
                            if (clubs.length >= 2) {
                                playerData.currentClub = clubs[0];
                                playerData.targetClub = clubs[1];
                                console.log('✅ Extracted clubs from card:', clubs);
                            }
                        }
                    }
                }

                // Set defaults for missing data
                const finalData = {
                    arabicName: playerData.arabicName || 'لاعب تجريبي',
                    currentClub: playerData.currentClub || 'النادي الحالي',
                    targetClub: playerData.targetClub || 'النادي المستهدف',
                    probability: playerData.probability || '75',
                    transferFee: playerData.transferFee || '50 مليون يورو'
                };

                console.log('✅ Final player data:', finalData);
                return finalData;

            } catch (error) {
                console.error('❌ Error getting player data:', error);

                // Return default data as fallback
                return {
                    arabicName: 'لاعب تجريبي',
                    currentClub: 'النادي الحالي',
                    targetClub: 'النادي المستهدف',
                    probability: '75',
                    transferFee: '50 مليون يورو'
                };
            }
        }

        function copySimpleStreamUrl() {
            console.log('📋 copySimpleStreamUrl called');

            try {
                const url = streamUrl; // Use the global streamUrl variable
                console.log('📋 Copying URL:', url);

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(url).then(() => {
                        console.log('✅ URL copied via clipboard API');
                        const message = '✅ تم نسخ رابط البث';
                        if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                            window.ultimateStudio.showNotification(message, 'success');
                        } else {
                            console.log(message);
                        }
                    }).catch((error) => {
                        console.log('⚠️ Clipboard API failed, using fallback:', error);
                        // Fallback method
                        copyToClipboardFallback(url);
                    });
                } else {
                    console.log('⚠️ Clipboard API not available, using fallback');
                    copyToClipboardFallback(url);
                }
            } catch (error) {
                console.error('❌ Error copying URL:', error);
                const message = '❌ فشل في نسخ الرابط: ' + error.message;
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(message, 'error');
                } else {
                    alert(message);
                }
            }
        }

        function copyToClipboardFallback(text) {
            try {
                // Create temporary textarea
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                textarea.setSelectionRange(0, 99999);
                document.execCommand('copy');
                document.body.removeChild(textarea);

                const message = '✅ تم نسخ رابط البث';
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(message, 'success');
                } else {
                    console.log(message);
                }
            } catch (error) {
                console.error('❌ Fallback copy failed:', error);
                // Last resort - show the URL to user
                prompt('انسخ هذا الرابط:', text);
            }
        }

        // 🎯 Auto-stream functionality
        function checkAutoStreamPlayer() {
            console.log('🎯 checkAutoStreamPlayer called');

            try {
                const autoStream = document.getElementById('autoShowInStream');
                if (!autoStream) {
                    console.log('⚠️ Auto stream checkbox not found');
                    return;
                }

                if (autoStream.checked && isStreamingActive) {
                    console.log('✅ Auto stream conditions met, showing player...');
                    setTimeout(() => {
                        showPlayerInSimpleStream();
                    }, 1000);
                } else {
                    console.log('⚠️ Auto stream conditions not met:', {
                        checked: autoStream.checked,
                        streaming: isStreamingActive
                    });
                }
            } catch (error) {
                console.error('❌ Error in checkAutoStreamPlayer:', error);
            }
        }

        // 🎯 Enhanced initialization system
        function initializeStreamSystem() {
            console.log('🎬 Initializing Enhanced Stream System...');

            try {
                // Initialize global variables with proper defaults
                if (typeof isStreamingActive === 'undefined') {
                    window.isStreamingActive = false;
                    console.log('🔧 Initialized isStreamingActive globally');
                }

                if (typeof streamUrl === 'undefined') {
                    window.streamUrl = 'http://localhost:8201/ultimate-stream-overlay';
                    console.log('🔧 Initialized streamUrl globally');
                }

                // Load previous stream state if exists
                const savedStreamState = localStorage.getItem('streamingActive');
                if (savedStreamState !== null) {
                    isStreamingActive = savedStreamState === 'true';
                    console.log('🔄 Restored stream state:', isStreamingActive);
                }

                // Wait for DOM to be fully ready
                setTimeout(() => {
                    // Update UI to current state
                    updateStreamUI();

                    // Set stream URL in input
                    const urlInput = document.getElementById('simpleStreamUrl');
                    if (urlInput) {
                        urlInput.value = streamUrl;
                        console.log('✅ Stream URL set in input:', streamUrl);
                    } else {
                        console.log('⚠️ Stream URL input not found');
                    }

                    // Validate all required elements
                    const requiredElements = [
                        'simpleStreamStatus', 'simpleStreamText', 'simpleStreamBtn',
                        'simpleStreamUrl', 'autoShowInStream'
                    ];

                    const missingElements = [];
                    requiredElements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            console.log(`✅ Element ${id}: found`);
                        } else {
                            console.log(`❌ Element ${id}: NOT FOUND`);
                            missingElements.push(id);
                        }
                    });

                    if (missingElements.length > 0) {
                        console.warn('⚠️ Missing elements:', missingElements);
                    }

                    // Setup periodic state synchronization
                    setInterval(() => {
                        const currentState = localStorage.getItem('streamingActive') === 'true';
                        if (currentState !== isStreamingActive) {
                            console.log('🔄 Syncing stream state from storage');
                            isStreamingActive = currentState;
                            updateStreamUI();
                        }
                    }, 2000);

                    console.log('✅ Enhanced Stream System initialized successfully');
                }, 500);

            } catch (error) {
                console.error('❌ Error initializing stream system:', error);
                const errorMsg = 'خطأ في تهيئة نظام البث: ' + error.message;
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }

        // 🎯 Initialize when DOM is ready - multiple approaches
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeStreamSystem);
            console.log('📅 Waiting for DOMContentLoaded...');
        } else {
            console.log('📅 DOM already ready, initializing immediately...');
            initializeStreamSystem();
        }

        // Also try after a delay as backup
        setTimeout(() => {
            console.log('⏰ Backup initialization after 2 seconds...');
            initializeStreamSystem();
        }, 2000);

        // 🎯 Debug functions
        window.debugStream = function() {
            console.log('🔍 Stream Debug Info:');
            console.log('- Is streaming:', isStreamingActive);
            console.log('- Stream URL:', streamUrl);

            // Check elements
            const elements = ['simpleStreamStatus', 'simpleStreamText', 'simpleStreamBtn', 'simpleStreamUrl'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                console.log(`- Element ${id}:`, !!el);
                if (el) {
                    console.log(`  - Value/Text:`, el.value || el.textContent || 'N/A');
                }
            });

            // Check player data
            const playerData = getCurrentPlayerData();
            console.log('- Current player data:', playerData);
        };

        // 🎯 Enhanced Test Functions
        window.testStreamSystem = function() {
            console.log('🧪 Testing stream system...');

            console.log('1. Testing variables...');
            console.log('- isStreamingActive:', typeof isStreamingActive, isStreamingActive);
            console.log('- streamUrl:', typeof streamUrl, streamUrl);

            console.log('2. Testing startSimpleStream...');
            try {
                startSimpleStream();
                console.log('✅ startSimpleStream executed');
            } catch (error) {
                console.error('❌ startSimpleStream failed:', error);
            }

            setTimeout(() => {
                console.log('3. Testing openSimpleStream...');
                try {
                    openSimpleStream();
                    console.log('✅ openSimpleStream executed');
                } catch (error) {
                    console.error('❌ openSimpleStream failed:', error);
                }
            }, 1000);

            setTimeout(() => {
                console.log('4. Testing copySimpleStreamUrl...');
                try {
                    copySimpleStreamUrl();
                    console.log('✅ copySimpleStreamUrl executed');
                } catch (error) {
                    console.error('❌ copySimpleStreamUrl failed:', error);
                }
            }, 2000);

            setTimeout(() => {
                console.log('5. Testing showPlayerInSimpleStream...');
                try {
                    showPlayerInSimpleStream();
                    console.log('✅ showPlayerInSimpleStream executed');
                } catch (error) {
                    console.error('❌ showPlayerInSimpleStream failed:', error);
                }
            }, 3000);
        };

        // 🎯 Quick Fix Function
        window.fixStreamSystem = function() {
            console.log('🔧 Fixing stream system...');

            // Re-initialize variables
            window.isStreamingActive = false;
            window.streamUrl = 'http://localhost:8201/ultimate-stream-overlay';

            // Re-initialize UI
            initializeStreamSystem();

            console.log('✅ Stream system fixed');
        };

        // 🎯 Manual Test Function
        window.manualTest = function() {
            console.log('🧪 Manual test - creating test player data...');

            // Try to fill form if exists
            const nameInput = document.getElementById('arabicName');
            const currentClubInput = document.getElementById('currentClub');
            const targetClubInput = document.getElementById('targetClub');

            if (nameInput) nameInput.value = 'محمد صلاح';
            if (currentClubInput) currentClubInput.value = 'ليفربول';
            if (targetClubInput) targetClubInput.value = 'ريال مدريد';

            console.log('✅ Test data filled');

            // Test showing player
            setTimeout(() => {
                showPlayerInSimpleStream();
            }, 500);
        };

        console.log('🎬 Ultimate Studio V4 Simple Streaming System loaded');
        console.log('🔍 Use window.debugStream() for debugging info');
        console.log('🧪 Use window.testStreamSystem() to test all functions');
        console.log('🔧 Use window.fixStreamSystem() if there are issues');
        console.log('👤 Use window.manualTest() to test with sample player data');

        // 🔧 Auto-fix system for stream issues
        function autoFixStreamSystem() {
            console.log('🔧 Auto-fixing stream system...');

            // Ensure global variables are defined
            if (typeof window.isStreamingActive === 'undefined') {
                window.isStreamingActive = false;
                console.log('✅ Fixed: isStreamingActive defined');
            }

            if (typeof window.streamUrl === 'undefined') {
                window.streamUrl = 'http://localhost:8201/ultimate-stream-overlay';
                console.log('✅ Fixed: streamUrl defined');
            }

            // Ensure functions are accessible globally
            if (typeof window.startSimpleStream === 'undefined') {
                window.startSimpleStream = startSimpleStream;
                console.log('✅ Fixed: startSimpleStream made global');
            }

            if (typeof window.showPlayerInSimpleStream === 'undefined') {
                window.showPlayerInSimpleStream = showPlayerInSimpleStream;
                console.log('✅ Fixed: showPlayerInSimpleStream made global');
            }

            if (typeof window.getCurrentPlayerData === 'undefined') {
                window.getCurrentPlayerData = getCurrentPlayerData;
                console.log('✅ Fixed: getCurrentPlayerData made global');
            }

            if (typeof window.openSimpleStream === 'undefined') {
                window.openSimpleStream = openSimpleStream;
                console.log('✅ Fixed: openSimpleStream made global');
            }

            if (typeof window.copySimpleStreamUrl === 'undefined') {
                window.copySimpleStreamUrl = copySimpleStreamUrl;
                console.log('✅ Fixed: copySimpleStreamUrl made global');
            }

            // Update UI to current state
            setTimeout(() => {
                updateStreamUI();
                console.log('✅ Fixed: UI updated');
            }, 500);

            console.log('🎉 Stream system auto-fix completed!');
        }

        // Run auto-fix
        autoFixStreamSystem();

        // Make auto-fix available globally
        window.autoFixStreamSystem = autoFixStreamSystem;

        console.log('🔧 Auto-fix system ready - use window.autoFixStreamSystem() if needed');

        // 🎬 NEW INTEGRATED STREAMING SYSTEM - Professional & Simple
        console.log('🚀 Loading New Integrated Streaming System...');

        // Global variables for new system - Auto-start enabled
        let newStreamActive = true; // Auto-start streaming
        const newStreamUrl = 'http://localhost:8201/stream-overlay-simple';

        // Toggle new stream
        function toggleNewStream() {
            console.log('🎬 toggleNewStream called');

            newStreamActive = !newStreamActive;

            // Store state in localStorage
            localStorage.setItem('streamActive', newStreamActive.toString());
            localStorage.setItem('streamStateChanged', Date.now().toString());

            // Update UI
            updateNewStreamUI();

            // Show notification
            const message = newStreamActive ? 'تم بدء البث المباشر' : 'تم إيقاف البث';
            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification(message, newStreamActive ? 'success' : 'info');
            } else {
                alert(message);
            }

            console.log('✅ New stream state:', newStreamActive);
        }

        // Show player in new stream - Auto-enabled
        function showPlayerInNewStream() {
            console.log('🎬 showPlayerInNewStream called - Auto-streaming enabled');

            // Auto-enable streaming if not active
            if (!newStreamActive) {
                newStreamActive = true;
                updateNewStreamUI();
                console.log('✅ Auto-enabled streaming for player display');
            }

            // Get current player data
            const playerData = getNewPlayerData();

            if (!playerData.playerName || !playerData.playerName.trim()) {
                const message = '⚠️ يرجى إدخال اسم اللاعب أولاً';
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(message, 'warning');
                } else {
                    alert(message);
                }
                return;
            }

            // Store player data for stream
            localStorage.setItem('currentPlayer', JSON.stringify(playerData));
            localStorage.setItem('playerChanged', Date.now().toString());

            const message = `✅ تم عرض ${playerData.playerName} في البث المباشر`;
            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification(message, 'success');
            } else {
                alert(message);
            }

            console.log('✅ Player shown in new stream:', playerData);
        }

        // Hide player from new stream
        function hidePlayerFromNewStream() {
            console.log('🎬 hidePlayerFromNewStream called');

            localStorage.removeItem('currentPlayer');
            localStorage.setItem('playerChanged', Date.now().toString());

            const message = '✅ تم إخفاء اللاعب من البث';
            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification(message, 'info');
            } else {
                alert(message);
            }

            console.log('✅ Player hidden from new stream');
        }

        // Get new player data
        function getNewPlayerData() {
            // Try to get from Ultimate Studio first
            if (window.ultimateStudio && window.ultimateStudio.currentPlayer) {
                const player = window.ultimateStudio.currentPlayer;
                return {
                    playerName: player.arabicName || player.name || '',
                    currentClub: player.currentClub || '',
                    targetClub: player.targetClub || '',
                    probability: player.probability || '75',
                    transferFee: player.transferFee || '',
                    timestamp: Date.now()
                };
            }

            // Fallback to form inputs
            const possibleIds = {
                playerName: ['arabicName', 'playerName', 'name'],
                currentClub: ['currentClub', 'fromClub', 'club1'],
                targetClub: ['targetClub', 'toClub', 'club2'],
                probability: ['probability', 'transferProbability', 'prob'],
                transferFee: ['transferFee', 'fee', 'price']
            };

            const playerData = { timestamp: Date.now() };

            for (const [field, ids] of Object.entries(possibleIds)) {
                let value = '';
                for (const id of ids) {
                    const element = document.getElementById(id);
                    if (element && element.value && element.value.trim()) {
                        value = element.value.trim();
                        break;
                    }
                }
                playerData[field] = value;
            }

            // Set defaults if empty
            if (!playerData.playerName) playerData.playerName = '';
            if (!playerData.currentClub) playerData.currentClub = '';
            if (!playerData.targetClub) playerData.targetClub = '';
            if (!playerData.probability) playerData.probability = '75';
            if (!playerData.transferFee) playerData.transferFee = '';

            return playerData;
        }

        // Update new stream UI
        function updateNewStreamUI() {
            const indicator = document.getElementById('newStreamStatus');
            const text = document.getElementById('newStreamText');
            const button = document.getElementById('newStreamBtn');

            if (indicator && text && button) {
                if (newStreamActive) {
                    indicator.classList.add('live');
                    text.innerHTML = 'البث مباشر <span style="color: #ff0000;">🔴</span>';
                    button.innerHTML = '<i class="fas fa-stop"></i> إيقاف البث';
                    button.className = 'ultimate-btn btn-danger-ultimate';
                } else {
                    indicator.classList.remove('live');
                    text.innerHTML = 'البث متوقف <span style="color: #888;">⚫</span>';
                    button.innerHTML = '<i class="fas fa-play"></i> بدء البث';
                    button.className = 'ultimate-btn btn-success-ultimate';
                }
            }
        }

        // Open new stream
        function openNewStream() {
            window.open(newStreamUrl, 'NewStreamOverlay', 'width=1920,height=1080,scrollbars=no,resizable=yes');
            console.log('✅ New stream window opened');
        }

        // Open control panel
        function openControlPanel() {
            window.open('/stream-control-panel', 'StreamControlPanel', 'width=900,height=800,scrollbars=yes,resizable=yes');
            console.log('✅ Control panel opened');
        }

        // Copy new stream URL
        function copyNewStreamUrl() {
            navigator.clipboard.writeText(newStreamUrl).then(() => {
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification('تم نسخ رابط البث', 'success');
                } else {
                    alert('تم نسخ رابط البث');
                }
            }).catch(() => {
                prompt('انسخ هذا الرابط:', newStreamUrl);
            });
        }

        // Clear new stream
        function clearNewStream() {
            localStorage.removeItem('currentPlayer');
            localStorage.removeItem('streamActive');
            localStorage.setItem('streamCleared', Date.now().toString());

            newStreamActive = false;
            updateNewStreamUI();

            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification('تم مسح البث', 'info');
            } else {
                alert('تم مسح البث');
            }

            console.log('✅ New stream cleared');
        }

        // Test new stream
        function testNewStream() {
            console.log('🧪 Testing new stream system...');

            // Fill test data
            const testData = {
                playerName: 'محمد صلاح',
                currentClub: 'ليفربول',
                targetClub: 'ريال مدريد',
                probability: '85',
                transferFee: '100 مليون يورو',
                timestamp: Date.now()
            };

            // Store test data
            localStorage.setItem('currentPlayer', JSON.stringify(testData));
            localStorage.setItem('streamActive', 'true');
            localStorage.setItem('playerChanged', Date.now().toString());

            newStreamActive = true;
            updateNewStreamUI();

            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification('تم تشغيل الاختبار - محمد صلاح', 'success');
            } else {
                alert('تم تشغيل الاختبار - محمد صلاح');
            }

            console.log('✅ Test data loaded:', testData);
        }

        // Auto-show in stream when creating card
        function checkAutoShowInNewStream() {
            const autoShow = document.getElementById('autoShowInNewStream');
            if (autoShow && autoShow.checked && newStreamActive) {
                setTimeout(() => {
                    showPlayerInNewStream();
                }, 500);
            }
        }

        // Initialize new stream system
        function initNewStreamSystem() {
            // Load saved state
            const savedState = localStorage.getItem('streamActive') === 'true';
            if (savedState) {
                newStreamActive = savedState;
            }

            // Update UI
            updateNewStreamUI();

            console.log('✅ New stream system initialized');
        }

        // Make functions globally available
        window.toggleNewStream = toggleNewStream;
        window.showPlayerInNewStream = showPlayerInNewStream;
        window.hidePlayerFromNewStream = hidePlayerFromNewStream;
        window.openNewStream = openNewStream;
        window.openControlPanel = openControlPanel;
        window.copyNewStreamUrl = copyNewStreamUrl;
        window.clearNewStream = clearNewStream;
        window.testNewStream = testNewStream;
        window.getNewPlayerData = getNewPlayerData;
        window.checkAutoShowInNewStream = checkAutoShowInNewStream;

        // Initialize new system with auto-start
        initNewStreamSystem();

        // Auto-start streaming after initialization
        setTimeout(() => {
            updateNewStreamUI();
            console.log('🔴 Auto-started streaming system - Professional Mode');

            // Show auto-start notification
            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification('🔴 نظام البث جاهز تلقائياً - Professional Mode', 'success');
            }
        }, 1500);

        console.log('🎉 New Integrated Streaming System Ready!');
        console.log('🎮 Use openControlPanel() for advanced control');
        console.log('🎬 Use testNewStream() for quick testing');

        // 🎬 DIRECT STREAM SYSTEM - Same design as Ultimate Studio V4
        console.log('🚀 Loading Direct Stream System...');

        // Global variables for direct stream - Auto-start enabled
        window.directStreamActive = true; // Auto-start streaming
        window.directStreamUrl = 'http://localhost:8201/stream-clean';

        // Toggle direct stream
        window.toggleDirectStream = function() {
            console.log('🎬 toggleDirectStream called');

            window.directStreamActive = !window.directStreamActive;

            // Store state in localStorage
            localStorage.setItem('directStreamActive', window.directStreamActive.toString());
            localStorage.setItem('directStreamStateChanged', Date.now().toString());

            // Update UI
            window.updateDirectStreamUI();

            // Show notification
            const message = window.directStreamActive ? 'تم بدء البث المباشر' : 'تم إيقاف البث المباشر';
            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification(message, window.directStreamActive ? 'success' : 'info');
            } else {
                alert(message);
            }

            console.log('✅ Direct stream state:', window.directStreamActive);
        };

        // Send current content to direct stream - Auto-enabled (ENHANCED VERSION 2)
        window.sendToDirectStreamV2 = function() {
            console.log('🎬 sendToDirectStreamV2 called - Auto-streaming enabled');

            // Auto-enable streaming if not active
            if (!window.directStreamActive) {
                window.directStreamActive = true;
                localStorage.setItem('directStreamActive', 'true');
                window.updateDirectStreamUI();
                console.log('✅ Auto-enabled direct streaming for content display');
            }

            // Get current content from previewContent
            const previewContent = document.getElementById('previewContent');
            if (!previewContent || !previewContent.innerHTML.trim()) {
                const message = '⚠️ لا يوجد محتوى لإرساله. يرجى إنشاء بطاقة أولاً';
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification(message, 'warning');
                } else {
                    alert(message);
                }
                return;
            }

            // Apply current size settings to content before sending
            let contentHtml = previewContent.innerHTML;
            contentHtml = window.applyCurrentSizesToContent(contentHtml);

            // Prepare content data with enhanced metadata
            const contentData = {
                html: contentHtml,
                timestamp: Date.now(),
                source: 'Ultimate Studio V4 - V2',
                id: 'content_v2_' + Date.now(),
                version: '2.1'
            };

            // Store content for direct stream (multiple methods)
            localStorage.setItem('directStreamActive', 'true');
            localStorage.setItem('directStreamContent', JSON.stringify(contentData));
            localStorage.setItem('directStreamContentChanged', Date.now().toString());
            localStorage.setItem('directStreamLastUpdate', Date.now().toString());

            // 📁 NEW: Send to OBS File System as well
            window.sendToOBSFileSystem(contentData);

            // Send to server API as well
            fetch('/api/stream-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache'
                },
                body: JSON.stringify({
                    active: true,
                    content: contentData
                })
            }).then(response => response.json())
              .then(data => {
                  console.log('📡 Content sent to server (V2):', data);
              })
              .catch(error => {
                  console.log('📱 Server unavailable, using localStorage only (V2)');
              });

            // Trigger events for cross-tab communication
            setTimeout(() => {
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'directStreamContent',
                    newValue: JSON.stringify(contentData),
                    storageArea: localStorage
                }));

                window.dispatchEvent(new CustomEvent('directStreamUpdate', {
                    detail: contentData
                }));
            }, 50);

            const message = '✅ تم إرسال المحتوى للبث المباشر';
            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification(message, 'success');
            } else {
                alert(message);
            }

            console.log('✅ Content sent to direct stream (V2):', contentData);
        };

        // Use the enhanced version as the main function
        if (typeof window.sendToDirectStream !== 'function') {
            window.sendToDirectStream = window.sendToDirectStreamV2;
        }

        // Hide content from direct stream
        window.hideFromDirectStream = function() {
            console.log('🎬 hideFromDirectStream called');

            localStorage.removeItem('directStreamContent');
            localStorage.setItem('directStreamContentChanged', Date.now().toString());

            const message = '✅ تم إخفاء المحتوى من البث المباشر';
            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification(message, 'info');
            } else {
                alert(message);
            }

            console.log('✅ Content hidden from direct stream');
        };

        // Open direct stream window
        window.openDirectStream = function() {
            window.open(window.directStreamUrl, 'DirectStreamView', 'width=1920,height=1080,scrollbars=no,resizable=yes');
            console.log('✅ Direct stream window opened');
        };

        // Copy direct stream URL
        window.copyDirectStreamUrl = function() {
            navigator.clipboard.writeText(window.directStreamUrl).then(() => {
                if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                    window.ultimateStudio.showNotification('تم نسخ رابط البث المباشر', 'success');
                } else {
                    alert('تم نسخ رابط البث المباشر');
                }
            }).catch(() => {
                prompt('انسخ هذا الرابط:', window.directStreamUrl);
            });
        };

        // Clear direct stream
        window.clearDirectStream = function() {
            localStorage.removeItem('directStreamContent');
            localStorage.removeItem('directStreamActive');
            localStorage.setItem('directStreamCleared', Date.now().toString());

            window.directStreamActive = false;
            window.updateDirectStreamUI();

            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification('تم مسح البث المباشر', 'info');
            } else {
                alert('تم مسح البث المباشر');
            }

            console.log('✅ Direct stream cleared');
        };

        // Test direct stream
        window.testDirectStream = function() {
            console.log('🧪 Testing direct stream system...');

            // Start stream
            window.directStreamActive = true;
            localStorage.setItem('directStreamActive', 'true');
            window.updateDirectStreamUI();

            // Send current content or create test content
            const previewContent = document.getElementById('previewContent');
            if (previewContent && previewContent.innerHTML.trim()) {
                // Send existing content
                window.sendToDirectStream();
            } else {
                // Create test content
                const testContent = {
                    html: `
                        <div class="fifa-card" style="
                            background: linear-gradient(135deg, #1e3c72, #2a5298);
                            border: 3px solid transparent;
                            border-radius: 25px;
                            padding: 40px;
                            color: white;
                            text-align: center;
                            width: 450px;
                            min-height: 550px;
                        ">
                            <h2 style="font-size: 36px; margin-bottom: 20px;">محمد صلاح</h2>
                            <div style="margin: 30px 0;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px;">ليفربول</div>
                                    <div style="font-size: 24px;">→</div>
                                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px;">ريال مدريد</div>
                                </div>
                            </div>
                            <div style="margin: 40px 0;">
                                <div style="font-size: 48px; font-weight: bold; color: #10b981;">85%</div>
                                <div style="font-size: 18px; opacity: 0.8;">احتمالية الانتقال</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; margin-top: 20px;">
                                رسوم الانتقال: 100 مليون يورو
                            </div>
                        </div>
                    `,
                    timestamp: Date.now(),
                    source: 'Test Data'
                };

                localStorage.setItem('directStreamContent', JSON.stringify(testContent));
                localStorage.setItem('directStreamContentChanged', Date.now().toString());
            }

            if (window.ultimateStudio && window.ultimateStudio.showNotification) {
                window.ultimateStudio.showNotification('تم تشغيل اختبار البث المباشر', 'success');
            } else {
                alert('تم تشغيل اختبار البث المباشر');
            }

            console.log('✅ Direct stream test completed');
        };

        // Update direct stream UI - Fixed element IDs
        window.updateDirectStreamUI = function() {
            const indicator = document.getElementById('newStreamStatus');
            const text = document.getElementById('newStreamText');
            const button = document.getElementById('newStreamBtn');

            console.log('🔄 Updating UI - Elements found:', {
                indicator: !!indicator,
                text: !!text,
                button: !!button,
                active: window.directStreamActive
            });

            if (indicator && text && button) {
                if (window.directStreamActive) {
                    indicator.classList.add('live');
                    text.innerHTML = 'البث مباشر <span style="color: #ff0000;">🔴</span>';
                    button.innerHTML = '<i class="fas fa-stop"></i> إيقاف البث';
                    button.className = 'ultimate-btn btn-danger-ultimate';
                    button.setAttribute('onclick', 'toggleDirectStream()');
                } else {
                    indicator.classList.remove('live');
                    text.innerHTML = 'البث متوقف <span style="color: #888;">⚫</span>';
                    button.innerHTML = '<i class="fas fa-play"></i> بدء البث';
                    button.className = 'ultimate-btn btn-success-ultimate';
                    button.setAttribute('onclick', 'toggleDirectStream()');
                }
                console.log('✅ UI updated successfully');
            } else {
                console.error('❌ UI elements not found - trying alternative IDs...');

                // Try alternative element IDs as fallback
                const altIndicator = document.querySelector('.stream-indicator');
                const altText = document.querySelector('#newStreamText, .stream-info-display span');
                const altButton = document.querySelector('#newStreamBtn, .ultimate-btn');

                console.log('🔄 Alternative elements found:', {
                    altIndicator: !!altIndicator,
                    altText: !!altText,
                    altButton: !!altButton
                });

                if (altIndicator && altText && altButton) {
                    if (window.directStreamActive) {
                        altIndicator.classList.add('live');
                        altText.innerHTML = 'البث مباشر <span style="color: #ff0000;">🔴</span>';
                        altButton.innerHTML = '<i class="fas fa-stop"></i> إيقاف البث';
                        altButton.className = 'ultimate-btn btn-danger-ultimate';
                        altButton.setAttribute('onclick', 'toggleDirectStream()');
                    } else {
                        altIndicator.classList.remove('live');
                        altText.innerHTML = 'البث متوقف <span style="color: #888;">⚫</span>';
                        altButton.innerHTML = '<i class="fas fa-play"></i> بدء البث';
                        altButton.className = 'ultimate-btn btn-success-ultimate';
                        altButton.setAttribute('onclick', 'toggleDirectStream()');
                    }
                    console.log('✅ UI updated using alternative elements');
                } else {
                    console.error('❌ No UI elements found at all');
                }
            }
        };

        // Auto-send to direct stream when creating card - ENHANCED VERSION (Duplicate removed, using main function above)

        // Initialize direct stream system with auto-start
        window.initDirectStreamSystem = function() {
            console.log('🚀 Initializing direct stream system with auto-start...');

            // Auto-start streaming (override saved state)
            window.directStreamActive = true;
            localStorage.setItem('directStreamActive', 'true');
            console.log('🔴 Auto-started direct streaming system');

            // Wait for DOM to be ready
            setTimeout(() => {
                // Update UI
                window.updateDirectStreamUI();

                // Update button onclick to use direct stream
                const streamBtn = document.getElementById('newStreamBtn');
                if (streamBtn) {
                    streamBtn.setAttribute('onclick', 'toggleDirectStream()');
                    console.log('🔗 Button onclick updated');
                } else {
                    console.error('❌ Stream button not found');
                }

                console.log('✅ Direct stream system initialized');
            }, 1000);
        };

        // Initialize direct stream system immediately
        window.initDirectStreamSystem();

        console.log('🎉 Direct Stream System Ready!');
        console.log('🎬 Use testDirectStream() for quick testing');
        console.log('📺 Stream URL: ' + directStreamUrl);

        // Additional initialization when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM loaded - reinitializing direct stream system');
            setTimeout(() => {
                window.initDirectStreamSystem();
            }, 500);
        });

        // Also initialize when window loads
        window.addEventListener('load', function() {
            console.log('🌐 Window loaded - final initialization');
            setTimeout(() => {
                window.initDirectStreamSystem();

                // Test if functions are available
                console.log('🧪 Testing function availability:');
                console.log('- toggleDirectStream:', typeof window.toggleDirectStream);
                console.log('- sendToDirectStream:', typeof window.sendToDirectStream);
                console.log('- openDirectStream:', typeof window.openDirectStream);
                console.log('- testDirectStream:', typeof window.testDirectStream);

                // Show success message
                if (typeof window.toggleDirectStream === 'function') {
                    console.log('🎉 جميع دوال البث المباشر محملة بنجاح!');
                } else {
                    console.error('❌ فشل في تحميل دوال البث المباشر');
                }
            }, 2000);
        });
    </script>
</body>
</html>
